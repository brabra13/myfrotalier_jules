<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>MyFrontaliers Web Kit</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --color-primary: #1a202c;
            --color-secondary: #2d3748;
            --color-accent: #3182ce;
            --color-success: #38a169;
            --color-success-light: #68d391;
            --color-warning: #ed8936;
            --color-error: #e53e3e;
            --color-background: #ffffff;
            --color-background-secondary: #f7fafc;
            --color-background-tertiary: #edf2f7;
            --color-text-primary: #1a202c;
            --color-text-secondary: #4a5568;
            --color-text-muted: #718096;
            --color-border: #e2e8f0;
            --color-border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --status-todo: #ed8936;
            --status-inprogress: #3182ce;
            --status-waiting: #d69e2e;
            --status-completed: #38a169;
        }
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            line-height: 1.6;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .font-display {
            font-family: "Playfair Display", Georgia, serif;
        }

        .premium-card {
            background: var(--color-background);
            border: 1px solid var(--color-border-light);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .premium-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .premium-button-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .premium-button-primary:hover {
            background-color: var(--color-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .premium-button-secondary {
            background-color: var(--color-background);
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        .premium-button-secondary:hover {
            background-color: var(--color-background-secondary);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .premium-button-accent {
            background-color: var(--color-accent);
            color: white;
        }

        .premium-button-accent:hover {
            background-color: #2c5aa0;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: capitalize;
            letter-spacing: 0.025em;
        }

        .status-todo {
            background-color: rgba(237, 137, 54, 0.1);
            color: var(--status-todo);
            border: 1px solid rgba(237, 137, 54, 0.2);
        }

        .status-inprogress {
            background-color: rgba(49, 130, 206, 0.1);
            color: var(--status-inprogress);
            border: 1px solid rgba(49, 130, 206, 0.2);
        }

        .status-waiting {
            background-color: rgba(214, 158, 46, 0.1);
            color: var(--status-waiting);
            border: 1px solid rgba(214, 158, 46, 0.2);
        }

        .status-completed {
            background-color: rgba(56, 161, 105, 0.1);
            color: var(--status-completed);
            border: 1px solid rgba(56, 161, 105, 0.2);
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            color: var(--color-text-secondary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 0.375rem;
            position: relative;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .sidebar-nav-item:hover {
            background-color: var(--color-background-secondary);
            color: var(--color-accent);
            transform: translateX(4px);
            border-color: rgba(49, 130, 206, 0.15);
            box-shadow: 0 2px 8px rgba(49, 130, 206, 0.1);
        }

        .sidebar-nav-item:hover svg {
            transform: scale(1.1);
        }

        .sidebar-nav-item svg {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-nav-item.active {
            background: linear-gradient(135deg, rgba(49, 130, 206, 0.12) 0%, rgba(49, 130, 206, 0.08) 100%);
            color: var(--color-accent);
            border: 1px solid rgba(49, 130, 206, 0.25);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.15);
            transform: translateX(6px);
            z-index: 25; /* Ensure active items appear above the separator */
        }

        .sidebar-nav-item.active::before {
            content: '';
            position: absolute;
            left: -1px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--color-accent) 0%, #2c5aa0 100%);
            border-radius: 0 2px 2px 0;
            box-shadow: 0 2px 4px rgba(49, 130, 206, 0.3);
        }

        .sidebar-nav-item.active svg {
            color: var(--color-accent);
            transform: scale(1.05);
        }

        .sidebar-nav-item:active {
            transform: translateX(2px);
            transition: transform 0.1s ease;
        }

        .tab-content {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .tab-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Amélioration de l'accessibilité */
        .sidebar-nav-item:focus {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
            background-color: var(--color-background-secondary);
        }

        .sidebar-nav-item:focus:not(:focus-visible) {
            outline: none;
        }

        /* Elegant Sidebar Separator */
        .sidebar-container::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(49, 130, 206, 0.1) 10%,
                rgba(49, 130, 206, 0.15) 30%,
                rgba(49, 130, 206, 0.2) 50%,
                rgba(49, 130, 206, 0.15) 70%,
                rgba(49, 130, 206, 0.1) 90%,
                transparent 100%
            );
            z-index: 20;
        }

        .sidebar-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: -1px;
            width: 3px;
            height: 100%;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(49, 130, 206, 0.03) 20%,
                rgba(49, 130, 206, 0.06) 50%,
                rgba(49, 130, 206, 0.03) 80%,
                transparent 100%
            );
            filter: blur(1px);
            z-index: 15;
        }

        /* Enhanced shadow for the sidebar */
        .sidebar-container {
            box-shadow:
                2px 0 8px rgba(49, 130, 206, 0.04),
                1px 0 3px rgba(49, 130, 206, 0.06),
                0 0 1px rgba(49, 130, 206, 0.08);
        }

        /* Subtle glow effect on sidebar hover interactions */
        .sidebar-container:hover::after {
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(49, 130, 206, 0.15) 10%,
                rgba(49, 130, 206, 0.25) 30%,
                rgba(49, 130, 206, 0.3) 50%,
                rgba(49, 130, 206, 0.25) 70%,
                rgba(49, 130, 206, 0.15) 90%,
                transparent 100%
            );
            transition: background 0.3s ease;
        }

        /* Responsive improvements pour la sidebar */
        @media (max-width: 1024px) {
            .sidebar-nav-item {
                padding: 0.75rem 0.875rem;
                font-size: 0.8rem;
            }

            .sidebar-nav-item:hover,
            .sidebar-nav-item.active {
                transform: none;
            }

            .sidebar-container::before,
            .sidebar-container::after {
                display: none;
            }

            .sidebar-container {
                box-shadow: none;
                border-right: 1px solid var(--color-border-light);
            }
        }

        /* Additional refinements for main content area */
        .main-content-area {
            position: relative;
            background: var(--color-background-secondary);
        }

        .main-content-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(255, 255, 255, 0.8) 20%,
                rgba(255, 255, 255, 0.9) 50%,
                rgba(255, 255, 255, 0.8) 80%,
                transparent 100%
            );
            z-index: 10;
        }

        .progress-bar {
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            background-color: var(--color-background-tertiary);
        }

        .progress-value {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .premium-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.875rem;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .premium-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.875rem;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .faq-question {
            cursor: pointer;
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border-light);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .faq-question:hover {
            background-color: var(--color-background-secondary);
        }

        .faq-answer {
            padding: 1.5rem;
            background-color: var(--color-background-secondary);
            display: none;
            border-bottom: 1px solid var(--color-border-light);
        }

        .drag-drop-area {
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            background-color: var(--color-background-secondary);
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .drag-drop-area:hover, .drag-drop-area.dragover {
            border-color: var(--color-accent);
            background-color: rgba(49, 130, 206, 0.05);
            transform: translateY(-2px);
        }

        .premium-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .premium-table th {
            background-color: var(--color-background-secondary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            border-bottom: 1px solid var(--color-border-light);
        }

        .premium-table th:first-child {
            border-top-left-radius: 8px;
        }

        .premium-table th:last-child {
            border-top-right-radius: 8px;
        }

        .premium-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border-light);
            font-size: 0.875rem;
        }

        .premium-table tr:hover {
            background-color: var(--color-background-secondary);
        }

        .section-header {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .section-subtitle {
            font-size: 1.125rem;
            color: var(--color-text-secondary);
            font-weight: 400;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.01em;
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-bottom: 1.5rem;
        }

        /* Simulator Scoped Styles */
        #simulator-container {
            /* Simulator CSS variables */
            --sim-primary: #2a5b8c;
            --sim-secondary: #4a90e2;
            --sim-accent: #ff6b35;
            --sim-success: #2e8b57;
            --sim-light: #f8f9fa;
            --sim-dark: #1d2d35;
            --sim-grey: #6c757d;
            --sim-border: #dee2e6;
            --sim-warning: #ffc107;
            --sim-font-main: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            --sim-font-heading: 'Montserrat', 'Arial Rounded MT Bold', sans-serif;
            --sim-space-xs: 0.5rem;
            --sim-space-sm: 1rem;
            --sim-space-md: 1.5rem;
            --sim-space-lg: 2rem;
            --sim-space-xl: 3rem;
            --sim-radius-sm: 4px;
            --sim-radius-md: 8px;
            --sim-radius-lg: 12px;
            --sim-radius-xl: 20px;
        }

        #simulator-container * {
            box-sizing: border-box;
        }

        /* Hero section */
        .simulator-hero {
            background: linear-gradient(135deg, rgba(42, 91, 140, 0.95), rgba(74, 144, 226, 0.85)), url('https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1951&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            border-radius: var(--sim-radius-xl);
            padding: var(--sim-space-xl);
            margin: var(--sim-space-md) 0;
        }

        .simulator-hero h1 {
            font-size: 2.5rem;
            margin-bottom: var(--sim-space-sm);
            font-family: var(--sim-font-heading);
        }

        .simulator-hero p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto var(--sim-space-lg);
            opacity: 0.9;
        }

        /* Features */
        .simulator-features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--sim-space-md);
            margin: var(--sim-space-xl) 0;
        }

        .simulator-feature {
            background: white;
            border-radius: var(--sim-radius-lg);
            padding: var(--sim-space-lg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s;
        }

        .simulator-feature:hover {
            transform: translateY(-5px);
        }

        .simulator-feature i {
            font-size: 2.5rem;
            color: var(--sim-primary);
            margin-bottom: var(--sim-space-sm);
        }

        .simulator-feature h3 {
            margin-bottom: var(--sim-space-xs);
            color: var(--sim-primary);
        }

        /* Warning */
        .simulator-warning {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid var(--sim-warning);
            padding: var(--sim-space-md);
            border-radius: var(--sim-radius-sm);
            margin: var(--sim-space-lg) 0;
        }

        /* Button */
        .simulator-btn {
            display: inline-block;
            padding: 0.8rem 2rem;
            background-color: var(--sim-accent);
            color: white;
            border-radius: var(--sim-radius-md);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .simulator-btn:hover {
            background-color: #e55a2b;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 107, 53, 0.3);
        }

        .simulator-btn-secondary {
            background-color: var(--sim-secondary);
        }

        .simulator-btn-secondary:hover {
            background-color: #3a7fd9;
        }

        /* Form container */
        .simulator-form-container {
            background: white;
            border-radius: var(--sim-radius-xl);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin: var(--sim-space-lg) 0;
        }

        .simulator-form-header {
            padding: var(--sim-space-md);
            background: var(--sim-primary);
            color: white;
            text-align: center;
        }

        .simulator-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            margin-top: var(--sim-space-sm);
            overflow: hidden;
        }

        .simulator-progress {
            height: 100%;
            background: white;
            width: 33%;
            border-radius: 4px;
            transition: width 0.5s;
        }

        .simulator-form-body {
            padding: var(--sim-space-lg);
        }

        .simulator-form-step {
            display: none;
        }

        .simulator-form-step.active {
            display: block;
        }

        .simulator-form-group {
            margin-bottom: var(--sim-space-lg);
        }

        .simulator-form-group h3 {
            margin-bottom: var(--sim-space-md);
            color: var(--sim-primary);
            border-bottom: 1px solid var(--sim-border);
            padding-bottom: var(--sim-space-xs);
        }

        .simulator-input-group {
            margin-bottom: var(--sim-space-md);
        }

        .simulator-input-group label {
            display: block;
            margin-bottom: var(--sim-space-xs);
            font-weight: 500;
        }

        #simulator-container input,
        #simulator-container select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--sim-border);
            border-radius: var(--sim-radius-md);
            font-family: var(--sim-font-main);
            font-size: 1rem;
        }

        #simulator-container input:focus,
        #simulator-container select:focus {
            outline: none;
            border-color: var(--sim-secondary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        .simulator-checkbox-group {
            display: flex;
            gap: var(--sim-space-sm);
            align-items: center;
            margin-bottom: var(--sim-space-xs);
        }

        .simulator-checkbox-group input {
            width: auto;
        }

        /* Info tooltip */
        .simulator-info-tooltip {
            display: inline-block;
            margin-left: var(--sim-space-xs);
            color: var(--sim-secondary);
            cursor: pointer;
            position: relative;
        }

        .simulator-tooltip-text {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--sim-dark);
            color: white;
            padding: var(--sim-space-sm);
            border-radius: var(--sim-radius-md);
            width: 250px;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .simulator-info-tooltip:hover .simulator-tooltip-text {
            opacity: 1;
            visibility: visible;
        }

        /* Advanced options */
        .simulator-advanced-toggle {
            display: flex;
            align-items: center;
            gap: var(--sim-space-xs);
            color: var(--sim-primary);
            font-weight: 500;
            cursor: pointer;
            margin-top: var(--sim-space-sm);
        }

        .simulator-advanced-options {
            display: none;
            margin-top: var(--sim-space-md);
            padding-top: var(--sim-space-md);
            border-top: 1px dashed var(--sim-border);
        }

        /* Slider */
        .simulator-slider-container {
            margin-top: var(--sim-space-sm);
        }

        .simulator-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--sim-border);
            outline: none;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .simulator-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--sim-primary);
            cursor: pointer;
        }

        .simulator-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--sim-grey);
        }

        /* Form navigation */
        .simulator-form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: var(--sim-space-lg);
        }

        /* Results */
        .simulator-results-header {
            text-align: center;
            margin-bottom: var(--sim-space-xl);
        }

        .simulator-results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--sim-space-lg);
            margin-bottom: var(--sim-space-xl);
        }

        .simulator-card {
            background: white;
            border-radius: var(--sim-radius-lg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: var(--sim-space-lg);
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }

        .simulator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .simulator-card.simulator-recommended {
            border: 2px solid var(--sim-success);
            transform: scale(1.02);
        }

        .simulator-card.simulator-recommended::after {
            content: 'Recommandé';
            position: absolute;
            top: -12px;
            right: 20px;
            background: var(--sim-success);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: var(--sim-radius-md);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .simulator-card-header {
            padding-bottom: var(--sim-space-md);
            margin-bottom: var(--sim-space-md);
            border-bottom: 1px solid var(--sim-border);
        }

        .simulator-price {
            font-size: 2.5rem;
            font-weight: 700;
            margin: var(--sim-space-sm) 0;
            color: var(--sim-primary);
        }

        .simulator-price-period {
            font-size: 1rem;
            color: var(--sim-grey);
            font-weight: 400;
        }

        .simulator-details-toggle {
            color: var(--sim-secondary);
            font-weight: 500;
            cursor: pointer;
            margin: var(--sim-space-sm) 0;
            display: inline-block;
        }

        .simulator-details-content {
            display: none;
            text-align: left;
            margin-top: var(--sim-space-md);
            background: #f8fafc;
            padding: var(--sim-space-md);
            border-radius: var(--sim-radius-md);
        }

        /* Threshold graph */
        .simulator-threshold-graph {
            background: white;
            border-radius: var(--sim-radius-lg);
            padding: var(--sim-space-lg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: var(--sim-space-lg);
        }

        .simulator-graph-container {
            height: 100px;
            background: linear-gradient(to right, var(--sim-secondary), var(--sim-accent));
            border-radius: var(--sim-radius-md);
            margin: var(--sim-space-md) 0;
            position: relative;
        }

        .simulator-threshold-marker {
            position: absolute;
            top: -25px;
            width: 2px;
            height: 150px;
            background: var(--sim-dark);
        }

        .simulator-threshold-label {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--sim-dark);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: var(--sim-radius-md);
            white-space: nowrap;
        }

        .simulator-current-position {
            position: absolute;
            bottom: -25px;
            transform: translateX(-50%);
            background: var(--sim-accent);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: var(--sim-radius-md);
            font-weight: 600;
        }

        .simulator-graph-labels {
            display: flex;
            justify-content: space-between;
            color: var(--sim-grey);
            font-size: 0.9rem;
        }

        /* Comparison table */
        .simulator-comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--sim-space-lg) 0;
        }

        .simulator-comparison-table th,
        .simulator-comparison-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--sim-border);
        }

        .simulator-comparison-table th {
            font-weight: 600;
            color: var(--sim-primary);
        }

        .simulator-comparison-table tr:last-child td {
            border-bottom: none;
        }

        /* Report */
        .simulator-report-container {
            text-align: center;
            padding: var(--sim-space-xl) 0;
        }

        .simulator-report-card {
            background: white;
            border-radius: var(--sim-radius-xl);
            padding: var(--sim-space-xl);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        /* FAQ */
        .simulator-faq-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .simulator-faq-item {
            margin-bottom: var(--sim-space-sm);
            border: 1px solid var(--sim-border);
            border-radius: var(--sim-radius-md);
            overflow: hidden;
        }

        .simulator-faq-question {
            padding: var(--sim-space-md);
            background: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .simulator-faq-answer {
            padding: 0 var(--sim-space-md);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s, padding 0.3s;
            background: #f8fafc;
        }

        .simulator-faq-item.active .simulator-faq-answer {
            padding: var(--sim-space-md);
            max-height: 500px;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .simulator-features {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .simulator-hero {
                padding: var(--sim-space-lg);
            }

            .simulator-hero h1 {
                font-size: 2rem;
            }

            .simulator-features {
                grid-template-columns: 1fr;
            }

            .simulator-form-container {
                margin: var(--sim-space-md) 0;
            }

            .simulator-results-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .simulator-hero {
                margin: var(--sim-space-sm) 0;
                padding: var(--sim-space-lg) var(--sim-space-md);
            }

            .simulator-hero h1 {
                font-size: 1.8rem;
            }

            .simulator-btn {
                width: 100%;
            }

            .simulator-form-navigation {
                flex-direction: column;
                gap: var(--sim-space-sm);
            }
        }

        /* Quasi-Resident Simulator Styles */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-highlight {
            transition: all 0.3s ease;
        }
        .input-highlight:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .hidden {
            display: none !important;
        }

        /* Enhanced Results Display Styles */
        .qr-results-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            /* Removed transition and hover transform effects */
        }

        .qr-results-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-success) 0%, var(--color-success-light) 100%);
            opacity: 0;
            /* Removed transition effect */
        }

        .qr-results-card.eligible::before {
            background: linear-gradient(90deg, var(--color-success) 0%, var(--color-success-light) 100%);
            opacity: 1;
        }

        .qr-results-card.not-eligible::before {
            background: linear-gradient(90deg, var(--color-error) 0%, #f56565 100%);
            opacity: 1;
        }

        /* Removed hover transform effects - container stays completely static */

        /* Enhanced Ratio Display Component */
        .qr-ratio-display {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            margin: 2rem 0;
        }

        .qr-ratio-circle {
            position: relative;
            width: 160px;
            height: 160px;
            margin-bottom: 1.5rem;
        }

        .qr-ratio-circle svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .qr-ratio-circle .circle-bg {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 8;
        }

        .qr-ratio-circle .circle-progress {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .qr-ratio-circle.eligible .circle-progress {
            stroke: url(#greenGradient);
        }

        .qr-ratio-circle.not-eligible .circle-progress {
            stroke: url(#redGradient);
        }

        .qr-ratio-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .qr-ratio-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.25rem;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .qr-ratio-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .qr-threshold-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            transition: all 0.3s ease;
        }

        .qr-threshold-indicator.eligible {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%);
            color: var(--color-success);
            border: 2px solid rgba(16, 185, 129, 0.2);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        }

        .qr-threshold-indicator.not-eligible {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
            color: var(--color-error);
            border: 2px solid rgba(239, 68, 68, 0.2);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .qr-threshold-icon {
            font-size: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Enhanced Status Badge */
        .qr-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .qr-status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .qr-status-badge:hover::before {
            left: 100%;
        }

        .qr-status-badge.eligible {
            background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .qr-status-badge.not-eligible {
            background: linear-gradient(135deg, var(--color-error) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .qr-status-icon {
            font-size: 1.25rem;
        }

        /* Enhanced Content Cards */
        .qr-content-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .qr-content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, var(--color-accent) 50%, transparent 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .qr-content-card:hover::before {
            transform: scaleX(1);
        }

        .qr-content-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: var(--color-accent);
        }

        .qr-content-card.success {
            border-color: rgba(16, 185, 129, 0.2);
            background: linear-gradient(135deg, #ffffff 0%, rgba(16, 185, 129, 0.02) 100%);
        }

        .qr-content-card.success::before {
            background: linear-gradient(90deg, transparent 0%, var(--color-success) 50%, transparent 100%);
        }

        .qr-content-card.info {
            border-color: rgba(59, 130, 246, 0.2);
            background: linear-gradient(135deg, #ffffff 0%, rgba(59, 130, 246, 0.02) 100%);
        }

        .qr-content-card.info::before {
            background: linear-gradient(90deg, transparent 0%, var(--color-accent) 50%, transparent 100%);
        }

        .qr-content-card.warning {
            border-color: rgba(245, 158, 11, 0.2);
            background: linear-gradient(135deg, #ffffff 0%, rgba(245, 158, 11, 0.02) 100%);
        }

        .qr-content-card.warning::before {
            background: linear-gradient(90deg, transparent 0%, var(--color-warning) 50%, transparent 100%);
        }

        .qr-content-card.error {
            border-color: rgba(239, 68, 68, 0.2);
            background: linear-gradient(135deg, #ffffff 0%, rgba(239, 68, 68, 0.02) 100%);
        }

        .qr-content-card.error::before {
            background: linear-gradient(90deg, transparent 0%, var(--color-error) 50%, transparent 100%);
        }

        /* Enhanced Button Styles */
        .qr-enhanced-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .qr-enhanced-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .qr-enhanced-button:hover::before {
            left: 100%;
        }

        .qr-enhanced-button:hover {
            transform: translateY(-2px);
        }

        .qr-enhanced-button.primary {
            background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .qr-enhanced-button.primary:hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .qr-enhanced-button.secondary {
            background: linear-gradient(135deg, var(--color-accent) 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .qr-enhanced-button.secondary:hover {
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        /* Animated Counter */
        .qr-animated-counter {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: countUp 2s ease-out;
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Animation Enhancement */
        .qr-loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
            text-align: center;
        }

        .qr-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid var(--color-success);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Advanced Visual Effects */
        /* Removed floating animation - elements stay static */

        .qr-glow-effect {
            position: relative;
        }

        .qr-glow-effect::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(16, 185, 129, 0.3), transparent);
            border-radius: inherit;
            z-index: -1;
            opacity: 0;
            /* Removed transition - no hover effect */
        }

        /* Removed hover glow effect - element stays static */

        /* Enhanced Micro-interactions */
        .qr-micro-bounce {
            transition: transform 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .qr-micro-bounce:hover {
            transform: scale(1.05);
        }

        .qr-micro-bounce:active {
            transform: scale(0.95);
        }

        /* Staggered Animation for Lists */
        .qr-stagger-animation li {
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInLeft 0.6s ease forwards;
        }

        .qr-stagger-animation li:nth-child(1) { animation-delay: 0.1s; }
        .qr-stagger-animation li:nth-child(2) { animation-delay: 0.2s; }
        .qr-stagger-animation li:nth-child(3) { animation-delay: 0.3s; }
        .qr-stagger-animation li:nth-child(4) { animation-delay: 0.4s; }
        .qr-stagger-animation li:nth-child(5) { animation-delay: 0.5s; }

        @keyframes slideInLeft {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Enhanced Progress Circle Animation */
        /* Removed scale animation - circle stays static */

        /* Particle Effect Background */
        .qr-particle-bg {
            position: relative;
            overflow: hidden;
        }

        .qr-particle-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            /* Removed animation - background stays static */
            pointer-events: none;
        }

        /* Removed particleFloat keyframes - no longer needed */

        /* Enhanced Status Indicators */
        .qr-status-indicator {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 0.75rem;
        }

        .qr-status-indicator.success {
            background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .qr-status-indicator.error {
            background: linear-gradient(135deg, var(--color-error) 0%, #dc2626 100%);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .qr-status-indicator::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: ripple 2s infinite;
        }

        .qr-status-indicator.success::after {
            background: rgba(16, 185, 129, 0.3);
        }

        .qr-status-indicator.error::after {
            background: rgba(239, 68, 68, 0.3);
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Enhanced Typography Effects */
        .qr-gradient-text {
            background: linear-gradient(135deg, #1f2937 0%, #374151 50%, #1f2937 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* ICC Details in TOU Card Styling */
        #touIccDetailsSection {
            border-top: 1px solid #e5e7eb;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
        }

        #touIccToggle, #touIfdToggle, #touCalculatedTaxToggle, #touIccDeductionsToggle, #touIfdDeductionsToggle {
            transition: all 0.2s ease;
            padding: 2px 4px;
            border-radius: 3px;
        }

        #touIccToggle:hover, #touIfdToggle:hover, #touCalculatedTaxToggle:hover, #touIccDeductionsToggle:hover, #touIfdDeductionsToggle:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        #touIccBreakdown {
            transition: max-height 0.3s ease-out;
        }

        /* Enhanced deduction details styling with clear visual separation */
        .bg-blue-25 {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .bg-green-25 {
            background-color: rgba(34, 197, 94, 0.05);
        }

        .border-blue-300 {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .border-green-300 {
            border-color: rgba(34, 197, 94, 0.3);
        }

        /* Social contributions section styling */
        .social-contributions-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(220, 38, 38, 0.08) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .social-contributions-header {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.15) 100%);
            border-bottom: 1px solid rgba(239, 68, 68, 0.2);
            padding: 8px 12px;
            border-radius: 7px 7px 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .social-contributions-icon {
            width: 16px;
            height: 16px;
            color: rgba(239, 68, 68, 0.8);
        }

        .social-contributions-title {
            font-weight: 600;
            font-size: 0.75rem;
            color: rgba(239, 68, 68, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .social-contributions-content {
            padding: 8px 12px;
        }

        /* Tax deductions section styling */
        .tax-deductions-section {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(22, 163, 74, 0.08) 100%);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .tax-deductions-header {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(22, 163, 74, 0.15) 100%);
            border-bottom: 1px solid rgba(34, 197, 94, 0.2);
            padding: 8px 12px;
            border-radius: 7px 7px 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tax-deductions-icon {
            width: 16px;
            height: 16px;
            color: rgba(34, 197, 94, 0.8);
        }

        .tax-deductions-title {
            font-weight: 600;
            font-size: 0.75rem;
            color: rgba(34, 197, 94, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .tax-deductions-content {
            padding: 8px 12px;
        }

        /* Deduction item styling */
        .deduction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .deduction-item:last-child {
            border-bottom: none;
        }

        .deduction-item-label {
            font-size: 0.75rem;
            color: rgba(55, 65, 81, 0.8);
            flex: 1;
        }

        .deduction-item-amount {
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(55, 65, 81, 0.9);
        }

        .deduction-item-explanation {
            font-size: 0.6875rem;
            color: rgba(107, 114, 128, 0.8);
            font-style: italic;
            margin-top: 2px;
            padding-left: 8px;
        }

        /* Section totals */
        .section-total {
            border-top: 2px solid rgba(0, 0, 0, 0.1);
            padding-top: 8px;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-total-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: rgba(55, 65, 81, 0.9);
        }

        .section-total-amount {
            font-size: 0.75rem;
            font-weight: 700;
            color: rgba(55, 65, 81, 1);
        }

        /* Information tooltips */
        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: rgba(55, 65, 81, 0.95);
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .info-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(55, 65, 81, 0.95) transparent transparent transparent;
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Enhanced section headers with better visual hierarchy */
        .enhanced-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .section-info-icon {
            width: 14px;
            height: 14px;
            color: rgba(107, 114, 128, 0.7);
            margin-left: 6px;
        }

        .border-green-200 {
            border-color: rgba(34, 197, 94, 0.2);
        }

        .border-l-3 {
            border-left-width: 3px;
        }

        /* Responsive Design Enhancements */
        @media (max-width: 768px) {
            .qr-results-card {
                margin: 1rem;
                padding: 1.5rem;
                border-radius: 16px;
            }

            #touIccDetailsSection .text-xs {
                font-size: 0.7rem;
            }

            #touIccToggle {
                font-size: 0.7rem;
            }

            #touIccToggle svg {
                width: 0.75rem;
                height: 0.75rem;
            }

            .qr-ratio-display {
                padding: 1.5rem;
                margin: 1.5rem 0;
            }

            .qr-ratio-circle {
                width: 120px;
                height: 120px;
                margin-bottom: 1rem;
            }

            .qr-ratio-number {
                font-size: 2rem;
            }

            .qr-status-badge {
                font-size: 0.875rem;
                padding: 0.625rem 1.25rem;
            }

            .qr-content-card {
                padding: 1.25rem;
                border-radius: 12px;
            }

            .qr-enhanced-button {
                padding: 0.875rem 1.5rem;
                font-size: 0.875rem;
            }

            .qr-status-indicator {
                width: 20px;
                height: 20px;
                margin-right: 0.5rem;
            }

            /* Ensure no animations on mobile - already removed globally */
        }

        @media (max-width: 480px) {
            .qr-results-card {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 12px;
            }

            .qr-ratio-display {
                padding: 1rem;
                margin: 1rem 0;
            }

            .qr-ratio-circle {
                width: 100px;
                height: 100px;
            }

            .qr-ratio-number {
                font-size: 1.75rem;
            }

            .qr-status-badge {
                font-size: 0.75rem;
                padding: 0.5rem 1rem;
                flex-direction: column;
                gap: 0.25rem;
                text-align: center;
            }

            .qr-status-icon {
                font-size: 1rem;
            }

            .qr-content-card {
                padding: 1rem;
            }

            .qr-content-card .flex.items-center {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .qr-content-card .flex.items-center .w-12 {
                width: 2.5rem;
                height: 2.5rem;
                margin-right: 0;
            }

            .qr-enhanced-button {
                padding: 0.75rem 1.25rem;
                font-size: 0.8rem;
            }

            /* Stack grid items on very small screens */
            .grid.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Accessibility Enhancements */
        .qr-results-card:focus-within {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        .qr-enhanced-button:focus {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        .qr-micro-bounce:focus {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
            transform: scale(1.05);
        }

        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .qr-status-indicator::after,
            .qr-gradient-text {
                animation: none;
            }

            .qr-stagger-animation li {
                animation: none;
                opacity: 1;
                transform: none;
            }

            .qr-micro-bounce:hover {
                transform: none;
            }

            .qr-enhanced-button:hover {
                transform: none;
            }

            .qr-content-card:hover {
                transform: none;
            }

            /* Results card already has no hover transforms */
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .qr-results-card {
                border: 2px solid;
            }

            .qr-status-badge {
                border: 2px solid;
            }

            .qr-enhanced-button {
                border: 2px solid;
            }

            .qr-content-card {
                border: 2px solid;
            }
        }

        /* Print styles */
        @media print {
            .qr-results-card {
                box-shadow: none;
                border: 1px solid #000;
                break-inside: avoid;
            }

            .qr-enhanced-button {
                display: none;
            }

            .qr-status-indicator::after {
                animation: none;
            }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Currency Converter Styles */
        .currency-input-container {
            position: relative;
        }
        .currency-toggle {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        .currency-toggle:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        .currency-toggle.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .currency-converted {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
            font-style: italic;
        }
        .currency-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 4px;
            opacity: 0.7;
        }

        /* TOU Simulator Scoped Styles */
        .tou-simulator-wrapper {
            position: relative;
        }

        .tou-simulator-wrapper .tou-card-hover {
            transition: all 0.3s ease;
        }

        .tou-simulator-wrapper .tou-card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .tou-simulator-wrapper .tou-input-focus {
            transition: all 0.2s ease;
        }

        .tou-simulator-wrapper .tou-input-focus:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .tou-simulator-wrapper .tou-fade-in {
            animation: touFadeIn 0.5s ease-in-out;
        }

        @keyframes touFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tou-simulator-wrapper .tou-result-card {
            transition: all 0.3s ease;
        }

        .tou-simulator-wrapper .tou-result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .tou-simulator-wrapper .tou-best-option {
            animation: touPulse 2s infinite;
        }

        @keyframes touPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(74, 222, 128, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .tou-simulator-wrapper .tou-error-border {
            border-color: #ef4444 !important;
        }

        /* Multi-Step Form Styles */
        .tou-simulator-wrapper .tou-step-container {
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 2rem;
        }



        .tou-simulator-wrapper .tou-progress-container {
            padding: 1.5rem 2.5rem 0 2.5rem;
        }

        .tou-simulator-wrapper .tou-progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .tou-simulator-wrapper .tou-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 3px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
        }

        .tou-simulator-wrapper .tou-progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .tou-simulator-wrapper .tou-step-content {
            padding: 2.5rem;
        }

        .tou-simulator-wrapper .tou-form-step {
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tou-simulator-wrapper .tou-form-step.active {
            display: block;
            animation: touStepFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes touStepFadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .tou-simulator-wrapper .tou-input-focus {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .tou-simulator-wrapper .tou-input-focus:focus {
            transform: translateY(-1px);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }

        .tou-simulator-wrapper .tou-input-group {
            position: relative;
        }

        .tou-simulator-wrapper .tou-input-group:hover .tou-input-focus {
            border-color: #9ca3af;
        }

        /* Enhanced Dropdown Styling */
        .tou-simulator-wrapper select.tou-input-focus {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 48px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }

        .tou-simulator-wrapper select.tou-input-focus:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        .tou-simulator-wrapper select.tou-input-focus:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        .tou-simulator-wrapper select.tou-input-focus:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        /* Enhanced option styling */
        .tou-simulator-wrapper select.tou-input-focus option {
            padding: 12px 16px;
            font-weight: 500;
            color: #374151;
            background-color: white;
        }

        .tou-simulator-wrapper select.tou-input-focus option:hover {
            background-color: #f3f4f6;
        }

        .tou-simulator-wrapper select.tou-input-focus option:checked {
            background-color: #3b82f6;
            color: white;
        }

        /* Dropdown container enhancements */
        .tou-simulator-wrapper .tou-dropdown-container {
            position: relative;
        }

        .tou-simulator-wrapper .tou-dropdown-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            pointer-events: none;
            transition: all 0.3s ease;
            opacity: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05));
        }

        .tou-simulator-wrapper .tou-dropdown-container:hover::after {
            opacity: 1;
        }

        .tou-simulator-wrapper .tou-dropdown-container.focused::after {
            opacity: 1;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1));
        }

        /* Error state styling for dropdowns */
        .tou-simulator-wrapper select.tou-input-focus.tou-error-border {
            border-color: #ef4444 !important;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ef4444' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        /* Success state styling for dropdowns */
        .tou-simulator-wrapper select.tou-input-focus.tou-success-border {
            border-color: #10b981;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2310b981' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }



        /* Loading Animation */
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Fiscal Tool Cards Styles */
        .fiscal-tool-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .fiscal-tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .fiscal-tool-card:hover::before {
            transform: scaleX(1);
        }

        .fiscal-tool-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .fiscal-card-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.05));
            border-radius: 20px;
            margin: 0 auto;
        }

        .fiscal-tool-card:hover .fiscal-card-icon {
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }

        .fiscal-card-footer button {
            transition: all 0.2s ease;
        }

        .fiscal-card-footer button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tou-simulator-wrapper .tou-form-group {
            margin-bottom: 2rem;
        }

        .tou-simulator-wrapper .tou-form-group-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tou-simulator-wrapper .tou-form-group-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-size: 0.875rem;
        }

        .tou-simulator-wrapper .tou-input-group {
            margin-bottom: 1.5rem;
        }

        .tou-simulator-wrapper .tou-input-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .tou-simulator-wrapper .tou-input-required {
            color: #ef4444;
            margin-left: 0.25rem;
        }

        .tou-simulator-wrapper .tou-input-help {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
            font-style: italic;
        }

        /* Enhanced Professional Frais Réels Accordion Styles - Light & Clean */
        .tou-frais-accordion {
            border: 1px solid #e1e7ef;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1.25rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .tou-frais-accordion:hover {
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .tou-frais-accordion::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #60a5fa, #3b82f6, #2563eb);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tou-frais-accordion:hover::before {
            opacity: 1;
        }

        .tou-frais-accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
            border: none;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
            letter-spacing: -0.025em;
            position: relative;
        }

        .tou-frais-accordion-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1.5rem;
            right: 1.5rem;
            height: 1px;
            background: linear-gradient(90deg, transparent, #e1e7ef, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tou-frais-accordion-header:hover {
            background: linear-gradient(135deg, #f8fafb 0%, #f1f5f9 100%);
            color: #111827;
        }

        .tou-frais-accordion-header:focus {
            outline: none;
            box-shadow: inset 0 0 0 2px #3b82f6, 0 0 0 4px rgba(59, 130, 246, 0.15);
        }

        .tou-frais-accordion-header[aria-expanded="true"] {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: #0369a1;
        }

        .tou-frais-accordion-header[aria-expanded="true"]::after {
            opacity: 1;
        }

        .tou-frais-accordion-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .tou-frais-accordion-title i {
            font-size: 1.125rem;
            width: 1.5rem;
            text-align: center;
            filter: drop-shadow(0 1px 2px rgba(59, 130, 246, 0.2));
        }

        .tou-frais-accordion-summary {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-right: 1.25rem;
        }

        .tou-frais-summary-badge {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: #0369a1;
            padding: 0.375rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 70px;
            text-align: center;
            border: 1px solid rgba(3, 105, 161, 0.2);
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.025em;
        }

        .tou-frais-summary-badge.has-values {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #047857;
            border-color: rgba(4, 120, 87, 0.2);
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.15);
        }

        .tou-frais-accordion-chevron {
            width: 1.25rem;
            height: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #6b7280;
            filter: drop-shadow(0 1px 1px rgba(59, 130, 246, 0.1));
        }

        .tou-frais-accordion-header[aria-expanded="true"] .tou-frais-accordion-chevron {
            transform: rotate(180deg);
            color: #0369a1;
        }

        .tou-frais-accordion-content {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
            position: relative;
        }

        .tou-frais-accordion-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 1.5rem;
            right: 1.5rem;
            height: 1px;
            background: linear-gradient(90deg, transparent, #e1e7ef, transparent);
        }

        .tou-frais-progress-bar {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
            border: 1px solid #e1e7ef;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1.5rem;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08);
            position: relative;
            overflow: hidden;
        }

        .tou-frais-progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #60a5fa, #3b82f6, #2563eb);
        }

        .tou-frais-progress-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tou-frais-progress-circle {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25), 0 2px 6px rgba(59, 130, 246, 0.15);
            position: relative;
            overflow: hidden;
        }

        .tou-frais-progress-circle::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(-45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(-45deg); }
        }

        .tou-frais-progress-info > div:last-child {
            line-height: 1.4;
        }

        .tou-frais-progress-info .font-medium {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
        }

        .tou-frais-progress-info .text-sm {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .tou-frais-controls {
            display: flex;
            gap: 0.75rem;
        }

        .tou-frais-control-btn {
            padding: 0.625rem 1.25rem;
            border: 1px solid #e1e7ef;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.08);
            position: relative;
            overflow: hidden;
        }

        .tou-frais-control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .tou-frais-control-btn:hover {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: #93c5fd;
            color: #1f2937;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .tou-frais-control-btn:hover::before {
            left: 100%;
        }

        .tou-frais-control-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .tou-frais-control-btn:active {
            transform: translateY(0);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .tou-frais-accordion-header {
                padding: 1rem 1.25rem;
            }

            .tou-frais-accordion-content {
                padding: 1.5rem 1.25rem;
            }

            .tou-frais-progress-bar {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                padding: 1.25rem;
            }

            .tou-frais-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .tou-frais-accordion-summary {
                margin-right: 0.75rem;
            }

            .tou-frais-progress-circle {
                width: 2.5rem;
                height: 2.5rem;
            }
        }

        /* Enhanced Form Input Styling within Frais Réels */
        .tou-frais-accordion .tou-input-group {
            margin-bottom: 1.75rem;
            position: relative;
        }

        .tou-frais-accordion .tou-input-group:last-child {
            margin-bottom: 0;
        }

        .tou-frais-accordion .tou-input-label {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            letter-spacing: -0.025em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tou-frais-accordion input[type="checkbox"] {
            width: 1.125rem;
            height: 1.125rem;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            appearance: none;
            -webkit-appearance: none;
        }

        .tou-frais-accordion input[type="checkbox"]:hover {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
        }

        .tou-frais-accordion input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border-color: #3b82f6;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        .tou-frais-accordion input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .tou-frais-accordion input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .tou-frais-accordion .tou-input-focus {
            border: 2px solid #e1e7ef;
            border-radius: 12px;
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #1f2937;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.05);
        }

        .tou-frais-accordion .tou-input-focus:hover:not(:disabled) {
            border-color: #93c5fd;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);
        }

        .tou-frais-accordion .tou-input-focus:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15), 0 2px 6px rgba(59, 130, 246, 0.1);
            background: #ffffff;
        }

        .tou-frais-accordion .tou-input-focus:disabled {
            background: linear-gradient(135deg, #f8fafb 0%, #f1f5f9 100%);
            color: #9ca3af;
            border-color: #e1e7ef;
            cursor: not-allowed;
        }

        .tou-frais-accordion .tou-input-help {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            font-style: normal;
            line-height: 1.4;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, #f8fafb 0%, #f1f5f9 100%);
            border-radius: 8px;
            border: 1px solid #e1e7ef;
            position: relative;
        }

        .tou-frais-accordion .tou-input-help::before {
            content: 'ℹ️';
            margin-right: 0.375rem;
            font-style: normal;
        }

        /* Enhanced grid layouts within accordion */
        .tou-frais-accordion .grid {
            gap: 1.5rem;
        }

        .tou-frais-accordion .space-y-2 > * + * {
            margin-top: 0.75rem;
        }

        /* Validation message styling within accordion */
        .tou-frais-accordion .tou-validation-message {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            border-width: 2px;
        }

        /* Enhanced select styling */
        .tou-frais-accordion select.tou-input-focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25rem 1.25rem;
            padding-right: 2.5rem;
            appearance: none;
            -webkit-appearance: none;
        }

        .tou-frais-accordion select.tou-input-focus:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2360a5fa' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Subtle animations for form interactions */
        .tou-frais-accordion .tou-input-group {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced spacing for checkbox groups */
        .tou-frais-accordion .flex.items-center {
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .tou-frais-accordion .flex.items-center label {
            margin-bottom: 0;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .tou-frais-accordion .flex.items-center:hover label {
            color: #111827;
        }

        /* Enhanced Validation Styling - Light & Professional */
        #touFraisValidationContainer .tou-validation-message {
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08), 0 2px 6px rgba(0, 0, 0, 0.05);
            border-width: 2px;
            position: relative;
            overflow: hidden;
        }

        #touFraisValidationContainer .tou-validation-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        #touFraisValidationContainer .bg-red-50 {
            background: linear-gradient(135deg, #fef7f7 0%, #fef2f2 100%);
            border-color: #f87171;
        }

        #touFraisValidationContainer .bg-red-50::before {
            background: linear-gradient(90deg, #f87171, #ef4444);
        }

        #touFraisValidationContainer .bg-yellow-50 {
            background: linear-gradient(135deg, #fffef7 0%, #fffbeb 100%);
            border-color: #fbbf24;
        }

        #touFraisValidationContainer .bg-yellow-50::before {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }

        #touFraisValidationContainer .font-medium {
            font-weight: 600;
            font-size: 0.95rem;
            letter-spacing: -0.025em;
        }

        #touFraisValidationContainer .text-sm {
            font-size: 0.875rem;
            line-height: 1.5;
        }

        #touFraisValidationContainer ul {
            margin-top: 0.75rem;
        }

        #touFraisValidationContainer li {
            margin-bottom: 0.25rem;
            padding-left: 0.25rem;
        }

        /* Enhanced typography throughout the accordion */
        .tou-frais-accordion h5 {
            font-weight: 600;
            letter-spacing: -0.025em;
            line-height: 1.3;
        }

        .tou-frais-accordion .text-sm {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Improved focus states for better accessibility */
        .tou-frais-accordion *:focus-visible {
            outline: 2px solid #60a5fa;
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Enhanced loading states */
        .tou-frais-accordion.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .tou-frais-accordion.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Advanced Micro-interactions and Polish */
        .tou-frais-accordion-header {
            position: relative;
            overflow: hidden;
        }

        .tou-frais-accordion-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .tou-frais-accordion-header:hover::before {
            left: 100%;
        }

        /* Staggered animation for accordion content */
        .tou-frais-accordion-content[style*="block"] .tou-input-group {
            animation: slideInStagger 0.4s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .tou-frais-accordion-content[style*="block"] .tou-input-group:nth-child(1) {
            animation-delay: 0.1s;
        }

        .tou-frais-accordion-content[style*="block"] .tou-input-group:nth-child(2) {
            animation-delay: 0.2s;
        }

        .tou-frais-accordion-content[style*="block"] .tou-input-group:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes slideInStagger {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced badge animations */
        .tou-frais-summary-badge {
            position: relative;
            overflow: hidden;
        }

        .tou-frais-summary-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .tou-frais-summary-badge.has-values::before {
            left: 100%;
        }

        /* Refined grid spacing */
        .tou-frais-accordion .grid.grid-cols-1.md\\:grid-cols-2 {
            gap: 2rem;
        }

        .tou-frais-accordion .grid.grid-cols-1.md\\:grid-cols-3 {
            gap: 1.75rem;
        }

        /* Enhanced button group styling */
        .tou-frais-controls {
            background: rgba(255, 255, 255, 0.8);
            padding: 0.5rem;
            border-radius: 12px;
            border: 1px solid rgba(225, 231, 239, 0.6);
            backdrop-filter: blur(10px);
        }

        /* Improved responsive behavior */
        @media (max-width: 640px) {
            .tou-frais-accordion {
                border-radius: 12px;
                margin-bottom: 1rem;
            }

            .tou-frais-accordion-header {
                padding: 1rem;
                font-size: 0.875rem;
            }

            .tou-frais-accordion-content {
                padding: 1.25rem 1rem;
            }

            .tou-frais-progress-bar {
                padding: 1rem;
                border-radius: 12px;
            }

            .tou-frais-progress-circle {
                width: 2.25rem;
                height: 2.25rem;
                font-size: 0.75rem;
            }

            .tou-frais-summary-badge {
                min-width: 60px;
                font-size: 0.6875rem;
                padding: 0.25rem 0.5rem;
            }

            .tou-frais-control-btn {
                padding: 0.5rem 0.875rem;
                font-size: 0.8125rem;
            }

            .tou-frais-accordion .grid {
                gap: 1.25rem;
            }
        }

        /* Print styles */
        @media print {
            .tou-frais-accordion {
                box-shadow: none;
                border: 1px solid #000;
                break-inside: avoid;
            }

            .tou-frais-accordion-header {
                background: #f5f5f5 !important;
                color: #000 !important;
            }

            .tou-frais-controls {
                display: none;
            }

            .tou-frais-accordion-content {
                display: block !important;
            }
        }

        .tou-simulator-wrapper .tou-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
            margin-top: 2rem;
        }

        .tou-simulator-wrapper .tou-nav-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .tou-simulator-wrapper .tou-nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tou-simulator-wrapper .tou-nav-button-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .tou-simulator-wrapper .tou-nav-button-secondary:hover:not(:disabled) {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .tou-simulator-wrapper .tou-nav-button-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .tou-simulator-wrapper .tou-nav-button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .tou-simulator-wrapper .tou-nav-button-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .tou-simulator-wrapper .tou-nav-button-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        /* Responsive Design for Multi-Step Form */
        @media (max-width: 768px) {
            .tou-simulator-wrapper .tou-progress-container {
                padding: 1rem 1.5rem 0 1.5rem;
            }

            .tou-simulator-wrapper .tou-step-content {
                padding: 1.5rem;
            }

            .tou-simulator-wrapper .tou-form-group-title {
                font-size: 1.125rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .tou-simulator-wrapper .tou-navigation {
                flex-direction: column;
                gap: 1rem;
            }

            .tou-simulator-wrapper .tou-navigation > div {
                display: flex;
                gap: 0.75rem;
                width: 100%;
            }

            .tou-simulator-wrapper .tou-nav-button {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .tou-simulator-wrapper .tou-progress-container {
                padding: 0.75rem 1rem 0 1rem;
            }

            .tou-simulator-wrapper .tou-step-content {
                padding: 1rem;
            }

            .tou-simulator-wrapper .tou-progress-text {
                font-size: 0.75rem;
            }

            /* Mobile dropdown enhancements */
            .tou-simulator-wrapper select.tou-input-focus {
                padding: 16px 48px 16px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                background-size: 24px;
                background-position: right 16px center;
            }

            .tou-simulator-wrapper select.tou-input-focus option {
                padding: 16px;
                font-size: 16px;
            }
        }



        .tou-simulator-wrapper .tou-currency-container {
            position: relative;
        }

        .tou-simulator-wrapper .tou-currency-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .tou-simulator-wrapper .tou-conversion-display {
            margin-top: 4px;
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* Quasi-Resident Simulator Multi-Step Styles */
        .qr-simulator-wrapper {
            position: relative;
        }

        .qr-simulator-wrapper .qr-step-container {
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .qr-simulator-wrapper .qr-progress-container {
            padding: 1.5rem 2.5rem 0 2.5rem;
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .qr-simulator-wrapper .qr-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .qr-simulator-wrapper .qr-progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .qr-simulator-wrapper .qr-progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: white;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .qr-simulator-wrapper .qr-step-content {
            padding: 2.5rem;
            background: white;
        }

        .qr-simulator-wrapper .qr-form-step {
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .qr-simulator-wrapper .qr-form-step.active {
            display: block;
            animation: qrStepFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes qrStepFadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .qr-simulator-wrapper .qr-form-group {
            margin-bottom: 2rem;
        }

        .qr-simulator-wrapper .qr-form-group-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #10b981;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .qr-simulator-wrapper .qr-form-group-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 0.875rem;
        }

        .qr-simulator-wrapper .qr-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
            margin-top: 2rem;
        }

        .qr-simulator-wrapper .qr-nav-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .qr-simulator-wrapper .qr-nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .qr-simulator-wrapper .qr-nav-button-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .qr-simulator-wrapper .qr-nav-button-secondary:hover:not(:disabled) {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .qr-simulator-wrapper .qr-nav-button-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .qr-simulator-wrapper .qr-nav-button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        /* Responsive Design for Quasi-Resident Multi-Step Form */
        @media (max-width: 768px) {
            .qr-simulator-wrapper .qr-progress-container {
                padding: 1rem 1.5rem 0 1.5rem;
            }

            .qr-simulator-wrapper .qr-step-content {
                padding: 1.5rem;
            }

            .qr-simulator-wrapper .qr-form-group-title {
                font-size: 1.125rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .qr-simulator-wrapper .qr-navigation {
                flex-direction: column;
                gap: 1rem;
            }

            .qr-simulator-wrapper .qr-navigation > div {
                display: flex;
                gap: 0.75rem;
                width: 100%;
            }

            .qr-simulator-wrapper .qr-nav-button {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .qr-simulator-wrapper .qr-progress-container {
                padding: 0.75rem 1rem 0 1rem;
            }

            .qr-simulator-wrapper .qr-step-content {
                padding: 1rem;
            }

            .qr-simulator-wrapper .qr-progress-text {
                font-size: 0.75rem;
            }
        }

        .tou-simulator-wrapper .tou-tax-details {
            margin-top: 12px;
            padding: 12px;
            background-color: #f8fafc;
            border-radius: 6px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="flex h-screen bg-[var(--color-background-secondary)]">
        <!-- Barre de navigation latérale -->
        <aside class="sidebar-container w-72 flex-shrink-0 bg-[var(--color-background)] relative">
            <div class="flex h-full flex-col relative z-10">
                <div class="p-8 border-b border-[var(--color-border-light)] bg-gradient-to-r from-[var(--color-background)] to-[var(--color-background-secondary)]">
                    <h1 class="font-display text-2xl font-semibold text-[var(--color-primary)] mb-1 transition-colors duration-300">MyFrontaliers</h1>
                    <p class="text-sm text-[var(--color-text-muted)] font-medium">Cabinet Expert Comptable</p>
                    <div class="mt-4 h-1 w-16 bg-gradient-to-r from-[var(--color-accent)] to-[var(--color-secondary)] rounded-full"></div>
                </div>
                <nav class="flex-1 p-6 bg-[var(--color-background)]">
                    <div class="space-y-2">
                        <a class="sidebar-nav-item tab-button active" data-tab="cabinet">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
                            </svg>
                            <span>Cabinet</span>
                        </a>
                        <a class="sidebar-nav-item tab-button" data-tab="fiscalite">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
                            </svg>
                            <span>Fiscalité</span>
                        </a>
                        <a class="sidebar-nav-item tab-button" data-tab="social">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
                            </svg>
                            <span>Social</span>
                        </a>
                        <a class="sidebar-nav-item tab-button" data-tab="depot">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
                            </svg>
                            <span>Dépôt de Documents</span>
                        </a>
                        <a class="sidebar-nav-item tab-button" data-tab="actualites">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m-4 3h2M5 10h2a1 1 0 011 1v1a1 1 0 01-1 1H5a1 1 0 01-1-1v-1a1 1 0 011-1z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
                            </svg>
                            <span>Actualités</span>
                        </a>
                        <a class="sidebar-nav-item tab-button" data-tab="faq">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 1.976-1.724 3.5-3.772 3.5-1.742 0-3.223-.835-3.772-2M12 18.5v.01M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
                            </svg>
                            <span>FAQ</span>
                        </a>
                    </div>
                </nav>
            </div>
        </aside>

        <!-- Contenu principal -->
        <main class="main-content-area flex-1 overflow-y-auto bg-[var(--color-background-secondary)]">
            <!-- Onglet Cabinet -->
            <div class="p-12 tab-content active" id="cabinet">
                <header class="section-header flex items-start justify-between">
                    <div>
                        <h1 class="section-title font-display">Tableau de Bord</h1>
                        <p class="section-subtitle">Vue d'ensemble de l'activité du cabinet</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="premium-button premium-button-primary">
                            <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path clip-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" fill-rule="evenodd"></path>
                            </svg>
                            Nouveau Client
                        </button>
                        <button class="premium-button premium-button-secondary">
                            <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.5a.75.75 0 001.5 0v-8.5z"></path>
                                <path clip-rule="evenodd" d="M3.25 2a.75.75 0 000 1.5h13.5a.75.75 0 000-1.5H3.25zM2.5 13.5A.5.5 0 013 13h14a.5.5 0 01.5.5v1a.5.5 0 01-.5.5H3a.5.5 0 01-.5-.5v-1z" fill-rule="evenodd"></path>
                            </svg>
                            Lettre de Mission
                        </button>
                    </div>
                </header>
                <section class="premium-card p-8 mb-8">
                    <div class="mb-8 flex flex-wrap items-center justify-between gap-6">
                        <div>
                            <h2 class="card-title">Suivi des Dossiers</h2>
                            <p class="card-subtitle">Gestion et suivi des missions clients</p>
                        </div>
                        <div class="flex gap-3">
                            <select class="premium-select text-sm min-w-[140px]">
                                <option>Collaborateur</option>
                                <option>Marie Dubois</option>
                                <option>Pierre Martin</option>
                                <option>Sophie Leclerc</option>
                            </select>
                            <select class="premium-select text-sm min-w-[120px]">
                                <option>Canton</option>
                                <option>Genève</option>
                                <option>Vaud</option>
                            </select>
                            <select class="premium-select text-sm min-w-[120px]">
                                <option>Statut</option>
                                <option>À faire</option>
                                <option>En cours</option>
                                <option>En attente client</option>
                                <option>Terminé</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Mission</th>
                                    <th>Canton</th>
                                    <th>Assigné</th>
                                    <th>Statut</th>
                                    <th>Rentabilité</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="font-semibold text-[var(--color-text-primary)]">Client A</td>
                                    <td class="text-[var(--color-text-secondary)]">Déclaration Fiscale 2024</td>
                                    <td class="text-[var(--color-text-secondary)]">Genève</td>
                                    <td class="text-[var(--color-text-secondary)]">Marie Dubois</td>
                                    <td><span class="status-badge status-todo">À faire</span></td>
                                    <td class="text-[var(--color-text-secondary)]">
                                        <div class="flex items-center gap-3">
                                            <div class="progress-bar w-20">
                                                <div class="progress-value bg-[var(--status-todo)]" style="width: 15%"></div>
                                            </div>
                                            <span class="text-sm font-medium">15%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold text-[var(--color-text-primary)]">Client B</td>
                                    <td class="text-[var(--color-text-secondary)]">Conseil Fiscal</td>
                                    <td class="text-[var(--color-text-secondary)]">Vaud</td>
                                    <td class="text-[var(--color-text-secondary)]">Pierre Martin</td>
                                    <td><span class="status-badge status-inprogress">En cours</span></td>
                                    <td class="text-[var(--color-text-secondary)]">
                                        <div class="flex items-center gap-3">
                                            <div class="progress-bar w-20">
                                                <div class="progress-value bg-[var(--status-inprogress)]" style="width: 22%"></div>
                                            </div>
                                            <span class="text-sm font-medium">22%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold text-[var(--color-text-primary)]">Client C</td>
                                    <td class="text-[var(--color-text-secondary)]">Optimisation Fiscale</td>
                                    <td class="text-[var(--color-text-secondary)]">Vaud</td>
                                    <td class="text-[var(--color-text-secondary)]">Sophie Leclerc</td>
                                    <td><span class="status-badge status-waiting">En attente Client</span></td>
                                    <td class="text-[var(--color-text-secondary)]">
                                        <div class="flex items-center gap-3">
                                            <div class="progress-bar w-20">
                                                <div class="progress-value bg-[var(--status-waiting)]" style="width: 10%"></div>
                                            </div>
                                            <span class="text-sm font-medium">10%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold text-[var(--color-text-primary)]">Client D</td>
                                    <td class="text-[var(--color-text-secondary)]">Déclaration Fiscale 2024</td>
                                    <td class="text-[var(--color-text-secondary)]">Genève</td>
                                    <td class="text-[var(--color-text-secondary)]">Marie Dubois</td>
                                    <td><span class="status-badge status-completed">Terminé</span></td>
                                    <td class="text-[var(--color-text-secondary)]">
                                        <div class="flex items-center gap-3">
                                            <div class="progress-bar w-20">
                                                <div class="progress-value bg-[var(--status-completed)]" style="width: 28%"></div>
                                            </div>
                                            <span class="text-sm font-medium">28%</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="premium-card p-8">
                    <div class="mb-6">
                        <h2 class="card-title">Formations à Venir</h2>
                        <p class="card-subtitle">Développement professionnel continu</p>
                    </div>
                    <div class="relative overflow-hidden rounded-xl bg-gradient-to-br from-[var(--color-primary)] via-[var(--color-secondary)] to-[var(--color-accent)] p-8 text-white">
                        <div class="relative z-10 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium uppercase tracking-wider opacity-90 mb-2">Prochain module</p>
                                <p class="text-2xl font-semibold mb-1">Optimisation fiscale transfrontalière</p>
                                <p class="text-sm opacity-80">Formation certifiante - 16 heures</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium uppercase tracking-wider opacity-90 mb-2">Date limite</p>
                                <p class="text-2xl font-semibold">30/09/2025</p>
                            </div>
                        </div>
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full transform translate-x-16 -translate-y-16"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white opacity-5 rounded-full transform -translate-x-12 translate-y-12"></div>
                    </div>
                </section>
            </div>

            <!-- Onglet Fiscalité -->
            <div class="p-12 tab-content" id="fiscalite">
                <!-- Fiscal Tools Overview -->
                <div id="fiscal-overview">
                    <header class="section-header">
                        <h1 class="section-title font-display">Outils Fiscaux</h1>
                        <p class="section-subtitle">Simulateurs et outils d'optimisation fiscale pour frontaliers</p>
                    </header>

                    <!-- Fiscal Tools Cards Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                        <!-- TOU vs Retenue à la Source Card -->
                        <div class="fiscal-tool-card premium-card p-8 cursor-pointer transition-all duration-300 hover:shadow-xl hover:scale-105" onclick="showTouSimulator()">
                            <div class="fiscal-card-header mb-6">
                                <div class="fiscal-card-icon mb-4">
                                    <i class="fas fa-balance-scale text-4xl text-blue-600"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">TOU vs Retenue à la Source</h3>
                                <p class="text-gray-600 text-sm">Simulateur de comparaison fiscale</p>
                            </div>

                            <div class="fiscal-card-content mb-6">
                                <p class="text-gray-700 text-sm leading-relaxed mb-4">
                                    Comparez votre impôt avec la Retenue à la Source et la Taxation Ordinaire Unique (TOU) pour optimiser votre situation fiscale.
                                </p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Calcul précis basé sur les barèmes officiels</li>
                                    <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Prise en compte des déductions</li>
                                    <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Recommandation personnalisée</li>
                                </ul>
                            </div>

                            <div class="fiscal-card-footer">
                                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-calculator mr-2"></i>
                                    Accéder au simulateur
                                </button>
                            </div>
                        </div>

                        <!-- Quasi-Resident Status Card -->
                        <div class="fiscal-tool-card premium-card p-8 cursor-pointer transition-all duration-300 hover:shadow-xl hover:scale-105" onclick="showQuasiResidentSimulator()">
                            <div class="fiscal-card-header mb-6">
                                <div class="fiscal-card-icon mb-4">
                                    <i class="fas fa-user-check text-4xl text-green-600"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Statut Quasi-Résident</h3>
                                <p class="text-gray-600 text-sm">Vérification d'éligibilité</p>
                            </div>

                            <div class="fiscal-card-content mb-6">
                                <p class="text-gray-700 text-sm leading-relaxed mb-4">
                                    Vérifiez si vous êtes éligible au statut de quasi-résident et découvrez les avantages fiscaux associés.
                                </p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Test d'éligibilité automatique</li>
                                    <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Calcul du seuil des 90%</li>
                                    <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Conseils personnalisés</li>
                                </ul>
                            </div>

                            <div class="fiscal-card-footer">
                                <button class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-user-check mr-2"></i>
                                    Vérifier mon éligibilité
                                </button>
                            </div>
                        </div>

                        <!-- Tax Declaration Assistant Card -->
                        <div class="fiscal-tool-card premium-card p-8 opacity-75 cursor-not-allowed">
                            <div class="fiscal-card-header mb-6">
                                <div class="fiscal-card-icon mb-4">
                                    <i class="fas fa-file-invoice text-4xl text-purple-600"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Assistant Déclaration</h3>
                                <p class="text-gray-600 text-sm">Aide à la déclaration fiscale</p>
                            </div>

                            <div class="fiscal-card-content mb-6">
                                <p class="text-gray-700 text-sm leading-relaxed mb-4">
                                    Assistant intelligent pour vous guider dans votre déclaration fiscale suisse et française.
                                </p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li class="flex items-center"><i class="fas fa-clock text-orange-500 mr-2"></i>Guide étape par étape</li>
                                    <li class="flex items-center"><i class="fas fa-clock text-orange-500 mr-2"></i>Vérification automatique</li>
                                    <li class="flex items-center"><i class="fas fa-clock text-orange-500 mr-2"></i>Export des documents</li>
                                </ul>
                            </div>

                            <div class="fiscal-card-footer">
                                <button class="w-full bg-gray-400 text-white font-medium py-3 px-4 rounded-lg cursor-not-allowed flex items-center justify-center">
                                    <i class="fas fa-clock mr-2"></i>
                                    Bientôt disponible
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-lg font-medium text-blue-800 mb-2">Expertise Fiscale Frontalière</h4>
                                <p class="text-blue-700 text-sm leading-relaxed">
                                    Nos outils fiscaux sont spécialement conçus pour les travailleurs frontaliers. Ils prennent en compte
                                    les spécificités de la fiscalité franco-suisse et vous aident à optimiser votre situation fiscale
                                    en toute conformité avec les réglementations en vigueur.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quasi-Resident Simulator (Hidden by default) -->
                <div id="quasi-resident-simulator" class="hidden">
                    <div class="flex items-center mb-6">
                        <button onclick="showFiscalOverview()" class="mr-4 text-gray-600 hover:text-gray-800 transition-colors">
                            <i class="fas fa-arrow-left text-xl"></i>
                        </button>
                        <div class="bg-green-100 p-2 rounded-full mr-4">
                            <i class="fas fa-user-check text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Vérification du Statut Quasi-Résident</h2>
                            <p class="text-gray-600">Vérifiez votre éligibilité au statut de quasi-résident</p>
                        </div>
                    </div>



                <!-- Simulation Form -->
                <section id="simulation-form" class="mb-8 fade-in">
                    <!-- Multi-Step Form Container -->
                    <div id="qr-simulator-container" class="qr-simulator-wrapper">
                        <div class="qr-step-container">
                            <!-- Progress Bar -->
                            <div class="qr-progress-container">
                                <div class="qr-progress-bar">
                                    <div class="qr-progress-fill" id="qrProgressFill" style="width: 25%"></div>
                                </div>
                                <div class="qr-progress-text">
                                    <span id="qrProgressText">Étape 1 sur 4</span>
                                    <span id="qrProgressPercent">25%</span>
                                </div>
                            </div>

                            <!-- Step Content -->
                            <div class="qr-step-content">

                                <form id="eligibility-form">
                                    <!-- Step 1: Personal Situation -->
                                    <div class="qr-form-step active" id="qrStep1">
                                        <div class="qr-form-group">
                                            <div class="qr-form-group-title">
                                                <div class="qr-form-group-icon">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                Votre situation familiale
                                            </div>
                                            <p class="text-gray-600 mb-6">Le statut familial détermine si les revenus de votre conjoint doivent être pris en compte dans le calcul</p>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label for="family-status" class="block text-sm font-medium text-gray-700 mb-2">Situation familiale <span class="text-red-500">*</span></label>
                                                    <select id="family-status" name="family-status" class="input-highlight mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-lg border" onchange="qrToggleSpouseIncome()">
                                                        <option value="">Sélectionnez votre situation</option>
                                                        <option value="single">Célibataire</option>
                                                        <option value="married">Marié/Pacsé</option>
                                                        <option value="divorced">Divorcé/Séparé</option>
                                                        <option value="widowed">Veuf/Veuve</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Navigation -->
                                        <div class="qr-navigation">
                                            <div></div> <!-- Empty div for spacing -->
                                            <div>
                                                <button type="button" class="qr-nav-button qr-nav-button-primary" onclick="qrNextStep()">
                                                    Suivant
                                                    <i class="fas fa-arrow-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 2: Swiss Income -->
                                    <div class="qr-form-step" id="qrStep2">
                                        <div class="qr-form-group">
                                            <div class="qr-form-group-title">
                                                <div class="qr-form-group-icon">
                                                    <i class="fas fa-coins"></i>
                                                </div>
                                                Vos revenus imposables en Suisse
                                            </div>
                                            <p class="text-gray-600 mb-6">Inclure tous les revenus soumis à l'impôt à la source en Suisse (salaires, primes, bonus)</p>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div>
                                                    <label for="income-dependent" class="block text-sm font-medium text-gray-700 mb-2">
                                                        <i class="fas fa-exchange-alt currency-icon mr-2"></i>Revenu brut de l'activité dépendante
                                                        <div class="tooltip ml-1 relative inline-block">
                                                            <i class="fas fa-question-circle text-gray-400 hover:text-gray-600"></i>
                                                            <div class="tooltip-text absolute z-10 w-64 bg-gray-800 text-white text-xs rounded p-2 -left-32 -top-12">
                                                                Salaires, traitements et autres revenus d'une activité salariée en Suisse
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <div class="currency-input-container">
                                                        <div class="mt-1 relative rounded-md shadow-sm">
                                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                <span id="income-dependent-currency-label" class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                            <input type="number" id="income-dependent" name="income-dependent" class="input-highlight focus:ring-green-500 focus:border-green-500 block w-full pl-12 pr-16 sm:text-sm border-gray-300 rounded-lg py-3 border" placeholder="120000" oninput="updateCurrencyConversion('income-dependent')">
                                                            <button type="button" class="currency-toggle" id="income-dependent-toggle" onclick="toggleCurrency('income-dependent')">CHF</button>
                                                        </div>
                                                        <div id="income-dependent-converted" class="currency-converted"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label for="income-independent" class="block text-sm font-medium text-gray-700 mb-2">
                                                        <i class="fas fa-exchange-alt currency-icon mr-2"></i>Bénéfice net de l'activité indépendante
                                                        <div class="tooltip ml-1 relative inline-block">
                                                            <i class="fas fa-question-circle text-gray-400 hover:text-gray-600"></i>
                                                            <div class="tooltip-text absolute z-10 w-64 bg-gray-800 text-white text-xs rounded p-2 -left-32 -top-12">
                                                                Bénéfices nets d'une activité indépendante, profession libérale ou entreprise individuelle en Suisse
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <div class="currency-input-container">
                                                        <div class="mt-1 relative rounded-md shadow-sm">
                                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                <span id="income-independent-currency-label" class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                            <input type="number" id="income-independent" name="income-independent" class="input-highlight focus:ring-green-500 focus:border-green-500 block w-full pl-12 pr-16 sm:text-sm border-gray-300 rounded-lg py-3 border" placeholder="0" oninput="updateCurrencyConversion('income-independent')">
                                                            <button type="button" class="currency-toggle" id="income-independent-toggle" onclick="toggleCurrency('income-independent')">CHF</button>
                                                        </div>
                                                        <div id="income-independent-converted" class="currency-converted"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                                <div id="spouse-income-container" class="hidden">
                                                    <label for="income-spouse" class="block text-sm font-medium text-gray-700 mb-2">
                                                        <i class="fas fa-exchange-alt currency-icon mr-2"></i>Revenus bruts annuels de votre conjoint
                                                    </label>
                                                    <div class="currency-input-container">
                                                        <div class="mt-1 relative rounded-md shadow-sm">
                                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                <span id="income-spouse-currency-label" class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                            <input type="number" id="income-spouse" name="income-spouse" class="input-highlight focus:ring-green-500 focus:border-green-500 block w-full pl-12 pr-16 sm:text-sm border-gray-300 rounded-lg py-3 border" placeholder="0" oninput="updateCurrencyConversion('income-spouse')">
                                                            <button type="button" class="currency-toggle" id="income-spouse-toggle" onclick="toggleCurrency('income-spouse')">CHF</button>
                                                        </div>
                                                        <div id="income-spouse-converted" class="currency-converted"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Navigation -->
                                        <div class="qr-navigation">
                                            <div>
                                                <button type="button" class="qr-nav-button qr-nav-button-secondary" onclick="qrPrevStep()">
                                                    <i class="fas fa-arrow-left"></i>
                                                    Précédent
                                                </button>
                                            </div>
                                            <div>
                                                <button type="button" class="qr-nav-button qr-nav-button-primary" onclick="qrNextStep()">
                                                    Suivant
                                                    <i class="fas fa-arrow-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 3: World Income -->
                                    <div class="qr-form-step" id="qrStep3">
                                        <div class="qr-form-group">
                                            <div class="qr-form-group-title">
                                                <div class="qr-form-group-icon">
                                                    <i class="fas fa-globe"></i>
                                                </div>
                                                Vos autres revenus mondiaux
                                            </div>
                                            <p class="text-gray-600 mb-4">Tous revenus perçus hors de Suisse (salaires étrangers, dividendes, intérêts, pensions, etc.)</p>
                                            <div class="bg-green-50 p-4 rounded-lg mb-6">
                                                <p class="text-sm text-green-800 flex items-start">
                                                    <i class="fas fa-info-circle mr-2 mt-1 flex-shrink-0"></i>
                                                    <span>Incluez tous les revenus bruts de votre foyer (salaires, rentes, revenus locatifs, etc.), où qu'ils soient perçus.</span>
                                                </p>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div>
                                                    <label for="income-foreign" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                                        <i class="fas fa-exchange-alt currency-icon mr-2"></i>Revenus hors Suisse <span class="text-gray-500 font-normal ml-1">(salaires, pensions, etc.)</span>
                                                        <div class="tooltip ml-1 relative">
                                                            <i class="fas fa-question-circle text-gray-400 hover:text-gray-600"></i>
                                                            <div class="tooltip-text absolute z-10 w-64 bg-gray-800 text-white text-xs rounded p-2 -left-32 -top-12">
                                                                Revenus perçus dans d'autres pays que la Suisse, même s'ils sont imposés localement
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <div class="currency-input-container">
                                                        <div class="mt-1 relative rounded-md shadow-sm">
                                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                <span id="income-foreign-currency-label" class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                            <input type="number" id="income-foreign" name="income-foreign" class="input-highlight focus:ring-green-500 focus:border-green-500 block w-full pl-12 pr-16 sm:text-sm border-gray-300 rounded-lg py-3 border" placeholder="0" oninput="updateCurrencyConversion('income-foreign')">
                                                            <button type="button" class="currency-toggle" id="income-foreign-toggle" onclick="toggleCurrency('income-foreign')">CHF</button>
                                                        </div>
                                                        <div id="income-foreign-converted" class="currency-converted"></div>
                                                    </div>
                                                                </div>
                                                <div>
                                                    <label for="rental-primary" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                                        <i class="fas fa-exchange-alt currency-icon mr-2"></i>Valeur locative résidence principale
                                                        <div class="tooltip ml-1 relative">
                                                            <i class="fas fa-question-circle text-gray-400 hover:text-gray-600"></i>
                                                            <div class="tooltip-text absolute z-10 w-64 bg-gray-800 text-white text-xs rounded p-2 -left-32 -top-12">
                                                                Estimation annuelle de la valeur locative si vous êtes propriétaire de votre résidence principale
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <div class="currency-input-container">
                                                        <div class="mt-1 relative rounded-md shadow-sm">
                                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                <span id="rental-primary-currency-label" class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                            <input type="number" id="rental-primary" name="rental-primary" class="input-highlight focus:ring-green-500 focus:border-green-500 block w-full pl-12 pr-16 sm:text-sm border-gray-300 rounded-lg py-3 border" placeholder="0" oninput="updateCurrencyConversion('rental-primary')">
                                                            <button type="button" class="currency-toggle" id="rental-primary-toggle" onclick="toggleCurrency('rental-primary')">CHF</button>
                                                        </div>
                                                        <div id="rental-primary-converted" class="currency-converted"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                                <div>
                                                    <label for="rental-secondary" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                                        <i class="fas fa-exchange-alt currency-icon mr-2"></i>Valeur locative résidence secondaire
                                                    </label>
                                                    <div class="currency-input-container">
                                                        <div class="mt-1 relative rounded-md shadow-sm">
                                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                <span id="rental-secondary-currency-label" class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                            <input type="number" id="rental-secondary" name="rental-secondary" class="input-highlight focus:ring-green-500 focus:border-green-500 block w-full pl-12 pr-16 sm:text-sm border-gray-300 rounded-lg py-3 border" placeholder="0" oninput="updateCurrencyConversion('rental-secondary')">
                                                            <button type="button" class="currency-toggle" id="rental-secondary-toggle" onclick="toggleCurrency('rental-secondary')">CHF</button>
                                                        </div>
                                                        <div id="rental-secondary-converted" class="currency-converted"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label for="income-lmnp" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                                        <i class="fas fa-exchange-alt currency-icon mr-2"></i>Revenus LMNP
                                                    </label>
                                                    <div class="currency-input-container">
                                                        <div class="mt-1 relative rounded-md shadow-sm">
                                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                <span id="income-lmnp-currency-label" class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                            <input type="number" id="income-lmnp" name="income-lmnp" class="input-highlight focus:ring-green-500 focus:border-green-500 block w-full pl-12 pr-16 sm:text-sm border-gray-300 rounded-lg py-3 border" placeholder="0" oninput="updateCurrencyConversion('income-lmnp')">
                                                            <button type="button" class="currency-toggle" id="income-lmnp-toggle" onclick="toggleCurrency('income-lmnp')">CHF</button>
                                                        </div>
                                                        <div id="income-lmnp-converted" class="currency-converted"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                                <div>
                                                    <label for="income-other" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                                        <i class="fas fa-exchange-alt currency-icon mr-2"></i>Autres revenus <span class="text-gray-500 font-normal ml-1">(allocations, retraite, etc.)</span>
                                                    </label>
                                                    <div class="currency-input-container">
                                                        <div class="mt-1 relative rounded-md shadow-sm">
                                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                <span id="income-other-currency-label" class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                            <input type="number" id="income-other" name="income-other" class="input-highlight focus:ring-green-500 focus:border-green-500 block w-full pl-12 pr-16 sm:text-sm border-gray-300 rounded-lg py-3 border" placeholder="0" oninput="updateCurrencyConversion('income-other')">
                                                            <button type="button" class="currency-toggle" id="income-other-toggle" onclick="toggleCurrency('income-other')">CHF</button>
                                                        </div>
                                                        <div id="income-other-converted" class="currency-converted"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Navigation -->
                                        <div class="qr-navigation">
                                            <div>
                                                <button type="button" class="qr-nav-button qr-nav-button-secondary" onclick="qrPrevStep()">
                                                    <i class="fas fa-arrow-left"></i>
                                                    Précédent
                                                </button>
                                            </div>
                                            <div>
                                                <button type="button" class="qr-nav-button qr-nav-button-primary" onclick="qrCalculateEligibility()">
                                                    <i class="fas fa-calculator"></i>
                                                    Calculer
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 4: Results -->
                                    <div class="qr-form-step" id="qrStep4">
                                        <div class="qr-form-group">
                                            <div class="qr-form-group-title">
                                                <div class="qr-form-group-icon">
                                                    <i class="fas fa-chart-line"></i>
                                                </div>
                                                Résultats de votre éligibilité
                                            </div>

                                            <!-- Results will be populated here by JavaScript -->
                                            <div id="qr-results-container">
                                                <div class="qr-loading-container">
                                                    <div class="qr-loading-spinner"></div>
                                                    <h4 class="text-xl font-semibold text-gray-800 mb-2">Calcul en cours...</h4>
                                                    <p class="text-gray-600">Analyse de votre situation fiscale</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Navigation -->
                                        <div class="qr-navigation">
                                            <div>
                                                <button type="button" class="qr-nav-button qr-nav-button-secondary" onclick="qrPrevStep()">
                                                    <i class="fas fa-arrow-left"></i>
                                                    Précédent
                                                </button>
                                            </div>
                                            <div>
                                                <button type="button" class="qr-nav-button qr-nav-button-primary" onclick="qrNewSimulation()">
                                                    <i class="fas fa-redo"></i>
                                                    Nouvelle simulation
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Results Section - Eligible (Hidden by default) -->
                <section id="result-eligible" class="hidden qr-results-card eligible fade-in qr-particle-bg p-8 mb-8">
                    <!-- SVG Gradients Definition -->
                    <svg width="0" height="0" style="position: absolute;">
                        <defs>
                            <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="redGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>

                    <div class="flex flex-col items-center text-center mb-8">
                        <!-- Enhanced Status Badge -->
                        <div class="qr-status-badge eligible" role="status" aria-label="Résultat d'éligibilité">
                            <i class="qr-status-icon fas fa-check-circle" aria-hidden="true"></i>
                            <span>Éligible au statut de quasi-résident</span>
                        </div>

                        <h2 class="text-3xl font-bold qr-gradient-text mb-4 leading-tight">
                            Félicitations ! Vous remplissez les critères
                        </h2>

                        <!-- Enhanced Ratio Display -->
                        <div class="qr-ratio-display" role="img" aria-labelledby="ratio-description">
                            <div class="qr-ratio-circle eligible qr-glow-effect">
                                <svg viewBox="0 0 160 160" aria-hidden="true">
                                    <circle class="circle-bg" cx="80" cy="80" r="70"></circle>
                                    <circle class="circle-progress" cx="80" cy="80" r="70"
                                            stroke-dasharray="0 440"
                                            id="eligible-progress-circle"></circle>
                                </svg>
                                <div class="qr-ratio-percentage">
                                    <div class="qr-ratio-number qr-animated-counter" id="eligible-ratio-display" aria-live="polite">90</div>
                                    <div class="qr-ratio-label">Pourcentage</div>
                                </div>
                            </div>

                            <div class="qr-threshold-indicator eligible" role="status" aria-live="polite">
                                <i class="qr-threshold-icon fas fa-check-circle" aria-hidden="true"></i>
                                <span>Seuil de 90% atteint</span>
                            </div>
                            <div id="ratio-description" class="sr-only">Graphique circulaire montrant le pourcentage de revenus imposés en Suisse</div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8 mt-8">
                        <div class="qr-content-card success">
                            <div class="flex items-center mb-4">
                                <div class="flex items-center justify-center w-12 h-12 bg-green-100 rounded-xl mr-4">
                                    <i class="fas fa-star text-green-600 text-xl"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-green-800">Vos avantages potentiels</h3>
                            </div>
                            <ul class="space-y-3 text-green-700 qr-stagger-animation">
                                <li class="flex items-start group qr-micro-bounce">
                                    <div class="qr-status-indicator success">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <span class="leading-relaxed">Déduction du 3ème pilier (prévoyance privée)</span>
                                </li>
                                <li class="flex items-start group qr-micro-bounce">
                                    <div class="qr-status-indicator success">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <span class="leading-relaxed">Déduction des frais réels (frais professionnels)</span>
                                </li>
                                <li class="flex items-start group qr-micro-bounce">
                                    <div class="qr-status-indicator success">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <span class="leading-relaxed">Imposition sur le revenu net après déductions</span>
                                </li>
                                <li class="flex items-start group qr-micro-bounce">
                                    <div class="qr-status-indicator success">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <span class="leading-relaxed">Accès à des taux d'imposition plus avantageux</span>
                                </li>
                            </ul>
                        </div>

                        <div class="qr-content-card info">
                            <div class="flex items-center mb-4">
                                <div class="flex items-center justify-center w-12 h-12 bg-blue-100 rounded-xl mr-4">
                                    <i class="fas fa-arrow-right text-blue-600 text-xl"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-blue-800">Prochaines étapes</h3>
                            </div>
                            <div class="space-y-4">
                                <p class="text-blue-700 leading-relaxed">
                                    Bien que ce simulateur indique une éligibilité potentielle, nous vous recommandons fortement de consulter un expert fiscal pour :
                                </p>
                                <ul class="space-y-3 text-blue-700">
                                    <li class="flex items-start group">
                                        <div class="flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full mr-3 mt-0.5 group-hover:bg-blue-200 transition-colors">
                                            <i class="fas fa-check text-blue-600 text-xs"></i>
                                        </div>
                                        <span class="leading-relaxed">Valider précisément votre situation</span>
                                    </li>
                                    <li class="flex items-start group">
                                        <div class="flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full mr-3 mt-0.5 group-hover:bg-blue-200 transition-colors">
                                            <i class="fas fa-check text-blue-600 text-xs"></i>
                                        </div>
                                        <span class="leading-relaxed">Optimiser votre déclaration fiscale</span>
                                    </li>
                                    <li class="flex items-start group">
                                        <div class="flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full mr-3 mt-0.5 group-hover:bg-blue-200 transition-colors">
                                            <i class="fas fa-check text-blue-600 text-xs"></i>
                                        </div>
                                        <span class="leading-relaxed">Effectuer la demande auprès des autorités</span>
                                    </li>
                                </ul>
                                <div class="qr-content-card warning mt-4">
                                    <div class="flex items-start">
                                        <div class="flex items-center justify-center w-8 h-8 bg-yellow-100 rounded-lg mr-3 flex-shrink-0">
                                            <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm text-yellow-700 leading-relaxed">
                                                <span class="font-semibold">Important :</span> Le choix du statut de quasi-résident est irrévocable pour l'année concernée. Une analyse approfondie est essentielle.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 text-center border-t border-gray-200 pt-6">
                        <button onclick="newSimulation()" class="qr-enhanced-button secondary"
                                aria-label="Recommencer la simulation avec de nouvelles données">
                            <i class="fas fa-redo" aria-hidden="true"></i>
                            <span>Effectuer une nouvelle simulation</span>
                        </button>
                    </div>
                </section>

                <!-- Results Section - Not Eligible (Hidden by default) -->
                <section id="result-not-eligible" class="hidden qr-results-card not-eligible fade-in qr-particle-bg p-8 mb-8">
                    <div class="flex flex-col items-center text-center mb-8">
                        <!-- Enhanced Status Badge -->
                        <div class="qr-status-badge not-eligible" role="status" aria-label="Résultat d'éligibilité">
                            <i class="qr-status-icon fas fa-times-circle" aria-hidden="true"></i>
                            <span>Non éligible au statut de quasi-résident</span>
                        </div>

                        <h2 class="text-3xl font-bold qr-gradient-text mb-4 leading-tight">
                            Critères non remplis pour cette année
                        </h2>

                        <!-- Enhanced Ratio Display -->
                        <div class="qr-ratio-display">
                            <div class="qr-ratio-circle not-eligible qr-glow-effect">
                                <svg viewBox="0 0 160 160">
                                    <circle class="circle-bg" cx="80" cy="80" r="70"></circle>
                                    <circle class="circle-progress" cx="80" cy="80" r="70"
                                            stroke-dasharray="0 440"
                                            id="not-eligible-progress-circle"></circle>
                                </svg>
                                <div class="qr-ratio-percentage">
                                    <div class="qr-ratio-number qr-animated-counter" id="not-eligible-ratio-display">75</div>
                                    <div class="qr-ratio-label">Pourcentage</div>
                                </div>
                            </div>

                            <div class="qr-threshold-indicator not-eligible">
                                <i class="qr-threshold-icon fas fa-times-circle"></i>
                                <span>Seuil de 90% non atteint</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8 mt-8">
                        <div class="qr-content-card error">
                            <div class="flex items-center mb-4">
                                <div class="flex items-center justify-center w-12 h-12 bg-red-100 rounded-xl mr-4">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-red-800">Principales raisons</h3>
                            </div>
                            <ul class="space-y-3 text-red-700">
                                <li class="flex items-start group">
                                    <div class="flex items-center justify-center w-6 h-6 bg-red-100 rounded-full mr-3 mt-0.5 group-hover:bg-red-200 transition-colors">
                                        <i class="fas fa-times text-red-600 text-xs"></i>
                                    </div>
                                    <span class="leading-relaxed">Vos revenus hors Suisse sont trop importants par rapport à vos revenus suisses</span>
                                </li>
                                <li class="flex items-start group">
                                    <div class="flex items-center justify-center w-6 h-6 bg-red-100 rounded-full mr-3 mt-0.5 group-hover:bg-red-200 transition-colors">
                                        <i class="fas fa-times text-red-600 text-xs"></i>
                                    </div>
                                    <span class="leading-relaxed">La valeur locative de vos biens immobiliers réduit votre ratio</span>
                                </li>
                                <li class="flex items-start group">
                                    <div class="flex items-center justify-center w-6 h-6 bg-red-100 rounded-full mr-3 mt-0.5 group-hover:bg-red-200 transition-colors">
                                        <i class="fas fa-times text-red-600 text-xs"></i>
                                    </div>
                                    <span class="leading-relaxed">Si vous êtes marié, les revenus de votre conjoint hors Suisse sont pris en compte</span>
                                </li>
                            </ul>
                            <div class="qr-content-card info mt-4">
                                <div class="flex items-start">
                                    <div class="flex items-center justify-center w-8 h-8 bg-blue-100 rounded-lg mr-3 flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-blue-700 leading-relaxed">
                                            <span class="font-semibold">Note :</span> Ce statut est réévalué chaque année. Une modification de votre situation (augmentation de salaire en Suisse, diminution des revenus étrangers) pourrait changer votre éligibilité.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="qr-content-card info">
                            <div class="flex items-center mb-4">
                                <div class="flex items-center justify-center w-12 h-12 bg-blue-100 rounded-xl mr-4">
                                    <i class="fas fa-lightbulb text-blue-600 text-xl"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-blue-800">Que faire ?</h3>
                            </div>
                            <div class="space-y-4">
                                <p class="text-blue-700 leading-relaxed">
                                    Bien que non éligible selon ce calcul, un expert fiscal pourrait vous aider à :
                                </p>
                                <ul class="space-y-3 text-blue-700">
                                    <li class="flex items-start group">
                                        <div class="flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full mr-3 mt-0.5 group-hover:bg-blue-200 transition-colors">
                                            <i class="fas fa-check text-blue-600 text-xs"></i>
                                        </div>
                                        <span class="leading-relaxed">Vérifier l'exactitude du calcul</span>
                                    </li>
                                    <li class="flex items-start group">
                                        <div class="flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full mr-3 mt-0.5 group-hover:bg-blue-200 transition-colors">
                                            <i class="fas fa-check text-blue-600 text-xs"></i>
                                        </div>
                                        <span class="leading-relaxed">Explorer d'autres optimisations fiscales</span>
                                    </li>
                                    <li class="flex items-start group">
                                        <div class="flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full mr-3 mt-0.5 group-hover:bg-blue-200 transition-colors">
                                            <i class="fas fa-check text-blue-600 text-xs"></i>
                                        </div>
                                        <span class="leading-relaxed">Planifier une stratégie pour améliorer votre ratio</span>
                                    </li>
                                </ul>
                                <div class="qr-content-card warning mt-4">
                                    <div class="flex items-start">
                                        <div class="flex items-center justify-center w-8 h-8 bg-yellow-100 rounded-lg mr-3 flex-shrink-0">
                                            <i class="fas fa-info-circle text-yellow-600"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm text-yellow-700 leading-relaxed">
                                                <span class="font-semibold">Conseil :</span> Si votre conjoint ne travaille pas en Suisse, son absence de revenus suisses impacte négativement votre ratio. Une activité même réduite en Suisse pourrait améliorer votre situation.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 text-center border-t border-gray-200 pt-6">
                        <button onclick="newSimulation()" class="qr-enhanced-button secondary">
                            <i class="fas fa-redo"></i>
                            <span>Effectuer une nouvelle simulation</span>
                        </button>
                    </div>
                </section>
                </div>

                <!-- TOU Simulator (Hidden by default) -->
                <div id="tou-simulator" class="hidden">
                    <div class="flex items-center mb-6">
                        <button onclick="showFiscalOverview()" class="mr-4 text-gray-600 hover:text-gray-800 transition-colors">
                            <i class="fas fa-arrow-left text-xl"></i>
                        </button>
                        <div class="bg-blue-100 p-2 rounded-full mr-4">
                            <i class="fas fa-balance-scale text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Simulateur TOU vs Retenue à la Source</h2>
                            <p class="text-gray-600">Comparez votre impôt avec la Retenue à la Source et la Taxation Ordinaire Unique (TOU)</p>
                        </div>
                    </div>

                <!-- TOU vs Withholding Tax Simulator Section -->
                <section id="tou-simulator-section" class="p-6 mb-8">

                    <!-- TOU Simulator Container with scoped styles -->
                    <div id="tou-simulator-container" class="tou-simulator-wrapper">
                        <!-- Multi-Step Form Container -->
                        <div class="tou-step-container">
                            <!-- Progress Bar -->
                            <div class="tou-progress-container">
                                <div class="tou-progress-bar">
                                    <div class="tou-progress-fill" id="touProgressFill" style="width: 25%"></div>
                                </div>
                                <div class="tou-progress-text">
                                    <span id="touProgressText">Étape 1 sur 4</span>
                                    <span id="touProgressPercent">25%</span>
                                </div>
                            </div>

                            <!-- Step Content -->
                            <div class="tou-step-content">
                                <form id="touTaxForm">
                                    <!-- Step 1: Personal Information -->
                                    <div class="tou-form-step active" id="touStep1">
                                        <div class="tou-form-group">
                                            <h3 class="tou-form-group-title">
                                                <div class="tou-form-group-icon">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                Situation personnelle
                                            </h3>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <!-- Canton de travail (fixed to Geneva) -->
                                                <div class="tou-input-group">
                                                    <label class="tou-input-label">Canton de travail <span class="tou-input-required">*</span></label>
                                                    <div class="px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg font-medium text-gray-700">
                                                        Genève
                                                    </div>
                                                    <p class="tou-input-help">Votre canton de travail est fixé à Genève pour cette simulation</p>
                                                </div>

                                                <!-- Commune de résidence -->
                                                <div class="tou-input-group">
                                                    <label class="tou-input-label" for="touCommune">Commune de résidence <span class="tou-input-required">*</span></label>
                                                    <div class="tou-dropdown-container">
                                                        <select id="touCommune" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" onchange="touValidateDropdown(this)">
                                                            <option value="">Sélectionnez une commune</option>
                                                            <option value="AIRE-LA-VILLE">AIRE-LA-VILLE</option>
                                                            <option value="ANIERES">ANIERES</option>
                                                            <option value="AVULLY">AVULLY</option>
                                                            <option value="AVUSY">AVUSY</option>
                                                            <option value="BARDONNEX">BARDONNEX</option>
                                                            <option value="BELLEVUE">BELLEVUE</option>
                                                            <option value="BERNEX">BERNEX</option>
                                                            <option value="CAROUGE">CAROUGE</option>
                                                            <option value="CARTIGNY">CARTIGNY</option>
                                                            <option value="CELIGNY">CELIGNY</option>
                                                            <option value="CHANCY">CHANCY</option>
                                                            <option value="CHENE-BOUGERIES">CHENE-BOUGERIES</option>
                                                            <option value="CHENE-BOURG">CHENE-BOURG</option>
                                                            <option value="CHOULEX">CHOULEX</option>
                                                            <option value="COLLEX-BOSSY">COLLEX-BOSSY</option>
                                                            <option value="COLLONGE-BELLERIVE">COLLONGE-BELLERIVE</option>
                                                            <option value="COLOGNY">COLOGNY</option>
                                                            <option value="CONFIGNON">CONFIGNON</option>
                                                            <option value="CORSIER">CORSIER</option>
                                                            <option value="DARDAGNY">DARDAGNY</option>
                                                            <option value="GENEVE" selected>GENEVE</option>
                                                            <option value="GENTHOD">GENTHOD</option>
                                                            <option value="GRAND-SACONNEX">GRAND-SACONNEX</option>
                                                            <option value="GY">GY</option>
                                                            <option value="HERMANCE">HERMANCE</option>
                                                            <option value="JUSSY">JUSSY</option>
                                                            <option value="LACONNEX">LACONNEX</option>
                                                            <option value="LANCY">LANCY</option>
                                                            <option value="MEINIER">MEINIER</option>
                                                            <option value="MEYRIN">MEYRIN</option>
                                                            <option value="ONEX">ONEX</option>
                                                            <option value="PERLY-CERTOUX">PERLY-CERTOUX</option>
                                                            <option value="PLAN-LES-OUATES">PLAN-LES-OUATES</option>
                                                            <option value="PREGNY-CHAMBESY">PREGNY-CHAMBESY</option>
                                                            <option value="PRESINGE">PRESINGE</option>
                                                            <option value="PUPLINGE">PUPLINGE</option>
                                                            <option value="RUSSIN">RUSSIN</option>
                                                            <option value="SATIGNY">SATIGNY</option>
                                                            <option value="SORAL">SORAL</option>
                                                            <option value="THONEX">THONEX</option>
                                                            <option value="TROINEX">TROINEX</option>
                                                            <option value="VANDOEUVRES">VANDOEUVRES</option>
                                                            <option value="VERNIER">VERNIER</option>
                                                            <option value="VERSOIX">VERSOIX</option>
                                                            <option value="VEYRIER">VEYRIER</option>
                                                        </select>
                                                    </div>
                                                    <p class="tou-input-help">Votre commune de résidence influence le calcul de l'impôt communal</p>
                                                </div>

                                                <!-- Situation familiale -->
                                                <div class="tou-input-group">
                                                    <label class="tou-input-label" for="touFamilyStatus">Situation familiale <span class="tou-input-required">*</span></label>
                                                    <div class="tou-dropdown-container">
                                                        <select id="touFamilyStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" onchange="touToggleConditionalFields(); touValidateDropdown(this)">
                                                            <option value="">Sélectionnez votre situation</option>
                                                            <option value="single">Célibataire</option>
                                                            <option value="married-no-income">Marié·e sans conjoint imposé</option>
                                                            <option value="married-with-income">Marié·e avec conjoint ayant un revenu</option>
                                                            <option value="divorced-single">Divorcé·e vivant seul·e</option>
                                                            <option value="divorced-with-children">Divorcé·e avec enfants à charge</option>
                                                            <option value="widow">Veuf/Veuve</option>
                                                        </select>
                                                    </div>
                                                    <p class="tou-input-help">Votre situation familiale détermine le barème fiscal applicable</p>
                                                </div>

                                                <!-- Nombre d'enfants -->
                                                <div id="touChildrenContainer" class="tou-input-group hidden">
                                                    <label class="tou-input-label" for="touChildrenCount">Nombre d'enfants à charge <span class="tou-input-required">*</span></label>
                                                    <input type="number" id="touChildrenCount" min="0" max="10" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0">
                                                    <p class="tou-input-help">Enfants de moins de 18 ans ou en formation</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 2: Employment & Income Details -->
                                    <div class="tou-form-step" id="touStep2">
                                        <div class="tou-form-group">
                                            <h3 class="tou-form-group-title">
                                                <div class="tou-form-group-icon">
                                                    <i class="fas fa-euro-sign"></i>
                                                </div>
                                                Revenus et patrimoine
                                            </h3>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <!-- Revenu annuel -->
                                                <div class="tou-input-group">
                                                    <label class="tou-input-label" for="touAnnualIncome">Revenu annuel (CHF) <span class="tou-input-required">*</span></label>
                                                    <div class="tou-currency-container" data-currency="CHF">
                                                        <div class="relative rounded-md shadow-sm">
                                                            <input type="number" id="touAnnualIncome" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" placeholder="Ex: 80000">
                                                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                                <span class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="tou-currency-toggle" onclick="touToggleCurrency(this)">CHF/EUR</button>
                                                        <div class="tou-conversion-display hidden" id="touAnnualIncomeConversion"></div>
                                                    </div>
                                                    <p class="tou-input-help">Votre salaire brut annuel avant déductions</p>
                                                </div>

                                                <!-- Revenu conjoint (conditionnel) -->
                                                <div id="touSpouseIncomeContainer" class="tou-input-group hidden">
                                                    <label class="tou-input-label" for="touSpouseIncome">Revenu annuel du conjoint (CHF)</label>
                                                    <div class="tou-currency-container" data-currency="CHF">
                                                        <div class="relative rounded-md shadow-sm">
                                                            <input type="number" id="touSpouseIncome" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" placeholder="Ex: 50000">
                                                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                                <span class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="tou-currency-toggle" onclick="touToggleCurrency(this)">CHF/EUR</button>
                                                        <div class="tou-conversion-display hidden" id="touSpouseIncomeConversion"></div>
                                                    </div>
                                                    <p class="tou-input-help">Revenus de votre conjoint(e) si applicable</p>
                                                </div>

                                                <!-- Fortune imposable -->
                                                <div class="tou-input-group">
                                                    <label class="tou-input-label" for="touWealth">Fortune imposable (CHF)</label>
                                                    <div class="tou-currency-container" data-currency="CHF">
                                                        <div class="relative rounded-md shadow-sm">
                                                            <input type="number" id="touWealth" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" placeholder="Ex: 500000">
                                                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                                <span class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="tou-currency-toggle" onclick="touToggleCurrency(this)">CHF/EUR</button>
                                                        <div class="tou-conversion-display hidden" id="touWealthConversion"></div>
                                                    </div>
                                                    <p class="tou-input-help">Valeur de vos biens immobiliers, comptes bancaires, etc.</p>
                                                </div>

                                                <!-- Pensions alimentaires -->
                                                <div class="tou-input-group">
                                                    <label class="tou-input-label" for="touAlimony">Pension alimentaire versée (CHF)</label>
                                                    <div class="tou-currency-container" data-currency="CHF">
                                                        <div class="relative rounded-md shadow-sm">
                                                            <input type="number" id="touAlimony" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" placeholder="Ex: 15000">
                                                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                                <span class="text-gray-500 sm:text-sm">CHF</span>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="tou-currency-toggle" onclick="touToggleCurrency(this)">CHF/EUR</button>
                                                        <div class="tou-conversion-display hidden" id="touAlimonyConversion"></div>
                                                    </div>
                                                    <p class="tou-input-help">⚠️ Si vous versez une pension alimentaire, vous devez obligatoirement choisir la TOU</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 3: Tax Deductions & Options -->
                                    <div class="tou-form-step" id="touStep3">
                                        <div class="tou-form-group">
                                            <h3 class="tou-form-group-title">
                                                <div class="tou-form-group-icon">
                                                    <i class="fas fa-receipt"></i>
                                                </div>
                                                Déductions fiscales
                                            </h3>

                                            <div class="grid grid-cols-1 gap-6">
                                                <!-- Option déductions TOU -->
                                                <div class="tou-input-group">
                                                    <label class="tou-input-label" for="touDeductionOption">Option de déductions TOU</label>
                                                    <div class="tou-dropdown-container">
                                                        <select id="touDeductionOption" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" onchange="touToggleDeductionFields(); touValidateDropdown(this)">
                                                            <option value="forfaitaire">Déductions forfaitaires</option>
                                                            <option value="reel">Frais réels</option>
                                                            <option value="optimize">Optimiser automatiquement</option>
                                                        </select>
                                                    </div>
                                                    <p class="tou-input-help">Choisissez entre les déductions forfaitaires (3% du revenu net, limites ICC/IFD), la déclaration de vos frais réels, ou l'optimisation automatique (calcule les deux et sélectionne la meilleure option)</p>
                                                </div>

                                                <!-- Comprehensive Actual Deductions (conditional) -->
                                                <div id="touRealDeductionsContainer" class="hidden">
                                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                                        <h4 class="font-medium text-blue-800 mb-2">Déductions réelles détaillées</h4>
                                                        <p class="text-sm text-blue-700">Renseignez vos frais réels selon les catégories officielles. Les limites ICC et IFD sont appliquées automatiquement.</p>
                                                    </div>

                                                    <!-- Progress and Controls Bar -->
                                                    <div class="tou-frais-progress-bar" role="region" aria-label="Progression des déductions">
                                                        <div class="tou-frais-progress-info">
                                                            <div class="tou-frais-progress-circle" id="touFraisProgressCircle" aria-label="Sections complétées">
                                                                0/5
                                                            </div>
                                                            <div>
                                                                <div class="font-medium text-gray-900" id="touFraisProgressText">Aucune section complétée</div>
                                                                <div class="text-sm text-gray-600">Remplissez uniquement les sections qui vous concernent</div>
                                                            </div>
                                                        </div>
                                                        <div class="tou-frais-controls" role="group" aria-label="Contrôles d'affichage">
                                                            <button type="button" class="tou-frais-control-btn" id="touExpandAllSections" aria-label="Développer toutes les sections">
                                                                <i class="fas fa-expand-alt mr-1" aria-hidden="true"></i>
                                                                Tout développer
                                                            </button>
                                                            <button type="button" class="tou-frais-control-btn" id="touCollapseAllSections" aria-label="Réduire toutes les sections">
                                                                <i class="fas fa-compress-alt mr-1" aria-hidden="true"></i>
                                                                Tout réduire
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Validation Messages Container -->
                                                    <div id="touFraisValidationContainer" aria-live="polite" aria-atomic="true"></div>

                                                    <!-- Professional Expenses Section -->
                                                    <div class="tou-frais-accordion" data-section="professional">
                                                        <button type="button" class="tou-frais-accordion-header" aria-expanded="true" aria-controls="touProfessionalContent" id="touProfessionalHeader">
                                                            <div class="tou-frais-accordion-title">
                                                                <i class="fas fa-briefcase text-blue-600" aria-hidden="true"></i>
                                                                <span>Frais professionnels</span>
                                                            </div>
                                                            <div class="tou-frais-accordion-summary">
                                                                <span class="tou-frais-summary-badge" id="touProfessionalBadge">0 CHF</span>
                                                            </div>
                                                            <svg class="tou-frais-accordion-chevron" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.29a.75.75 0 01-.02-1.08z" clip-rule="evenodd" />
                                                            </svg>
                                                        </button>
                                                        <div class="tou-frais-accordion-content" id="touProfessionalContent" role="region" aria-labelledby="touProfessionalHeader">
                                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <!-- Commuting -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touCommutingEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touCommutingAmount">Transport domicile-travail</label>
                                                                    </div>
                                                                    <input type="number" id="touCommutingAmount" min="0" max="3200" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <p class="tou-input-help">ICC: 529 CHF forfait | IFD: Max 3,200 CHF réels</p>
                                                                </div>
                                                                <!-- Meals -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touMealsEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touMealsWorkingDays">Frais de repas</label>
                                                                    </div>
                                                                    <div class="space-y-2">
                                                                        <input type="number" id="touMealsWorkingDays" min="0" max="250" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="220" placeholder="Jours de travail/an" disabled>
                                                                        <div class="flex items-center">
                                                                            <input type="checkbox" id="touMealsEmployerContribution" class="mr-2" disabled>
                                                                            <label class="text-sm text-gray-600">Contribution employeur</label>
                                                                        </div>
                                                                    </div>
                                                                    <p class="tou-input-help">Sans contribution: 15 CHF/jour (max 3,200) | Avec: 7.50 CHF/jour (max 1,600)</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Health and Insurance Section -->
                                                    <div class="tou-frais-accordion" data-section="health">
                                                        <button type="button" class="tou-frais-accordion-header" aria-expanded="false" aria-controls="touHealthContent" id="touHealthHeader">
                                                            <div class="tou-frais-accordion-title">
                                                                <i class="fas fa-heartbeat text-red-600" aria-hidden="true"></i>
                                                                <span>Assurances et frais médicaux</span>
                                                            </div>
                                                            <div class="tou-frais-accordion-summary">
                                                                <span class="tou-frais-summary-badge" id="touHealthBadge">0 CHF</span>
                                                            </div>
                                                            <svg class="tou-frais-accordion-chevron" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.29a.75.75 0 01-.02-1.08z" clip-rule="evenodd" />
                                                            </svg>
                                                        </button>
                                                        <div class="tou-frais-accordion-content" id="touHealthContent" role="region" aria-labelledby="touHealthHeader" style="display: none;">
                                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <!-- Health Insurance -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touHealthInsuranceEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touHealthInsuranceAmount">Primes assurance maladie</label>
                                                                    </div>
                                                                    <input type="number" id="touHealthInsuranceAmount" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <select id="touHealthInsuranceCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus mt-2" disabled>
                                                                        <option value="adults">Adultes (ICC: 16,207 | IFD: 1,700/3,500)</option>
                                                                        <option value="young_adults">18-26 ans (ICC: 12,442)</option>
                                                                        <option value="children">Enfants (ICC: 3,811 | IFD: 700/enfant)</option>
                                                                    </select>
                                                                    <p class="tou-input-help">Limites différentes selon ICC/IFD et âge</p>
                                                                </div>
                                                                <!-- Medical Expenses -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touMedicalExpensesEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touMedicalExpensesAmount">Frais médicaux (ICC uniquement)</label>
                                                                    </div>
                                                                    <input type="number" id="touMedicalExpensesAmount" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <input type="number" id="touMedicalExpensesReimbursement" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus mt-2" value="0" placeholder="Remboursements assurance" disabled>
                                                                    <p class="tou-input-help">Déductible au-delà de 0.5% du revenu net imposable</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Pension and Investment Section -->
                                                    <div class="tou-frais-accordion" data-section="pension">
                                                        <button type="button" class="tou-frais-accordion-header" aria-expanded="false" aria-controls="touPensionContent" id="touPensionHeader">
                                                            <div class="tou-frais-accordion-title">
                                                                <i class="fas fa-piggy-bank text-green-600" aria-hidden="true"></i>
                                                                <span>Prévoyance et investissements</span>
                                                            </div>
                                                            <div class="tou-frais-accordion-summary">
                                                                <span class="tou-frais-summary-badge" id="touPensionBadge">0 CHF</span>
                                                            </div>
                                                            <svg class="tou-frais-accordion-chevron" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.29a.75.75 0 01-.02-1.08z" clip-rule="evenodd" />
                                                            </svg>
                                                        </button>
                                                        <div class="tou-frais-accordion-content" id="touPensionContent" role="region" aria-labelledby="touPensionHeader" style="display: none;">
                                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                                <!-- 3rd Pillar A -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touPillar3AEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touPillar3AAmount">3ème pilier A</label>
                                                                    </div>
                                                                    <input type="number" id="touPillar3AAmount" min="0" max="7056" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <div class="flex items-center mt-2">
                                                                        <input type="checkbox" id="touPillar3AHasSecondPillar" class="mr-2" disabled>
                                                                        <label class="text-sm text-gray-600">Avec 2ème pilier</label>
                                                                    </div>
                                                                    <p class="tou-input-help">Max 7,056 CHF/an (avec 2ème pilier)</p>
                                                                </div>
                                                                <!-- 3rd Pillar B -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touPillar3BEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touPillar3BAmount">3ème pillar B (ICC uniquement)</label>
                                                                    </div>
                                                                    <input type="number" id="touPillar3BAmount" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <input type="number" id="touPillar3BAdults" min="1" max="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus mt-2" value="1" placeholder="Nombre d'adultes" disabled>
                                                                    <p class="tou-input-help">Max 2,324 CHF/an par adulte</p>
                                                                </div>
                                                                <!-- Loan Interest -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touLoanInterestEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touLoanInterestAmount">Intérêts d'emprunts</label>
                                                                    </div>
                                                                    <input type="number" id="touLoanInterestAmount" min="0" max="50000" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <p class="tou-input-help">Max 50,000 CHF/an (ICC et IFD)</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Family and Personal Section -->
                                                    <div class="tou-frais-accordion" data-section="family">
                                                        <button type="button" class="tou-frais-accordion-header" aria-expanded="false" aria-controls="touFamilyContent" id="touFamilyHeader">
                                                            <div class="tou-frais-accordion-title">
                                                                <i class="fas fa-users text-purple-600" aria-hidden="true"></i>
                                                                <span>Famille et frais personnels</span>
                                                            </div>
                                                            <div class="tou-frais-accordion-summary">
                                                                <span class="tou-frais-summary-badge" id="touFamilyBadge">0 CHF</span>
                                                            </div>
                                                            <svg class="tou-frais-accordion-chevron" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.29a.75.75 0 01-.02-1.08z" clip-rule="evenodd" />
                                                            </svg>
                                                        </button>
                                                        <div class="tou-frais-accordion-content" id="touFamilyContent" role="region" aria-labelledby="touFamilyHeader" style="display: none;">
                                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <!-- Childcare -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touChildcareEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touChildcareAmount">Frais de garde d'enfants</label>
                                                                    </div>
                                                                    <input type="number" id="touChildcareAmount" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <input type="number" id="touChildcareChildren" min="0" max="10" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus mt-2" value="0" placeholder="Nombre d'enfants" disabled>
                                                                    <p class="tou-input-help">ICC: 26,080 CHF/enfant | IFD: 25,500 CHF/enfant</p>
                                                                </div>
                                                                <!-- Alimony -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touAlimonyEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touAlimonyAmount">Pensions alimentaires</label>
                                                                    </div>
                                                                    <input type="number" id="touAlimonyAmount" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <div class="flex items-center mt-2">
                                                                        <input type="checkbox" id="touAlimonyChildrenUnder18" class="mr-2" disabled>
                                                                        <label class="text-sm text-gray-600">Enfants < 18 ans</label>
                                                                    </div>
                                                                    <p class="tou-input-help">ICC: Max 6,768 CHF (enfants < 18) | IFD: Sans limite</p>
                                                                </div>
                                                                <!-- Training Expenses -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touTrainingEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touTrainingAmount">Frais de formation</label>
                                                                    </div>
                                                                    <input type="number" id="touTrainingAmount" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <p class="tou-input-help">ICC: Max 12,140 CHF | IFD: Max 12,900 CHF</p>
                                                                </div>
                                                                <!-- Union Contributions -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touUnionEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touUnionAmount">Cotisations syndicales (ICC uniquement)</label>
                                                                    </div>
                                                                    <input type="number" id="touUnionAmount" min="0" max="700" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <p class="tou-input-help">Max 700 CHF/an</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Property and Other Section -->
                                                    <div class="tou-frais-accordion" data-section="property">
                                                        <button type="button" class="tou-frais-accordion-header" aria-expanded="false" aria-controls="touPropertyContent" id="touPropertyHeader">
                                                            <div class="tou-frais-accordion-title">
                                                                <i class="fas fa-home text-orange-600" aria-hidden="true"></i>
                                                                <span>Immobilier et autres frais</span>
                                                            </div>
                                                            <div class="tou-frais-accordion-summary">
                                                                <span class="tou-frais-summary-badge" id="touPropertyBadge">0 CHF</span>
                                                            </div>
                                                            <svg class="tou-frais-accordion-chevron" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.29a.75.75 0 01-.02-1.08z" clip-rule="evenodd" />
                                                            </svg>
                                                        </button>
                                                        <div class="tou-frais-accordion-content" id="touPropertyContent" role="region" aria-labelledby="touPropertyHeader" style="display: none;">
                                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <!-- Property Maintenance -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touPropertyMaintenanceEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touPropertyMaintenanceRent">Entretien immobilier</label>
                                                                    </div>
                                                                    <input type="number" id="touPropertyMaintenanceRent" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" placeholder="Loyer brut ou valeur locative" disabled>
                                                                    <p class="tou-input-help">20% forfait du loyer brut/valeur locative</p>
                                                                </div>
                                                                <!-- Real Estate Work -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touRealEstateWorkEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touRealEstateWorkAmount">Travaux immobiliers</label>
                                                                    </div>
                                                                    <input type="number" id="touRealEstateWorkAmount" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <p class="tou-input-help">Sans limite (ICC et IFD)</p>
                                                                </div>
                                                                <!-- Double Residence -->
                                                                <div class="tou-input-group">
                                                                    <div class="flex items-center mb-2">
                                                                        <input type="checkbox" id="touDoubleResidenceEnabled" class="mr-2">
                                                                        <label class="tou-input-label" for="touDoubleResidenceAmount">Frais de double domicile</label>
                                                                    </div>
                                                                    <input type="number" id="touDoubleResidenceAmount" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus" value="0" disabled>
                                                                    <input type="number" id="touDoubleResidenceMonths" min="1" max="12" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none tou-input-focus mt-2" value="12" placeholder="Nombre de mois" disabled>
                                                                    <p class="tou-input-help">Max 500 CHF/mois (ICC et IFD)</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Section A1-A5 Brackets (Alimony Consideration) -->
                                        <div class="tou-form-group">
                                            <h3 class="tou-form-group-title">
                                                <div class="tou-form-group-icon">
                                                    <i class="fas fa-balance-scale"></i>
                                                </div>
                                                Barèmes spéciaux A1-A5 (Pension alimentaire)
                                            </h3>

                                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                                <div class="flex items-start">
                                                    <input id="touUseA1A5Brackets" type="checkbox" class="h-5 w-5 text-orange-600 rounded border-gray-300 focus:ring-orange-500 mt-1" onchange="touToggleA1A5Info()">
                                                    <div class="ml-3">
                                                        <label for="touUseA1A5Brackets" class="block font-medium text-gray-700">Utiliser les barèmes A1-A5 pour l'impôt à la source</label>
                                                        <p class="text-sm text-gray-600 mt-1">Ces barèmes tiennent compte des pensions alimentaires dans le calcul de l'impôt à la source</p>

                                                        <!-- A1-A5 Information Panel -->
                                                        <div id="touA1A5InfoPanel" class="hidden mt-3 p-3 bg-white border border-orange-300 rounded-md">
                                                            <h4 class="font-medium text-orange-800 mb-2">Conditions d'éligibilité :</h4>
                                                            <ul class="text-sm text-gray-700 space-y-1">
                                                                <li>• Résider à Genève OU avoir le statut de quasi-résident</li>
                                                                <li>• Payer une pension alimentaire de plus de 12,000 CHF par an</li>
                                                                <li>• Paiements pour enfants mineurs ou ex-conjoint</li>
                                                            </ul>
                                                            <p class="text-xs text-orange-700 mt-2">
                                                                ⚠️ <strong>Important :</strong> L'utilisation des barèmes A1-A5 nécessite une demande écrite à votre employeur pendant l'année en cours.
                                                            </p>
                                                            <p class="text-xs text-gray-600 mt-1">
                                                                Alternative : Demander la TOU l'année suivante pour récupération.
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="tou-form-group">
                                            <h3 class="tou-form-group-title">
                                                <div class="tou-form-group-icon">
                                                    <i class="fas fa-home"></i>
                                                </div>
                                                Statut de résidence
                                            </h3>

                                            <!-- Quasi-resident status -->
                                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                                <div class="flex items-start">
                                                    <input id="touQuasiResident" type="checkbox" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 mt-1">
                                                    <div class="ml-3">
                                                        <label for="touQuasiResident" class="block font-medium text-gray-700">Je suis quasi-résident</label>
                                                        <p class="text-sm text-gray-600 mt-1">Plus de 90% de mes revenus sont imposés en Suisse</p>
                                                        <p class="text-xs text-yellow-700 mt-2">⚠️ Cochez cette case uniquement si vous remplissez les conditions strictes du statut de quasi-résident</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 4: Results (will be populated after calculation) -->
                                    <div class="tou-form-step" id="touStep4">
                                        <div class="tou-form-group">
                                            <h3 class="tou-form-group-title">
                                                <div class="tou-form-group-icon">
                                                    <i class="fas fa-chart-bar"></i>
                                                </div>
                                                Résultats de votre simulation
                                            </h3>

                                            <div class="text-center py-8">
                                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                                    <i class="fas fa-calculator text-blue-600 text-3xl mb-4"></i>
                                                    <h4 class="text-lg font-medium text-blue-800 mb-2">Calcul en cours...</h4>
                                                    <p class="text-blue-600">Vos résultats s'afficheront ici après le calcul</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Navigation Buttons -->
                                    <div class="tou-navigation">
                                        <button type="button" id="touPrevBtn" class="tou-nav-button tou-nav-button-secondary" onclick="touPreviousStep()" disabled>
                                            <i class="fas fa-chevron-left"></i>
                                            Précédent
                                        </button>
                                        <div class="flex gap-3">
                                            <button type="button" id="touResetBtn" class="tou-nav-button tou-nav-button-secondary">
                                                <i class="fas fa-redo"></i>
                                                Réinitialiser
                                            </button>
                                            <button type="button" id="touNextBtn" class="tou-nav-button tou-nav-button-primary" onclick="touNextStep()">
                                                Suivant
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                            <button type="button" id="touCalculateBtn" class="tou-nav-button tou-nav-button-success hidden">
                                                <i class="fas fa-calculator"></i>
                                                Calculer ma simulation
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div id="touResultsSection" class="hidden mb-8 tou-fade-in">
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                                <div class="bg-blue-600 p-6">
                                    <h3 class="text-xl font-bold text-white">Résultats de la simulation</h3>
                                </div>

                                <div class="p-6 md:p-8">
                                    <!-- Quasi-Resident Status -->
                                    <div id="touQuasiResidentAlert" class="hidden mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <div class="flex">
                                            <div class="flex-shrink-0">
                                                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                                </svg>
                                            </div>
                                            <div class="ml-3 flex-1 md:flex md:justify-between">
                                                <p class="text-sm text-blue-700" id="touEligibilityText">Vous êtes éligible au statut de quasi-résident (plus de 90% de vos revenus imposés en Suisse).</p>
                                            </div>
                                        </div>
                                    </div>



                                    <!-- Comparison Cards -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                        <!-- Retenue à la Source -->
                                        <div id="touWithholdingResult" class="tou-result-card border border-gray-200 rounded-xl p-6 bg-gray-50">
                                            <div class="flex items-center mb-4">
                                                <div class="bg-blue-600 text-white p-2 rounded-lg mr-3">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                </div>
                                                <h4 class="text-xl font-bold text-gray-800">Retenue à la Source</h4>
                                            </div>
                                            <div class="space-y-3">
                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Barème appliqué:</span>
                                                    <span id="touSourceBracket" class="font-medium">A0</span>
                                                </div>
                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Base imposable:</span>
                                                    <span id="touSourceBase" class="font-medium">80'000 CHF</span>
                                                </div>
                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Revenu de référence:</span>
                                                    <span id="touReferenceIncome" class="font-medium">80'000 CHF</span>
                                                </div>
                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Taux d'imposition:</span>
                                                    <span id="touWithholdingRate" class="font-medium">12%</span>
                                                </div>
                                                <div class="flex justify-between text-lg font-bold pt-2">
                                                    <span>Impôt calculé:</span>
                                                    <span id="touSourceTax" class="text-blue-600">9'600 CHF</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- TOU -->
                                        <div id="touTouResult" class="tou-result-card border border-gray-200 rounded-xl p-6 bg-gray-50">
                                            <div class="flex items-center mb-4">
                                                <div class="bg-blue-600 text-white p-2 rounded-lg mr-3">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                    </svg>
                                                </div>
                                                <h4 class="text-xl font-bold text-gray-800">Taxation Ordinaire (TOU)</h4>
                                            </div>
                                            <div class="space-y-3">
                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Déductions appliquées:</span>
                                                    <span id="touTouDeductions" class="font-medium">11'826 CHF</span>
                                                </div>
                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Revenu imposable ICC:</span>
                                                    <span id="touRevenuNetIcc" class="font-medium">68'174 CHF</span>
                                                </div>

                                                <!-- ICC Deductions Details Section -->
                                                <div id="touIccDeductionsDetailsSection" class="hidden">
                                                    <div class="flex items-center justify-between py-1">
                                                        <span id="touIccDeductionsLabel" class="text-xs text-gray-500">Détail Déductions forfaitaires ICC</span>
                                                        <button id="touIccDeductionsToggle" class="text-xs text-blue-500 hover:text-blue-700 focus:outline-none transition-colors duration-200 flex items-center">
                                                            <span class="mr-1">Afficher</span>
                                                            <svg class="w-3 h-3 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div id="touIccDeductionsBreakdown" class="hidden overflow-hidden transition-all duration-300 ease-out">
                                                        <div class="bg-blue-50 rounded-md p-2 mt-1 mb-2 border-l-3 border-blue-200">
                                                            <div class="space-y-1 text-xs" id="touIccDeductionsContent">
                                                                <!-- Dynamic ICC content will be populated here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Revenu imposable IFD:</span>
                                                    <span id="touRevenuNetIfd" class="font-medium">68'174 CHF</span>
                                                </div>

                                                <!-- IFD Deductions Details Section -->
                                                <div id="touIfdDeductionsDetailsSection" class="hidden">
                                                    <div class="flex items-center justify-between py-1">
                                                        <span id="touIfdDeductionsLabel" class="text-xs text-gray-500">Détail Déductions forfaitaires IFD</span>
                                                        <button id="touIfdDeductionsToggle" class="text-xs text-blue-500 hover:text-blue-700 focus:outline-none transition-colors duration-200 flex items-center">
                                                            <span class="mr-1">Afficher</span>
                                                            <svg class="w-3 h-3 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div id="touIfdDeductionsBreakdown" class="hidden overflow-hidden transition-all duration-300 ease-out">
                                                        <div class="bg-green-50 rounded-md p-2 mt-1 mb-2 border-l-3 border-green-200">
                                                            <div class="space-y-1 text-xs" id="touIfdDeductionsContent">
                                                                <!-- Dynamic IFD content will be populated here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Deduction Comparison Panel (for optimization mode) -->
                                                <div id="touDeductionComparisonSection" class="hidden">
                                                    <div class="flex items-center justify-between py-1">
                                                        <span class="text-xs text-gray-500">Comparaison déductions</span>
                                                        <button id="touDeductionComparisonToggle" class="text-xs text-blue-500 hover:text-blue-700 focus:outline-none transition-colors duration-200 flex items-center">
                                                            <span class="mr-1">Afficher</span>
                                                            <svg class="w-3 h-3 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div id="touDeductionComparisonBreakdown" class="hidden overflow-hidden transition-all duration-300 ease-out">
                                                        <div class="bg-amber-50 rounded-md p-3 mt-1 mb-2 border-l-3 border-amber-200">
                                                            <div class="space-y-2 text-xs">
                                                                <div class="font-medium text-amber-800 mb-2">
                                                                    <i class="fas fa-lightbulb mr-1"></i>
                                                                    <span id="touOptimizationRecommendation">Recommandation: Déductions forfaitaires</span>
                                                                </div>

                                                                <div class="grid grid-cols-2 gap-3">
                                                                    <div class="bg-white rounded p-2 border">
                                                                        <div class="font-medium text-gray-700 mb-1">Forfaitaires</div>
                                                                        <div class="space-y-1">
                                                                            <div class="flex justify-between">
                                                                                <span class="text-gray-600">ICC:</span>
                                                                                <span id="touForfaitIcc" class="text-gray-800">-</span>
                                                                            </div>
                                                                            <div class="flex justify-between">
                                                                                <span class="text-gray-600">IFD:</span>
                                                                                <span id="touForfaitIfd" class="text-gray-800">-</span>
                                                                            </div>
                                                                            <div class="flex justify-between border-t pt-1">
                                                                                <span class="text-gray-600">Revenu net:</span>
                                                                                <span id="touForfaitNetIncome" class="font-medium">-</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="bg-white rounded p-2 border">
                                                                        <div class="font-medium text-gray-700 mb-1">Réelles</div>
                                                                        <div class="space-y-1">
                                                                            <div class="flex justify-between">
                                                                                <span class="text-gray-600">ICC:</span>
                                                                                <span id="touReellesIcc" class="text-gray-800">-</span>
                                                                            </div>
                                                                            <div class="flex justify-between">
                                                                                <span class="text-gray-600">IFD:</span>
                                                                                <span id="touReellesIfd" class="text-gray-800">-</span>
                                                                            </div>
                                                                            <div class="flex justify-between border-t pt-1">
                                                                                <span class="text-gray-600">Revenu net:</span>
                                                                                <span id="touReellesNetIncome" class="font-medium">-</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="bg-green-100 rounded p-2 border border-green-200">
                                                                    <div class="flex justify-between items-center">
                                                                        <span class="text-green-700 font-medium">Économie potentielle:</span>
                                                                        <span id="touOptimizationSavings" class="text-green-800 font-bold">-</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Taux ICC:</span>
                                                    <span id="touIccRate" class="font-medium">8.50%</span>
                                                </div>

                                                <!-- ICC Details Section (Minimalist) -->
                                                <div id="touIccDetailsSection" class="hidden">
                                                    <div class="flex items-center justify-between py-1">
                                                        <span class="text-xs text-gray-500">Détail ICC</span>
                                                        <button id="touIccToggle" class="text-xs text-blue-500 hover:text-blue-700 focus:outline-none transition-colors duration-200 flex items-center">
                                                            <span class="mr-1">Afficher</span>
                                                            <svg class="w-3 h-3 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div id="touIccBreakdown" class="hidden overflow-hidden transition-all duration-300 ease-out">
                                                        <div class="bg-blue-50 rounded-md p-2 mt-1 mb-2 border-l-3 border-blue-200">
                                                            <div class="space-y-1 text-xs">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Impôt de base:</span>
                                                                    <span id="touIccBase" class="text-gray-800 font-medium">-</span>
                                                                </div>

                                                                <!-- Splitting Details Section (Hidden by default) -->
                                                                <div id="touSplittingDetails" class="hidden bg-gray-50 rounded-md p-2 mt-1 mb-1 border-l-2 border-gray-300">
                                                                    <div class="text-xs text-gray-700 font-medium mb-1">
                                                                        <span id="touSplittingTitle">Calcul avec splitting familial:</span>
                                                                    </div>
                                                                    <div class="space-y-1 text-xs">
                                                                        <div class="flex justify-between">
                                                                            <span class="text-gray-600">Revenu imposable total:</span>
                                                                            <span id="touSplittingOriginalIncome" class="text-gray-700">-</span>
                                                                        </div>
                                                                        <div class="flex justify-between">
                                                                            <span class="text-gray-600">Division par:</span>
                                                                            <span id="touSplittingDivision" class="text-gray-700">-</span>
                                                                        </div>
                                                                        <div class="flex justify-between">
                                                                            <span class="text-gray-600">Revenu de référence:</span>
                                                                            <span id="touSplittingReferenceIncome" class="text-gray-700">-</span>
                                                                        </div>
                                                                        <div class="flex justify-between">
                                                                            <span class="text-gray-600">Impôt sur revenu de référence:</span>
                                                                            <span id="touSplittingIntermediateTax" class="text-gray-700">-</span>
                                                                        </div>
                                                                        <div class="flex justify-between">
                                                                            <span class="text-gray-600">Multiplication par:</span>
                                                                            <span id="touSplittingMultiplier" class="text-gray-700">-</span>
                                                                        </div>
                                                                        <div class="flex justify-between border-t border-gray-300 pt-1">
                                                                            <span class="text-gray-700 font-medium">Impôt de base final:</span>
                                                                            <span id="touSplittingFinalTax" class="text-gray-800 font-medium">-</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="flex justify-between">
                                                                    <span id="touIccCantonalLabel" class="text-gray-600">Centimes cantonaux (47.5%):</span>
                                                                    <span id="touIccCantonal" class="text-gray-800 font-medium">-</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Diminution (12%):</span>
                                                                    <span id="touIccReduction" class="text-red-600 font-medium">-</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Centime aide domicile (1%):</span>
                                                                    <span id="touIccHomeCare" class="text-gray-800 font-medium">-</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span id="touIccMunicipalLabel" class="text-gray-600">Centimes communaux:</span>
                                                                    <span id="touIccMunicipal" class="text-gray-800 font-medium">-</span>
                                                                </div>
                                                                <hr class="border-gray-300 my-1">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-800 font-medium">Total ICC:</span>
                                                                    <span id="touIccTotal" class="text-blue-600 font-bold">-</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="flex justify-between border-b pb-2">
                                                    <span class="text-gray-600">Taux IFD:</span>
                                                    <span id="touIfdRate" class="font-medium">4.25%</span>
                                                </div>

                                                <!-- IFD Details Section (Minimalist) -->
                                                <div id="touIfdDetailsSection" class="hidden">
                                                    <div class="flex items-center justify-between py-1">
                                                        <span class="text-xs text-gray-500">Détail IFD</span>
                                                        <button id="touIfdToggle" class="text-xs text-blue-500 hover:text-blue-700 focus:outline-none transition-colors duration-200 flex items-center">
                                                            <span class="mr-1">Afficher</span>
                                                            <svg class="w-3 h-3 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div id="touIfdBreakdown" class="hidden overflow-hidden transition-all duration-300 ease-out">
                                                        <div class="bg-green-50 rounded-md p-2 mt-1 mb-2 border-l-3 border-green-200">
                                                            <div class="space-y-1 text-xs">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Impôt sur la tranche précédente:</span>
                                                                    <span id="touIfdPreviousBracketsTax" class="text-gray-700 font-medium">-</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Taux de la tranche:</span>
                                                                    <span id="touIfdCurrentBracketRate" class="text-gray-700 font-medium">-</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Montant restant:</span>
                                                                    <span id="touIfdRemainingAmount" class="text-gray-700 font-medium">-</span>
                                                                </div>

                                                                <hr class="border-gray-300 my-1">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-800 font-medium">Total IFD:</span>
                                                                    <span id="touIfdFinalTotal" class="text-green-600 font-bold">-</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="flex justify-between text-lg font-bold pt-2">
                                                    <span>Impôt calculé:</span>
                                                    <span id="touTouTax" class="text-blue-600">8'522 CHF</span>
                                                </div>

                                                <!-- Calculated Tax Details Section (Minimalist) -->
                                                <div id="touCalculatedTaxDetailsSection" class="hidden">
                                                    <div class="flex items-center justify-between py-1">
                                                        <span class="text-xs text-gray-500">Détail Impôt calculé</span>
                                                        <button id="touCalculatedTaxToggle" class="text-xs text-blue-500 hover:text-blue-700 focus:outline-none transition-colors duration-200 flex items-center">
                                                            <span class="mr-1">Afficher</span>
                                                            <svg class="w-3 h-3 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div id="touCalculatedTaxBreakdown" class="hidden overflow-hidden transition-all duration-300 ease-out">
                                                        <div class="bg-purple-50 rounded-md p-2 mt-1 mb-2 border-l-3 border-purple-200">
                                                            <div class="space-y-1 text-xs">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">ICC (Cantonal et Communal):</span>
                                                                    <span id="touCalculatedTaxICC" class="text-gray-700 font-medium">-</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">IFD (Fédéral Direct):</span>
                                                                    <span id="touCalculatedTaxIFD" class="text-gray-700 font-medium">-</span>
                                                                </div>

                                                                <hr class="border-gray-300 my-1">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-800 font-medium">Total calculé:</span>
                                                                    <span id="touCalculatedTaxFinalTotal" class="text-purple-600 font-bold">-</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Comparison Result -->
                                    <div id="touComparisonSummary" class="hidden mb-6 p-5 rounded-xl bg-yellow-50 border border-yellow-200">
                                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                                            <div class="mb-4 md:mb-0">
                                                <p class="text-lg font-medium">Résultat de la comparaison</p>
                                                <p class="text-gray-600">Différence entre les deux options de taxation</p>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-sm font-medium text-gray-600">Gain/perte avec la TOU</p>
                                                <p id="touTaxDifference" class="text-2xl font-bold text-green-600">-1'078 CHF</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Recommendation -->
                                    <div id="touRecommendation" class="hidden p-5 bg-green-50 border border-green-200 rounded-xl mb-6">
                                        <div class="flex">
                                            <div class="flex-shrink-0">
                                                <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                                </svg>
                                            </div>
                                            <div class="ml-3">
                                                <p class="text-sm font-medium text-green-800">La <span id="touBestOption" class="font-bold">Taxation Ordinaire (TOU)</span> est plus avantageuse dans votre situation.</p>
                                                <p class="mt-1 text-sm text-green-700">Vous économiseriez <span id="touSavingsAmount">1'078 CHF</span> par rapport à la Retenue à la Source.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Warnings -->
                                    <div id="touWarningsSection" class="hidden">
                                        <div id="touAlimonyWarning" class="mt-2 bg-red-50 border-l-4 border-red-400 p-4 hidden">
                                            <div class="flex">
                                                <div class="flex-shrink-0 text-red-500">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </div>
                                                <div class="ml-3">
                                                    <p class="text-sm text-red-700">
                                                        <span class="font-bold">Important :</span> Vous avez indiqué verser une pension alimentaire. Vous devez obligatoirement choisir la TOU et faire une demande à l'administration fiscale.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="touQuasiResidentWarning" class="mt-2 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700 hidden">
                                            <i class="fas fa-exclamation-triangle mr-2"></i>
                                            <span>Vous ne remplissez pas les conditions pour le statut de quasi-résident (moins de 90% de vos revenus imposés en Suisse). La TOU n'est pas disponible pour vous.</span>
                                        </div>
                                    </div>

                                    <!-- Download Button -->
                                    <div class="pt-4">
                                        <button id="touDownloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out opacity-50 cursor-not-allowed" disabled>
                                            <i class="fas fa-download mr-2"></i>
                                            Télécharger les résultats
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                </div>
            </div>

            <!-- Onglet Social -->
            <div class="p-12 tab-content" id="social">
                <header class="section-header">
                    <h1 class="section-title font-display">Social</h1>
                    <p class="section-subtitle">Comparateurs et outils pour la protection sociale</p>
                </header>

                <!-- Simulateur LAMal vs CMU intégré -->
                <div id="simulator-container">
                    <!-- Page d'accueil du simulateur -->
                    <section id="simulator-home">
                        <div class="simulator-hero">
                            <h1>Simulateur LAMal vs. CMU pour frontaliers</h1>
                            <p>Obtenez une comparaison personnalisée, fiable et 100% gratuite basée sur les chiffres officiels 2025</p>
                            <a href="#simulator-form" class="simulator-btn" onclick="showSimulatorForm()">Démarrer ma simulation</a>
                        </div>

                        <div class="simulator-features">
                            <div class="simulator-feature">
                                <i class="fas fa-calculator"></i>
                                <h3>Calculs Précis</h3>
                                <p>Basés sur les données officielles 2025 pour des résultats fiables</p>
                            </div>
                            <div class="simulator-feature">
                                <i class="fas fa-bolt"></i>
                                <h3>Résultats Instantanés</h3>
                                <p>Comparaison immédiate avec visualisation claire des données</p>
                            </div>
                            <div class="simulator-feature">
                                <i class="fas fa-file-pdf"></i>
                                <h3>Rapport Détaillé</h3>
                                <p>Téléchargez votre analyse personnalisée pour prendre votre décision</p>
                            </div>
                        </div>

                        <div class="simulator-warning">
                            <p><strong>Important :</strong> Votre choix d'assurance maladie est obligatoire et irrévocable pendant toute l'année civile. Cette décision impacte votre protection santé et votre budget. Prenez le temps de bien comparer les options.</p>
                        </div>
                    </section>

                    <!-- Simulateur -->
                    <section id="simulator-form" style="display: none;">
                        <h2 style="text-align: center; margin-bottom: var(--space-lg);">Simulez votre assurance maladie</h2>

                        <div class="simulator-form-container">
                            <div class="simulator-form-header">
                                <h3>Votre situation personnelle</h3>
                                <div class="simulator-progress-bar">
                                    <div class="simulator-progress" id="formProgress"></div>
                                </div>
                            </div>

                            <div class="simulator-form-body">
                                <!-- Étape 1: Votre Situation -->
                                <div class="simulator-form-step active" id="step1">
                                    <div class="simulator-form-group">
                                        <h3>1. Votre situation familiale</h3>
                                        <div class="simulator-input-group">
                                            <label>Situation familiale</label>
                                            <select id="familySituation">
                                                <option value="single">Célibataire</option>
                                                <option value="married">Marié/Pacsé</option>
                                                <option value="divorced">Divorcé/Séparé</option>
                                                <option value="widowed">Veuf/Veuve</option>
                                            </select>
                                        </div>

                                        <div class="simulator-input-group">
                                            <label>Nombre d'enfants à charge</label>
                                            <input type="number" id="childrenCount" min="0" max="10" value="0">
                                        </div>

                                        <div class="simulator-input-group" id="childrenAges" style="display: none;">
                                            <label>Âges des enfants (séparés par des virgules)</label>
                                            <input type="text" placeholder="Ex: 5, 8, 12">
                                        </div>

                                        <div class="simulator-input-group">
                                            <label>Votre conjoint(e) perçoit-il/elle des revenus en France ?</label>
                                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xs);">
                                                <div class="simulator-checkbox-group">
                                                    <input type="radio" id="spouseIncomeYes" name="spouseIncome" value="yes">
                                                    <label for="spouseIncomeYes">Oui</label>
                                                </div>
                                                <div class="simulator-checkbox-group">
                                                    <input type="radio" id="spouseIncomeNo" name="spouseIncome" value="no" checked>
                                                    <label for="spouseIncomeNo">Non</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="simulator-form-group">
                                        <h3>2. Votre activité professionnelle</h3>
                                        <div class="simulator-input-group">
                                            <label>Canton de travail en Suisse</label>
                                            <select id="canton">
                                                <option value="geneve">Genève</option>
                                                <option value="vaud">Vaud</option>
                                                <option value="neuchatel">Neuchâtel</option>
                                                <option value="jura">Jura</option>
                                                <option value="valais">Valais</option>
                                                <option value="basel">Bâle</option>
                                            </select>
                                        </div>

                                        <div class="simulator-input-group">
                                            <label>Votre âge</label>
                                            <input type="number" id="age" min="18" max="70" value="35">
                                        </div>
                                    </div>

                                    <div class="simulator-form-navigation">
                                        <div></div> <!-- Spacer -->
                                        <button class="simulator-btn" onclick="nextStep(2)">Suivant</button>
                                    </div>
                                </div>

                                <!-- Étape 2: Vos Revenus -->
                                <div class="simulator-form-step" id="step2">
                                    <div class="simulator-form-group">
                                        <h3>3. Vos revenus</h3>
                                        <div class="simulator-input-group">
                                            <label>Salaire Brut Annuel en CHF</label>
                                            <input type="number" id="salary" value="80000">
                                        </div>

                                        <div class="simulator-input-group">
                                            <label>
                                                Revenu Fiscal de Référence (RFR) de l'année N-2 (2023 pour la cotisation 2025)
                                                <span class="simulator-info-tooltip">
                                                    <i class="fas fa-info-circle"></i>
                                                    <span class="simulator-tooltip-text">Trouvez cette information sur votre avis d'imposition français, en haut de la première page.</span>
                                                </span>
                                            </label>
                                            <input type="number" id="rfr" value="35000">
                                        </div>

                                        <div class="simulator-advanced-toggle" onclick="toggleAdvanced()">
                                            <i class="fas fa-cog"></i>
                                            <span>Options de simulation avancée</span>
                                        </div>

                                        <div class="simulator-advanced-options" id="advancedOptions">
                                            <div class="simulator-input-group">
                                                <label>Déductions spécifiques (rachat 2ème pilier, frais réels, etc.)</label>
                                                <input type="number" id="deductions" value="0">
                                            </div>

                                            <div class="simulator-input-group">
                                                <label>
                                                    Taux de change CHF/EUR
                                                    <span class="simulator-info-tooltip">
                                                        <i class="fas fa-info-circle"></i>
                                                        <span class="simulator-tooltip-text">Taux officiel Banque de France. Modifiable si vous souhaitez simuler avec un taux différent.</span>
                                                    </span>
                                                </label>
                                                <input type="number" id="exchangeRate" step="0.01" value="1.07">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="simulator-form-navigation">
                                        <button class="simulator-btn simulator-btn-secondary" onclick="prevStep(1)">Précédent</button>
                                        <button class="simulator-btn" onclick="nextStep(3)">Suivant</button>
                                    </div>
                                </div>

                                <!-- Étape 3: Vos Besoins de Santé -->
                                <div class="simulator-form-step" id="step3">
                                    <div class="simulator-form-group">
                                        <h3>4. Vos besoins de santé</h3>
                                        <div class="simulator-input-group">
                                            <label>Où prévoyez-vous de vous faire soigner principalement ?</label>
                                            <select id="healthcareLocation">
                                                <option value="france">France</option>
                                                <option value="switzerland">Suisse</option>
                                                <option value="both">Les deux indifféremment</option>
                                            </select>
                                        </div>

                                        <div class="simulator-input-group">
                                            <label>Pour affiner la simulation LAMal, estimez vos dépenses de santé annuelles (consultations, pharmacie...)</label>
                                            <div class="simulator-slider-container">
                                                <input type="range" min="0" max="2" value="1" class="simulator-slider" id="healthCosts">
                                                <div class="simulator-slider-labels">
                                                    <span>Faibles (&lt; 300 CHF)</span>
                                                    <span>Moyennes (~1000 CHF)</span>
                                                    <span>Élevées (&gt; 2000 CHF)</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="simulator-form-navigation">
                                        <button class="simulator-btn simulator-btn-secondary" onclick="prevStep(2)">Précédent</button>
                                        <button class="simulator-btn" onclick="calculateResults()">Voir les résultats</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Résultats -->
                    <section id="simulator-results" style="display: none;">
                        <div class="simulator-results-header">
                            <h2>Résultats de votre simulation</h2>
                            <p>Comparaison personnalisée basée sur votre situation</p>
                        </div>

                        <div class="simulator-results-container">
                            <div class="simulator-card" id="lamalCard">
                                <div class="simulator-card-header">
                                    <h3>LAMal</h3>
                                    <p>Assurance maladie suisse</p>
                                </div>
                                <div class="simulator-price">124€ <span class="simulator-price-period">/ mois</span></div>
                                <p>Coût annuel estimé: <strong>1,488€</strong></p>
                                <p class="simulator-details-toggle" onclick="toggleDetails('lamalDetails')">Voir le détail du calcul</p>
                                <div class="simulator-details-content" id="lamalDetails">
                                    <p><strong>Détail du calcul:</strong></p>
                                    <ul>
                                        <li>Prime de base: 95€/mois</li>
                                        <li>Franchise: 300€</li>
                                        <li>Quote-part: 93€</li>
                                        <li>Total annuel: 1,488€</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="simulator-card simulator-recommended" id="cmuCard">
                                <div class="simulator-card-header">
                                    <h3>CMU</h3>
                                    <p>Couverture Maladie Universelle française</p>
                                </div>
                                <div class="simulator-price">87€ <span class="simulator-price-period">/ mois</span></div>
                                <p>Coût annuel estimé: <strong>1,044€</strong></p>
                                <p class="simulator-details-toggle" onclick="toggleDetails('cmuDetails')">Voir le détail du calcul</p>
                                <div class="simulator-details-content" id="cmuDetails">
                                    <p><strong>Détail du calcul:</strong></p>
                                    <ul>
                                        <li>RFR: 35,000€</li>
                                        <li>Abattement: 5,000€</li>
                                        <li>Taux: 8%</li>
                                        <li>Total annuel: (35,000 - 5,000) × 8% = 1,044€</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="simulator-threshold-graph">
                            <h3>À partir de quel revenu la LAMal devient-elle plus intéressante ?</h3>
                            <p>Pour votre situation familiale, le seuil de basculement est de <strong>42,000€ de RFR</strong></p>

                            <div class="simulator-graph-container">
                                <div class="simulator-threshold-marker" style="left: 65%;"></div>
                                <div class="simulator-threshold-label">Seuil: 42,000€</div>
                                <div class="simulator-current-position" style="left: 45%;">Votre RFR: 35,000€</div>
                            </div>

                            <div class="simulator-graph-labels">
                                <span>CMU avantageuse</span>
                                <span>LAMal avantageuse</span>
                            </div>
                        </div>

                        <div class="simulator-comparison-table">
                            <h3 style="text-align: center; margin-bottom: var(--space-md);">Comparaison des avantages et inconvénients</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Critère</th>
                                        <th>LAMal</th>
                                        <th>CMU</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Couverture des soins en Suisse</td>
                                        <td><i class="fas fa-check" style="color: var(--success);"></i> Excellente</td>
                                        <td><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Limitée</td>
                                    </tr>
                                    <tr>
                                        <td>Couverture des soins en France</td>
                                        <td><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Sous conditions</td>
                                        <td><i class="fas fa-check" style="color: var(--success);"></i> Complète</td>
                                    </tr>
                                    <tr>
                                        <td>Couverture de la famille</td>
                                        <td><i class="fas fa-times" style="color: #e53e3e;"></i> Payante par personne</td>
                                        <td><i class="fas fa-check" style="color: var(--success);"></i> Incluse pour ayants droit</td>
                                    </tr>
                                    <tr>
                                        <td>Démarches administratives</td>
                                        <td><i class="fas fa-check" style="color: var(--success);"></i> Simplifiées en Suisse</td>
                                        <td><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Complexes pour remboursements</td>
                                    </tr>
                                    <tr>
                                        <td>Impact des hauts revenus</td>
                                        <td><i class="fas fa-check" style="color: var(--success);"></i> Prime fixe, indépendante du revenu</td>
                                        <td><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Contribution proportionnelle au RFR</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="simulator-card" style="background: #f0f7ff; border-left: 4px solid var(--primary); margin-top: var(--space-xl);">
                            <h3>Recommandation personnalisée</h3>
                            <p>Selon votre profil (famille avec conjoint sans revenus en France), <strong>la CMU présente un avantage financier notable</strong> avec une économie annuelle d'environ 444€.</p>
                            <p>Pour vos besoins de santé principalement en France, la CMU offre également une meilleure couverture et des démarches simplifiées.</p>
                        </div>

                        <div style="text-align: center; margin-top: var(--space-xl);">
                            <button class="simulator-btn" onclick="showReport()">Télécharger mon rapport personnalisé (PDF)</button>
                        </div>
                    </section>

                    <!-- Rapport -->
                    <section id="simulator-report" style="display: none;">
                        <div class="simulator-report-container">
                            <h2 style="margin-bottom: var(--space-md);">Votre rapport personnalisé est prêt !</h2>
                            <p>Téléchargez votre analyse complète pour prendre une décision éclairée</p>

                            <div class="simulator-report-card">
                                <i class="fas fa-file-pdf" style="font-size: 4rem; color: var(--accent); margin-bottom: var(--space-md);"></i>
                                <h3 style="margin-bottom: var(--space-sm);">Rapport d'analyse LAMal vs. CMU</h3>
                                <p style="margin-bottom: var(--space-lg);">Personnalisé pour <strong>Martin Dupont</strong> - Généré le 15/07/2025</p>

                                <a href="#" class="simulator-btn" style="margin-bottom: var(--space-xl);">
                                    <i class="fas fa-download"></i> Télécharger le rapport (PDF)
                                </a>

                                <div class="simulator-warning">
                                    <p><strong>Avertissement :</strong> Cette simulation a une valeur informative et ne constitue pas un conseil personnalisé. Les résultats sont basés sur les informations fournies et les données officielles disponibles en juillet 2025. Pour une analyse précise de votre situation, consultez un conseiller spécialisé.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- FAQ -->
                    <section id="simulator-faq" style="background: #f8fafc; padding: var(--space-xl) 0;">
                        <h2 style="text-align: center; margin-bottom: var(--space-xl);">Foire Aux Questions</h2>

                        <div class="simulator-faq-container">
                            <div class="simulator-faq-item">
                                <div class="simulator-faq-question" onclick="toggleFAQ(this)">
                                    <span>Quelle est la différence entre la LAMal et la CMU ?</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="simulator-faq-answer">
                                    <p>La LAMal (Loi sur l'Assurance Maladie) est le système d'assurance maladie obligatoire en Suisse. La CMU (Couverture Maladie Universelle) est le système français. En tant que frontalier, vous pouvez choisir entre les deux systèmes, mais ce choix est annuel et irrévocable.</p>
                                </div>
                            </div>

                            <div class="simulator-faq-item">
                                <div class="simulator-faq-question" onclick="toggleFAQ(this)">
                                    <span>Où trouver mon Revenu Fiscal de Référence (RFR) ?</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="simulator-faq-answer">
                                    <p>Votre RFR figure sur votre avis d'imposition français, en haut de la première page. Il correspond à votre revenu net imposable après abattements. Pour la cotisation 2025, on utilise le RFR de l'année 2023 (N-2).</p>
                                </div>
                            </div>

                            <div class="simulator-faq-item">
                                <div class="simulator-faq-question" onclick="toggleFAQ(this)">
                                    <span>Puis-je changer d'option en cours d'année ?</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="simulator-faq-answer">
                                    <p>Non, votre choix est annuel et irrévocable. Vous devez faire votre déclaration avant le 30 novembre pour l'année suivante. Les seules exceptions concernent des changements majeurs de situation (mariage, naissance, perte d'emploi).</p>
                                </div>
                            </div>

                            <div class="simulator-faq-item">
                                <div class="simulator-faq-question" onclick="toggleFAQ(this)">
                                    <span>Comment est calculée la contribution CMU ?</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="simulator-faq-answer">
                                    <p>La contribution CMU est calculée comme suit : (Revenu Fiscal de Référence - Abattement) × Taux (8% en 2025). L'abattement est de 8,922€ pour une personne seule et augmente selon votre situation familiale.</p>
                                </div>
                            </div>

                            <div class="simulator-faq-item">
                                <div class="simulator-faq-question" onclick="toggleFAQ(this)">
                                    <span>Quelle option est préférable pour une famille ?</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="simulator-faq-answer">
                                    <p>La CMU présente souvent un avantage financier pour les familles car elle couvre gratuitement les enfants et le conjoint sans revenus. Avec la LAMal, chaque membre de la famille doit souscrire une assurance séparée, ce qui augmente significativement le coût.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Onglet Dépôt de Documents -->
            <div class="p-12 tab-content" id="depot">
                <header class="section-header">
                    <div>
                        <h1 class="section-title font-display">Dépôt de Documents</h1>
                        <div class="flex items-center gap-3 mt-3">
                            <div class="flex items-center gap-2 px-3 py-1 bg-[var(--color-success-light)] text-[var(--color-success)] rounded-full text-sm font-medium">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                <span>Connexion sécurisée SSL</span>
                            </div>
                        </div>
                    </div>
                </header>

                <section class="premium-card p-8 mb-8">
                    <div class="mb-8">
                        <h2 class="card-title">Déposer un document</h2>
                        <p class="card-subtitle">Sélectionnez un client pour déposer des documents</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-[var(--color-background-secondary)] rounded-xl p-6">
                            <h3 class="font-semibold mb-6 text-[var(--color-text-primary)]">Sélection du client</h3>

                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-[var(--color-text-primary)] mb-2">Client</label>
                                <select class="premium-select">
                                    <option>Sélectionnez un client...</option>
                                    <option selected>Martin Dupont</option>
                                    <option>Sophie Bernard</option>
                                    <option>Thomas Moreau</option>
                                    <option>Camille Lefevre</option>
                                </select>
                            </div>

                            <div class="text-sm">
                                <p class="font-semibold text-[var(--color-text-primary)] mb-3">Informations client</p>
                                <ul class="space-y-2 text-[var(--color-text-secondary)]">
                                    <li class="flex justify-between">
                                        <span>ID Client:</span>
                                        <span class="font-medium">MC-4582</span>
                                    </li>
                                    <li class="flex justify-between">
                                        <span>Canton:</span>
                                        <span class="font-medium">Genève</span>
                                    </li>
                                    <li class="flex justify-between">
                                        <span>Dernier dépôt:</span>
                                        <span class="font-medium">12/06/2025</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-2">
                            <div class="drag-drop-area">
                                <div class="mb-4">
                                    <svg class="h-12 w-12 mx-auto text-[var(--color-text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold mb-2">Glissez vos documents ici</h3>
                                <p class="text-[var(--color-text-secondary)] mb-4">Formats acceptés : PDF, JPG, PNG (max. 10 Mo par fichier)</p>
                                <button class="rounded-lg bg-white border border-[var(--color-border)] px-4 py-2 text-[var(--color-text-secondary)] hover:bg-gray-50">
                                    Ou parcourir vos fichiers
                                </button>
                            </div>
                            
                            <div class="mt-6">
                                <h3 class="font-bold mb-3">Documents en cours de dépôt</h3>
                                <div class="border border-[var(--color-border)] rounded-lg">
                                    <div class="p-3 border-b flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <svg class="h-5 w-5 text-[var(--color-text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span>Déclaration_impots_2024.pdf</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm text-[var(--color-text-secondary)]">12.4 Mo</span>
                                            <button class="text-red-500">
                                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="p-3 flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <svg class="h-5 w-5 text-[var(--color-text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span>Relevé_bancaire_Q2_2025.pdf</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm text-[var(--color-text-secondary)]">8.2 Mo</span>
                                            <button class="text-red-500">
                                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end">
                                <button class="rounded-lg bg-[var(--color-secondary)] px-4 py-2 text-white hover:bg-[var(--color-primary)] transition-colors">
                                    Envoyer les documents
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="rounded-lg bg-white p-6 shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Documents récents</h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-[var(--color-border)] bg-gray-50">
                                    <th class="px-4 py-3 text-sm font-medium text-[var(--color-text-secondary)]">Document</th>
                                    <th class="px-4 py-3 text-sm font-medium text-[var(--color-text-secondary)]">Client</th>
                                    <th class="px-4 py-3 text-sm font-medium text-[var(--color-text-secondary)]">Date de dépôt</th>
                                    <th class="px-4 py-3 text-sm font-medium text-[var(--color-text-secondary)]">Statut</th>
                                    <th class="px-4 py-3 text-sm font-medium text-[var(--color-text-secondary)]">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[var(--color-border)]">
                                <tr>
                                    <td class="px-4 py-3 font-medium">Avis d'imposition 2024</td>
                                    <td class="px-4 py-3">Martin Dupont</td>
                                    <td class="px-4 py-3 text-[var(--color-text-secondary)]">15/07/2025</td>
                                    <td class="px-4 py-3"><span class="status-badge status-completed">Traité</span></td>
                                    <td class="px-4 py-3">
                                        <button class="text-[var(--color-secondary)] hover:underline">Télécharger</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium">Contrat de travail</td>
                                    <td class="px-4 py-3">Sophie Bernard</td>
                                    <td class="px-4 py-3 text-[var(--color-text-secondary)]">14/07/2025</td>
                                    <td class="px-4 py-3"><span class="status-badge status-inprogress">En vérification</span></td>
                                    <td class="px-4 py-3">
                                        <button class="text-[var(--color-secondary)] hover:underline">Voir</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium">Relevé bancaire Q2</td>
                                    <td class="px-4 py-3">Thomas Moreau</td>
                                    <td class="px-4 py-3 text-[var(--color-text-secondary)]">10/07/2025</td>
                                    <td class="px-4 py-3"><span class="status-badge status-completed">Traité</span></td>
                                    <td class="px-4 py-3">
                                        <button class="text-[var(--color-secondary)] hover:underline">Télécharger</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium">Justificatif domicile</td>
                                    <td class="px-4 py-3">Camille Lefevre</td>
                                    <td class="px-4 py-3 text-[var(--color-text-secondary)]">08/07/2025</td>
                                    <td class="px-4 py-3"><span class="status-badge status-waiting">En attente</span></td>
                                    <td class="px-4 py-3">
                                        <button class="text-[var(--color-secondary)] hover:underline">Voir</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Onglet Actualités -->
            <div class="p-12 tab-content" id="actualites">
                <header class="section-header">
                    <h1 class="section-title font-display">Actualités</h1>
                    <p class="section-subtitle">Les dernières informations sur la fiscalité transfrontalière</p>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <article class="premium-card overflow-hidden group hover:shadow-lg transition-all duration-300">
                        <div class="h-48 bg-gradient-to-br from-[var(--color-accent)] to-[var(--color-secondary)] relative overflow-hidden">
                            <div class="absolute inset-0 bg-black bg-opacity-20"></div>
                            <div class="absolute bottom-4 left-4 right-4">
                                <span class="inline-block px-3 py-1 bg-white bg-opacity-90 text-[var(--color-primary)] text-xs font-semibold rounded-full">Fiscalité</span>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <time class="text-sm text-[var(--color-text-muted)] font-medium">10 juillet 2025</time>
                            </div>
                            <h3 class="text-xl font-semibold mb-3 text-[var(--color-text-primary)] group-hover:text-[var(--color-accent)] transition-colors">Nouveaux seuils pour le télétravail des frontaliers à Genève</h3>
                            <p class="text-[var(--color-text-secondary)] mb-4 leading-relaxed">Les autorités genevoises ont annoncé une augmentation du nombre de jours de télétravail autorisés pour les frontaliers, passant de 34 à 45 jours par an à compter du 1er janvier 2026.</p>
                            <button class="inline-flex items-center text-[var(--color-accent)] font-semibold hover:text-[var(--color-primary)] transition-colors">
                                Lire la suite
                                <svg class="ml-2 h-4 w-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                                </svg>
                            </button>
                        </div>
                    </article>
                    
                    <div class="rounded-lg bg-white shadow-sm overflow-hidden">
                        <div class="h-48 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');"></div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 bg-[var(--color-success)] text-white text-xs rounded">Social</span>
                                <span class="text-sm text-[var(--color-text-secondary)]">08/07/2025</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2">Réforme des cotisations sociales pour les travailleurs frontaliers</h3>
                            <p class="text-[var(--color-text-secondary)] mb-4">Une nouvelle convention entre la France et la Suisse modifie les règles de cotisation sociale pour les frontaliers. Découvrez les impacts sur votre protection sociale.</p>
                            <button class="text-[var(--color-secondary)] font-medium hover:underline">Lire la suite</button>
                        </div>
                    </div>
                    
                    <div class="rounded-lg bg-white shadow-sm overflow-hidden">
                        <div class="h-48 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1460925895917-afdab827c52f?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');"></div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 bg-[var(--color-cta)] text-white text-xs rounded">Échéance</span>
                                <span class="text-sm text-[var(--color-text-secondary)]">05/07/2025</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2">Déclaration fiscale 2025 : dates importantes à retenir</h3>
                            <p class="text-[var(--color-text-secondary)] mb-4">Le calendrier des déclarations fiscales pour 2025 vient d'être publié. Notez dès maintenant les dates limites pour les résidents et frontaliers.</p>
                            <button class="text-[var(--color-secondary)] font-medium hover:underline">Lire la suite</button>
                        </div>
                    </div>
                    
                    <div class="rounded-lg bg-white shadow-sm overflow-hidden">
                        <div class="h-48 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1553877522-43269d4ea984?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');"></div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 bg-[var(--color-secondary)] text-white text-xs rounded">Fiscalité</span>
                                <span class="text-sm text-[var(--color-text-secondary)]">02/07/2025</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2">Optimisation fiscale : les nouvelles stratégies pour 2025</h3>
                            <p class="text-[var(--color-text-secondary)] mb-4">Découvrez les dernières stratégies d'optimisation fiscale pour les travailleurs frontaliers suite aux changements législatifs en France et en Suisse.</p>
                            <button class="text-[var(--color-secondary)] font-medium hover:underline">Lire la suite</button>
                        </div>
                    </div>
                    
                    <div class="rounded-lg bg-white shadow-sm overflow-hidden">
                        <div class="h-48 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1589156280159-27698a70f29e?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');"></div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 bg-[var(--color-success)] text-white text-xs rounded">Retraite</span>
                                <span class="text-sm text-[var(--color-text-secondary)]">28/06/2025</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2">Réforme des retraites : impacts pour les frontaliers</h3>
                            <p class="text-[var(--color-text-secondary)] mb-4">La réforme des retraites en France aura des conséquences spécifiques pour les travailleurs frontaliers. Analyse des changements et stratégies d'adaptation.</p>
                            <button class="text-[var(--color-secondary)] font-medium hover:underline">Lire la suite</button>
                        </div>
                    </div>
                    
                    <div class="rounded-lg bg-white shadow-sm overflow-hidden">
                        <div class="h-48 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1551836022-d5d88e9218df?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');"></div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 bg-[var(--color-cta)] text-white text-xs rounded">Formation</span>
                                <span class="text-sm text-[var(--color-text-secondary)]">25/06/2025</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2">Nouveau module de formation : optimisation transfrontalière</h3>
                            <p class="text-[var(--color-text-secondary)] mb-4">Notre nouveau module de formation sur les dernières techniques d'optimisation fiscale transfrontalière est désormais disponible pour tous les collaborateurs.</p>
                            <button class="text-[var(--color-secondary)] font-medium hover:underline">Lire la suite</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 text-center">
                    <button class="rounded-lg border border-[var(--color-border)] bg-white px-4 py-2 text-[var(--color-text-secondary)] shadow-sm transition-colors hover:bg-gray-50">
                        Charger plus d'actualités
                    </button>
                </div>
            </div>

            <!-- Onglet FAQ -->
            <div class="p-12 tab-content" id="faq">
                <header class="section-header">
                    <h1 class="section-title font-display">Foire Aux Questions</h1>
                    <p class="section-subtitle">Trouvez des réponses aux questions fréquentes sur la fiscalité transfrontalière</p>
                </header>

                <div class="premium-card overflow-hidden">
                    <div class="border-b border-[var(--color-border-light)] last:border-b-0">
                        <div class="faq-question p-6 cursor-pointer hover:bg-[var(--color-background-secondary)] transition-colors" data-category="fiscalite">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-[var(--color-text-primary)] pr-4">Quelles sont les conditions pour bénéficier du statut de quasi-résident à Genève ?</span>
                                <svg class="h-5 w-5 transform transition-transform text-[var(--color-text-muted)] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="faq-answer px-6 pb-6 text-[var(--color-text-secondary)] leading-relaxed">
                            <p class="mb-4">Pour bénéficier du statut de quasi-résident à Genève, vous devez remplir les conditions suivantes :</p>
                            <ul class="space-y-3">
                                <li class="flex items-start gap-3">
                                    <span class="w-1.5 h-1.5 bg-[var(--color-accent)] rounded-full mt-2 flex-shrink-0"></span>
                                    <span>Être domicilié fiscalement en France</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="w-1.5 h-1.5 bg-[var(--color-accent)] rounded-full mt-2 flex-shrink-0"></span>
                                    <span>Travailler principalement dans le canton de Genève (au moins 90% de votre activité professionnelle)</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="w-1.5 h-1.5 bg-[var(--color-accent)] rounded-full mt-2 flex-shrink-0"></span>
                                    <span>Ne pas avoir eu votre résidence principale en Suisse durant les 5 dernières années</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="w-1.5 h-1.5 bg-[var(--color-accent)] rounded-full mt-2 flex-shrink-0"></span>
                                    <span>Disposer d'une résidence permanente en France</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="border-b">
                        <div class="faq-question" data-category="fiscalite">
                            <div class="flex justify-between items-center">
                                <span>Comment déclarer mes revenus suisses en France ?</span>
                                <svg class="h-5 w-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="faq-answer">
                            <p>Les revenus suisses doivent être déclarés en France selon les modalités suivantes :</p>
                            <ol class="list-decimal pl-5 mt-2 space-y-1">
                                <li>Déclarez vos revenus bruts suisses dans la catégorie "Traitements et salaires"</li>
                                <li>Appliquez un abattement de 10% pour frais professionnels</li>
                                <li>Déduisez les cotisations sociales effectivement payées en Suisse</li>
                                <li>Mentionnez l'impôt à la source payé en Suisse pour bénéficier du crédit d'impôt</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="border-b">
                        <div class="faq-question" data-category="social">
                            <div class="flex justify-between items-center">
                                <span>Quelle assurance maladie choisir en tant que frontalier ?</span>
                                <svg class="h-5 w-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="faq-answer">
                            <p>En tant que frontalier, vous avez le choix entre :</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                <div class="border p-4 rounded-lg">
                                    <h4 class="font-bold mb-2">LAMal (Suisse)</h4>
                                    <ul class="list-disc pl-5 space-y-1">
                                        <li>Couverture étendue en Suisse</li>
                                        <li>Prise en charge à l'étranger limitée</li>
                                        <li>Coût généralement plus élevé</li>
                                        <li>Délai de résiliation : 3 mois</li>
                                    </ul>
                                </div>
                                <div class="border p-4 rounded-lg">
                                    <h4 class="font-bold mb-2">CMU (France)</h4>
                                    <ul class="list-disc pl-5 space-y-1">
                                        <li>Couverture valable en France et Suisse</li>
                                        <li>Coût généralement moins élevé</li>
                                        <li>Prise en charge à l'étranger limitée</li>
                                        <li>Délai de résiliation : 12 mois</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-b">
                        <div class="faq-question" data-category="retraite">
                            <div class="flex justify-between items-center">
                                <span>Comment fonctionne la retraite pour les travailleurs frontaliers ?</span>
                                <svg class="h-5 w-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="faq-answer">
                            <p>Le système de retraite des travailleurs frontaliers est régi par la convention franco-suisse :</p>
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li>Vous cotisez au 1er pilier suisse (AVS) et au 2ème pilier (LPP)</li>
                                <li>Vous cotisez également au système français pour la retraite de base et complémentaire</li>
                                <li>Au moment de la retraite, vous percevrez une pension de chaque pays</li>
                                <li>Le 3ème pilier suisse est un excellent outil d'optimisation fiscale</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="border-b">
                        <div class="faq-question" data-category="fiscalite">
                            <div class="flex justify-between items-center">
                                <span>Puis-je déduire mes frais de transport entre la France et la Suisse ?</span>
                                <svg class="h-5 w-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="faq-answer">
                            <p>Oui, les frais de transport entre votre domicile français et votre lieu de travail en Suisse sont déductibles :</p>
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li>Pour les résidents français : déduction possible dans la limite de 4 872€ par an</li>
                                <li>Pour les quasi-résidents : déduction intégrale des frais réels</li>
                                <li>Conservez tous vos justificatifs (billets, abonnements, factures de carburant)</li>
                                <li>Les frais de péage et de parking sont également déductibles</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="border-b">
                        <div class="faq-question" data-category="documents">
                            <div class="flex justify-between items-center">
                                <span>Quels documents dois-je fournir pour mon dossier fiscal ?</span>
                                <svg class="h-5 w-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="faq-answer">
                            <p>Pour constituer un dossier fiscal complet, vous devez fournir :</p>
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li>Votre contrat de travail suisse</li>
                                <li>Vos fiches de salaire de l'année</li>
                                <li>Votre avis d'imposition français de l'année précédente</li>
                                <li>Votre attestation de sécurité sociale</li>
                                <li>Les justificatifs de frais professionnels (transport, repas, formation)</li>
                                <li>Votre attestation de situation familiale</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Vous ne trouvez pas de réponse ?</h2>
                    <div class="bg-gray-50 rounded-lg p-6">
                        <form>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Votre nom</label>
                                    <input type="text" class="w-full rounded-lg border-[var(--color-border)] p-2 focus:border-[var(--color-secondary)] focus:ring-[var(--color-secondary)]">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Votre email</label>
                                    <input type="email" class="w-full rounded-lg border-[var(--color-border)] p-2 focus:border-[var(--color-secondary)] focus:ring-[var(--color-secondary)]">
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Catégorie de question</label>
                                <select class="w-full rounded-lg border-[var(--color-border)] p-2 focus:border-[var(--color-secondary)] focus:ring-[var(--color-secondary)]">
                                    <option>Sélectionnez une catégorie...</option>
                                    <option>Fiscalité</option>
                                    <option>Protection sociale</option>
                                    <option>Retraite</option>
                                    <option>Documents</option>
                                    <option>Autre</option>
                                </select>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Votre question</label>
                                <textarea rows="4" class="w-full rounded-lg border-[var(--color-border)] p-2 focus:border-[var(--color-secondary)] focus:ring-[var(--color-secondary)]"></textarea>
                            </div>
                            
                            <button class="rounded-lg bg-[var(--color-secondary)] px-4 py-2 text-white hover:bg-[var(--color-primary)] transition-colors">
                                Envoyer votre question
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Gestion des onglets avec animations améliorées
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const tabId = this.getAttribute('data-tab');

                // Vérifier si l'onglet est déjà actif
                if (this.classList.contains('active')) {
                    return;
                }

                // Masquer tous les contenus d'onglet avec animation
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Afficher le contenu de l'onglet sélectionné avec un léger délai pour l'animation
                setTimeout(() => {
                    document.getElementById(tabId).classList.add('active');
                }, 100);

                // Mettre à jour l'onglet actif dans la barre latérale
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                    // Réinitialiser les classes obsolètes si elles existent
                    btn.classList.remove('bg-sky-100', 'text-[var(--color-primary)]');
                });

                // Ajouter la classe active au bouton cliqué
                this.classList.add('active');

                // Ajouter un effet de ripple pour le feedback visuel
                createRippleEffect(this, e);
            });

            // Améliorer l'accessibilité avec le clavier
            button.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });

        // Fonction pour créer un effet de ripple au clic
        function createRippleEffect(element, event) {
            const ripple = document.createElement('span');
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
                background: rgba(49, 130, 206, 0.3);
                border-radius: 50%;
                transform: scale(0);
                animation: ripple 0.6s ease-out;
                pointer-events: none;
                z-index: 1;
            `;

            element.style.position = 'relative';
            element.style.overflow = 'hidden';
            element.appendChild(ripple);

            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // Ajouter l'animation CSS pour l'effet ripple
        const rippleStyle = document.createElement('style');
        rippleStyle.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(2);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(rippleStyle);

        // Gestion des FAQ
        document.querySelectorAll('.faq-question').forEach(question => {
            question.addEventListener('click', function() {
                const answer = this.nextElementSibling;
                const icon = this.querySelector('svg');
                
                if (answer.style.display === 'block') {
                    answer.style.display = 'none';
                    icon.classList.remove('rotate-180');
                } else {
                    answer.style.display = 'block';
                    icon.classList.add('rotate-180');
                }
            });
        });

        // Zone de drag and drop
        const dropArea = document.querySelector('.drag-drop-area');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('dragover');
        }
        
        function unhighlight() {
            dropArea.classList.remove('dragover');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        function handleFiles(files) {
            alert(`Vous avez déposé ${files.length} fichier(s)`);
        }

        // Simulator JavaScript Functions
        function showSimulatorForm() {
            document.getElementById('simulator-home').style.display = 'none';
            document.getElementById('simulator-form').style.display = 'block';
            document.getElementById('simulator-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Gestion des étapes du formulaire
        function nextStep(step) {
            document.querySelector('.simulator-form-step.active').classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');

            // Mise à jour de la barre de progression
            const progress = document.getElementById('formProgress');
            progress.style.width = `${step * 33}%`;

            // Faire défiler jusqu'au formulaire
            document.getElementById('simulator-form').scrollIntoView({ behavior: 'smooth' });
        }

        function prevStep(step) {
            document.querySelector('.simulator-form-step.active').classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');

            // Mise à jour de la barre de progression
            const progress = document.getElementById('formProgress');
            progress.style.width = `${step * 33}%`;
        }

        // Affichage des options avancées
        function toggleAdvanced() {
            const advancedOptions = document.getElementById('advancedOptions');
            const toggleIcon = document.querySelector('.simulator-advanced-toggle i');

            if (advancedOptions.style.display === 'block') {
                advancedOptions.style.display = 'none';
                toggleIcon.className = 'fas fa-cog';
            } else {
                advancedOptions.style.display = 'block';
                toggleIcon.className = 'fas fa-times';
            }
        }

        // Affichage des détails des résultats
        function toggleDetails(id) {
            const details = document.getElementById(id);
            if (details.style.display === 'block') {
                details.style.display = 'none';
            } else {
                details.style.display = 'block';
            }
        }

        // Calcul des résultats
        function calculateResults() {
            // Simulation de calcul
            document.getElementById('simulator-form').style.display = 'none';
            document.getElementById('simulator-results').style.display = 'block';
            document.getElementById('simulator-results').scrollIntoView({ behavior: 'smooth' });
        }

        // Affichage du rapport
        function showReport() {
            document.getElementById('simulator-results').style.display = 'none';
            document.getElementById('simulator-report').style.display = 'block';
            document.getElementById('simulator-report').scrollIntoView({ behavior: 'smooth' });
        }

        // Gestion de la FAQ du simulateur
        function toggleFAQ(element) {
            const faqItem = element.parentElement;
            faqItem.classList.toggle('active');

            const icon = element.querySelector('i');
            if (faqItem.classList.contains('active')) {
                icon.className = 'fas fa-chevron-up';
            } else {
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Affichage des âges des enfants si nécessaire
        document.addEventListener('DOMContentLoaded', function() {
            const childrenCountInput = document.getElementById('childrenCount');
            if (childrenCountInput) {
                childrenCountInput.addEventListener('change', function() {
                    const childrenAges = document.getElementById('childrenAges');
                    if (this.value > 0) {
                        childrenAges.style.display = 'block';
                    } else {
                        childrenAges.style.display = 'none';
                    }
                });
            }
        });

        // Quasi-Resident Simulator Functions
        // Currency conversion rates
        const EXCHANGE_RATES = {
            CHF_TO_EUR: 0.92,
            EUR_TO_CHF: 1.087
        };

        // Currency state tracking
        const currencyStates = {
            'income-dependent': 'CHF',
            'income-independent': 'CHF',
            'income-spouse': 'CHF',
            'income-foreign': 'CHF',
            'rental-primary': 'CHF',
            'rental-secondary': 'CHF',
            'income-lmnp': 'CHF',
            'income-other': 'CHF'
        };

        // Toggle currency for a specific field
        function toggleCurrency(fieldId) {
            const currentCurrency = currencyStates[fieldId];
            const newCurrency = currentCurrency === 'CHF' ? 'EUR' : 'CHF';

            // Update currency state
            currencyStates[fieldId] = newCurrency;

            // Update UI elements
            const toggle = document.getElementById(fieldId + '-toggle');
            const label = document.getElementById(fieldId + '-currency-label');
            const input = document.getElementById(fieldId);

            toggle.textContent = newCurrency;
            label.textContent = newCurrency;

            // Update toggle button styling
            if (newCurrency === 'EUR') {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }

            // Convert existing value if present
            if (input.value) {
                const currentValue = parseFloat(input.value);
                let convertedValue;

                if (newCurrency === 'EUR') {
                    convertedValue = currentValue * EXCHANGE_RATES.CHF_TO_EUR;
                } else {
                    convertedValue = currentValue * EXCHANGE_RATES.EUR_TO_CHF;
                }

                input.value = Math.round(convertedValue * 100) / 100;
            }

            // Update conversion display
            updateCurrencyConversion(fieldId);
        }

        // Update currency conversion display
        function updateCurrencyConversion(fieldId) {
            const input = document.getElementById(fieldId);
            const convertedDiv = document.getElementById(fieldId + '-converted');
            const currentCurrency = currencyStates[fieldId];

            if (!input.value || input.value === '0') {
                convertedDiv.textContent = '';
                return;
            }

            const value = parseFloat(input.value);
            let convertedValue, targetCurrency;

            if (currentCurrency === 'CHF') {
                convertedValue = value * EXCHANGE_RATES.CHF_TO_EUR;
                targetCurrency = 'EUR';
            } else {
                convertedValue = value * EXCHANGE_RATES.EUR_TO_CHF;
                targetCurrency = 'CHF';
            }

            const formattedValue = Math.round(convertedValue * 100) / 100;
            convertedDiv.textContent = `≈ ${formattedValue.toLocaleString()} ${targetCurrency}`;
        }

        // Get value in CHF for calculations (convert if necessary)
        function getValueInCHF(fieldId) {
            const input = document.getElementById(fieldId);
            const value = parseFloat(input.value) || 0;
            const currentCurrency = currencyStates[fieldId];

            if (currentCurrency === 'EUR') {
                return value * EXCHANGE_RATES.EUR_TO_CHF;
            }
            return value;
        }

        // Show/hide spouse income field based on family status
        document.getElementById('family-status').addEventListener('change', function() {
            const spouseIncomeContainer = document.getElementById('spouse-income-container');
            if (this.value === 'married') {
                spouseIncomeContainer.classList.remove('hidden');
            } else {
                spouseIncomeContainer.classList.add('hidden');
                document.getElementById('income-spouse').value = '';
                updateCurrencyConversion('income-spouse');
            }
        });



        // Reset form
        function resetForm() {
            document.getElementById('eligibility-form').reset();
            document.getElementById('spouse-income-container').classList.add('hidden');

            // Remove any validation errors
            const existingError = document.querySelector('.validation-error');
            if (existingError) {
                existingError.remove();
            }

            // Remove error styling from inputs
            const inputs = document.querySelectorAll('#eligibility-form input');
            inputs.forEach(input => {
                input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            });

            // Reset all currency states to CHF
            const fieldIds = ['income-dependent', 'income-independent', 'income-spouse', 'income-foreign', 'rental-primary', 'rental-secondary', 'income-lmnp', 'income-other'];
            fieldIds.forEach(fieldId => {
                currencyStates[fieldId] = 'CHF';
                const toggle = document.getElementById(fieldId + '-toggle');
                const label = document.getElementById(fieldId + '-currency-label');
                const convertedDiv = document.getElementById(fieldId + '-converted');

                if (toggle) {
                    toggle.textContent = 'CHF';
                    toggle.classList.remove('active');
                }
                if (label) {
                    label.textContent = 'CHF';
                }
                if (convertedDiv) {
                    convertedDiv.textContent = '';
                }
            });
        }

        // New simulation - show form, hide results
        function newSimulation() {
            // Check if we're in the quasi-resident simulator context
            const quasiResidentSimulator = document.getElementById('quasi-resident-simulator');
            const isQuasiResidentActive = quasiResidentSimulator && !quasiResidentSimulator.classList.contains('hidden');

            if (isQuasiResidentActive) {
                // Use the quasi-resident specific reset function
                qrNewSimulation();
            } else {
                // Original functionality for other simulators
                document.getElementById('simulation-form').classList.remove('hidden');
                document.getElementById('result-eligible').classList.add('hidden');
                document.getElementById('result-not-eligible').classList.add('hidden');
                resetForm();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Calculate eligibility
        function calculateEligibility() {
            try {
                // Get form values (converted to CHF for consistent calculation)
                const familyStatus = document.getElementById('family-status').value;
                const incomeDependent = getValueInCHF('income-dependent');
                const incomeIndependent = getValueInCHF('income-independent');
                const incomeSpouse = familyStatus === 'married' ? getValueInCHF('income-spouse') : 0;
                const incomeForeign = getValueInCHF('income-foreign');
                const rentalPrimary = getValueInCHF('rental-primary');
                const rentalSecondary = getValueInCHF('rental-secondary');
                const incomeLmnp = getValueInCHF('income-lmnp');
                const incomeOther = getValueInCHF('income-other');

                // Calculate total Swiss income
                const totalSwissIncome = incomeDependent + incomeIndependent;

                // Validate required fields - at least one Swiss income source should be provided
                if (totalSwissIncome <= 0) {
                    highlightInvalidFields(['income-dependent', 'income-independent']);
                    showValidationError('Veuillez saisir au moins un type de revenus en Suisse (activité dépendante ou indépendante)');
                    return;
                }

                // Additional validation for married status
                if (familyStatus === 'married' && incomeSpouse < 0) {
                    showValidationError('Le revenu du conjoint ne peut pas être négatif');
                    return;
                }

                // Calculate totals (all in CHF)
                const totalRevenusSuisse = totalSwissIncome + incomeSpouse;
                const totalRevenusMondial = totalRevenusSuisse + incomeForeign + rentalPrimary + rentalSecondary + incomeLmnp + incomeOther;

                // Validate total world income
                if (totalRevenusMondial <= 0) {
                    showValidationError('Le total des revenus mondiaux doit être supérieur à zéro');
                    return;
                }

                // Calculate ratio
                let ratioSuisse = (totalRevenusSuisse / totalRevenusMondial) * 100;

                // Round to 1 decimal
                ratioSuisse = Math.round(ratioSuisse * 10) / 10;

                // Show appropriate result
                document.getElementById('simulation-form').classList.add('hidden');

                if (ratioSuisse >= 90) {
                    // Update enhanced ratio display for eligible
                    updateEnhancedRatioDisplay('eligible', ratioSuisse);
                    document.getElementById('result-eligible').classList.remove('hidden');
                } else {
                    // Update enhanced ratio display for not eligible
                    updateEnhancedRatioDisplay('not-eligible', ratioSuisse);
                    document.getElementById('result-not-eligible').classList.remove('hidden');
                }

                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('Error calculating eligibility:', error);
                showValidationError('Une erreur est survenue lors du calcul. Veuillez vérifier vos données et réessayer.');
            }
        }

        // Enhanced ratio display with animations
        function updateEnhancedRatioDisplay(type, ratio) {
            const isEligible = type === 'eligible';
            const prefix = isEligible ? 'eligible' : 'not-eligible';

            // Update the old ratio display for backward compatibility
            const oldRatioElement = document.getElementById(prefix + '-ratio');
            if (oldRatioElement) {
                oldRatioElement.textContent = ratio + '%';
            }

            // Update the new enhanced ratio display
            const ratioDisplayElement = document.getElementById(prefix + '-ratio-display');
            const progressCircleElement = document.getElementById(prefix + '-progress-circle');
            const ratioTextElement = document.getElementById(prefix + '-ratio-text');

            if (ratioDisplayElement) {
                // Animate the counter
                animateCounter(ratioDisplayElement, 0, ratio, 2000);
            }

            if (progressCircleElement) {
                // Animate the progress circle
                const circumference = 2 * Math.PI * 70; // radius = 70
                const progress = (ratio / 100) * circumference;

                // Set initial state
                progressCircleElement.style.strokeDasharray = `0 ${circumference}`;

                // Animate to final state
                setTimeout(() => {
                    progressCircleElement.style.strokeDasharray = `${progress} ${circumference}`;
                }, 500);
            }

            if (ratioTextElement) {
                ratioTextElement.textContent = ratio + '%';
            }
        }

        // Animate counter from start to end value
        function animateCounter(element, start, end, duration) {
            const startTime = performance.now();
            const range = end - start;

            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Use easing function for smooth animation
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const current = start + (range * easeOutQuart);

                element.textContent = Math.round(current * 10) / 10;

                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }

            requestAnimationFrame(updateCounter);
        }

        // Update enhanced ratio display within a specific container (for multi-step form)
        function updateEnhancedRatioDisplayInContainer(container, type, ratio) {
            const ratioDisplayElement = container.querySelector('.qr-ratio-number');
            const progressCircleElement = container.querySelector('.circle-progress');

            // Removed animation class addition - circle stays static

            if (ratioDisplayElement) {
                // Animate the counter
                animateCounter(ratioDisplayElement, 0, ratio, 2000);
            }

            if (progressCircleElement) {
                // Animate the progress circle
                const circumference = 2 * Math.PI * 70; // radius = 70
                const progress = (ratio / 100) * circumference;

                // Set initial state
                progressCircleElement.style.strokeDasharray = `0 ${circumference}`;

                // Animate to final state
                setTimeout(() => {
                    progressCircleElement.style.strokeDasharray = `${progress} ${circumference}`;
                }, 500);
            }
        }

        // Show validation error message
        function showValidationError(message) {
            // Remove any existing error messages
            const existingError = document.querySelector('.validation-error');
            if (existingError) {
                existingError.remove();
            }

            // Create error message element
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error bg-red-50 border border-red-200 rounded-lg p-4 mb-4';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                    <p class="text-red-700 font-medium">${message}</p>
                </div>
            `;

            // Insert error message at the top of the form
            const form = document.getElementById('simulation-form');
            form.insertBefore(errorDiv, form.firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv && errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);

            // Scroll to show the error
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Clear validation errors
        function clearValidationErrors() {
            // Remove any existing error messages
            const existingErrors = document.querySelectorAll('.validation-error');
            existingErrors.forEach(error => error.remove());

            // Remove field highlights
            const allInputs = document.querySelectorAll('#eligibility-form input, #eligibility-form select');
            allInputs.forEach(input => {
                input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                input.classList.add('border-gray-300');
            });
        }

        // Highlight invalid form fields
        function highlightInvalidFields(fieldIds) {
            // First remove any existing highlights
            const allInputs = document.querySelectorAll('#eligibility-form input');
            allInputs.forEach(input => {
                input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            });

            // Highlight the specified invalid fields
            fieldIds.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                }
            });
        }

        // Fiscal Tools Navigation
        function showFiscalOverview() {
            // Hide all simulators
            document.getElementById('fiscal-overview').classList.remove('hidden');
            document.getElementById('quasi-resident-simulator').classList.add('hidden');
            document.getElementById('tou-simulator').classList.add('hidden');
        }

        function showQuasiResidentSimulator() {
            // Show quasi-resident simulator
            document.getElementById('fiscal-overview').classList.add('hidden');
            document.getElementById('quasi-resident-simulator').classList.remove('hidden');
            document.getElementById('tou-simulator').classList.add('hidden');

            // Reset the simulator to initial state - show form directly
            document.getElementById('simulation-form').classList.remove('hidden');
            document.getElementById('result-eligible').classList.add('hidden');
            document.getElementById('result-not-eligible').classList.add('hidden');

            // Initialize multi-step form
            qrCurrentStep = 1;
            qrUpdateStepDisplay();

            // Reset form if needed
            if (document.getElementById('eligibility-form')) {
                resetForm();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Quasi-Resident Multi-Step Form Navigation
        let qrCurrentStep = 1;
        const qrTotalSteps = 4;

        // Step configuration
        const qrStepConfig = {
            1: { progress: 25 },
            2: { progress: 50 },
            3: { progress: 75 },
            4: { progress: 100 }
        };

        function qrUpdateStepDisplay() {
            const config = qrStepConfig[qrCurrentStep];

            // Update progress bar
            const progressFill = document.getElementById('qrProgressFill');
            const progressText = document.getElementById('qrProgressText');
            const progressPercent = document.getElementById('qrProgressPercent');

            if (progressFill) progressFill.style.width = config.progress + '%';
            if (progressText) progressText.textContent = `Étape ${qrCurrentStep} sur ${qrTotalSteps}`;
            if (progressPercent) progressPercent.textContent = config.progress + '%';

            // Show/hide steps
            for (let i = 1; i <= qrTotalSteps; i++) {
                const step = document.getElementById(`qrStep${i}`);
                if (step) {
                    if (i === qrCurrentStep) {
                        step.classList.add('active');
                        step.classList.remove('hidden');
                    } else {
                        step.classList.remove('active');
                        step.classList.add('hidden');
                    }
                }
            }
        }

        function qrNextStep() {
            if (qrValidateStep(qrCurrentStep)) {
                if (qrCurrentStep < qrTotalSteps) {
                    qrCurrentStep++;
                    qrUpdateStepDisplay();
                }
            }
        }

        function qrPrevStep() {
            if (qrCurrentStep > 1) {
                qrCurrentStep--;
                qrUpdateStepDisplay();
            }
        }

        function qrGoToStep(step) {
            if (step >= 1 && step <= qrTotalSteps) {
                qrCurrentStep = step;
                qrUpdateStepDisplay();
            }
        }

        function qrValidateStep(step) {
            const requiredFields = {
                1: ['family-status'],
                2: [], // Swiss income validation will be done in calculateEligibility
                3: [] // No required fields in step 3
            };

            const fields = requiredFields[step] || [];
            let isValid = true;

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && (!field.value || field.value.trim() === '')) {
                    field.classList.add('border-red-500');
                    isValid = false;
                } else if (field) {
                    field.classList.remove('border-red-500');
                }
            });

            if (!isValid && step === 1) {
                alert('Veuillez sélectionner votre situation familiale.');
            }

            return isValid;
        }

        function qrToggleSpouseIncome() {
            const familyStatus = document.getElementById('family-status').value;
            const spouseContainer = document.getElementById('spouse-income-container');

            if (familyStatus === 'married') {
                spouseContainer.classList.remove('hidden');
            } else {
                spouseContainer.classList.add('hidden');
                // Reset spouse income when hidden
                const spouseInput = document.getElementById('income-spouse');
                if (spouseInput) spouseInput.value = '';
            }
        }

        function qrCalculateEligibility() {
            // Move to results step and calculate
            qrCurrentStep = 4;
            qrUpdateStepDisplay();

            // Show enhanced loading state
            const resultsContainer = document.getElementById('qr-results-container');
            resultsContainer.innerHTML = `
                <div class="qr-loading-container">
                    <div class="qr-loading-spinner"></div>
                    <h4 class="text-xl font-semibold text-gray-800 mb-2">Calcul en cours...</h4>
                    <p class="text-gray-600">Analyse de votre situation fiscale</p>
                </div>
            `;

            // Perform calculation after a short delay to show loading
            setTimeout(() => {
                calculateEligibility();

                // Update results container with the calculated results
                const eligibleSection = document.getElementById('result-eligible');
                const notEligibleSection = document.getElementById('result-not-eligible');

                if (eligibleSection && !eligibleSection.classList.contains('hidden')) {
                    resultsContainer.innerHTML = eligibleSection.innerHTML;

                    // Update button onclick to use qrNewSimulation for consistency
                    const newSimButton = resultsContainer.querySelector('button[onclick*="newSimulation"]');
                    if (newSimButton) {
                        newSimButton.setAttribute('onclick', 'qrNewSimulation()');
                    }

                    // Re-trigger animations for the copied content
                    setTimeout(() => {
                        const ratioElement = resultsContainer.querySelector('.qr-ratio-number');
                        const circleElement = resultsContainer.querySelector('.circle-progress');
                        if (ratioElement && circleElement) {
                            const ratio = parseFloat(ratioElement.textContent);
                            updateEnhancedRatioDisplayInContainer(resultsContainer, 'eligible', ratio);
                        }
                    }, 100);
                } else if (notEligibleSection && !notEligibleSection.classList.contains('hidden')) {
                    resultsContainer.innerHTML = notEligibleSection.innerHTML;

                    // Update button onclick to use qrNewSimulation for consistency
                    const newSimButton = resultsContainer.querySelector('button[onclick*="newSimulation"]');
                    if (newSimButton) {
                        newSimButton.setAttribute('onclick', 'qrNewSimulation()');
                    }

                    // Re-trigger animations for the copied content
                    setTimeout(() => {
                        const ratioElement = resultsContainer.querySelector('.qr-ratio-number');
                        const circleElement = resultsContainer.querySelector('.circle-progress');
                        if (ratioElement && circleElement) {
                            const ratio = parseFloat(ratioElement.textContent);
                            updateEnhancedRatioDisplayInContainer(resultsContainer, 'not-eligible', ratio);
                        }
                    }, 100);
                }
            }, 1500);
        }

        function qrNewSimulation() {
            try {
                // Reset to step 1
                qrCurrentStep = 1;
                qrUpdateStepDisplay();

                // Reset form data completely
                resetForm();

                // Clear any validation errors
                clearValidationErrors();

                // Hide original results sections
                const eligibleSection = document.getElementById('result-eligible');
                const notEligibleSection = document.getElementById('result-not-eligible');
                if (eligibleSection) eligibleSection.classList.add('hidden');
                if (notEligibleSection) notEligibleSection.classList.add('hidden');

                // Reset results container with enhanced loading state
                const resultsContainer = document.getElementById('qr-results-container');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="qr-loading-container">
                            <div class="qr-loading-spinner"></div>
                            <h4 class="text-xl font-semibold text-gray-800 mb-2">Prêt pour le calcul</h4>
                            <p class="text-gray-600">Remplissez le formulaire et cliquez sur "Calculer"</p>
                        </div>
                    `;
                }

                // Ensure the simulation form is visible and results are hidden
                const simulationForm = document.getElementById('simulation-form');
                if (simulationForm) {
                    simulationForm.classList.remove('hidden');
                }

                // Reset spouse income visibility
                const spouseContainer = document.getElementById('spouse-income-container');
                if (spouseContainer) {
                    spouseContainer.classList.add('hidden');
                }

                // Reset family status to trigger proper form state
                const familyStatusSelect = document.getElementById('family-status');
                if (familyStatusSelect) {
                    familyStatusSelect.value = '';
                    // Trigger change event to update spouse visibility
                    familyStatusSelect.dispatchEvent(new Event('change'));
                }

                // Scroll to top for better user experience
                window.scrollTo({ top: 0, behavior: 'smooth' });

                console.log('Quasi-resident simulation reset successfully');
            } catch (error) {
                console.error('Error resetting quasi-resident simulation:', error);
                // Fallback: at least try to reset to step 1
                qrCurrentStep = 1;
                if (typeof qrUpdateStepDisplay === 'function') {
                    qrUpdateStepDisplay();
                }
            }
        }

        function showTouSimulator() {
            // Show TOU simulator
            document.getElementById('fiscal-overview').classList.add('hidden');
            document.getElementById('quasi-resident-simulator').classList.add('hidden');
            document.getElementById('tou-simulator').classList.remove('hidden');
        }

        // TOU Multi-Step Form Navigation
        let touCurrentStep = 1;
        const touTotalSteps = 4;

        // Step configuration (simplified)
        const touStepConfig = {
            1: { progress: 25 },
            2: { progress: 50 },
            3: { progress: 75 },
            4: { progress: 100 }
        };

        function touUpdateStepDisplay() {
            // Update progress bar
            const progressFill = document.getElementById('touProgressFill');
            const progressText = document.getElementById('touProgressText');
            const progressPercent = document.getElementById('touProgressPercent');

            if (progressFill && touStepConfig[touCurrentStep]) {
                progressFill.style.width = touStepConfig[touCurrentStep].progress + '%';
            }

            if (progressText) {
                progressText.textContent = `Étape ${touCurrentStep} sur ${touTotalSteps}`;
            }

            if (progressPercent && touStepConfig[touCurrentStep]) {
                progressPercent.textContent = touStepConfig[touCurrentStep].progress + '%';
            }

            // Show/hide steps
            for (let i = 1; i <= touTotalSteps; i++) {
                const step = document.getElementById(`touStep${i}`);
                if (step) {
                    step.classList.remove('active');
                    if (i === touCurrentStep) {
                        step.classList.add('active');
                    }
                }
            }

            // Update navigation buttons
            const prevBtn = document.getElementById('touPrevBtn');
            const nextBtn = document.getElementById('touNextBtn');
            const calculateBtn = document.getElementById('touCalculateBtn');

            if (prevBtn) {
                prevBtn.disabled = touCurrentStep === 1;
            }

            if (nextBtn && calculateBtn) {
                if (touCurrentStep === 3) {
                    nextBtn.classList.add('hidden');
                    calculateBtn.classList.remove('hidden');
                } else if (touCurrentStep === 4) {
                    nextBtn.classList.add('hidden');
                    calculateBtn.classList.add('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    calculateBtn.classList.add('hidden');
                }
            }
        }

        function touValidateStep(step) {
            const requiredFields = {
                1: ['touCommune', 'touFamilyStatus'],
                2: ['touAnnualIncome'],
                3: [] // No required fields in step 3
            };

            const fields = requiredFields[step] || [];
            let isValid = true;

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('tou-error-border');
                    if (!field.value || field.value.trim() === '') {
                        field.classList.add('tou-error-border');
                        isValid = false;
                    }
                }
            });

            // Additional validation for children count when family status requires it
            if (step === 1) {
                const familyStatus = document.getElementById('touFamilyStatus').value;
                const childrenContainer = document.getElementById('touChildrenContainer');
                const childrenCount = document.getElementById('touChildrenCount');

                if ((familyStatus === 'divorced-with-children' || familyStatus === 'married-with-income' || familyStatus === 'married-no-income') &&
                    !childrenContainer.classList.contains('hidden')) {
                    if (!childrenCount.value || parseInt(childrenCount.value) < 0) {
                        childrenCount.classList.add('tou-error-border');
                        isValid = false;
                    } else {
                        childrenCount.classList.remove('tou-error-border');
                    }
                }
            }

            // Validation for annual income
            if (step === 2) {
                const annualIncome = document.getElementById('touAnnualIncome');
                if (annualIncome && (!annualIncome.value || parseFloat(annualIncome.value) <= 0)) {
                    annualIncome.classList.add('tou-error-border');
                    isValid = false;
                }
            }

            return isValid;
        }

        function touNextStep() {
            if (!touValidateStep(touCurrentStep)) {
                // Show validation error
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-3 mb-4 text-red-700 text-sm';
                errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Veuillez remplir tous les champs obligatoires avant de continuer.';

                const stepContent = document.getElementById(`touStep${touCurrentStep}`);
                if (stepContent) {
                    stepContent.insertBefore(errorDiv, stepContent.firstChild);
                    setTimeout(() => {
                        if (errorDiv && errorDiv.parentNode) {
                            errorDiv.parentNode.removeChild(errorDiv);
                        }
                    }, 3000);
                }
                return;
            }

            if (touCurrentStep < touTotalSteps) {
                touCurrentStep++;
                touUpdateStepDisplay();
            }
        }

        function touPreviousStep() {
            if (touCurrentStep > 1) {
                touCurrentStep--;
                touUpdateStepDisplay();
            }
        }

        function touGoToStep(step) {
            if (step >= 1 && step <= touTotalSteps) {
                touCurrentStep = step;
                touUpdateStepDisplay();
            }
        }

        // TOU Simulator JavaScript Functions
        // Currency conversion constants for TOU simulator
        const TOU_CHF_TO_EUR = 0.92;
        const TOU_EUR_TO_CHF = 1.087;

        // TOU Tax brackets data structure (Geneva 2024 rates)
        // Global variable to hold the tax brackets data loaded from JSON
        let touTaxBrackets = [];

        // A1-A5 Tax brackets data structure (Geneva 2024 rates with alimony consideration)
        // Global variable to hold the A1-A5 tax brackets data loaded from JSON
        let touA1A5TaxBrackets = [];
        let touA1A5TaxBracketsLoaded = false;

        // ===== UNIFIED DATA ARCHITECTURE - SINGLE SOURCE =====
        // All tax calculation data loaded from simulateur_tou_geneve_complete.json

        // Global data structures - populated from unified JSON
        let unifiedTaxData = null; // Complete data from simulateur_tou_geneve_complete.json
        let iccTaxBrackets = [];
        let municipalTaxRates = {};
        let ifdTaxBrackets = [];
        let socialContributionRates = {};
        let deductionData = {};
        let taxCalculationParams = {};

        // Data loading status
        let dataLoadingStatus = {
            loaded: false,
            loading: false,
            error: null,
            timestamp: null
        };

        // Embedded tax brackets data (subset for CORS fallback)
        // This contains key income brackets commonly used for calculations
        window.EMBEDDED_TAX_BRACKETS = {
            "titre_document": "Barèmes 2024 impôt à la source (subset)",
            "entite": "République et Canton de Genève",
            "date_application": "2024-01-01",
            "baremes": [
                {
                    "tranche": { "annee_fr": "0 - 28'799" },
                    "A0_seule_pourcent": 0.0,
                    "B_marie_conjoint_ne_travaille_pas": {
                        "B0_0_enfants_pourcent": 0.0, "B1_1_enfant_pourcent": 0.0, "B2_2_enfants_pourcent": 0.0,
                        "B3_3_enfants_pourcent": 0.0, "B4_4_enfants_pourcent": 0.0, "B5_5_enfants_pourcent": 0.0
                    },
                    "C_marie_2_conjoints_travaillent": {
                        "C0_0_enfants_pourcent": 0.0, "C1_1_enfant_pourcent": 0.0, "C2_2_enfants_pourcent": 0.0,
                        "C3_3_enfants_pourcent": 0.0, "C4_4_enfants_pourcent": 0.0, "C5_5_enfants_pourcent": 0.0
                    },
                    "H_famille_monoparentale": {
                        "H1_1_enfant_pourcent": 0.0, "H2_2_enfants_pourcent": 0.0, "H3_3_enfants_pourcent": 0.0,
                        "H4_4_enfants_pourcent": 0.0, "H5_5_enfants_pourcent": 0.0
                    }
                },
                {
                    "tranche": { "annee_fr": "30'000 - 30'599" },
                    "A0_seule_pourcent": 0.5,
                    "B_marie_conjoint_ne_travaille_pas": {
                        "B0_0_enfants_pourcent": 0.0, "B1_1_enfant_pourcent": 0.4, "B2_2_enfants_pourcent": 0.4,
                        "B3_3_enfants_pourcent": 0.0, "B4_4_enfants_pourcent": 0.0, "B5_5_enfants_pourcent": 0.0
                    },
                    "C_marie_2_conjoints_travaillent": {
                        "C0_0_enfants_pourcent": 0.6, "C1_1_enfant_pourcent": 0.5, "C2_2_enfants_pourcent": 0.0,
                        "C3_3_enfants_pourcent": 0.0, "C4_4_enfants_pourcent": 0.0, "C5_5_enfants_pourcent": 0.0
                    },
                    "H_famille_monoparentale": {
                        "H1_1_enfant_pourcent": 0.4, "H2_2_enfants_pourcent": 0.3, "H3_3_enfants_pourcent": 0.0,
                        "H4_4_enfants_pourcent": 0.0, "H5_5_enfants_pourcent": 0.0
                    }
                },
                {
                    "tranche": { "annee_fr": "50'000 - 50'599" },
                    "A0_seule_pourcent": 5.8,
                    "B_marie_conjoint_ne_travaille_pas": {
                        "B0_0_enfants_pourcent": 1.8, "B1_1_enfant_pourcent": 1.1, "B2_2_enfants_pourcent": 0.5,
                        "B3_3_enfants_pourcent": 0.0, "B4_4_enfants_pourcent": 0.0, "B5_5_enfants_pourcent": 0.0
                    },
                    "C_marie_2_conjoints_travaillent": {
                        "C0_0_enfants_pourcent": 5.3, "C1_1_enfant_pourcent": 4.6, "C2_2_enfants_pourcent": 3.9,
                        "C3_3_enfants_pourcent": 3.2, "C4_4_enfants_pourcent": 2.5, "C5_5_enfants_pourcent": 1.8
                    },
                    "H_famille_monoparentale": {
                        "H1_1_enfant_pourcent": 1.1, "H2_2_enfants_pourcent": 0.5, "H3_3_enfants_pourcent": 0.0,
                        "H4_4_enfants_pourcent": 0.0, "H5_5_enfants_pourcent": 0.0
                    }
                },
                {
                    "tranche": { "annee_fr": "79'800 - 80'399" },
                    "A0_seule_pourcent": 12.79,
                    "B_marie_conjoint_ne_travaille_pas": {
                        "B0_0_enfants_pourcent": 3.79, "B1_1_enfant_pourcent": 0.40, "B2_2_enfants_pourcent": 0.0,
                        "B3_3_enfants_pourcent": 0.0, "B4_4_enfants_pourcent": 0.0, "B5_5_enfants_pourcent": 0.0
                    },
                    "C_marie_2_conjoints_travaillent": {
                        "C0_0_enfants_pourcent": 12.14, "C1_1_enfant_pourcent": 9.15, "C2_2_enfants_pourcent": 6.26,
                        "C3_3_enfants_pourcent": 3.57, "C4_4_enfants_pourcent": 1.48, "C5_5_enfants_pourcent": 0.0
                    },
                    "H_famille_monoparentale": {
                        "H1_1_enfant_pourcent": 1.57, "H2_2_enfants_pourcent": 0.0, "H3_3_enfants_pourcent": 0.0,
                        "H4_4_enfants_pourcent": 0.0, "H5_5_enfants_pourcent": 0.0
                    }
                },
                {
                    "tranche": { "annee_fr": "100'000 - 100'599" },
                    "A0_seule_pourcent": 15.8,
                    "B_marie_conjoint_ne_travaille_pas": {
                        "B0_0_enfants_pourcent": 7.8, "B1_1_enfant_pourcent": 5.1, "B2_2_enfants_pourcent": 2.4,
                        "B3_3_enfants_pourcent": 0.0, "B4_4_enfants_pourcent": 0.0, "B5_5_enfants_pourcent": 0.0
                    },
                    "C_marie_2_conjoints_travaillent": {
                        "C0_0_enfants_pourcent": 15.15, "C1_1_enfant_pourcent": 12.16, "C2_2_enfants_pourcent": 9.27,
                        "C3_3_enfants_pourcent": 6.58, "C4_4_enfants_pourcent": 4.49, "C5_5_enfants_pourcent": 2.90
                    },
                    "H_famille_monoparentale": {
                        "H1_1_enfant_pourcent": 6.18, "H2_2_enfants_pourcent": 3.51, "H3_3_enfants_pourcent": 1.42,
                        "H4_4_enfants_pourcent": 0.0, "H5_5_enfants_pourcent": 0.0
                    }
                }
            ]
        };





        // ===== LEGACY EMBEDDED DATA REMOVED =====
        // All embedded fallback functions removed - using unified data source only





        // IFD tax brackets now declared in unified data section above

        // ===== DEDUCTION OPTIMIZATION MODULE =====
        // This module computes both forfaitaire and réelles deductions and selects the best option

        /**
         * Optimize deductions by computing both forfaitaire and réelles options - PHASE 2 ENHANCEMENT
         * Now compares actual tax burden instead of taxable income for true optimization
         * @param {Object} profil - Tax profile with income and deduction details
         * @param {Object} options - Additional options for calculation
         * @returns {Object} Optimization result with best choice and comparison
         */
        function optimizeDeductions(profil, options = {}) {
            console.log('🔍 [OPTIMIZE ENHANCED] Computing advanced deduction optimization...');

            try {
                // Compute forfaitaire deductions
                const forfaitResult = calculerDeductionsComprehensives(profil, { type: 'forfaitaire' });
                console.log('📊 [OPTIMIZE] Forfaitaire result:', forfaitResult);

                // Compute réelles deductions
                const reellesResult = calculerDeductionsComprehensives(profil, { type: 'reel' });
                console.log('📊 [OPTIMIZE] Réelles result:', reellesResult);

                // PHASE 2 ENHANCEMENT: Calculate actual tax burden for both scenarios
                const forfaitTaxes = calculateTotalTaxBurden(profil, forfaitResult);
                const reellesTaxes = calculateTotalTaxBurden(profil, reellesResult);

                console.log(`💰 [OPTIMIZE] Tax burden comparison:
                    - Forfaitaire: ICC=${formatCurrency(forfaitTaxes.icc)} + IFD=${formatCurrency(forfaitTaxes.ifd)} = ${formatCurrency(forfaitTaxes.total)}
                    - Réelles: ICC=${formatCurrency(reellesTaxes.icc)} + IFD=${formatCurrency(reellesTaxes.ifd)} = ${formatCurrency(reellesTaxes.total)}`);

                // Compare total tax burden (lower = better for taxpayer)
                const totalSavings = forfaitTaxes.total - reellesTaxes.total;
                const iccSavings = forfaitTaxes.icc - reellesTaxes.icc;
                const ifdSavings = forfaitTaxes.ifd - reellesTaxes.ifd;

                // Administrative burden consideration
                const administrativeBurden = calculateAdministrativeBurden(reellesResult);
                const threshold = 100; // Minimum savings to justify administrative burden

                // Determine best option considering both savings and administrative cost
                const netSavings = totalSavings - administrativeBurden;
                const recommendedType = netSavings > threshold ? 'reelles' : 'forfaitaire';

                console.log(`✅ [OPTIMIZE] Enhanced analysis:
                    - Total tax savings: ${formatCurrency(totalSavings)}
                    - Administrative burden: ${formatCurrency(administrativeBurden)}
                    - Net benefit: ${formatCurrency(netSavings)}
                    - Recommendation: ${recommendedType} (threshold: ${formatCurrency(threshold)})`);

                return {
                    forfaitaire: {
                        result: forfaitResult,
                        taxes: forfaitTaxes
                    },
                    reelles: {
                        result: reellesResult,
                        taxes: reellesTaxes
                    },
                    analysis: {
                        totalSavings,
                        iccSavings,
                        ifdSavings,
                        administrativeBurden,
                        netSavings,
                        threshold
                    },
                    recommended: recommendedType === 'reelles' ? reellesResult : forfaitResult,
                    recommendedType,
                    confidence: Math.abs(netSavings) > threshold ? 'high' : 'low'
                };

            } catch (error) {
                console.error('❌ [OPTIMIZE] Enhanced deduction optimization failed:', error);

                // Enhanced fallback with better error handling
                try {
                    const forfaitResult = calculerDeductionsComprehensives(profil, { type: 'forfaitaire' });
                    return {
                        forfaitaire: { result: forfaitResult, taxes: { icc: 0, ifd: 0, total: 0 } },
                        reelles: { result: null, taxes: null },
                        analysis: { totalSavings: 0, netSavings: 0, threshold: 100, iccSavings: 0, ifdSavings: 0, administrativeBurden: 0 },
                        recommended: forfaitResult,
                        recommendedType: 'forfaitaire',
                        confidence: 'low',
                        error: error.message
                    };
                } catch (fallbackError) {
                    console.error('❌ [OPTIMIZE] Fallback also failed:', fallbackError);
                    return {
                        forfaitaire: { result: null, taxes: null },
                        reelles: { result: null, taxes: null },
                        analysis: { totalSavings: 0, netSavings: 0, threshold: 100, iccSavings: 0, ifdSavings: 0, administrativeBurden: 0 },
                        recommended: null,
                        recommendedType: 'forfaitaire',
                        confidence: 'none',
                        error: `Primary: ${error.message}, Fallback: ${fallbackError.message}`
                    };
                }
            }
        }

        /**
         * Calculate total tax burden for a given deduction scenario - PHASE 2 ENHANCEMENT
         * @param {Object} profil - Tax profile
         * @param {Object} deductionResult - Deduction calculation result
         * @returns {Object} Tax burden breakdown
         */
        function calculateTotalTaxBurden(profil, deductionResult) {
            try {
                // Enhanced validation and debugging
                console.log(`💰 [TAX BURDEN] Input validation:
                    - Profil income: ${profil.revenu_brut_determinant} (type: ${typeof profil.revenu_brut_determinant})
                    - Deduction ICC: ${deductionResult.ICC?.total_deductions_sur_revenu}
                    - Family status: ${profil.statut_familial || profil.etat_civil}
                    - Commune: ${profil.commune}`);

                // Validate inputs
                if (!profil.revenu_brut_determinant || isNaN(profil.revenu_brut_determinant)) {
                    throw new Error(`Invalid income in profile: ${profil.revenu_brut_determinant}`);
                }

                if (!deductionResult || !deductionResult.ICC || typeof deductionResult.ICC.total_deductions_sur_revenu === 'undefined') {
                    throw new Error(`Invalid deduction result: ${JSON.stringify(deductionResult)}`);
                }

                // Extract deduction amounts from the correct structure
                const iccDeductions = deductionResult.ICC.total_deductions_sur_revenu || 0;
                const ifdDeductions = deductionResult.IFD?.total_deductions_sur_revenu || 0;

                // Calculate ICC tax
                const iccNetIncome = profil.revenu_brut_determinant - iccDeductions;
                const iccResult = calculateIccFinalTax(iccNetIncome, profil.statut_familial || profil.etat_civil, profil.commune);
                const iccTax = iccResult.impotTotalDu || 0;

                // Calculate IFD tax (simplified - would need actual IFD calculation function)
                const ifdNetIncome = profil.revenu_brut_determinant - ifdDeductions;
                const ifdTax = calculateIfdTaxEstimate(ifdNetIncome, profil.statut_familial || profil.etat_civil);

                const totalTax = iccTax + ifdTax;

                console.log(`💰 [TAX BURDEN] ICC: ${formatCurrency(iccTax)}, IFD: ${formatCurrency(ifdTax)}, Total: ${formatCurrency(totalTax)}`);

                return {
                    icc: iccTax,
                    ifd: ifdTax,
                    total: totalTax,
                    details: {
                        iccNetIncome,
                        ifdNetIncome,
                        iccResult
                    }
                };
            } catch (error) {
                console.error('❌ [TAX BURDEN] Calculation failed:', error);
                return { icc: 0, ifd: 0, total: 0, error: error.message };
            }
        }

        /**
         * Estimate IFD tax burden - SIMPLIFIED FOR OPTIMIZATION
         * @param {number} netIncome - Net taxable income
         * @param {string} familyStatus - Family status
         * @returns {number} Estimated IFD tax
         */
        function calculateIfdTaxEstimate(netIncome, familyStatus) {
            // Simplified IFD calculation for optimization purposes
            // In production, this would use the full IFD calculation
            const baseRate = familyStatus === 'celibataire' ? 0.08 : 0.06; // Simplified rates
            const exemption = familyStatus === 'celibataire' ? 15000 : 25000;
            const taxableIncome = Math.max(0, netIncome - exemption);
            return taxableIncome * baseRate;
        }

        /**
         * Calculate administrative burden for réelles deductions - PHASE 2 ENHANCEMENT
         * @param {Object} reellesResult - Réelles deduction result
         * @returns {number} Estimated administrative cost in CHF
         */
        function calculateAdministrativeBurden(reellesResult) {
            // Estimate administrative burden based on complexity
            let burden = 0;

            // Base cost for maintaining records
            burden += 50;

            // Additional cost per deduction category
            const categories = [
                'frais_professionnels',
                'frais_formation',
                'frais_transport',
                'assurances',
                'interets_dettes'
            ];

            categories.forEach(category => {
                if (reellesResult[category] && reellesResult[category] > 0) {
                    burden += 20; // CHF per category
                }
            });

            // Additional cost for complex deductions
            if (reellesResult.ICC?.total_deductions_sur_revenu > 10000) {
                burden += 30; // Higher complexity
            }

            console.log(`📋 [ADMIN BURDEN] Estimated administrative cost: ${formatCurrency(burden)}`);
            return burden;
        }

        // ===== TAX VALIDATION MODULE - PHASE 1 CRITICAL FIX =====
        const TaxValidation = {
            validateInputs: function(income, commune, familyStatus, children = 0) {
                const errors = [];

                // Income validation with Swiss tax law limits
                if (!income || isNaN(income)) {
                    errors.push('Le revenu doit être un nombre valide');
                } else if (income < 0) {
                    errors.push('Le revenu ne peut pas être négatif');
                } else if (income > 50000000) {
                    errors.push('Le revenu dépasse la limite maximale (50M CHF)');
                }

                // Commune validation against 2025 list - FIXED FOR ROBUSTNESS
                const validCommunes = Object.keys(municipalTaxRates || {});

                // If municipal rates aren't loaded yet, use a basic validation
                if (validCommunes.length === 0) {
                    // Basic commune validation when data not loaded
                    if (!commune || typeof commune !== 'string' || commune.trim().length === 0) {
                        errors.push('Commune requise');
                    }
                } else {
                    // Full validation when data is loaded
                    const normalizedCommune = commune?.toUpperCase().trim();
                    if (!commune || !validCommunes.includes(normalizedCommune)) {
                        const communeList = validCommunes.length > 5
                            ? validCommunes.slice(0, 5).join(', ') + '...'
                            : validCommunes.join(', ');
                        errors.push(`Commune invalide. Communes valides: ${communeList}`);
                    }
                }

                // Family status validation
                const validStatuses = ['celibataire', 'marie_splitting', 'splitting_partiel', 'famille_monoparentale', 'garde_alternee'];
                if (!familyStatus || !validStatuses.includes(familyStatus)) {
                    errors.push(`Statut familial invalide. Statuts valides: ${validStatuses.join(', ')}`);
                }

                // Children validation
                if (children < 0 || children > 20) {
                    errors.push('Le nombre d\'enfants doit être entre 0 et 20');
                }

                return {
                    isValid: errors.length === 0,
                    errors,
                    warnings: this.generateWarnings(income, commune, familyStatus, children)
                };
            },

            generateWarnings: function(income, commune, familyStatus, children) {
                const warnings = [];

                // High income warning
                if (income > 1000000) {
                    warnings.push('Revenu élevé: considérez la taxation forfaitaire');
                }

                // Municipal rate warning
                const municipalRate = municipalTaxRates[commune?.toUpperCase()];
                if (municipalRate && municipalRate > 45) {
                    warnings.push(`Taux communal élevé (${municipalRate}%): considérez un déménagement fiscal`);
                }

                // Splitting opportunity warning
                if (familyStatus === 'celibataire' && children > 0) {
                    warnings.push('Vérifiez votre éligibilité au splitting partiel (garde alternée)');
                }

                return warnings;
            },

            validateTaxData: function() {
                const issues = [];

                // Validate ICC brackets
                if (!iccTaxBrackets || iccTaxBrackets.length !== 18) {
                    issues.push(`ICC brackets: ${iccTaxBrackets?.length || 0}/18 tranches chargées`);
                }

                // Validate municipal rates
                const communeCount = Object.keys(municipalTaxRates || {}).length;
                if (communeCount !== 44) {
                    issues.push(`Taux communaux: ${communeCount}/44 communes chargées`);
                }

                // Validate bracket continuity
                if (iccTaxBrackets && iccTaxBrackets.length > 1) {
                    for (let i = 1; i < iccTaxBrackets.length; i++) {
                        const prev = iccTaxBrackets[i-1];
                        const curr = iccTaxBrackets[i];
                        if (prev.revenu_max !== "plus" && prev.revenu_max + 1 !== curr.revenu_min) {
                            issues.push(`Discontinuité détectée: tranche ${i-1} (${prev.revenu_max}) -> tranche ${i} (${curr.revenu_min})`);
                        }
                    }
                }

                return {
                    isValid: issues.length === 0,
                    issues,
                    dataIntegrity: issues.length === 0 ? 'VALID' : 'COMPROMISED'
                };
            }
        };

        /**
         * Get splitting coefficient for family status - REFACTORED FOR ACCURACY
         * @param {string} statutFiscal - Family status
         * @returns {number} Splitting coefficient
         */
        function getSplittingCoefficient(statutFiscal) {
            const coefficients = {
                'celibataire': 1.0,
                'single': 1.0,                    // English equivalent of celibataire
                'marie': 0.5,                     // Basic married status (full splitting)
                'marie_splitting': 0.5,           // Full splitting: divide by 2
                'married': 0.5,                   // English equivalent of marie_splitting
                'married-no-income': 0.5,         // Married with non-working spouse (full splitting)
                'married-with-income': 0.5,       // Married with both working (full splitting)
                'splitting_partiel': 0.5556,      // Partial splitting: divide by 1.8 (1/1.8 = 0.5556)
                'famille_monoparentale': 0.5,
                'single_parent': 0.5,             // English equivalent of famille_monoparentale
                'divorced-with-children': 0.5,    // Single parent (divorced with children)
                'divorced-single': 1.0,           // Divorced without children (like single)
                'widow': 0.5,                     // Widow with potential children (single parent treatment)
                'garde_alternee': 0.5556
            };

            const coeff = coefficients[statutFiscal];
            if (coeff === undefined) {
                console.warn(`⚠️ [SPLITTING] Unknown family status: ${statutFiscal}, defaulting to 1.0`);
                return 1.0;
            }

            console.log(`📊 [SPLITTING] Status: ${statutFiscal}, Coefficient: ${coeff}`);
            return coeff;
        }

        /**
         * Create zero tax result for cases with no tax due
         * @param {Object} baseTaxResult - Base tax calculation result
         * @returns {Object} Zero tax result
         */
        function createZeroTaxResult(baseTaxResult) {
            return {
                impotDeBase: 0,
                reductionBase: 0,
                impotApresReduction: 0,
                centimesCantonaux: 0,
                centimeAideDomicile: 0,
                tauxCommunal: 0,
                centimesCommunaux: 0,
                impotTotalDu: 0,
                splittingDetails: baseTaxResult,
                reformeAppliquee: '2025',
                details: 'No tax due - income below threshold'
            };
        }

        /**
         * Get municipal rate with validation - UNIFIED DATA SOURCE ONLY
         * @param {string} commune - Commune name
         * @param {number} anneeFiscale - Tax year (ignored - unified data is current)
         * @returns {number} Municipal tax rate
         */
        function getMunicipalRateValidated(commune, anneeFiscale) {
            console.log(`🏛️ [MUNICIPAL] Looking up rate for: "${commune}"`);

            // Validate that unified data is loaded
            if (!dataLoadingStatus.loaded || !municipalTaxRates || Object.keys(municipalTaxRates).length === 0) {
                console.error('❌ [MUNICIPAL] Unified tax data not loaded or municipal rates empty');
                console.log('🔍 [MUNICIPAL] Debug info:', {
                    dataLoaded: dataLoadingStatus.loaded,
                    municipalRatesExists: !!municipalTaxRates,
                    municipalRatesCount: municipalTaxRates ? Object.keys(municipalTaxRates).length : 0
                });
                throw new Error('Tax data not loaded or municipal rates empty. Please ensure loadUnifiedTaxData() is called first.');
            }

            // Normalize commune name
            const communeKey = normalizeCommuneName(commune);

            // Direct lookup in unified data
            const rate = municipalTaxRates[communeKey];

            if (rate !== undefined) {
                console.log(`✅ [MUNICIPAL] Found rate for ${commune}: ${rate}%`);
                return rate;
            } else {
                // Fuzzy matching for typos
                const fuzzyMatch = findBestCommuneMatch(communeKey, Object.keys(municipalTaxRates));

                if (fuzzyMatch.score > 0.7) { // 70% similarity threshold
                    const fuzzyRate = municipalTaxRates[fuzzyMatch.key];
                    console.warn(`⚠️ [MUNICIPAL] Fuzzy match: "${commune}" -> "${fuzzyMatch.key}" (${fuzzyRate}%, similarity: ${(fuzzyMatch.score * 100).toFixed(1)}%)`);
                    return fuzzyRate;
                } else {
                    console.error(`❌ [MUNICIPAL] Commune not found: "${commune}" (normalized: "${communeKey}"), using Geneva default`);
                    console.log(`🔍 [MUNICIPAL] Available communes (first 10):`, Object.keys(municipalTaxRates).slice(0, 10));
                    console.log(`🔍 [MUNICIPAL] Total communes loaded:`, Object.keys(municipalTaxRates).length);
                    return 45.49; // Geneva default
                }
            }
        }

        /**
         * Normalize commune name for consistent matching - PHASE 2 ENHANCEMENT
         * @param {string} commune - Raw commune name
         * @returns {string} Normalized commune name
         */
        function normalizeCommuneName(commune) {
            let normalized = commune.toUpperCase()
                                   .trim()
                                   .replace(/[ÀÁÂÄàáâä]/g, 'A')
                                   .replace(/[ÈÉÊËèéêë]/g, 'E')
                                   .replace(/[ÌÍÎÏìíîï]/g, 'I')
                                   .replace(/[ÒÓÔÖòóôö]/g, 'O')
                                   .replace(/[ÙÚÛÜùúûü]/g, 'U')
                                   .replace(/[Ññ]/g, 'N')
                                   .replace(/[Çç]/g, 'C')
                                   .replace(/œ/g, 'OE')
                                   .replace(/Œ/g, 'OE')
                                   .replace(/VILLE DE /g, '') // Remove "VILLE DE " prefix
                                   .replace(/[^A-Z0-9\s-]/g, '') // Remove special characters
                                   .replace(/\s+/g, ' ') // Normalize spaces
                                   .replace(/[-\s]/g, '-'); // Normalize spaces and hyphens

            // Special case for Geneva - always return "GENEVE"
            if (normalized === 'GENEVE' || normalized === 'VILLE-DE-GENEVE' || commune.toLowerCase().includes('genève')) {
                return 'GENEVE';
            }

            return normalized;
        }

        /**
         * Find best commune match using fuzzy string matching - PHASE 2 ENHANCEMENT
         * @param {string} target - Target commune name
         * @param {Array} candidates - Array of candidate commune names
         * @returns {Object} Best match with score
         */
        function findBestCommuneMatch(target, candidates) {
            let bestMatch = { key: null, score: 0 };

            for (const candidate of candidates) {
                const score = calculateStringSimilarity(target, candidate);

                if (score > bestMatch.score) {
                    bestMatch = { key: candidate, score };
                }
            }

            return bestMatch;
        }

        /**
         * Calculate string similarity using Levenshtein distance - PHASE 2 ENHANCEMENT
         * @param {string} str1 - First string
         * @param {string} str2 - Second string
         * @returns {number} Similarity score (0-1)
         */
        function calculateStringSimilarity(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;

            if (len1 === 0) return len2 === 0 ? 1 : 0;
            if (len2 === 0) return 0;

            // Create matrix
            const matrix = Array(len1 + 1).fill().map(() => Array(len2 + 1).fill(0));

            // Initialize first row and column
            for (let i = 0; i <= len1; i++) matrix[i][0] = i;
            for (let j = 0; j <= len2; j++) matrix[0][j] = j;

            // Fill matrix
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,     // deletion
                        matrix[i][j - 1] + 1,     // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }

            // Convert distance to similarity score
            const maxLen = Math.max(len1, len2);
            const distance = matrix[len1][len2];
            return 1 - (distance / maxLen);
        }

        /**
         * Update the deduction comparison panel in the results
         * @param {Object} optimizationResult - Result from optimizeDeductions function
         */
        function touUpdateDeductionComparisonPanel(optimizationResult) {
            console.log('📊 [COMPARISON] Updating deduction comparison panel');

            const comparisonSection = document.getElementById('touDeductionComparisonSection');
            if (!comparisonSection || !optimizationResult) {
                console.warn('⚠️ [COMPARISON] Comparison section not found or no optimization result');
                return;
            }

            // Show the comparison section
            comparisonSection.classList.remove('hidden');

            // Update recommendation
            const recommendationEl = document.getElementById('touOptimizationRecommendation');
            if (recommendationEl) {
                const recommendedText = optimizationResult.recommendedType === 'reelles' ? 'Frais réels' : 'Déductions forfaitaires';
                recommendationEl.innerHTML = `<i class="fas fa-lightbulb mr-1"></i>Recommandation: ${recommendedText}`;
            }

            // Update forfaitaire values
            const forfaitResult = optimizationResult.forfaitaire;
            if (forfaitResult && forfaitResult.result) {
                document.getElementById('touForfaitIcc').textContent = formatCurrency(forfaitResult.result.ICC?.total_deductions_sur_revenu || 0);
                document.getElementById('touForfaitIfd').textContent = formatCurrency(forfaitResult.result.IFD?.total_deductions_sur_revenu || 0);
                document.getElementById('touForfaitNetIncome').textContent = formatCurrency(
                    (forfaitResult.netIncome?.icc || 0) + (forfaitResult.netIncome?.ifd || 0)
                );
            }

            // Update réelles values
            const reellesResult = optimizationResult.reelles;
            if (reellesResult && reellesResult.result) {
                document.getElementById('touReellesIcc').textContent = formatCurrency(reellesResult.result.ICC?.total_deductions_sur_revenu || 0);
                document.getElementById('touReellesIfd').textContent = formatCurrency(reellesResult.result.IFD?.total_deductions_sur_revenu || 0);
                document.getElementById('touReellesNetIncome').textContent = formatCurrency(
                    (reellesResult.netIncome?.icc || 0) + (reellesResult.netIncome?.ifd || 0)
                );
            }

            // Update savings
            const savingsEl = document.getElementById('touOptimizationSavings');
            if (savingsEl && optimizationResult.savings) {
                savingsEl.textContent = formatCurrency(optimizationResult.savings.total);
            }

            // Add toggle functionality if not already added
            const toggleButton = document.getElementById('touDeductionComparisonToggle');
            const breakdownDiv = document.getElementById('touDeductionComparisonBreakdown');

            if (toggleButton && breakdownDiv && !toggleButton.hasAttribute('data-initialized')) {
                toggleButton.setAttribute('data-initialized', 'true');
                toggleButton.addEventListener('click', function() {
                    const isHidden = breakdownDiv.classList.contains('hidden');
                    const toggleText = toggleButton.querySelector('span');
                    const toggleIcon = toggleButton.querySelector('svg');

                    if (isHidden) {
                        breakdownDiv.classList.remove('hidden');
                        toggleText.textContent = 'Masquer';
                        toggleIcon.style.transform = 'rotate(180deg)';
                    } else {
                        breakdownDiv.classList.add('hidden');
                        toggleText.textContent = 'Afficher';
                        toggleIcon.style.transform = 'rotate(0deg)';
                    }
                });
            }

            console.log('✅ [COMPARISON] Deduction comparison panel updated');
        }

        // ===== CROSS-VALIDATION FRAMEWORK - PHASE 2 ENHANCEMENT =====
        const CrossValidation = {
            /**
             * Known test cases for validation against official calculators
             */
            testCases: [
                {
                    name: "Single taxpayer, middle income",
                    profile: {
                        revenu_brut_determinant: 80000,
                        statut_familial: 'celibataire',
                        commune: 'GENEVE',
                        nombre_enfants: 0
                    },
                    expected: {
                        icc_base: 4200, // Approximate expected values
                        icc_total: 6100,
                        tolerance: 0.02 // 2% tolerance
                    }
                },
                {
                    name: "Married couple, high income",
                    profile: {
                        revenu_brut_determinant: 150000,
                        statut_familial: 'marie_splitting',
                        commune: 'CAROUGE',
                        nombre_enfants: 2
                    },
                    expected: {
                        icc_base: 6800,
                        icc_total: 9500,
                        tolerance: 0.02
                    }
                },
                {
                    name: "Partial splitting, moderate income",
                    profile: {
                        revenu_brut_determinant: 100000,
                        statut_familial: 'splitting_partiel',
                        commune: 'VANDOEUVRES',
                        nombre_enfants: 1
                    },
                    expected: {
                        icc_base: 4800,
                        icc_total: 6200,
                        tolerance: 0.02
                    }
                }
            ],

            /**
             * Run validation tests against known cases
             * @returns {Object} Validation results
             */
            runValidationTests: function() {
                console.log('🧪 [CROSS-VALIDATION] Running validation tests...');

                const results = {
                    totalTests: this.testCases.length,
                    passed: 0,
                    failed: 0,
                    details: []
                };

                this.testCases.forEach((testCase, index) => {
                    try {
                        console.log(`🧪 [TEST ${index + 1}] ${testCase.name}`);

                        // Run calculation
                        const baseTaxResult = calculateIccBaseTax(
                            testCase.profile.revenu_brut_determinant,
                            testCase.profile.statut_familial
                        );

                        const finalTaxResult = calculateIccFinalTax(
                            testCase.profile.revenu_brut_determinant,
                            testCase.profile.statut_familial,
                            testCase.profile.commune
                        );

                        // Validate results
                        const baseError = Math.abs(baseTaxResult.impotDeBase - testCase.expected.icc_base) / testCase.expected.icc_base;
                        const totalError = Math.abs(finalTaxResult.impotTotalDu - testCase.expected.icc_total) / testCase.expected.icc_total;

                        const basePassed = baseError <= testCase.expected.tolerance;
                        const totalPassed = totalError <= testCase.expected.tolerance;
                        const testPassed = basePassed && totalPassed;

                        if (testPassed) {
                            results.passed++;
                        } else {
                            results.failed++;
                        }

                        results.details.push({
                            name: testCase.name,
                            passed: testPassed,
                            baseError: baseError * 100,
                            totalError: totalError * 100,
                            actual: {
                                base: baseTaxResult.impotDeBase,
                                total: finalTaxResult.impotTotalDu
                            },
                            expected: testCase.expected
                        });

                        console.log(`${testPassed ? '✅' : '❌'} [TEST ${index + 1}] ${testCase.name}: Base error: ${(baseError * 100).toFixed(2)}%, Total error: ${(totalError * 100).toFixed(2)}%`);

                    } catch (error) {
                        console.error(`❌ [TEST ${index + 1}] Failed: ${error.message}`);
                        results.failed++;
                        results.details.push({
                            name: testCase.name,
                            passed: false,
                            error: error.message
                        });
                    }
                });

                const successRate = (results.passed / results.totalTests) * 100;
                console.log(`🧪 [CROSS-VALIDATION] Results: ${results.passed}/${results.totalTests} passed (${successRate.toFixed(1)}%)`);

                return results;
            },

            /**
             * Validate against bracket boundaries
             * @returns {Object} Boundary validation results
             */
            validateBracketBoundaries: function() {
                console.log('🎯 [BOUNDARY-VALIDATION] Testing bracket boundaries...');

                const boundaryTests = [
                    18479, 18480, // First bracket boundary
                    22264, 22265, // Second bracket boundary
                    27273, 27274, // Third bracket boundary
                    50000, 100000, 200000 // Various income levels
                ];

                const results = [];

                boundaryTests.forEach(income => {
                    try {
                        const result = calculateIccBaseTax(income, 'celibataire');
                        results.push({
                            income,
                            tax: result.impotDeBase,
                            bracket: result.details?.bracket?.revenu_min + '-' + result.details?.bracket?.revenu_max,
                            valid: result.impotDeBase >= 0
                        });

                        console.log(`🎯 [BOUNDARY] ${formatCurrency(income)} -> ${formatCurrency(result.impotDeBase)} (${result.details?.bracket?.revenu_min}-${result.details?.bracket?.revenu_max})`);
                    } catch (error) {
                        console.error(`❌ [BOUNDARY] Failed for ${formatCurrency(income)}: ${error.message}`);
                        results.push({
                            income,
                            error: error.message,
                            valid: false
                        });
                    }
                });

                return results;
            }
        };

        // ===== ERROR HANDLING & RECOVERY MODULE - PHASE 3 ROBUSTNESS =====
        const ErrorHandler = {
            /**
             * Error types and their severity levels
             */
            ErrorTypes: {
                VALIDATION: { level: 'warning', recoverable: true },
                CALCULATION: { level: 'error', recoverable: true },
                DATA_INTEGRITY: { level: 'critical', recoverable: false },
                SYSTEM: { level: 'critical', recoverable: false }
            },

            /**
             * Handle errors with graceful degradation
             * @param {Error} error - The error object
             * @param {string} context - Context where error occurred
             * @param {Object} fallbackData - Fallback data for recovery
             * @returns {Object} Recovery result
             */
            handleError: function(error, context, fallbackData = null) {
                const errorInfo = {
                    message: error.message,
                    context,
                    timestamp: new Date().toISOString(),
                    stack: error.stack
                };

                console.error(`❌ [ERROR] ${context}: ${error.message}`);

                // Determine error type and recovery strategy
                const errorType = this.classifyError(error, context);
                const recovery = this.attemptRecovery(errorType, context, fallbackData);

                // Log error for monitoring
                this.logError(errorInfo, errorType, recovery);

                return {
                    success: recovery.success,
                    data: recovery.data,
                    error: errorInfo,
                    recovery: recovery.strategy,
                    userMessage: this.generateUserMessage(errorType, recovery)
                };
            },

            /**
             * Classify error type based on context and message
             * @param {Error} error - The error object
             * @param {string} context - Error context
             * @returns {Object} Error classification
             */
            classifyError: function(error, context) {
                if (context.includes('validation') || error.message.includes('invalid')) {
                    return this.ErrorTypes.VALIDATION;
                } else if (context.includes('calculation') || context.includes('tax')) {
                    return this.ErrorTypes.CALCULATION;
                } else if (context.includes('data') || error.message.includes('bracket')) {
                    return this.ErrorTypes.DATA_INTEGRITY;
                } else {
                    return this.ErrorTypes.SYSTEM;
                }
            },

            /**
             * Attempt error recovery based on type
             * @param {Object} errorType - Error type classification
             * @param {string} context - Error context
             * @param {Object} fallbackData - Fallback data
             * @returns {Object} Recovery result
             */
            attemptRecovery: function(errorType, context, fallbackData) {
                if (!errorType.recoverable) {
                    return {
                        success: false,
                        strategy: 'none',
                        data: null
                    };
                }

                // Recovery strategies by context
                if (context.includes('municipal')) {
                    return {
                        success: true,
                        strategy: 'default_rate',
                        data: { municipalRate: 45.49 } // Geneva default
                    };
                } else if (context.includes('deduction')) {
                    return {
                        success: true,
                        strategy: 'forfaitaire_fallback',
                        data: fallbackData || { type: 'forfaitaire' }
                    };
                } else if (context.includes('splitting')) {
                    return {
                        success: true,
                        strategy: 'no_splitting',
                        data: { coefficient: 1.0 }
                    };
                } else {
                    return {
                        success: false,
                        strategy: 'unknown',
                        data: null
                    };
                }
            },

            /**
             * Generate user-friendly error message
             * @param {Object} errorType - Error type
             * @param {Object} recovery - Recovery result
             * @returns {string} User message
             */
            generateUserMessage: function(errorType, recovery) {
                if (recovery.success) {
                    switch (recovery.strategy) {
                        case 'default_rate':
                            return 'Commune non trouvée, utilisation du taux de Genève par défaut.';
                        case 'forfaitaire_fallback':
                            return 'Erreur dans le calcul des déductions réelles, utilisation des déductions forfaitaires.';
                        case 'no_splitting':
                            return 'Erreur dans le calcul du splitting, calcul sans splitting appliqué.';
                        default:
                            return 'Erreur récupérée, calcul poursuivi avec des valeurs par défaut.';
                    }
                } else {
                    return 'Erreur critique: impossible de poursuivre le calcul. Veuillez vérifier vos données.';
                }
            },

            /**
             * Log error for monitoring and debugging
             * @param {Object} errorInfo - Error information
             * @param {Object} errorType - Error type
             * @param {Object} recovery - Recovery result
             */
            logError: function(errorInfo, errorType, recovery) {
                const logEntry = {
                    ...errorInfo,
                    severity: errorType.level,
                    recoverable: errorType.recoverable,
                    recovery: recovery.strategy,
                    recovered: recovery.success
                };

                // In production, this would send to monitoring service
                console.warn('📊 [ERROR LOG]', logEntry);

                // Store in session for debugging
                if (!window.errorLog) window.errorLog = [];
                window.errorLog.push(logEntry);
            }
        };

        // ===== PERFORMANCE OPTIMIZATION MODULE - PHASE 3 ROBUSTNESS =====
        const PerformanceOptimizer = {
            // Caches for expensive calculations
            caches: {
                taxCalculations: new Map(),
                bracketLookups: new Map(),
                municipalRates: new Map(),
                deductionResults: new Map()
            },

            // Performance metrics
            metrics: {
                cacheHits: 0,
                cacheMisses: 0,
                calculationTimes: []
            },

            /**
             * Get cached result or compute and cache
             * @param {string} cacheKey - Cache key
             * @param {Function} computeFunction - Function to compute result
             * @param {string} cacheType - Type of cache to use
             * @returns {*} Cached or computed result
             */
            getCachedOrCompute: function(cacheKey, computeFunction, cacheType = 'taxCalculations') {
                const cache = this.caches[cacheType];

                if (cache.has(cacheKey)) {
                    this.metrics.cacheHits++;
                    console.log(`⚡ [CACHE HIT] ${cacheType}: ${cacheKey}`);
                    return cache.get(cacheKey);
                }

                this.metrics.cacheMisses++;
                const startTime = performance.now();

                try {
                    const result = computeFunction();
                    const endTime = performance.now();

                    // Cache the result
                    cache.set(cacheKey, result);

                    // Track performance
                    this.metrics.calculationTimes.push(endTime - startTime);

                    console.log(`⚡ [CACHE MISS] ${cacheType}: ${cacheKey} (computed in ${(endTime - startTime).toFixed(2)}ms)`);
                    return result;
                } catch (error) {
                    console.error(`❌ [CACHE] Computation failed for ${cacheKey}:`, error);
                    throw error;
                }
            },

            /**
             * Optimized bracket lookup using binary search
             * @param {number} income - Income to find bracket for
             * @param {Array} brackets - Tax brackets array
             * @returns {Object} Found bracket or null
             */
            findBracketOptimized: function(income, brackets) {
                const cacheKey = `${income}_${brackets.length}`;

                return this.getCachedOrCompute(cacheKey, () => {
                    // Binary search for efficiency
                    let left = 0;
                    let right = brackets.length - 1;

                    while (left <= right) {
                        const mid = Math.floor((left + right) / 2);
                        const bracket = brackets[mid];

                        const inRange = income >= bracket.revenu_min &&
                                       (bracket.revenu_max === "plus" || income <= bracket.revenu_max);

                        if (inRange) {
                            return bracket;
                        } else if (income < bracket.revenu_min) {
                            right = mid - 1;
                        } else {
                            left = mid + 1;
                        }
                    }

                    return null;
                }, 'bracketLookups');
            },

            /**
             * Clear caches to free memory
             * @param {string} cacheType - Specific cache to clear, or 'all'
             */
            clearCache: function(cacheType = 'all') {
                if (cacheType === 'all') {
                    Object.values(this.caches).forEach(cache => cache.clear());
                    console.log('🧹 [CACHE] All caches cleared');
                } else if (this.caches[cacheType]) {
                    this.caches[cacheType].clear();
                    console.log(`🧹 [CACHE] ${cacheType} cache cleared`);
                }
            },

            /**
             * Get performance statistics
             * @returns {Object} Performance metrics
             */
            getPerformanceStats: function() {
                const totalRequests = this.metrics.cacheHits + this.metrics.cacheMisses;
                const hitRate = totalRequests > 0 ? (this.metrics.cacheHits / totalRequests) * 100 : 0;
                const avgCalculationTime = this.metrics.calculationTimes.length > 0
                    ? this.metrics.calculationTimes.reduce((a, b) => a + b, 0) / this.metrics.calculationTimes.length
                    : 0;

                return {
                    cacheHitRate: hitRate.toFixed(1) + '%',
                    totalRequests,
                    cacheHits: this.metrics.cacheHits,
                    cacheMisses: this.metrics.cacheMisses,
                    avgCalculationTime: avgCalculationTime.toFixed(2) + 'ms',
                    cacheSize: {
                        taxCalculations: this.caches.taxCalculations.size,
                        bracketLookups: this.caches.bracketLookups.size,
                        municipalRates: this.caches.municipalRates.size,
                        deductionResults: this.caches.deductionResults.size
                    }
                };
            },

            /**
             * Optimize tax calculation with caching
             * @param {number} income - Income amount
             * @param {string} familyStatus - Family status
             * @param {string} commune - Commune name
             * @returns {Object} Tax calculation result
             */
            optimizedTaxCalculation: function(income, familyStatus, commune) {
                const cacheKey = `${income}_${familyStatus}_${commune}`;

                return this.getCachedOrCompute(cacheKey, () => {
                    return calculateIccFinalTax(income, familyStatus, commune);
                }, 'taxCalculations');
            }
        };

        // ===== COMPREHENSIVE VALIDATION FRAMEWORK - PHASE 3 ROBUSTNESS =====
        const ComprehensiveValidator = {
            /**
             * Run complete validation suite
             * @returns {Object} Complete validation results
             */
            runCompleteValidation: function() {
                console.log('🔍 [COMPREHENSIVE] Starting complete validation suite...');

                const results = {
                    timestamp: new Date().toISOString(),
                    dataIntegrity: null,
                    crossValidation: null,
                    boundaryTests: null,
                    performanceTests: null,
                    errorHandling: null,
                    overall: null
                };

                try {
                    // 1. Data Integrity Validation
                    console.log('📊 [VALIDATION] Testing data integrity...');
                    results.dataIntegrity = TaxValidation.validateTaxData();

                    // 2. Cross-Validation Tests
                    console.log('🧪 [VALIDATION] Running cross-validation tests...');
                    results.crossValidation = CrossValidation.runValidationTests();

                    // 3. Boundary Condition Tests
                    console.log('🎯 [VALIDATION] Testing boundary conditions...');
                    results.boundaryTests = CrossValidation.validateBracketBoundaries();

                    // 4. Performance Tests
                    console.log('⚡ [VALIDATION] Running performance tests...');
                    results.performanceTests = this.runPerformanceTests();

                    // 5. Error Handling Tests
                    console.log('🛡️ [VALIDATION] Testing error handling...');
                    results.errorHandling = this.testErrorHandling();

                    // 6. Overall Assessment
                    results.overall = this.assessOverallQuality(results);

                    console.log('✅ [COMPREHENSIVE] Validation suite completed');
                    return results;

                } catch (error) {
                    console.error('❌ [COMPREHENSIVE] Validation suite failed:', error);
                    results.overall = {
                        status: 'FAILED',
                        error: error.message
                    };
                    return results;
                }
            },

            /**
             * Run performance tests
             * @returns {Object} Performance test results
             */
            runPerformanceTests: function() {
                const testCases = [
                    { income: 50000, status: 'celibataire', commune: 'GENEVE' },
                    { income: 100000, status: 'marie_splitting', commune: 'CAROUGE' },
                    { income: 200000, status: 'splitting_partiel', commune: 'VANDOEUVRES' }
                ];

                const results = {
                    totalTests: testCases.length,
                    times: [],
                    cachePerformance: null
                };

                // Clear cache for accurate timing
                PerformanceOptimizer.clearCache();

                testCases.forEach((testCase, index) => {
                    const startTime = performance.now();

                    try {
                        // First run (cache miss)
                        PerformanceOptimizer.optimizedTaxCalculation(
                            testCase.income,
                            testCase.status,
                            testCase.commune
                        );

                        const firstRunTime = performance.now() - startTime;

                        // Second run (cache hit)
                        const secondStartTime = performance.now();
                        PerformanceOptimizer.optimizedTaxCalculation(
                            testCase.income,
                            testCase.status,
                            testCase.commune
                        );
                        const secondRunTime = performance.now() - secondStartTime;

                        results.times.push({
                            testCase: index + 1,
                            firstRun: firstRunTime,
                            secondRun: secondRunTime,
                            improvement: ((firstRunTime - secondRunTime) / firstRunTime * 100).toFixed(1) + '%'
                        });

                    } catch (error) {
                        console.error(`❌ [PERFORMANCE] Test ${index + 1} failed:`, error);
                        results.times.push({
                            testCase: index + 1,
                            error: error.message
                        });
                    }
                });

                results.cachePerformance = PerformanceOptimizer.getPerformanceStats();
                return results;
            },

            /**
             * Test error handling capabilities
             * @returns {Object} Error handling test results
             */
            testErrorHandling: function() {
                const errorTests = [
                    {
                        name: 'Invalid income',
                        test: () => calculateIccBaseTax(-1000, 'celibataire'),
                        expectError: true
                    },
                    {
                        name: 'Invalid commune',
                        test: () => getMunicipalRateValidated('INVALID_COMMUNE', 2025),
                        expectError: false // Should fallback gracefully
                    },
                    {
                        name: 'Invalid family status',
                        test: () => getSplittingCoefficient('invalid_status'),
                        expectError: false // Should fallback to 1.0
                    }
                ];

                const results = {
                    totalTests: errorTests.length,
                    passed: 0,
                    failed: 0,
                    details: []
                };

                errorTests.forEach((test, index) => {
                    try {
                        const result = test.test();
                        const passed = !test.expectError; // If we expected error but got result, it's handled gracefully

                        if (passed) results.passed++;
                        else results.failed++;

                        results.details.push({
                            name: test.name,
                            passed,
                            result: 'Graceful handling',
                            value: result
                        });

                    } catch (error) {
                        const passed = test.expectError; // If we expected error and got one, it's correct

                        if (passed) results.passed++;
                        else results.failed++;

                        results.details.push({
                            name: test.name,
                            passed,
                            result: test.expectError ? 'Expected error' : 'Unexpected error',
                            error: error.message
                        });
                    }
                });

                return results;
            },

            /**
             * Assess overall quality based on all test results
             * @param {Object} results - All test results
             * @returns {Object} Overall quality assessment
             */
            assessOverallQuality: function(results) {
                let score = 0;
                let maxScore = 0;
                const issues = [];

                // Data integrity (25 points)
                maxScore += 25;
                if (results.dataIntegrity?.isValid) {
                    score += 25;
                } else {
                    issues.push('Data integrity issues detected');
                    score += Math.max(0, 25 - (results.dataIntegrity?.issues?.length || 5) * 5);
                }

                // Cross-validation (30 points)
                maxScore += 30;
                if (results.crossValidation) {
                    const successRate = results.crossValidation.passed / results.crossValidation.totalTests;
                    score += Math.round(successRate * 30);
                    if (successRate < 0.8) {
                        issues.push(`Cross-validation success rate: ${(successRate * 100).toFixed(1)}%`);
                    }
                }

                // Performance (20 points)
                maxScore += 20;
                if (results.performanceTests?.cachePerformance) {
                    const hitRate = parseFloat(results.performanceTests.cachePerformance.cacheHitRate);
                    score += Math.round((hitRate / 100) * 20);
                    if (hitRate < 50) {
                        issues.push(`Low cache hit rate: ${hitRate}%`);
                    }
                }

                // Error handling (25 points)
                maxScore += 25;
                if (results.errorHandling) {
                    const errorSuccessRate = results.errorHandling.passed / results.errorHandling.totalTests;
                    score += Math.round(errorSuccessRate * 25);
                    if (errorSuccessRate < 0.8) {
                        issues.push(`Error handling success rate: ${(errorSuccessRate * 100).toFixed(1)}%`);
                    }
                }

                const percentage = (score / maxScore) * 100;
                let grade, status;

                if (percentage >= 90) {
                    grade = 'A';
                    status = 'EXCELLENT';
                } else if (percentage >= 80) {
                    grade = 'B';
                    status = 'GOOD';
                } else if (percentage >= 70) {
                    grade = 'C';
                    status = 'ACCEPTABLE';
                } else {
                    grade = 'D';
                    status = 'NEEDS_IMPROVEMENT';
                }

                return {
                    score,
                    maxScore,
                    percentage: percentage.toFixed(1),
                    grade,
                    status,
                    issues,
                    recommendation: this.generateRecommendation(percentage, issues)
                };
            },

            /**
             * Generate improvement recommendations
             * @param {number} percentage - Overall score percentage
             * @param {Array} issues - List of issues found
             * @returns {string} Recommendation text
             */
            generateRecommendation: function(percentage, issues) {
                if (percentage >= 90) {
                    return 'Excellent! The TOU simulator meets production quality standards.';
                } else if (percentage >= 80) {
                    return 'Good quality. Minor improvements recommended: ' + issues.slice(0, 2).join(', ');
                } else if (percentage >= 70) {
                    return 'Acceptable but needs improvement. Focus on: ' + issues.slice(0, 3).join(', ');
                } else {
                    return 'Significant improvements needed. Critical issues: ' + issues.join(', ');
                }
            }
        };

        // ===== MONITORING & LOGGING MODULE - PHASE 3 ROBUSTNESS =====
        const MonitoringSystem = {
            // Log storage
            logs: {
                calculations: [],
                errors: [],
                performance: [],
                validations: []
            },

            // Metrics tracking
            metrics: {
                totalCalculations: 0,
                successfulCalculations: 0,
                failedCalculations: 0,
                averageCalculationTime: 0,
                userSessions: 0
            },

            /**
             * Log calculation details for monitoring
             * @param {Object} calculationData - Calculation input and results
             */
            logCalculation: function(calculationData) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    sessionId: this.getSessionId(),
                    type: 'calculation',
                    ...calculationData
                };

                this.logs.calculations.push(logEntry);
                this.metrics.totalCalculations++;

                if (calculationData.success) {
                    this.metrics.successfulCalculations++;
                } else {
                    this.metrics.failedCalculations++;
                }

                // Keep only last 1000 entries to prevent memory issues
                if (this.logs.calculations.length > 1000) {
                    this.logs.calculations = this.logs.calculations.slice(-1000);
                }

                console.log('📊 [MONITORING] Calculation logged:', logEntry);
            },

            /**
             * Log performance metrics
             * @param {Object} performanceData - Performance metrics
             */
            logPerformance: function(performanceData) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    sessionId: this.getSessionId(),
                    type: 'performance',
                    ...performanceData
                };

                this.logs.performance.push(logEntry);

                // Update average calculation time
                if (performanceData.calculationTime) {
                    const totalTime = this.metrics.averageCalculationTime * (this.metrics.totalCalculations - 1) + performanceData.calculationTime;
                    this.metrics.averageCalculationTime = totalTime / this.metrics.totalCalculations;
                }

                console.log('⚡ [MONITORING] Performance logged:', logEntry);
            },

            /**
             * Log validation results
             * @param {Object} validationData - Validation results
             */
            logValidation: function(validationData) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    sessionId: this.getSessionId(),
                    type: 'validation',
                    ...validationData
                };

                this.logs.validations.push(logEntry);
                console.log('🔍 [MONITORING] Validation logged:', logEntry);
            },

            /**
             * Generate monitoring report
             * @returns {Object} Comprehensive monitoring report
             */
            generateReport: function() {
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);

                // Filter recent logs
                const recentCalculations = this.logs.calculations.filter(log =>
                    new Date(log.timestamp) > oneHourAgo
                );

                const recentErrors = this.logs.errors.filter(log =>
                    new Date(log.timestamp) > oneHourAgo
                );

                // Calculate success rate
                const successRate = this.metrics.totalCalculations > 0
                    ? (this.metrics.successfulCalculations / this.metrics.totalCalculations) * 100
                    : 0;

                // Get performance stats
                const performanceStats = PerformanceOptimizer.getPerformanceStats();

                return {
                    timestamp: now.toISOString(),
                    period: 'Last hour',
                    summary: {
                        totalCalculations: this.metrics.totalCalculations,
                        successRate: successRate.toFixed(1) + '%',
                        averageCalculationTime: this.metrics.averageCalculationTime.toFixed(2) + 'ms',
                        recentCalculations: recentCalculations.length,
                        recentErrors: recentErrors.length
                    },
                    performance: performanceStats,
                    dataQuality: {
                        dataIntegrity: TaxValidation.validateTaxData(),
                        lastValidation: this.logs.validations[this.logs.validations.length - 1]?.timestamp || 'Never'
                    },
                    recommendations: this.generateRecommendations(successRate, recentErrors.length)
                };
            },

            /**
             * Generate system recommendations based on metrics
             * @param {number} successRate - Current success rate
             * @param {number} errorCount - Recent error count
             * @returns {Array} List of recommendations
             */
            generateRecommendations: function(successRate, errorCount) {
                const recommendations = [];

                if (successRate < 95) {
                    recommendations.push('Success rate below 95% - investigate calculation errors');
                }

                if (errorCount > 10) {
                    recommendations.push('High error rate detected - review error handling');
                }

                if (this.metrics.averageCalculationTime > 100) {
                    recommendations.push('Average calculation time > 100ms - consider performance optimization');
                }

                const cacheStats = PerformanceOptimizer.getPerformanceStats();
                if (parseFloat(cacheStats.cacheHitRate) < 50) {
                    recommendations.push('Low cache hit rate - review caching strategy');
                }

                if (recommendations.length === 0) {
                    recommendations.push('System performing well - no immediate actions required');
                }

                return recommendations;
            },

            /**
             * Get or create session ID
             * @returns {string} Session ID
             */
            getSessionId: function() {
                if (!window.sessionId) {
                    window.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    this.metrics.userSessions++;
                }
                return window.sessionId;
            },

            /**
             * Export logs for analysis
             * @param {string} logType - Type of logs to export ('all', 'calculations', 'errors', etc.)
             * @returns {string} JSON string of logs
             */
            exportLogs: function(logType = 'all') {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    sessionId: this.getSessionId(),
                    metrics: this.metrics
                };

                if (logType === 'all') {
                    exportData.logs = this.logs;
                } else if (this.logs[logType]) {
                    exportData.logs = { [logType]: this.logs[logType] };
                } else {
                    throw new Error(`Invalid log type: ${logType}`);
                }

                return JSON.stringify(exportData, null, 2);
            }
        };

        // ===== DEBUG & TESTING UTILITIES - FOR TROUBLESHOOTING =====

        /**
         * Manual test function for debugging TOU calculation issues
         * Can be called from browser console: testTOUCalculation()
         */
        function testTOUCalculation() {
            console.log('🧪 [DEBUG] Starting manual TOU calculation test...');

            // Set test values in form
            const testData = {
                commune: 'GENEVE',
                familyStatus: 'celibataire',
                annualIncome: '80000',
                childrenCount: '0',
                spouseIncome: '0',
                wealth: '0',
                alimony: '0',
                deductionOption: 'optimize'
            };

            // Fill form fields
            Object.entries(testData).forEach(([key, value]) => {
                const element = document.getElementById('tou' + key.charAt(0).toUpperCase() + key.slice(1));
                if (element) {
                    element.value = value;
                    console.log(`✅ [DEBUG] Set ${key}: ${value}`);
                } else {
                    console.warn(`⚠️ [DEBUG] Element not found: tou${key.charAt(0).toUpperCase() + key.slice(1)}`);
                }
            });

            // Wait a moment then trigger calculation
            setTimeout(() => {
                console.log('🚀 [DEBUG] Triggering calculation...');
                try {
                    touCalculateTaxes();
                    console.log('✅ [DEBUG] Calculation triggered successfully');
                } catch (error) {
                    console.error('❌ [DEBUG] Calculation failed:', error);
                }
            }, 500);
        }

        /**
         * Debug form field values
         */
        function debugFormFields() {
            console.log('🔍 [DEBUG] Current form field values:');

            const fields = [
                'touCommune', 'touFamilyStatus', 'touAnnualIncome',
                'touChildrenCount', 'touSpouseIncome', 'touWealth',
                'touAlimony', 'touDeductionOption', 'touQuasiResident'
            ];

            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    const value = element.type === 'checkbox' ? element.checked : element.value;
                    console.log(`  ${fieldId}: "${value}" (type: ${typeof value})`);
                } else {
                    console.warn(`  ${fieldId}: ELEMENT NOT FOUND`);
                }
            });
        }

        // Make functions available globally for console access
        window.testTOUCalculation = testTOUCalculation;
        window.debugFormFields = debugFormFields;

        // ===== UNIFIED DATA LOADING SYSTEM - SINGLE SOURCE =====
        // This module loads ALL tax calculation data from simulateur_tou_geneve_complete.json
        // Replaces all legacy data loading mechanisms (2024, embedded fallbacks, multiple files)

        /**
         * Load unified tax data from simulateur_tou_geneve_complete.json
         * This is the ONLY data loading function - no fallbacks, no multiple sources
         * @returns {Promise<boolean>} true if data loaded successfully, false otherwise
         */
        async function loadUnifiedTaxData() {
            // Prevent concurrent loading
            if (dataLoadingStatus.loading) {
                console.log('⏳ [UNIFIED DATA] Loading already in progress...');
                return false;
            }

            if (dataLoadingStatus.loaded) {
                console.log('✅ [UNIFIED DATA] Data already loaded');
                return true;
            }

            dataLoadingStatus.loading = true;
            dataLoadingStatus.error = null;

            try {
                console.log('🔄 [UNIFIED DATA] Loading tax data from simulateur_tou_geneve_complete.json...');

                // Add cache-busting parameter to ensure we get the latest version
                const cacheBuster = new Date().getTime();
                const response = await fetch(`./simulateur_tou_geneve_complete.json?v=${cacheBuster}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                unifiedTaxData = await response.json();
                console.log('✅ [UNIFIED DATA] Successfully loaded unified JSON data');
                console.log('🔍 [UNIFIED DATA] Top-level keys:', Object.keys(unifiedTaxData));

                // Map ICC tax brackets from unified data
                if (unifiedTaxData.icc_geneve && unifiedTaxData.icc_geneve.bareme) {
                    iccTaxBrackets = unifiedTaxData.icc_geneve.bareme.map(tranche => ({
                        revenu_min: tranche.min,
                        revenu_max: tranche.max === 10000000 ? "plus" : tranche.max,
                        taux_imposition_pourcentage: tranche.taux * 100, // Convert to percentage
                        impot_max_tranche_chf: 0, // Will be calculated if needed
                        impot_total_cumul_chf: tranche.cumul
                    }));
                    console.log(`✅ [UNIFIED DATA] Mapped ${iccTaxBrackets.length} ICC tax brackets`);
                } else {
                    throw new Error('ICC tax brackets not found in unified data');
                }

                // Map municipal rates from unified data
                console.log('🔍 [UNIFIED DATA] Checking municipal data structure:', {
                    hasIccGeneve: !!unifiedTaxData.icc_geneve,
                    hasCentimesAdditionnels: !!(unifiedTaxData.icc_geneve?.centimes_additionnels),
                    centimesKeys: unifiedTaxData.icc_geneve?.centimes_additionnels ? Object.keys(unifiedTaxData.icc_geneve.centimes_additionnels).slice(0, 5) : 'N/A'
                });

                if (unifiedTaxData.icc_geneve && unifiedTaxData.icc_geneve.centimes_additionnels) {
                    municipalTaxRates = {};
                    Object.entries(unifiedTaxData.icc_geneve.centimes_additionnels).forEach(([nom, taux]) => {
                        let normalizedName = nom.toUpperCase()
                                               .trim()
                                               .replace(/[ÀÁÂÄàáâä]/g, 'A')
                                               .replace(/[ÈÉÊËèéêë]/g, 'E')
                                               .replace(/[ÌÍÎÏìíîï]/g, 'I')
                                               .replace(/[ÒÓÔÖòóôö]/g, 'O')
                                               .replace(/[ÙÚÛÜùúûü]/g, 'U')
                                               .replace(/[Ññ]/g, 'N')
                                               .replace(/[Çç]/g, 'C')
                                               .replace(/œ/g, 'OE')
                                               .replace(/Œ/g, 'OE')
                                               .replace(/VILLE DE /g, '') // Remove "VILLE DE " prefix
                                               .replace(/[-\s]/g, '-'); // Normalize spaces and hyphens

                        // Special case for Geneva - ensure it's always mapped as "GENEVE"
                        if (normalizedName === 'GENEVE' || normalizedName === 'VILLE-DE-GENEVE' || nom.toLowerCase().includes('genève')) {
                            municipalTaxRates['GENEVE'] = taux;
                        }

                        municipalTaxRates[normalizedName] = taux;
                    });
                    console.log(`✅ [UNIFIED DATA] Mapped ${Object.keys(municipalTaxRates).length} municipal tax rates`);
                    console.log(`🔍 [UNIFIED DATA] Available communes:`, Object.keys(municipalTaxRates).slice(0, 10).join(', '), '...');
                } else {
                    console.warn('⚠️ [UNIFIED DATA] Municipal tax rates not found in unified data structure');
                    console.log('🔍 [UNIFIED DATA] Available icc_geneve keys:', unifiedTaxData.icc_geneve ? Object.keys(unifiedTaxData.icc_geneve) : 'N/A');

                    // Fallback: Create minimal municipal rates with Geneva default
                    municipalTaxRates = {
                        'GENEVE': 45.49,
                        'CAROUGE': 40,
                        'VERNIER': 50,
                        'LANCY': 39,
                        'MEYRIN': 42
                    };
                    console.log('⚠️ [UNIFIED DATA] Using fallback municipal rates');
                }

                // Map IFD tax brackets from unified data
                if (unifiedTaxData.ifd && unifiedTaxData.ifd.bareme) {
                    ifdTaxBrackets = {
                        "Célibataires": unifiedTaxData.ifd.bareme.celibataire.map(tranche => ({
                            "Tranche inférieure": tranche.min,
                            "Tranche supérieure": tranche.max === 10000000 ? "plus" : tranche.max,
                            "Taux de la tranche": tranche.taux / 100, // Convert percentage to decimal (e.g., 2.97% -> 0.0297)
                            "Cumul": tranche.cumul || 0
                        })),
                        "Mariés": unifiedTaxData.ifd.bareme.couple.map(tranche => ({
                            "Tranche inférieure": tranche.min,
                            "Tranche supérieure": tranche.max === 10000000 ? "plus" : tranche.max,
                            "Taux de la tranche": tranche.taux / 100, // Convert percentage to decimal (e.g., 3.0% -> 0.03)
                            "Cumul": tranche.cumul || 0
                        }))
                    };
                    console.log(`✅ [UNIFIED DATA] Mapped IFD brackets: ${ifdTaxBrackets.Célibataires.length} single, ${ifdTaxBrackets.Mariés.length} married`);
                    console.log(`🔍 [UNIFIED DATA] Sample IFD bracket (single):`, ifdTaxBrackets.Célibataires[0]);
                    console.log(`🔍 [UNIFIED DATA] Rate conversion example: ${unifiedTaxData.ifd.bareme.celibataire[4].taux}% -> ${(unifiedTaxData.ifd.bareme.celibataire[4].taux / 100).toFixed(6)} decimal`);
                } else {
                    throw new Error('IFD tax brackets not found in unified data');
                }

                // Map deduction data from unified data
                if (unifiedTaxData.ifd && unifiedTaxData.ifd.deductions) {
                    deductionData = unifiedTaxData.ifd.deductions;
                    console.log('✅ [UNIFIED DATA] Mapped deduction parameters');
                } else {
                    throw new Error('Deduction data not found in unified data');
                }

                // Map tax calculation parameters from unified data
                if (unifiedTaxData.icc_geneve && unifiedTaxData.icc_geneve.calcul) {
                    taxCalculationParams = unifiedTaxData.icc_geneve.calcul;
                    console.log('✅ [UNIFIED DATA] Mapped tax calculation parameters');
                } else {
                    throw new Error('Tax calculation parameters not found in unified data');
                }

                // Map social contribution rates from unified data
                console.log('🔍 [UNIFIED DATA] Checking for social contribution rates...');
                console.log('🔍 [UNIFIED DATA] Available top-level keys:', Object.keys(unifiedTaxData));
                console.log('🔍 [UNIFIED DATA] cotisations_sociales exists:', !!unifiedTaxData.cotisations_sociales);

                if (unifiedTaxData.cotisations_sociales) {
                    socialContributionRates = unifiedTaxData.cotisations_sociales;
                    console.log('✅ [UNIFIED DATA] Mapped social contribution rates');
                    console.log(`🔍 [UNIFIED DATA] Available social contributions:`, Object.keys(socialContributionRates).filter(key => key !== 'description' && key !== 'source').join(', '));
                } else {
                    console.warn('⚠️ [UNIFIED DATA] Social contribution rates not found, using fallback values');
                    // Fallback with proper structure matching JSON format
                    socialContributionRates = {
                        description: "Fallback social contribution rates for Geneva 2025",
                        avs: { taux_employe: 0.0435, taux_employeur: 0.0435, description: "Assurance-vieillesse et survivants (fallback)" },
                        ai: { taux_employe: 0.007, taux_employeur: 0.007, description: "Assurance-invalidité (fallback)" },
                        apg: { taux_employe: 0.0025, taux_employeur: 0.0025, description: "Allocations pour perte de gain (fallback)" },
                        ac: { taux_employe: 0.011, taux_employeur: 0.011, plafond_salaire: 148200, description: "Assurance-chômage (fallback)" },
                        af: { taux_employe: 0.0, taux_employeur: 0.0225, description: "Allocations familiales (fallback)" },
                        amat: { taux_employe: 0.00032, taux_employeur: 0.00032, description: "Allocation maternité cantonale (fallback)" },
                        cpe: { taux_employe: 0.0, taux_employeur: 0.0007, description: "Contribution petite enfance (fallback)" },
                        lfp: { taux_employe: 0.0, taux_employeur_min: 0.0003, taux_employeur_max: 0.0008, description: "Formation professionnelle (fallback)" },
                        pilier2: { taux_employe_moyen: 0.06, taux_employeur_moyen: 0.06, plafond_cotisation_annuelle: 54432, description: "Prévoyance professionnelle (fallback)" },
                        aanp: { taux_employe: 0.01, taux_employeur: 0.0, plafond_cotisation_annuelle: 1482, description: "Assurance accidents non professionnels (fallback)" }
                    };
                }

                // Update loading status
                dataLoadingStatus.loaded = true;
                dataLoadingStatus.loading = false;
                dataLoadingStatus.timestamp = new Date().toISOString();

                console.log('🎉 [UNIFIED DATA] All tax data successfully loaded from single source');
                return true;

            } catch (error) {
                dataLoadingStatus.loading = false;
                dataLoadingStatus.error = error.message;
                console.error('❌ [UNIFIED DATA] Failed to load tax data:', error.message);
                console.error('❌ [UNIFIED DATA] Error details:', {
                    message: error.message,
                    name: error.name,
                    stack: error.stack?.substring(0, 200)
                });

                // Create emergency fallback data to keep the system functional
                console.warn('⚠️ [UNIFIED DATA] Creating emergency fallback data...');

                // Emergency municipal rates (Geneva area communes)
                municipalTaxRates = {
                    'GENEVE': 45.49,
                    'CAROUGE': 40,
                    'VERNIER': 50,
                    'LANCY': 39,
                    'MEYRIN': 42,
                    'ONEX': 50.5,
                    'THONEX': 44,
                    'PLAN-LES-OUATES': 35,
                    'GRAND-SACONNEX': 44,
                    'CHENE-BOUGERIES': 32
                };

                // Emergency ICC brackets (simplified)
                iccTaxBrackets = [
                    { revenu_min: 0, revenu_max: 18479, taux_imposition_pourcentage: 0.00 },
                    { revenu_min: 18480, revenu_max: 22264, taux_imposition_pourcentage: 8.00 },
                    { revenu_min: 22265, revenu_max: 27273, taux_imposition_pourcentage: 9.00 },
                    { revenu_min: 27274, revenu_max: 33333, taux_imposition_pourcentage: 10.00 },
                    { revenu_min: 33334, revenu_max: 40816, taux_imposition_pourcentage: 11.00 },
                    { revenu_min: 40817, revenu_max: 50000, taux_imposition_pourcentage: 12.00 },
                    { revenu_min: 50001, revenu_max: 61538, taux_imposition_pourcentage: 13.00 },
                    { revenu_min: 61539, revenu_max: 76923, taux_imposition_pourcentage: 14.00 },
                    { revenu_min: 76924, revenu_max: 96774, taux_imposition_pourcentage: 15.00 },
                    { revenu_min: 96775, revenu_max: 122449, taux_imposition_pourcentage: 16.00 },
                    { revenu_min: 122450, revenu_max: 156250, taux_imposition_pourcentage: 17.00 },
                    { revenu_min: 156251, revenu_max: 200000, taux_imposition_pourcentage: 18.00 },
                    { revenu_min: 200001, revenu_max: "plus", taux_imposition_pourcentage: 19.00 }
                ];

                // Emergency IFD brackets (simplified)
                ifdTaxBrackets = {
                    "Célibataires": [
                        { "Tranche inférieure": 0, "Tranche supérieure": 14999, "Taux de la tranche": 0 },
                        { "Tranche inférieure": 15000, "Tranche supérieure": 31299, "Taux de la tranche": 0.0077 },
                        { "Tranche inférieure": 31300, "Tranche supérieure": 41299, "Taux de la tranche": 0.0088 },
                        { "Tranche inférieure": 41300, "Tranche supérieure": 55199, "Taux de la tranche": 0.0264 },
                        { "Tranche inférieure": 55200, "Tranche supérieure": 72499, "Taux de la tranche": 0.0297 },
                        { "Tranche inférieure": 72500, "Tranche supérieure": 78099, "Taux de la tranche": 0.0594 },
                        { "Tranche inférieure": 78100, "Tranche supérieure": 107399, "Taux de la tranche": 0.066 },
                        { "Tranche inférieure": 107400, "Tranche supérieure": 139599, "Taux de la tranche": 0.088 },
                        { "Tranche inférieure": 139600, "Tranche supérieure": 182599, "Taux de la tranche": 0.11 },
                        { "Tranche inférieure": 182600, "Tranche supérieure": "plus", "Taux de la tranche": 0.132 }
                    ],
                    "Mariés": [
                        { "Tranche inférieure": 0, "Tranche supérieure": 28199, "Taux de la tranche": 0 },
                        { "Tranche inférieure": 28200, "Tranche supérieure": 50199, "Taux de la tranche": 0.01 },
                        { "Tranche inférieure": 50200, "Tranche supérieure": 58499, "Taux de la tranche": 0.02 },
                        { "Tranche inférieure": 58500, "Tranche supérieure": 75399, "Taux de la tranche": 0.03 },
                        { "Tranche inférieure": 75400, "Tranche supérieure": 90899, "Taux de la tranche": 0.04 },
                        { "Tranche inférieure": 90900, "Tranche supérieure": 103599, "Taux de la tranche": 0.05 },
                        { "Tranche inférieure": 103600, "Tranche supérieure": 120099, "Taux de la tranche": 0.06 },
                        { "Tranche inférieure": 120100, "Tranche supérieure": 141399, "Taux de la tranche": 0.07 },
                        { "Tranche inférieure": 141400, "Tranche supérieure": 166899, "Taux de la tranche": 0.08 },
                        { "Tranche inférieure": 166900, "Tranche supérieure": "plus", "Taux de la tranche": 0.088 }
                    ]
                };

                // Emergency social contribution rates (2025 Geneva rates)
                socialContributionRates = {
                    description: "Emergency fallback social contribution rates for Geneva 2025",
                    source: "Emergency fallback data",
                    avs: { taux_employe: 0.0435, taux_employeur: 0.0435, description: "Assurance-vieillesse et survivants" },
                    ai: { taux_employe: 0.007, taux_employeur: 0.007, description: "Assurance-invalidité" },
                    apg: { taux_employe: 0.0025, taux_employeur: 0.0025, description: "Allocations pour perte de gain" },
                    ac: { taux_employe: 0.011, taux_employeur: 0.011, plafond_salaire: 148200, description: "Assurance-chômage" },
                    af: { taux_employe: 0.0, taux_employeur: 0.0225, description: "Allocations familiales" },
                    amat: { taux_employe: 0.00032, taux_employeur: 0.00032, description: "Allocation maternité cantonale" },
                    cpe: { taux_employe: 0.0, taux_employeur: 0.0007, description: "Contribution petite enfance" },
                    lfp: { taux_employe: 0.0, taux_employeur_min: 0.0003, taux_employeur_max: 0.0008, description: "Formation professionnelle" },
                    pilier2: { taux_employe_moyen: 0.06, taux_employeur_moyen: 0.06, plafond_cotisation_annuelle: 54432, description: "Prévoyance professionnelle" },
                    aanp: { taux_employe: 0.01, taux_employeur: 0.0, plafond_cotisation_annuelle: 1482, description: "Assurance accidents non professionnels" }
                };

                console.warn('⚠️ [UNIFIED DATA] Emergency fallback data created - system will continue with limited functionality');
                dataLoadingStatus.loaded = true; // Allow system to continue
                dataLoadingStatus.error = `Fallback mode: ${error.message}`;
                return true; // Don't throw error, allow system to continue
            }
        }

        /**
         * Validate unified tax data integrity
         * @returns {Object} Validation result with details
         */
        function validateUnifiedDataIntegrity() {
            console.log('🔍 [UNIFIED DATA] Validating data integrity...');

            const validation = {
                valid: true,
                errors: [],
                warnings: [],
                details: {}
            };

            if (!unifiedTaxData) {
                validation.valid = false;
                validation.errors.push('No unified tax data loaded');
                return validation;
            }

            // Validate ICC data
            const iccTrancheCount = unifiedTaxData.icc_geneve?.bareme?.length || 0;
            validation.details.iccTranches = iccTrancheCount;
            if (iccTrancheCount !== 18) {
                validation.warnings.push(`ICC tranches: ${iccTrancheCount} (expected: 18)`);
            }
            console.log(`📊 [VALIDATION] ICC tranches: ${iccTrancheCount}`);

            // Validate municipal rates
            const communeCount = Object.keys(unifiedTaxData.icc_geneve?.centimes_additionnels || {}).length;
            validation.details.communes = communeCount;
            if (communeCount < 40) {
                validation.warnings.push(`Communes: ${communeCount} (expected: ~44)`);
            }
            console.log(`🏛️ [VALIDATION] Communes: ${communeCount}`);

            // Validate IFD data
            const ifdSingleCount = unifiedTaxData.ifd?.bareme?.celibataire?.length || 0;
            const ifdCoupleCount = unifiedTaxData.ifd?.bareme?.couple?.length || 0;
            validation.details.ifdBrackets = { single: ifdSingleCount, couple: ifdCoupleCount };
            console.log(`📊 [VALIDATION] IFD brackets: ${ifdSingleCount} single, ${ifdCoupleCount} couple`);

            // Validate calculation parameters
            const calcParams = unifiedTaxData.icc_geneve?.calcul;
            if (calcParams) {
                validation.details.calculationParams = calcParams;
                console.log(`💰 [VALIDATION] ICC reduction: ${(calcParams.reduction_base * 100)}%`);
                console.log(`🏛️ [VALIDATION] Centimes cantonaux: ${(calcParams.centimes_cantonaux * 100)}%`);
            } else {
                validation.errors.push('Missing ICC calculation parameters');
                validation.valid = false;
            }

            return validation;
        }



        /**
         * Display a discreet UI indicator showing which tax year data is being used
         */
        function showTaxDataYearIndicator() {
            // Remove any existing indicator
            const existingIndicator = document.getElementById('taxDataYearIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            // Create new indicator for unified data source
            const indicator = document.createElement('div');
            indicator.id = 'taxDataYearIndicator';
            indicator.className = 'bg-green-50 border border-green-200 text-green-700'; // Always green for unified data
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 500;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: opacity 0.3s ease;
            `;

            const dataStatus = dataLoadingStatus.loaded ? 'validées' : 'chargement...';
            const icon = dataLoadingStatus.loaded ? '✅' : '🔄';
            const message = `${icon} Source unique unifiée (${dataStatus})`;

            indicator.innerHTML = message;

            // Add to page
            document.body.appendChild(indicator);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (indicator && indicator.parentNode) {
                    indicator.style.opacity = '0';
                    setTimeout(() => {
                        if (indicator && indicator.parentNode) {
                            indicator.parentNode.removeChild(indicator);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Global currency formatting function
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-CH', {
                style: 'currency',
                currency: 'CHF',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('CHF', 'CHF');
        }

        // ===== FONCTIONS DE GESTION DES BARÈMES A1-A5 =====

        /**
         * Toggle l'affichage du panneau d'information A1-A5
         */
        function touToggleA1A5Info() {
            const checkbox = document.getElementById('touUseA1A5Brackets');
            const infoPanel = document.getElementById('touA1A5InfoPanel');

            if (checkbox && infoPanel) {
                if (checkbox.checked) {
                    infoPanel.classList.remove('hidden');
                    console.log('📋 [A1-A5] Panneau d\'information A1-A5 affiché');
                } else {
                    infoPanel.classList.add('hidden');
                    console.log('📋 [A1-A5] Panneau d\'information A1-A5 masqué');
                }
            }
        }

        /**
         * Détermine si un contribuable est éligible aux barèmes A1-A5
         * @param {Object} profile - Profil du contribuable
         * @returns {Object} Résultat de l'éligibilité
         */
        function touCheckA1A5Eligibility(profile) {
            console.log('🔍 [A1-A5] Vérification de l\'éligibilité aux barèmes A1-A5', profile);

            const result = {
                eligible: false,
                reason: '',
                recommendedBracket: 'A0',
                alimonyAmount: 0
            };

            // Condition 1: Doit vivre à Genève OU avoir le statut de quasi-résident
            const livesInGeneva = profile.commune === 'Genève' || profile.isGenevaresident;
            const isQuasiResident = profile.isQuasiResident;

            if (!livesInGeneva && !isQuasiResident) {
                result.reason = 'Doit vivre à Genève ou avoir le statut de quasi-résident';
                console.log('❌ [A1-A5] Non éligible:', result.reason);
                return result;
            }

            // Condition 2: Doit payer une pension alimentaire de plus de 12,000 CHF par an
            const alimonyAmount = parseFloat(profile.alimony) || 0;
            if (alimonyAmount <= 12000) {
                result.reason = `Pension alimentaire insuffisante: ${formatCurrency(alimonyAmount)} (minimum: 12,001 CHF)`;
                console.log('❌ [A1-A5] Non éligible:', result.reason);
                return result;
            }

            // Condition 3: Les paiements doivent être pour enfants mineurs ou ex-conjoint
            // (Cette condition est supposée remplie si l'utilisateur saisit une pension alimentaire)

            // Déterminer le barème A1-A5 approprié selon le nombre d'enfants
            const childrenCount = parseInt(profile.childrenCount) || 0;
            let recommendedBracket = 'A1'; // Par défaut A1 (1 enfant)

            if (childrenCount >= 5) {
                recommendedBracket = 'A5';
            } else if (childrenCount >= 4) {
                recommendedBracket = 'A4';
            } else if (childrenCount >= 3) {
                recommendedBracket = 'A3';
            } else if (childrenCount >= 2) {
                recommendedBracket = 'A2';
            } else {
                recommendedBracket = 'A1'; // 1 enfant ou pension pour ex-conjoint
            }

            result.eligible = true;
            result.recommendedBracket = recommendedBracket;
            result.alimonyAmount = alimonyAmount;
            result.reason = `Éligible au barème ${recommendedBracket} (pension: ${formatCurrency(alimonyAmount)}, enfants: ${childrenCount})`;

            console.log('✅ [A1-A5] Éligible:', result);
            return result;
        }

        /**
         * Obtient le taux d'impôt à la source A1-A5 pour un profil donné
         * @param {number} income - Revenu annuel
         * @param {string} bracket - Barème A1-A5 (A1, A2, A3, A4, A5)
         * @returns {number} Taux d'impôt en pourcentage
         */
        function touGetA1A5WithholdingTaxRate(income, bracket) {
            console.log(`🔍 [A1-A5] Recherche du taux pour revenu ${formatCurrency(income)} avec barème ${bracket}`);

            if (!touA1A5TaxBracketsLoaded || !touA1A5TaxBrackets.length) {
                console.warn('⚠️ [A1-A5] Barèmes A1-A5 non chargés, utilisation du barème A0 standard');
                return null;
            }

            // Trouver la tranche appropriée basée sur le revenu
            let applicableBracket = null;

            for (const bracket_data of touA1A5TaxBrackets) {
                if (bracket_data.annee_fr) {
                    // Parser la plage de revenus (format: "79'800 - 80'399")
                    const rangeMatch = bracket_data.annee_fr.match(/(\d+(?:'?\d+)*)\s*-\s*(\d+(?:'?\d+)*)/);
                    if (rangeMatch) {
                        const minIncome = parseInt(rangeMatch[1].replace(/'/g, ''));
                        const maxIncome = parseInt(rangeMatch[2].replace(/'/g, ''));

                        if (income >= minIncome && income <= maxIncome) {
                            applicableBracket = bracket_data;
                            break;
                        }
                    }
                }
            }

            if (!applicableBracket) {
                console.warn(`⚠️ [A1-A5] Aucune tranche trouvée pour le revenu ${formatCurrency(income)}`);
                return null;
            }

            // Extraire le taux selon le barème demandé
            let taxRate = 0;
            const bracketKey = `${bracket}_${bracket.slice(1)}_enfants_pourcent`;

            if (applicableBracket.A_seule_pourcent && applicableBracket.A_seule_pourcent[bracketKey] !== undefined) {
                taxRate = applicableBracket.A_seule_pourcent[bracketKey];
            } else {
                console.warn(`⚠️ [A1-A5] Barème ${bracket} non trouvé dans la tranche, utilisation de A1`);
                taxRate = applicableBracket.A_seule_pourcent?.A1_1_enfants_pourcent || 0;
            }

            console.log(`✅ [A1-A5] Taux trouvé: ${taxRate}% pour barème ${bracket} (tranche: ${applicableBracket.annee_fr})`);
            return taxRate;
        }

        // ===== ALGORITHME D'ESTIMATION DES DÉDUCTIONS FISCALES =====

        /**
         * Enhanced comprehensive deduction calculation system
         * Supports both forfait and actual expense deductions for ICC and IFD
         * @param {Object} profil - Taxpayer profile
         * @param {Object} options - Deduction options and actual expenses
         * @returns {Object} Results for ICC and IFD deductions
         */
        function calculerDeductionsComprehensives(profil, options = {}) {
            console.log('🧮 [ENHANCED DEDUCTIONS] Starting comprehensive deduction calculation', profil, options);

            const deductionType = options.type || 'forfaitaire';

            if (deductionType === 'forfaitaire') {
                return calculerDeductionsForfaitaires(profil);
            } else if (deductionType === 'reel') {
                return calculerDeductionsReelles(profil, options);
            } else {
                throw new Error(`Unknown deduction type: ${deductionType}`);
            }
        }

        /**
         * Calcule les déductions forfaitaires pour ICC et IFD selon l'algorithme officiel
         * @param {Object} profil - Profil du contribuable
         * @returns {Object} Résultats des déductions ICC et IFD
         */
        function calculerDeductionsForfaitaires(profil) {
            console.log('🧮 [DEDUCTIONS] Début du calcul des déductions forfaitaires', profil);

            const resultats = {
                ICC: calculerDeductionsICC(profil),
                IFD: calculerDeductionsIFD(profil)
            };

            console.log('✅ [DEDUCTIONS] Calculs terminés:', resultats);
            return resultats;
        }

        /**
         * Calculate actual expense deductions for ICC and IFD
         * @param {Object} profil - Taxpayer profile
         * @param {Object} options - Actual expense options and amounts
         * @returns {Object} Results for ICC and IFD deductions
         */
        function calculerDeductionsReelles(profil, options) {
            console.log('🧮 [ACTUAL DEDUCTIONS] Starting actual expense deduction calculation', profil, options);

            const resultats = {
                ICC: calculerDeductionsReellesICC(profil, options),
                IFD: calculerDeductionsReellesIFD(profil, options)
            };

            console.log('✅ [ACTUAL DEDUCTIONS] Calculations completed:', resultats);
            return resultats;
        }

        /**
         * Helper function to get social contribution rates from JSON configuration
         * @param {string} contributionType - Type of contribution (avs, ai, apg, ac, af, amat, cpe, lfp, pilier2, aanp)
         * @param {string} rateType - Type of rate (taux_employe, taux_employeur, plafond_salaire, etc.)
         * @returns {number|null} The rate value or null if not found
         */
        function getSocialContributionRate(contributionType, rateType = 'taux_employe') {
            try {
                if (!socialContributionRates || !socialContributionRates[contributionType]) {
                    console.warn(`⚠️ [SOCIAL RATES] Contribution type '${contributionType}' not found, using fallback`);
                    return null;
                }

                const contribution = socialContributionRates[contributionType];
                const rate = contribution[rateType];

                if (rate === undefined || rate === null) {
                    console.warn(`⚠️ [SOCIAL RATES] Rate type '${rateType}' not found for '${contributionType}', using fallback`);
                    return null;
                }

                return rate;
            } catch (error) {
                console.error(`❌ [SOCIAL RATES] Error getting rate for ${contributionType}.${rateType}:`, error);
                return null;
            }
        }

        /**
         * Calculate social contributions using rates from JSON configuration
         * @param {number} grossIncome - Gross income (revenu_brut_determinant)
         * @returns {Object} Object containing all social contribution amounts and details
         */
        function calculateSocialContributions(grossIncome) {
            const contributions = {};
            let totalContributions = 0;

            try {
                // AVS/AI/APG (combined in current implementation)
                const avsRate = getSocialContributionRate('avs', 'taux_employe') || 0.0435;
                const aiRate = getSocialContributionRate('ai', 'taux_employe') || 0.007;
                const apgRate = getSocialContributionRate('apg', 'taux_employe') || 0.0025;
                const combinedAvsAiApgRate = avsRate + aiRate + apgRate; // Total: 0.053

                contributions.avs_ai_apg = grossIncome * combinedAvsAiApgRate;
                totalContributions += contributions.avs_ai_apg;

                // Unemployment insurance (AC)
                const acRate = getSocialContributionRate('ac', 'taux_employe') || 0.011;
                const acCeiling = getSocialContributionRate('ac', 'plafond_salaire') || 148200;
                contributions.chomage = Math.min(grossIncome, acCeiling) * acRate;
                totalContributions += contributions.chomage;

                // 2nd pillar (Pilier 2)
                const pilier2Rate = getSocialContributionRate('pilier2', 'taux_employe_moyen') || 0.06;
                const pilier2Ceiling = getSocialContributionRate('pilier2', 'plafond_cotisation_annuelle') || 54432;
                contributions.pilier2 = Math.min(grossIncome * pilier2Rate, pilier2Ceiling);
                totalContributions += contributions.pilier2;

                // Maternity allowance (AMat) - Geneva specific
                const amatRate = getSocialContributionRate('amat', 'taux_employe') || 0.00032;
                contributions.maternite = grossIncome * amatRate;
                totalContributions += contributions.maternite;

                // Non-professional accident insurance (AANP)
                const aanpRate = getSocialContributionRate('aanp', 'taux_employe') || 0.01;
                const aanpCeiling = getSocialContributionRate('aanp', 'plafond_cotisation_annuelle') || 1482;
                contributions.aanp = Math.min(grossIncome * aanpRate, aanpCeiling);
                totalContributions += contributions.aanp;

                contributions.total = totalContributions;

                console.log(`📊 [SOCIAL CONTRIBUTIONS] Calculated for ${grossIncome.toLocaleString()} CHF:`, {
                    'AVS/AI/APG': contributions.avs_ai_apg.toFixed(2),
                    'Chômage': contributions.chomage.toFixed(2),
                    '2ème pilier': contributions.pilier2.toFixed(2),
                    'Maternité': contributions.maternite.toFixed(2),
                    'AANP': contributions.aanp.toFixed(2),
                    'Total': contributions.total.toFixed(2)
                });

                return contributions;

            } catch (error) {
                console.error('❌ [SOCIAL CONTRIBUTIONS] Error calculating social contributions:', error);
                // Return fallback calculation with hard-coded rates
                return {
                    avs_ai_apg: grossIncome * 0.053,
                    chomage: Math.min(grossIncome, 148200) * 0.011,
                    pilier2: Math.min(grossIncome * 0.06, 54432),
                    maternite: grossIncome * 0.00032,
                    aanp: Math.min(grossIncome * 0.01, 1482),
                    total: grossIncome * 0.053 + Math.min(grossIncome, 148200) * 0.011 + Math.min(grossIncome * 0.06, 54432) + grossIncome * 0.00032 + Math.min(grossIncome * 0.01, 1482)
                };
            }
        }

        /**
         * Étape A : Calcul des Déductions pour l'Impôt Cantonal et Communal (ICC)
         */
        function calculerDeductionsICC(profil) {
            console.log('🏛️ [ICC] Calcul des déductions ICC');

            let totalDeductionsIcc = 0;
            const detailsCalculIcc = {};

            // Calcul des cotisations sociales (points 1 à 5) - using JSON configuration
            const socialContributions = calculateSocialContributions(profil.revenu_brut_determinant);

            detailsCalculIcc['Cotisation AVS/AI/APG'] = socialContributions.avs_ai_apg;
            detailsCalculIcc['Cotisation chômage'] = socialContributions.chomage;
            detailsCalculIcc['Cotisation 2ème pilier'] = socialContributions.pilier2;
            detailsCalculIcc['Cotisation maternité'] = socialContributions.maternite;
            detailsCalculIcc['Prime AANP'] = socialContributions.aanp;

            const totalCotisations = socialContributions.total;

            totalDeductionsIcc += totalCotisations;

            console.log(`💼 [ICC] Cotisations sociales: ${formatCurrency(totalCotisations)}`);

            // Calcul des déductions restantes (points 6 à 9)

            // Frais professionnels (point 6) - Déduction forfaitaire ICC
            // 3% du revenu net (revenu brut - cotisations sociales)
            // Minimum 634 CHF - Maximum 1,796 CHF
            const revenuApresCotisations = profil.revenu_brut_determinant - totalCotisations;
            const deductionFraisProBrute = revenuApresCotisations * 0.03;
            const deductionFraisPro = Math.max(634, Math.min(deductionFraisProBrute, 1796));

            detailsCalculIcc['Frais professionnels'] = deductionFraisPro;
            totalDeductionsIcc += deductionFraisPro;

            console.log(`📋 [ICC] Frais professionnels: ${formatCurrency(deductionFraisPro)} (3% de ${formatCurrency(revenuApresCotisations)}, min 634 CHF, max 1,796 CHF)`);

            // Primes d'assurance-maladie (point 7)
            let deductionMaladie = profil.etat_civil === 'marié' ? 13728 : 6864;
            deductionMaladie += profil.nombre_enfants * 1764;

            detailsCalculIcc['Primes assurance-maladie'] = deductionMaladie;
            totalDeductionsIcc += deductionMaladie;

            console.log(`🏥 [ICC] Primes assurance-maladie: ${formatCurrency(deductionMaladie)}`);

            // Déduction pour enfant (point 8)
            const deductionEnfant = profil.nombre_enfants * 13660;

            if (deductionEnfant > 0) {
                detailsCalculIcc['Déduction pour enfants'] = deductionEnfant;
                totalDeductionsIcc += deductionEnfant;
                console.log(`👶 [ICC] Déduction enfants: ${formatCurrency(deductionEnfant)}`);
            }

            // Déduction pour époux (point 9)
            let deductionEpoux = 0;
            if (profil.etat_civil === 'marié' && profil.epoux_exercent_activite_lucrative) {
                deductionEpoux = 1051;
                detailsCalculIcc['Déduction pour époux'] = deductionEpoux;
                totalDeductionsIcc += deductionEpoux;
                console.log(`💑 [ICC] Déduction époux: ${formatCurrency(deductionEpoux)}`);
            }

            const resultat = {
                total_deductions_sur_revenu: totalDeductionsIcc,
                details: detailsCalculIcc
            };

            console.log(`✅ [ICC] Total déductions: ${formatCurrency(totalDeductionsIcc)}`);
            return resultat;
        }

        /**
         * Calculate actual expense deductions for ICC (Cantonal and Communal Tax)
         * @param {Object} profil - Taxpayer profile
         * @param {Object} options - Actual expense options and amounts
         * @returns {Object} ICC deduction results
         */
        function calculerDeductionsReellesICC(profil, options) {
            console.log('🏛️ [ICC ACTUAL] Starting ICC actual expense deductions calculation');

            let totalDeductionsIcc = 0;
            const detailsCalculIcc = {};

            // Social contributions (same as forfait - points 1 to 5) - using JSON configuration
            const socialContributions = calculateSocialContributions(profil.revenu_brut_determinant);

            detailsCalculIcc['Cotisation AVS/AI/APG'] = socialContributions.avs_ai_apg;
            detailsCalculIcc['Cotisation chômage'] = socialContributions.chomage;
            detailsCalculIcc['Cotisation 2ème pilier'] = socialContributions.pilier2;
            detailsCalculIcc['Cotisation maternité'] = socialContributions.maternite;
            detailsCalculIcc['Prime AANP'] = socialContributions.aanp;

            const totalCotisations = socialContributions.total;

            totalDeductionsIcc += totalCotisations;

            // Professional expenses - actual expenses (ICC specific rules)
            let professionalExpenses = 0;

            // Home-to-work commuting (ICC: 529 CHF forfait, not combinable with general professional expense forfait)
            if (options.commuting && options.commuting.enabled) {
                professionalExpenses += 529; // Fixed forfait for ICC
                detailsCalculIcc['Frais de transport domicile-travail'] = 529;
            }

            // Meal expenses (ICC specific rules)
            if (options.meals && options.meals.enabled) {
                let mealExpenses = 0;
                const workingDays = options.meals.workingDays || 220; // Default 220 working days per year

                if (options.meals.employerContribution) {
                    // With employer contribution: 7.50 CHF/day, max 1,600 CHF/year
                    mealExpenses = Math.min(workingDays * 7.5, 1600);
                    detailsCalculIcc['Frais de repas (avec contribution employeur)'] = mealExpenses;
                } else {
                    // Without employer contribution: 15 CHF/day, max 3,200 CHF/year
                    mealExpenses = Math.min(workingDays * 15, 3200);
                    detailsCalculIcc['Frais de repas (sans contribution employeur)'] = mealExpenses;
                }

                professionalExpenses += mealExpenses;
            }

            totalDeductionsIcc += professionalExpenses;

            // Health and accident insurance premiums (ICC: age-based limits)
            if (options.healthInsurance && options.healthInsurance.enabled) {
                let healthInsuranceDeduction = 0;
                const premiums = options.healthInsurance.premiums || [];

                premiums.forEach(premium => {
                    let maxDeduction = 0;
                    if (premium.ageCategory === 'children') {
                        maxDeduction = 3811; // Children
                    } else if (premium.ageCategory === 'young_adults') {
                        maxDeduction = 12442; // Ages 18-26
                    } else if (premium.ageCategory === 'adults') {
                        maxDeduction = 16207; // Adults
                    }

                    const deduction = Math.min(premium.amount || 0, maxDeduction);
                    healthInsuranceDeduction += deduction;
                    detailsCalculIcc[`Primes assurance maladie (${premium.ageCategory})`] = deduction;
                });

                totalDeductionsIcc += healthInsuranceDeduction;
            }

            // Medical expenses (ICC only - must exceed 0.5% of taxable net income, after insurance reimbursements)
            if (options.medicalExpenses && options.medicalExpenses.enabled) {
                const netTaxableIncome = profil.revenu_brut_determinant - totalCotisations;
                const threshold = netTaxableIncome * 0.005; // 0.5% threshold
                const medicalExpensesAfterInsurance = (options.medicalExpenses.amount || 0) - (options.medicalExpenses.insuranceReimbursement || 0);

                if (medicalExpensesAfterInsurance > threshold) {
                    const medicalDeduction = medicalExpensesAfterInsurance - threshold;
                    detailsCalculIcc['Frais médicaux (au-delà du seuil)'] = medicalDeduction;
                    totalDeductionsIcc += medicalDeduction;
                }
            }

            // 3rd pillar A (7,056 CHF/year for employees with 2nd pillar)
            if (options.pillar3A && options.pillar3A.enabled && options.pillar3A.hasSecondPillar) {
                const pillar3ADeduction = Math.min(options.pillar3A.amount || 0, 7056);
                detailsCalculIcc['3ème pilier A'] = pillar3ADeduction;
                totalDeductionsIcc += pillar3ADeduction;
            }

            // 3rd pillar B (ICC only - 2,324 CHF/year per adult)
            if (options.pillar3B && options.pillar3B.enabled) {
                const adults = options.pillar3B.adults || 1;
                const pillar3BDeduction = Math.min(options.pillar3B.amount || 0, 2324 * adults);
                detailsCalculIcc['3ème pilier B'] = pillar3BDeduction;
                totalDeductionsIcc += pillar3BDeduction;
            }

            // Childcare expenses (ICC: 26,080 CHF/year per child)
            if (options.childcare && options.childcare.enabled) {
                const children = options.childcare.children || 0;
                const childcareDeduction = Math.min(options.childcare.amount || 0, 26080 * children);
                detailsCalculIcc['Frais de garde d\'enfants'] = childcareDeduction;
                totalDeductionsIcc += childcareDeduction;
            }

            // Loan interest (both ICC and IFD - 50,000 CHF limit)
            if (options.loanInterest && options.loanInterest.enabled) {
                const loanInterestDeduction = Math.min(options.loanInterest.amount || 0, 50000);
                detailsCalculIcc['Intérêts d\'emprunts'] = loanInterestDeduction;
                totalDeductionsIcc += loanInterestDeduction;
            }

            // Union contributions (ICC only - 700 CHF/year maximum)
            if (options.unionContributions && options.unionContributions.enabled) {
                const unionDeduction = Math.min(options.unionContributions.amount || 0, 700);
                detailsCalculIcc['Cotisations syndicales'] = unionDeduction;
                totalDeductionsIcc += unionDeduction;
            }

            // Double residence expenses (both ICC and IFD - 500 CHF/month)
            if (options.doubleResidence && options.doubleResidence.enabled) {
                const months = options.doubleResidence.months || 12;
                const doubleResidenceDeduction = Math.min(options.doubleResidence.amount || 0, 500 * months);
                detailsCalculIcc['Frais de double domicile'] = doubleResidenceDeduction;
                totalDeductionsIcc += doubleResidenceDeduction;
            }

            // Training expenses (ICC: 12,140 CHF/year)
            if (options.trainingExpenses && options.trainingExpenses.enabled) {
                const trainingDeduction = Math.min(options.trainingExpenses.amount || 0, 12140);
                detailsCalculIcc['Frais de formation'] = trainingDeduction;
                totalDeductionsIcc += trainingDeduction;
            }

            // Alimony payments (ICC: Half family charge deduction (6,768 CHF) for children under 18)
            if (options.alimony && options.alimony.enabled && options.alimony.childrenUnder18) {
                const alimonyDeduction = Math.min(options.alimony.amount || 0, 6768);
                detailsCalculIcc['Pensions alimentaires (enfants < 18 ans)'] = alimonyDeduction;
                totalDeductionsIcc += alimonyDeduction;
            }

            // Real estate work (both ICC and IFD - no limit)
            if (options.realEstateWork && options.realEstateWork.enabled) {
                const realEstateDeduction = options.realEstateWork.amount || 0;
                detailsCalculIcc['Travaux immobiliers'] = realEstateDeduction;
                totalDeductionsIcc += realEstateDeduction;
            }

            // Property maintenance (20% forfait of gross rent or rental value)
            if (options.propertyMaintenance && options.propertyMaintenance.enabled) {
                const grossRent = options.propertyMaintenance.grossRent || 0;
                const propertyMaintenanceDeduction = grossRent * 0.20;
                detailsCalculIcc['Entretien immobilier (20% forfait)'] = propertyMaintenanceDeduction;
                totalDeductionsIcc += propertyMaintenanceDeduction;
            }

            console.log(`✅ [ICC ACTUAL] Total ICC actual deductions: ${formatCurrency(totalDeductionsIcc)}`);

            return {
                total_deductions_sur_revenu: totalDeductionsIcc,
                details: detailsCalculIcc
            };
        }

        /**
         * Étape B : Calcul des Déductions pour l'Impôt Fédéral Direct (IFD)
         */
        function calculerDeductionsIFD(profil) {
            console.log('🏛️ [IFD] Calcul des déductions IFD');

            let totalDeductionsIfd = 0;
            let creditImpotIfd = 0;
            const detailsCalculIfd = {};

            // Calcul des cotisations sociales (points 1 à 5) - identique à ICC - using JSON configuration
            const socialContributions = calculateSocialContributions(profil.revenu_brut_determinant);

            detailsCalculIfd['Cotisation AVS/AI/APG'] = socialContributions.avs_ai_apg;
            detailsCalculIfd['Cotisation chômage'] = socialContributions.chomage;
            detailsCalculIfd['Cotisation 2ème pilier'] = socialContributions.pilier2;
            detailsCalculIfd['Cotisation maternité'] = socialContributions.maternite;
            detailsCalculIfd['Prime AANP'] = socialContributions.aanp;

            const totalCotisations = socialContributions.total;

            totalDeductionsIfd += totalCotisations;

            console.log(`💼 [IFD] Cotisations sociales: ${formatCurrency(totalCotisations)}`);

            // Calcul des déductions restantes (points 6 à 10)

            // Frais professionnels (point 6) - Déduction forfaitaire IFD
            // 3% du revenu net (revenu brut - cotisations sociales)
            // Minimum 2,000 CHF - Maximum 4,000 CHF
            const revenuApresCotisationsIfd = profil.revenu_brut_determinant - totalCotisations;
            const deductionForfaitaireBrute = revenuApresCotisationsIfd * 0.03;
            const deductionFraisPro = Math.max(2000, Math.min(deductionForfaitaireBrute, 4000));

            detailsCalculIfd['Frais professionnels'] = deductionFraisPro;
            totalDeductionsIfd += deductionFraisPro;

            console.log(`📋 [IFD] Frais professionnels: ${formatCurrency(deductionFraisPro)} (3% de ${formatCurrency(revenuApresCotisationsIfd)}, min 2,000 CHF, max 4,000 CHF)`);

            // Primes d'assurances (point 7)
            let primeAssurance;
            if (profil.etat_civil === 'marié') {
                primeAssurance = Math.min(profil.revenu_brut_determinant * 0.05, 3700);
            } else {
                primeAssurance = Math.min(profil.revenu_brut_determinant * 0.03, 1800);
            }
            primeAssurance += profil.nombre_enfants * 700;

            detailsCalculIfd['Primes d\'assurances'] = primeAssurance;
            totalDeductionsIfd += primeAssurance;

            console.log(`🏥 [IFD] Primes assurances: ${formatCurrency(primeAssurance)}`);

            // Déduction pour enfant (point 8)
            const deductionEnfant = profil.nombre_enfants * 6800;

            if (deductionEnfant > 0) {
                detailsCalculIfd['Déduction pour enfants'] = deductionEnfant;
                totalDeductionsIfd += deductionEnfant;
                console.log(`👶 [IFD] Déduction enfants: ${formatCurrency(deductionEnfant)}`);
            }

            // Déduction pour conjoint (point 9)
            let deductionConjoint = 0;
            if (profil.etat_civil === 'marié') {
                deductionConjoint = 2800;
                detailsCalculIfd['Déduction pour conjoint'] = deductionConjoint;
                totalDeductionsIfd += deductionConjoint;
                console.log(`💑 [IFD] Déduction conjoint: ${formatCurrency(deductionConjoint)}`);
            }

            // Déduction pour époux (point 10)
            let deductionEpoux = 0;
            if (profil.etat_civil === 'marié' && profil.epoux_exercent_activite_lucrative) {
                const deductionEpouxBrute = profil.revenu_brut_le_plus_bas * 0.50;
                deductionEpoux = Math.max(8600, Math.min(deductionEpouxBrute, 14100));
                detailsCalculIfd['Déduction pour époux'] = deductionEpoux;
                totalDeductionsIfd += deductionEpoux;
                console.log(`👫 [IFD] Déduction époux: ${formatCurrency(deductionEpoux)}`);
            }

            // Calcul du crédit d'impôt (point 11)
            creditImpotIfd = profil.nombre_enfants * 263;
            if (creditImpotIfd > 0) {
                console.log(`💰 [IFD] Crédit d'impôt enfants: ${formatCurrency(creditImpotIfd)}`);
            }

            const resultat = {
                total_deductions_sur_revenu: totalDeductionsIfd,
                credit_impot_final: creditImpotIfd,
                details: detailsCalculIfd
            };

            console.log(`✅ [IFD] Total déductions: ${formatCurrency(totalDeductionsIfd)}, Crédit d'impôt: ${formatCurrency(creditImpotIfd)}`);
            return resultat;
        }

        /**
         * Calculate actual expense deductions for IFD (Federal Direct Tax)
         * @param {Object} profil - Taxpayer profile
         * @param {Object} options - Actual expense options and amounts
         * @returns {Object} IFD deduction results
         */
        function calculerDeductionsReellesIFD(profil, options) {
            console.log('🏛️ [IFD ACTUAL] Starting IFD actual expense deductions calculation');

            let totalDeductionsIfd = 0;
            let creditImpotIfd = 0;
            const detailsCalculIfd = {};

            // Social contributions (same as forfait - points 1 to 5) - using JSON configuration
            const socialContributions = calculateSocialContributions(profil.revenu_brut_determinant);

            detailsCalculIfd['Cotisation AVS/AI/APG'] = socialContributions.avs_ai_apg;
            detailsCalculIfd['Cotisation chômage'] = socialContributions.chomage;
            detailsCalculIfd['Cotisation 2ème pilier'] = socialContributions.pilier2;
            detailsCalculIfd['Cotisation maternité'] = socialContributions.maternite;
            detailsCalculIfd['Prime AANP'] = socialContributions.aanp;

            const totalCotisations = socialContributions.total;

            totalDeductionsIfd += totalCotisations;

            // Professional expenses - actual expenses (IFD specific rules)
            let professionalExpenses = 0;

            // Home-to-work commuting (IFD: Actual expenses up to 3,200 CHF maximum, can be combined with forfait)
            if (options.commuting && options.commuting.enabled) {
                const commutingDeduction = Math.min(options.commuting.amount || 0, 3200);
                professionalExpenses += commutingDeduction;
                detailsCalculIfd['Frais de transport domicile-travail'] = commutingDeduction;
            }

            // Meal expenses (IFD: Same as ICC but can be combined with forfait)
            if (options.meals && options.meals.enabled) {
                let mealExpenses = 0;
                const workingDays = options.meals.workingDays || 220; // Default 220 working days per year

                if (options.meals.employerContribution) {
                    // With employer contribution: 7.50 CHF/day, max 1,600 CHF/year
                    mealExpenses = Math.min(workingDays * 7.5, 1600);
                    detailsCalculIfd['Frais de repas (avec contribution employeur)'] = mealExpenses;
                } else {
                    // Without employer contribution: 15 CHF/day, max 3,200 CHF/year
                    mealExpenses = Math.min(workingDays * 15, 3200);
                    detailsCalculIfd['Frais de repas (sans contribution employeur)'] = mealExpenses;
                }

                professionalExpenses += mealExpenses;
            }

            // For IFD, if no actual professional expenses are claimed, use the forfait
            if (professionalExpenses === 0) {
                const deductionForfaitaireBrute = profil.revenu_brut_determinant * 0.03;
                professionalExpenses = Math.max(2000, Math.min(deductionForfaitaireBrute, 4000));
                detailsCalculIfd['Frais professionnels (forfait)'] = professionalExpenses;
            }

            totalDeductionsIfd += professionalExpenses;

            // Health and accident insurance premiums (IFD: family status-based limits)
            if (options.healthInsurance && options.healthInsurance.enabled) {
                let healthInsuranceDeduction = 0;

                if (profil.etat_civil === 'marié') {
                    // Married couple: 3,500 CHF
                    healthInsuranceDeduction = Math.min(options.healthInsurance.amount || 0, 3500);
                    detailsCalculIfd['Primes assurance maladie (couple marié)'] = healthInsuranceDeduction;
                } else {
                    // Single: 1,700 CHF
                    healthInsuranceDeduction = Math.min(options.healthInsurance.amount || 0, 1700);
                    detailsCalculIfd['Primes assurance maladie (célibataire)'] = healthInsuranceDeduction;
                }

                // Per dependent child: 700 CHF
                if (options.healthInsurance.dependentChildren) {
                    const childrenDeduction = Math.min(
                        (options.healthInsurance.childrenAmount || 0),
                        700 * (options.healthInsurance.dependentChildren || 0)
                    );
                    healthInsuranceDeduction += childrenDeduction;
                    detailsCalculIfd['Primes assurance maladie (enfants à charge)'] = childrenDeduction;
                }

                totalDeductionsIfd += healthInsuranceDeduction;
            }

            // 3rd pillar A (7,056 CHF/year for employees with 2nd pillar)
            if (options.pillar3A && options.pillar3A.enabled && options.pillar3A.hasSecondPillar) {
                const pillar3ADeduction = Math.min(options.pillar3A.amount || 0, 7056);
                detailsCalculIfd['3ème pilier A'] = pillar3ADeduction;
                totalDeductionsIfd += pillar3ADeduction;
            }

            // Childcare expenses (IFD: 25,500 CHF/year per child)
            if (options.childcare && options.childcare.enabled) {
                const children = options.childcare.children || 0;
                const childcareDeduction = Math.min(options.childcare.amount || 0, 25500 * children);
                detailsCalculIfd['Frais de garde d\'enfants'] = childcareDeduction;
                totalDeductionsIfd += childcareDeduction;
            }

            // Loan interest (both ICC and IFD - 50,000 CHF limit)
            if (options.loanInterest && options.loanInterest.enabled) {
                const loanInterestDeduction = Math.min(options.loanInterest.amount || 0, 50000);
                detailsCalculIfd['Intérêts d\'emprunts'] = loanInterestDeduction;
                totalDeductionsIfd += loanInterestDeduction;
            }

            // Double residence expenses (both ICC and IFD - 500 CHF/month)
            if (options.doubleResidence && options.doubleResidence.enabled) {
                const months = options.doubleResidence.months || 12;
                const doubleResidenceDeduction = Math.min(options.doubleResidence.amount || 0, 500 * months);
                detailsCalculIfd['Frais de double domicile'] = doubleResidenceDeduction;
                totalDeductionsIfd += doubleResidenceDeduction;
            }

            // Training expenses (IFD: 12,900 CHF/year)
            if (options.trainingExpenses && options.trainingExpenses.enabled) {
                const trainingDeduction = Math.min(options.trainingExpenses.amount || 0, 12900);
                detailsCalculIfd['Frais de formation'] = trainingDeduction;
                totalDeductionsIfd += trainingDeduction;
            }

            // Alimony payments (IFD: No limit)
            if (options.alimony && options.alimony.enabled) {
                const alimonyDeduction = options.alimony.amount || 0;
                detailsCalculIfd['Pensions alimentaires'] = alimonyDeduction;
                totalDeductionsIfd += alimonyDeduction;
            }

            // Real estate work (both ICC and IFD - no limit)
            if (options.realEstateWork && options.realEstateWork.enabled) {
                const realEstateDeduction = options.realEstateWork.amount || 0;
                detailsCalculIfd['Travaux immobiliers'] = realEstateDeduction;
                totalDeductionsIfd += realEstateDeduction;
            }

            // Property maintenance (20% forfait of gross rent or rental value)
            if (options.propertyMaintenance && options.propertyMaintenance.enabled) {
                const grossRent = options.propertyMaintenance.grossRent || 0;
                const propertyMaintenanceDeduction = grossRent * 0.20;
                detailsCalculIfd['Entretien immobilier (20% forfait)'] = propertyMaintenanceDeduction;
                totalDeductionsIfd += propertyMaintenanceDeduction;
            }

            // Calculate child tax credit for IFD (same logic as forfait)
            if (profil.nombre_enfants > 0) {
                creditImpotIfd = profil.nombre_enfants * 251;
                console.log(`💰 [IFD ACTUAL] Crédit d'impôt enfants: ${formatCurrency(creditImpotIfd)}`);
            }

            console.log(`✅ [IFD ACTUAL] Total IFD actual deductions: ${formatCurrency(totalDeductionsIfd)}`);

            return {
                total_deductions_sur_revenu: totalDeductionsIfd,
                credit_impot_final: creditImpotIfd,
                details: detailsCalculIfd
            };
        }

        // Function to calculate IFD (Impôt Fédéral Direct) according to the official algorithm
        function calculateIfdTax(revenu_imposable, statut_fiscal) {
            console.log(`🏛️ [IFD] Starting IFD calculation for ${revenu_imposable} CHF, status: ${statut_fiscal}`);

            // Use loaded IFD data if available, otherwise use embedded fallback data
            let bareme_IFD = ifdTaxBrackets;

            if (!bareme_IFD) {
                console.error('❌ [IFD] IFD tax brackets not loaded from unified data');
                throw new Error('IFD tax data not loaded. Please ensure loadUnifiedTaxData() is called first.');
            }

            // Step 1: Select appropriate tax bracket based on fiscal status
            let selectedBrackets;
            if (statut_fiscal === 'marie' || statut_fiscal === 'marie_splitting') {
                selectedBrackets = bareme_IFD["Mariés"];
                console.log(`🏛️ [IFD] Using "Mariés" tax brackets`);
            } else {
                selectedBrackets = bareme_IFD["Célibataires"];
                console.log(`🏛️ [IFD] Using "Célibataires" tax brackets`);
            }

            if (!selectedBrackets || !Array.isArray(selectedBrackets)) {
                console.error('❌ [IFD] Invalid tax brackets structure');
                return {
                    impotTotal: 0,
                    revenuImposable: revenu_imposable,
                    statutFiscal: statut_fiscal,
                    tauxEffectif: 0,
                    details: []
                };
            }

            // Step 2: Initialize calculation
            let impot_total = 0;
            let calculationDetails = [];

            console.log(`🏛️ [IFD] Processing ${selectedBrackets.length} tax brackets`);

            // Step 3: Process each tax bracket using correct progressive tax logic
            for (let i = 0; i < selectedBrackets.length; i++) {
                const tranche = selectedBrackets[i];
                const tranche_inferieure = tranche["Tranche inférieure"];
                const tranche_superieure = tranche["Tranche supérieure"];
                const taux_tranche = tranche["Taux de la tranche"]; // Already in decimal format

                console.log(`🏛️ [IFD] Processing bracket ${i + 1}: ${tranche_inferieure} - ${tranche_superieure}, rate: ${(taux_tranche * 100).toFixed(2)}%`);

                // Skip if income is below this bracket
                if (revenu_imposable < tranche_inferieure) {
                    console.log(`🏛️ [IFD] Income ${revenu_imposable} below bracket minimum ${tranche_inferieure}, stopping calculation`);
                    break;
                }

                // Handle "plus" value for highest bracket
                const isHighestBracket = tranche_superieure === "plus";
                const effectiveUpperLimit = isHighestBracket ? revenu_imposable : Math.min(tranche_superieure, revenu_imposable);

                // Calculate taxable amount in this bracket
                const taxableInThisBracket = effectiveUpperLimit - tranche_inferieure;

                if (taxableInThisBracket > 0) {
                    const impot_de_la_tranche = taxableInThisBracket * taux_tranche;
                    impot_total += impot_de_la_tranche;

                    calculationDetails.push({
                        tranche: `${tranche_inferieure} - ${tranche_superieure}`,
                        montantImpose: taxableInThisBracket,
                        taux: taux_tranche * 100, // Convert to percentage for display
                        impot: impot_de_la_tranche,
                        type: revenu_imposable > tranche_superieure && !isHighestBracket ? 'complete' : 'partial'
                    });

                    console.log(`🏛️ [IFD] Bracket calculation: ${taxableInThisBracket} × ${(taux_tranche * 100).toFixed(2)}% = ${impot_de_la_tranche.toFixed(2)} CHF`);
                }

                // If income doesn't exceed this bracket, we're done
                if (revenu_imposable <= tranche_superieure || isHighestBracket) {
                    console.log(`🏛️ [IFD] Final total tax: ${impot_total.toFixed(2)} CHF`);
                    break;
                }
            }

            // Calculate effective tax rate
            const tauxEffectif = revenu_imposable > 0 ? (impot_total / revenu_imposable) * 100 : 0;

            console.log(`🏛️ [IFD] Calculation complete: ${impot_total.toFixed(2)} CHF (${tauxEffectif.toFixed(2)}%)`);

            return {
                impotTotal: impot_total,
                revenuImposable: revenu_imposable,
                statutFiscal: statut_fiscal,
                tauxEffectif: tauxEffectif,
                details: calculationDetails
            };
        }

        // Function to calculate ICC base tax according to the official algorithm - REFACTORED FOR ACCURACY
        function calculateIccBaseTax(revenuImposable, statutFiscal) {
            console.log(`📊 [ICC BASE] Starting calculation: ${formatCurrency(revenuImposable)}, ${statutFiscal}`);

            // Validate that unified data is loaded
            if (!dataLoadingStatus.loaded || !iccTaxBrackets || iccTaxBrackets.length === 0) {
                console.error('❌ [ICC BASE] Unified tax data not loaded');
                throw new Error('Tax data not loaded. Please ensure loadUnifiedTaxData() is called first.');
            }

            const taxBracketsData = iccTaxBrackets;

            // CRITICAL FIX: Correct splitting coefficient application
            const splittingCoeff = getSplittingCoefficient(statutFiscal);

            // CORRECT: Divide by splitting coefficient for calculation (not multiply)
            const splitIncome = splittingCoeff < 1 ? revenuImposable / splittingCoeff : revenuImposable;

            console.log(`📊 [ICC BASE] Splitting coefficient: ${splittingCoeff}, Split income: ${formatCurrency(splitIncome)}`);

            // PHASE 2 ENHANCEMENT: Robust bracket finding with boundary condition handling
            let applicableBracket = null;

            // Handle edge case: zero or negative income
            if (splitIncome <= 0) {
                console.log(`📊 [ICC BASE] Zero/negative income: ${formatCurrency(splitIncome)}`);
                return {
                    impotDeBase: 0,
                    revenuImposable: revenuImposable,
                    referenceIncome: splitIncome,
                    statutFiscal: statutFiscal,
                    splittingCoeff: splittingCoeff,
                    details: { reason: 'Zero or negative income' }
                };
            }

            // Enhanced bracket finding with boundary precision
            for (let i = 0; i < taxBracketsData.length; i++) {
                const bracket = taxBracketsData[i];

                // Handle boundary conditions precisely
                const isInRange = splitIncome >= bracket.revenu_min &&
                                 (bracket.revenu_max === "plus" || splitIncome <= bracket.revenu_max);

                // Special handling for bracket boundaries (exact matches)
                const isExactBoundary = splitIncome === bracket.revenu_max || splitIncome === bracket.revenu_min;

                if (isInRange) {
                    applicableBracket = bracket;

                    // Log boundary condition details
                    if (isExactBoundary) {
                        console.log(`🎯 [ICC BASE] Exact bracket boundary detected: ${formatCurrency(splitIncome)} at bracket ${i}`);
                    }
                    break;
                }
            }

            if (!applicableBracket) {
                console.warn(`⚠️ [ICC BASE] No applicable bracket found for income: ${formatCurrency(splitIncome)}`);
                return {
                    impotDeBase: 0,
                    revenuImposable: revenuImposable,
                    referenceIncome: splitIncome,
                    statutFiscal: statutFiscal,
                    splittingCoeff: splittingCoeff,
                    error: 'No applicable tax bracket'
                };
            }

            console.log(`🎯 [ICC BASE] Found bracket: ${applicableBracket.revenu_min} - ${applicableBracket.revenu_max}, rate: ${applicableBracket.taux_imposition_pourcentage}%`);

            // CRITICAL FIX: Use cumulative tax + marginal calculation (not recalculate from scratch)
            const excessIncome = Math.max(0, splitIncome - applicableBracket.revenu_min);
            const marginalRate = applicableBracket.taux_imposition_pourcentage / 100;
            const marginalTax = excessIncome * marginalRate;
            const cumulativeTax = applicableBracket.impot_total_cumul_chf || 0;
            const totalTaxBeforeSplitting = cumulativeTax + marginalTax;

            // CRITICAL FIX: Apply splitting multiplier correctly
            const finalTax = splittingCoeff < 1 ? totalTaxBeforeSplitting / splittingCoeff : totalTaxBeforeSplitting;

            console.log(`📊 [ICC BASE] Calculation details:
                - Excess income: ${formatCurrency(excessIncome)}
                - Marginal rate: ${(marginalRate * 100).toFixed(2)}%
                - Marginal tax: ${formatCurrency(marginalTax)}
                - Cumulative tax: ${formatCurrency(cumulativeTax)}
                - Total before splitting: ${formatCurrency(totalTaxBeforeSplitting)}
                - Final tax: ${formatCurrency(finalTax)}`);

            return {
                impotDeBase: finalTax,
                revenuImposable: revenuImposable,
                referenceIncome: splitIncome,
                statutFiscal: statutFiscal,
                splittingCoeff: splittingCoeff,
                details: {
                    excessIncome,
                    marginalRate,
                    marginalTax,
                    cumulativeTax,
                    totalBeforeSplitting: totalTaxBeforeSplitting,
                    finalTax,
                    bracket: applicableBracket
                }
            };

        }




        // Function to get municipal tax rate - UNIFIED DATA SOURCE ONLY
        function getMunicipalTaxRate(commune, anneeFiscale) {
            console.log(`🏛️ [MUNICIPAL RATE] Looking up rate for: "${commune}"`);

            // Validate that unified data is loaded
            if (!dataLoadingStatus.loaded || !municipalTaxRates) {
                console.error('❌ [MUNICIPAL RATE] Unified tax data not loaded');
                throw new Error('Tax data not loaded. Please ensure loadUnifiedTaxData() is called first.');
            }

            // Normalize commune name for lookup
            const normalizedCommune = commune.toUpperCase()
                                             .trim()
                                             .replace(/[ÀÁÂÄàáâä]/g, 'A')
                                             .replace(/[ÈÉÊËèéêë]/g, 'E')
                                             .replace(/[ÌÍÎÏìíîï]/g, 'I')
                                             .replace(/[ÒÓÔÖòóôö]/g, 'O')
                                             .replace(/[ÙÚÛÜùúûü]/g, 'U')
                                             .replace(/[Ññ]/g, 'N')
                                             .replace(/[Çç]/g, 'C')
                                             .replace(/œ/g, 'OE')
                                             .replace(/Œ/g, 'OE');

            const rate = municipalTaxRates[normalizedCommune];
            if (rate !== undefined) {
                console.log(`✅ [MUNICIPAL RATE] Found rate for ${commune}: ${rate}%`);
                return rate;
            } else {
                console.warn(`⚠️ [MUNICIPAL RATE] Commune not found: ${commune} (normalized: ${normalizedCommune}), using Geneva default`);
                return 45.49; // Default Geneva rate
            }

        }

        // Function to calculate final ICC tax according to 2025 Geneva reform - REFACTORED FOR COMPLIANCE
        function calculateIccFinalTax(revenuImposable, statutFiscal, commune, anneeFiscale = 2025) {
            console.log(`🏁 [ICC 2025] Starting calculation: ${formatCurrency(revenuImposable)}, ${statutFiscal}, ${commune}`);

            // Basic input validation (lenient during calculation)
            if (!revenuImposable || isNaN(revenuImposable) || revenuImposable < 0) {
                console.error(`❌ [ICC 2025] Invalid income: ${revenuImposable}`);
                throw new Error(`Invalid income: ${revenuImposable}`);
            }

            if (!statutFiscal) {
                console.error(`❌ [ICC 2025] Invalid family status: ${statutFiscal}`);
                throw new Error(`Invalid family status: ${statutFiscal}`);
            }

            if (!commune) {
                console.error(`❌ [ICC 2025] Invalid commune: ${commune}`);
                throw new Error(`Invalid commune: ${commune}`);
            }

            // Step 1: Calculate base tax
            const baseTaxResult = calculateIccBaseTax(revenuImposable, statutFiscal);
            const impotDeBase = baseTaxResult.impotDeBase;

            if (impotDeBase === 0) {
                return createZeroTaxResult(baseTaxResult);
            }

            // Step 2: Apply 2025 reform parameters in CORRECT order

            // Validate base tax before calculations
            if (isNaN(impotDeBase) || impotDeBase < 0) {
                console.error(`❌ [ICC 2025] Invalid base tax: ${impotDeBase}`);
                throw new Error(`Invalid base tax calculated: ${impotDeBase}`);
            }

            // 2a. Base reduction (12% of original base tax)
            const reductionBase = impotDeBase * 0.12;
            const impotApresReduction = impotDeBase - reductionBase;

            // 2b. Cantonal centimes (47.5% of original base, reduced by 12%)
            const centimesCantonaux = impotDeBase * 0.475 * (1 - 0.12);

            // 2c. Aide domicile (1% of original base)
            const centimeAideDomicile = impotDeBase * 0.01;

            // 2d. Municipal centimes (rate% of original base)
            const tauxCommunal = getMunicipalRateValidated(commune, anneeFiscale);
            if (isNaN(tauxCommunal) || tauxCommunal < 0) {
                console.error(`❌ [ICC 2025] Invalid municipal rate: ${tauxCommunal} for commune: ${commune}`);
                throw new Error(`Invalid municipal rate for ${commune}: ${tauxCommunal}`);
            }
            const centimesCommunaux = impotDeBase * (tauxCommunal / 100);

            // Step 3: Calculate final total with validation
            const impotTotalDu = impotApresReduction + centimesCantonaux + centimeAideDomicile + centimesCommunaux;

            // Validate all calculated values
            const calculatedValues = {
                reductionBase,
                impotApresReduction,
                centimesCantonaux,
                centimeAideDomicile,
                centimesCommunaux,
                impotTotalDu
            };

            Object.entries(calculatedValues).forEach(([key, value]) => {
                if (isNaN(value)) {
                    console.error(`❌ [ICC 2025] NaN detected in ${key}: ${value}`);
                    throw new Error(`Invalid calculation result for ${key}: ${value}`);
                }
            });

            console.log(`🏁 [ICC 2025] Final calculation:
                - Base tax: ${formatCurrency(impotDeBase)}
                - Base reduction (12%): -${formatCurrency(reductionBase)}
                - After reduction: ${formatCurrency(impotApresReduction)}
                - Cantonal centimes: ${formatCurrency(centimesCantonaux)}
                - Aide domicile: ${formatCurrency(centimeAideDomicile)}
                - Municipal centimes (${tauxCommunal}%): ${formatCurrency(centimesCommunaux)}
                - TOTAL ICC: ${formatCurrency(impotTotalDu)}`);

            return {
                impotDeBase,
                reductionBase,
                impotApresReduction,
                centimesCantonaux,
                centimeAideDomicile,
                tauxCommunal,
                centimesCommunaux,
                impotTotalDu,
                splittingDetails: baseTaxResult,
                reformeAppliquee: '2025',
                calculDetails: {
                    etape1_base: impotDeBase,
                    etape2_reduction: reductionBase,
                    etape3_cantonal: centimesCantonaux,
                    etape4_aide: centimeAideDomicile,
                    etape5_communal: centimesCommunaux,
                    etape6_total: impotTotalDu
                }
            };
        }

        // Test function to validate ICC calculations
        function testIccCalculations() {
            console.log('🧪 [ICC TEST] Starting ICC calculation validation tests...');

            if (!iccTaxBrackets || iccTaxBrackets.length === 0) {
                console.error('❌ [ICC TEST] ICC tax brackets not loaded');
                return false;
            }

            if (!municipalTaxRates || Object.keys(municipalTaxRates).length === 0) {
                console.error('❌ [ICC TEST] Municipal tax rates not loaded');
                return false;
            }

            // Test case 1: Single person with 50,000 CHF in Geneva
            console.log('🧪 [ICC TEST] Test 1: Single person, 50,000 CHF, Geneva');
            const test1 = calculateIccFinalTax(50000, 'celibataire', 'GENEVE', 2024);
            console.log(`  Result: ${test1.impotTotalDu.toFixed(2)} CHF`);

            // Test case 2: Married couple with 80,000 CHF in Carouge
            console.log('🧪 [ICC TEST] Test 2: Married couple, 80,000 CHF, Carouge');
            const test2 = calculateIccFinalTax(80000, 'marie_splitting', 'CAROUGE', 2024);
            console.log(`  Result: ${test2.impotTotalDu.toFixed(2)} CHF`);

            // Test case 3: Single person with 100,000 CHF in Vernier
            console.log('🧪 [ICC TEST] Test 3: Single person, 100,000 CHF, Vernier');
            const test3 = calculateIccFinalTax(100000, 'celibataire', 'VERNIER', 2024);
            console.log(`  Result: ${test3.impotTotalDu.toFixed(2)} CHF`);

            // Validate that results are reasonable
            const allTestsPassed = test1.impotTotalDu > 0 && test2.impotTotalDu > 0 && test3.impotTotalDu > 0;

            if (allTestsPassed) {
                console.log('✅ [ICC TEST] All ICC calculation tests passed');
            } else {
                console.error('❌ [ICC TEST] Some ICC calculation tests failed');
            }

            return allTestsPassed;
        }

        // Unified function to load tax data from single source only
        async function touLoadTaxBrackets(retryCount = 0, maxRetries = 3) {
            console.log('🚀 [UNIFIED DATA] Loading tax data from single source...');

            try {
                const success = await loadUnifiedTaxData();
                if (success) {
                    console.log('✅ [UNIFIED DATA] Successfully loaded all tax data');
                    showTaxDataYearIndicator();
                    return true;
                } else {
                    throw new Error('Failed to load unified tax data');
                }
            } catch (error) {
                console.error('❌ [UNIFIED DATA] Failed to load tax data:', error.message);
                if (retryCount < maxRetries) {
                    console.log(`🔄 [UNIFIED DATA] Retrying... (attempt ${retryCount + 2}/${maxRetries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                    return touLoadTaxBrackets(retryCount + 1, maxRetries);
                } else {
                    console.error('❌ [UNIFIED DATA] All retry attempts failed');
                    return false;
                }
            }


        }

        // Function to load A1-A5 tax brackets from JSON file
        async function touLoadA1A5TaxBrackets() {
            try {
                console.log('🔄 [A1-A5] Loading A1-A5 tax brackets from JSON file...');
                const response = await fetch('./baremes-2024-impot-source-A1-A5.json');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data && Array.isArray(data.baremes)) {
                    // Transform the data structure for compatibility
                    touA1A5TaxBrackets = data.baremes.map(bracket => {
                        const transformed = { ...bracket };

                        // Extract annee_fr from tranche for compatibility
                        if (bracket.tranche && bracket.tranche.annee_fr) {
                            transformed.annee_fr = bracket.tranche.annee_fr;
                        }
                        // Remove the tranche wrapper
                        delete transformed.tranche;

                        return transformed;
                    });

                    touA1A5TaxBracketsLoaded = true;
                    console.log(`✅ [A1-A5] Successfully loaded ${touA1A5TaxBrackets.length} A1-A5 tax brackets`);
                    console.log(`📋 [A1-A5] Sample bracket:`, touA1A5TaxBrackets[0]);
                    return true;
                } else {
                    throw new Error('Invalid A1-A5 JSON structure: missing baremes array');
                }
            } catch (error) {
                console.error('❌ [A1-A5] Failed to load A1-A5 tax brackets:', error);
                touA1A5TaxBracketsLoaded = false;
                return false;
            }
        }

        // Simple test function to load JSON directly (for debugging)
        async function touTestDirectJSONLoad() {
            console.log(`🧪 [TEST] Starting direct JSON load test...`);
            try {
                const response = await fetch('./baremes-2024-impot-source_complet.json');
                console.log(`🧪 [TEST] Response:`, response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`🧪 [TEST] JSON loaded successfully`);
                console.log(`🧪 [TEST] Brackets count:`, data?.baremes?.length);

                if (data && data.baremes && Array.isArray(data.baremes)) {
                    // Transform and assign directly
                    touTaxBrackets = data.baremes.map(bracket => {
                        const transformed = { ...bracket };
                        if (bracket.tranche && bracket.tranche.annee_fr) {
                            transformed.annee_fr = bracket.tranche.annee_fr;
                        }
                        delete transformed.tranche;
                        return transformed;
                    });

                    console.log(`🧪 [TEST] SUCCESS: Loaded ${touTaxBrackets.length} brackets directly`);
                    return true;
                } else {
                    console.log(`🧪 [TEST] FAILED: Invalid JSON structure`);
                    return false;
                }
            } catch (error) {
                console.log(`🧪 [TEST] ERROR:`, error.message);
                return false;
            }
        }

        // Function to load embedded tax brackets data (CORS fallback)
        async function touLoadEmbeddedTaxBrackets() {
            try {
                console.log('🔄 Loading embedded tax brackets data (CORS fallback)...');

                // Check if embedded data is available
                if (typeof window.EMBEDDED_TAX_BRACKETS !== 'undefined' && window.EMBEDDED_TAX_BRACKETS) {
                    const data = window.EMBEDDED_TAX_BRACKETS;

                    // Validate the data structure
                    if (data && data.baremes && Array.isArray(data.baremes)) {
                        // Transform the data to match expected structure
                        touTaxBrackets = data.baremes.map(bracket => {
                            const transformed = { ...bracket };
                            // Extract annee_fr from tranche for compatibility
                            if (bracket.tranche && bracket.tranche.annee_fr) {
                                transformed.annee_fr = bracket.tranche.annee_fr;
                            }
                            // Remove the tranche wrapper as it's not needed for calculations
                            delete transformed.tranche;
                            return transformed;
                        });

                        console.log(`✓ Successfully loaded ${touTaxBrackets.length} tax brackets from embedded data`);
                        console.log('Sample bracket:', touTaxBrackets[0]);
                        return true;
                    } else {
                        throw new Error('Invalid embedded data structure: missing baremes array');
                    }
                } else {
                    throw new Error('No embedded tax brackets data available');
                }
            } catch (error) {
                console.error('❌ Failed to load embedded tax brackets:', error.message);
                return false;
            }
        }

        // Function to display error message to user when tax data cannot be loaded
        function touShowDataLoadingError(errorMessage, isCorsError = false) {
            const touSimulatorContainer = document.getElementById('tou-simulator-container');
            if (touSimulatorContainer) {
                // Create error message element
                const errorDiv = document.createElement('div');
                errorDiv.id = 'touDataLoadingError';
                errorDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-6 mb-6';
                errorDiv.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Erreur de chargement des données fiscales</h3>
                        </div>
                    </div>
                    <div class="text-sm text-red-700">
                        <p class="mb-3">Le simulateur TOU ne peut pas fonctionner car les barèmes fiscaux officiels n'ont pas pu être chargés.</p>
                        <p class="mb-3"><strong>Erreur:</strong> ${errorMessage}</p>
                        ${isCorsError ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-medium text-yellow-800">Problème CORS détecté</h4>
                                        <div class="mt-2 text-sm text-yellow-700">
                                            <p class="mb-2">Cette erreur se produit lorsque le fichier HTML est ouvert directement dans le navigateur (protocole file://).</p>
                                            <p class="mb-2"><strong>Solutions recommandées:</strong></p>
                                            <ul class="list-disc list-inside space-y-1 ml-4">
                                                <li>Utilisez un serveur web local (ex: Live Server dans VS Code)</li>
                                                <li>Ou utilisez Python: <code class="bg-gray-100 px-1 rounded">python -m http.server 8000</code></li>
                                                <li>Ou utilisez Node.js: <code class="bg-gray-100 px-1 rounded">npx serve .</code></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <p class="mb-4">Veuillez vérifier votre connexion internet et réessayer.</p>
                        `}
                        <button onclick="touRetryDataLoading()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md text-sm transition duration-150 ease-in-out">
                            <i class="fas fa-redo mr-2"></i>Réessayer le chargement
                        </button>
                        ${isCorsError ? `
                            <button onclick="touLoadEmbeddedDataManually()" class="ml-3 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md text-sm transition duration-150 ease-in-out">
                                <i class="fas fa-download mr-2"></i>Charger données intégrées
                            </button>
                        ` : ''}
                    </div>
                `;

                // Insert error message at the beginning of the container
                touSimulatorContainer.insertBefore(errorDiv, touSimulatorContainer.firstChild);

                // Disable the simulator form
                const touForm = document.getElementById('touTaxForm');
                if (touForm) {
                    touForm.style.opacity = '0.5';
                    touForm.style.pointerEvents = 'none';
                }

                // Disable calculate button
                const touCalculateBtn = document.getElementById('touCalculateBtn');
                if (touCalculateBtn) {
                    touCalculateBtn.disabled = true;
                    touCalculateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // Function to retry data loading
        async function touRetryDataLoading() {
            // Remove existing error message
            const errorDiv = document.getElementById('touDataLoadingError');
            if (errorDiv) {
                errorDiv.remove();
            }

            // Re-enable the form
            const touForm = document.getElementById('touTaxForm');
            if (touForm) {
                touForm.style.opacity = '1';
                touForm.style.pointerEvents = 'auto';
            }

            // Re-enable calculate button
            const touCalculateBtn = document.getElementById('touCalculateBtn');
            if (touCalculateBtn) {
                touCalculateBtn.disabled = false;
                touCalculateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // Attempt to reload data (loading indicator removed for cleaner UI)
            const success = await touLoadTaxBrackets();

            if (success) {
                console.log('✓ Tax data successfully reloaded');
                // Show success message briefly
                const successDiv = document.createElement('div');
                successDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-4 mb-4 text-green-700 text-sm';
                successDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Barèmes fiscaux chargés avec succès!';

                if (touSimulatorContainer) {
                    touSimulatorContainer.insertBefore(successDiv, touSimulatorContainer.firstChild);
                    setTimeout(() => {
                        if (successDiv && successDiv.parentNode) {
                            successDiv.parentNode.removeChild(successDiv);
                        }
                    }, 3000);
                }
            }
        }

        // TOU Currency conversion functions
        function touToggleCurrency(button) {
            const container = button.closest('.tou-currency-container');
            const currentCurrency = container.dataset.currency;
            const input = container.querySelector('input');
            const conversionDisplay = container.querySelector('.tou-conversion-display');

            if (currentCurrency === 'CHF') {
                container.dataset.currency = 'EUR';
                button.textContent = 'EUR/CHF';
                if (input.value) {
                    const eurValue = (parseFloat(input.value) * TOU_CHF_TO_EUR).toFixed(2);
                    conversionDisplay.textContent = `≈ ${eurValue} EUR`;
                    conversionDisplay.classList.remove('hidden');
                }
            } else {
                container.dataset.currency = 'CHF';
                button.textContent = 'CHF/EUR';
                if (input.value) {
                    const chfValue = (parseFloat(input.value) * TOU_EUR_TO_CHF).toFixed(2);
                    conversionDisplay.textContent = `≈ ${chfValue} CHF`;
                    conversionDisplay.classList.remove('hidden');
                }
            }
        }

        function touUpdateCurrencyConversion(input) {
            const container = input.closest('.tou-currency-container');
            const currency = container.dataset.currency;
            const conversionDisplay = container.querySelector('.tou-conversion-display');

            if (!input.value) {
                conversionDisplay.classList.add('hidden');
                return;
            }

            const value = parseFloat(input.value);
            if (currency === 'CHF') {
                const eurValue = (value * TOU_CHF_TO_EUR).toFixed(2);
                conversionDisplay.textContent = `≈ ${eurValue} EUR`;
            } else {
                const chfValue = (value * TOU_EUR_TO_CHF).toFixed(2);
                conversionDisplay.textContent = `≈ ${chfValue} CHF`;
            }
            conversionDisplay.classList.remove('hidden');
        }

        // TOU Form field toggle functions
        function touToggleConditionalFields() {
            const familyStatus = document.getElementById('touFamilyStatus').value;
            const childrenContainer = document.getElementById('touChildrenContainer');
            const spouseIncomeContainer = document.getElementById('touSpouseIncomeContainer');

            // Reset visibility
            childrenContainer.classList.add('hidden');
            spouseIncomeContainer.classList.add('hidden');

            // Show children field for relevant statuses
            if (familyStatus === 'married-no-income' || familyStatus === 'married-with-income' ||
                familyStatus === 'divorced-with-children') {
                childrenContainer.classList.remove('hidden');
            }

            // Show spouse income field for married with income
            if (familyStatus === 'married-with-income') {
                spouseIncomeContainer.classList.remove('hidden');
            }
        }

        function touToggleDeductionFields() {
            const deductionOption = document.getElementById('touDeductionOption').value;
            const realDeductionsContainer = document.getElementById('touRealDeductionsContainer');

            if (deductionOption === 'reel' || deductionOption === 'optimize') {
                realDeductionsContainer.classList.remove('hidden');
                // Initialize enhanced deduction field handlers
                touInitializeEnhancedDeductionFields();
                // Initialize accordion functionality
                touInitializeFraisAccordion();
                // Reset frais réels to ensure clean initial state
                if (typeof touResetFraisReelsAccordion === 'function') {
                    touResetFraisReelsAccordion();
                }

                // Add optimization notice for optimize mode
                if (deductionOption === 'optimize') {
                    const optimizeNotice = document.getElementById('touOptimizeNotice');
                    if (!optimizeNotice) {
                        const notice = document.createElement('div');
                        notice.id = 'touOptimizeNotice';
                        notice.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4';
                        notice.innerHTML = `
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-blue-800">Mode optimisation activé</h4>
                                    <p class="text-sm text-blue-700 mt-1">
                                        Remplissez vos frais réels ci-dessous. Le système calculera automatiquement
                                        les déductions forfaitaires et réelles, puis sélectionnera la meilleure option pour vous.
                                    </p>
                                </div>
                            </div>
                        `;
                        realDeductionsContainer.insertBefore(notice, realDeductionsContainer.firstChild);
                    }
                } else {
                    // Remove optimization notice if switching away from optimize mode
                    const optimizeNotice = document.getElementById('touOptimizeNotice');
                    if (optimizeNotice) {
                        optimizeNotice.remove();
                    }
                }
            } else {
                realDeductionsContainer.classList.add('hidden');
                // Also reset when switching away from frais réels
                if (typeof touResetFraisReelsAccordion === 'function') {
                    touResetFraisReelsAccordion();
                }
                // Remove optimization notice
                const optimizeNotice = document.getElementById('touOptimizeNotice');
                if (optimizeNotice) {
                    optimizeNotice.remove();
                }
            }
        }

        /**
         * Initialize the enhanced accordion interface for frais réels
         */
        function touInitializeFraisAccordion() {
            // Prevent multiple initializations
            const accordionContainer = document.getElementById('touRealDeductionsContainer');
            if (!accordionContainer || accordionContainer.dataset.accordionInitialized === 'true') {
                return;
            }

            // Initialize accordion headers
            const accordionHeaders = document.querySelectorAll('.tou-frais-accordion-header');
            accordionHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    const contentId = this.getAttribute('aria-controls');
                    const content = document.getElementById(contentId);

                    // Toggle this accordion
                    this.setAttribute('aria-expanded', !isExpanded);
                    if (content) {
                        content.style.display = isExpanded ? 'none' : 'block';
                    }
                });
            });

            // Initialize expand/collapse all buttons
            const expandAllBtn = document.getElementById('touExpandAllSections');
            const collapseAllBtn = document.getElementById('touCollapseAllSections');

            if (expandAllBtn) {
                expandAllBtn.addEventListener('click', function() {
                    accordionHeaders.forEach(header => {
                        header.setAttribute('aria-expanded', 'true');
                        const contentId = header.getAttribute('aria-controls');
                        const content = document.getElementById(contentId);
                        if (content) content.style.display = 'block';
                    });
                });
            }

            if (collapseAllBtn) {
                collapseAllBtn.addEventListener('click', function() {
                    accordionHeaders.forEach(header => {
                        header.setAttribute('aria-expanded', 'false');
                        const contentId = header.getAttribute('aria-controls');
                        const content = document.getElementById(contentId);
                        if (content) content.style.display = 'none';
                    });
                });
            }

            // Initialize summary updates
            touUpdateFraisSummaries();

            // Add event listeners to all inputs for real-time summary updates
            const container = document.getElementById('touRealDeductionsContainer');
            if (container) {
                const inputs = container.querySelectorAll('input[type="number"], input[type="checkbox"], select');
                inputs.forEach(input => {
                    input.addEventListener('input', touUpdateFraisSummaries);
                    input.addEventListener('change', touUpdateFraisSummaries);
                });
            }

            // Mark as initialized
            accordionContainer.dataset.accordionInitialized = 'true';
        }

        /**
         * Update section summaries and progress indicators
         */
        function touUpdateFraisSummaries() {
            const sections = [
                {
                    id: 'professional',
                    badge: 'touProfessionalBadge',
                    calculate: () => {
                        let total = 0;

                        // Commuting
                        if (document.getElementById('touCommutingEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touCommutingAmount')?.value) || 0;
                        }

                        // Meals
                        if (document.getElementById('touMealsEnabled')?.checked) {
                            const days = parseInt(document.getElementById('touMealsWorkingDays')?.value) || 0;
                            const hasContribution = document.getElementById('touMealsEmployerContribution')?.checked;
                            const rate = hasContribution ? 7.5 : 15;
                            total += Math.min(days * rate, hasContribution ? 1600 : 3200);
                        }

                        return total;
                    }
                },
                {
                    id: 'health',
                    badge: 'touHealthBadge',
                    calculate: () => {
                        let total = 0;

                        // Health Insurance
                        if (document.getElementById('touHealthInsuranceEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touHealthInsuranceAmount')?.value) || 0;
                        }

                        // Medical Expenses
                        if (document.getElementById('touMedicalExpensesEnabled')?.checked) {
                            const expenses = parseFloat(document.getElementById('touMedicalExpensesAmount')?.value) || 0;
                            const reimbursement = parseFloat(document.getElementById('touMedicalExpensesReimbursement')?.value) || 0;
                            total += Math.max(0, expenses - reimbursement);
                        }

                        return total;
                    }
                },
                {
                    id: 'pension',
                    badge: 'touPensionBadge',
                    calculate: () => {
                        let total = 0;

                        // 3rd Pillar A
                        if (document.getElementById('touPillar3AEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touPillar3AAmount')?.value) || 0;
                        }

                        // 3rd Pillar B
                        if (document.getElementById('touPillar3BEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touPillar3BAmount')?.value) || 0;
                        }

                        // Loan Interest
                        if (document.getElementById('touLoanInterestEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touLoanInterestAmount')?.value) || 0;
                        }

                        return total;
                    }
                },
                {
                    id: 'family',
                    badge: 'touFamilyBadge',
                    calculate: () => {
                        let total = 0;

                        // Childcare
                        if (document.getElementById('touChildcareEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touChildcareAmount')?.value) || 0;
                        }

                        // Alimony
                        if (document.getElementById('touAlimonyEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touAlimonyAmount')?.value) || 0;
                        }

                        // Training
                        if (document.getElementById('touTrainingEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touTrainingAmount')?.value) || 0;
                        }

                        // Union
                        if (document.getElementById('touUnionEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touUnionAmount')?.value) || 0;
                        }

                        return total;
                    }
                },
                {
                    id: 'property',
                    badge: 'touPropertyBadge',
                    calculate: () => {
                        let total = 0;

                        // Property Maintenance
                        if (document.getElementById('touPropertyMaintenanceEnabled')?.checked) {
                            const rent = parseFloat(document.getElementById('touPropertyMaintenanceRent')?.value) || 0;
                            total += rent * 0.2; // 20% forfait
                        }

                        // Real Estate Work
                        if (document.getElementById('touRealEstateWorkEnabled')?.checked) {
                            total += parseFloat(document.getElementById('touRealEstateWorkAmount')?.value) || 0;
                        }

                        // Double Residence
                        if (document.getElementById('touDoubleResidenceEnabled')?.checked) {
                            const amount = parseFloat(document.getElementById('touDoubleResidenceAmount')?.value) || 0;
                            const months = parseInt(document.getElementById('touDoubleResidenceMonths')?.value) || 12;
                            total += Math.min(amount, 500 * months);
                        }

                        return total;
                    }
                }
            ];

            let completedSections = 0;

            sections.forEach(section => {
                const total = section.calculate();
                const badge = document.getElementById(section.badge);

                if (badge) {
                    badge.textContent = total.toLocaleString('fr-CH', {
                        style: 'currency',
                        currency: 'CHF',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });

                    // Update badge styling based on whether there are values
                    if (total > 0) {
                        badge.classList.add('has-values');
                        completedSections++;
                    } else {
                        badge.classList.remove('has-values');
                    }
                }
            });

            // Update progress indicator
            const progressCircle = document.getElementById('touFraisProgressCircle');
            const progressText = document.getElementById('touFraisProgressText');

            if (progressCircle) {
                progressCircle.textContent = `${completedSections}/5`;
            }

            if (progressText) {
                if (completedSections === 0) {
                    progressText.textContent = 'Aucune section complétée';
                } else if (completedSections === 5) {
                    progressText.textContent = 'Toutes les sections complétées';
                } else {
                    progressText.textContent = `${completedSections} section${completedSections > 1 ? 's' : ''} complétée${completedSections > 1 ? 's' : ''}`;
                }
            }
        }

        /**
         * Reset all frais réels (actual expenses) accordion fields to default state
         */
        function touResetFraisReelsAccordion() {
            console.log('🔄 [RESET] Resetting frais réels accordion to default state...');

            // Define all the frais réels fields that need to be reset
            const fraisReelsFields = [
                // Professional expenses
                { checkbox: 'touCommutingEnabled', amount: 'touCommutingAmount', defaultValue: '0' },
                { checkbox: 'touMealsEnabled', amount: 'touMealsWorkingDays', defaultValue: '220' },

                // Health and insurance
                { checkbox: 'touHealthInsuranceEnabled', amount: 'touHealthInsuranceAmount', defaultValue: '0' },
                { checkbox: 'touMedicalExpensesEnabled', amount: 'touMedicalExpensesAmount', defaultValue: '0' },

                // Pension and retirement
                { checkbox: 'touPillar3AEnabled', amount: 'touPillar3AAmount', defaultValue: '0' },
                { checkbox: 'touPillar3BEnabled', amount: 'touPillar3BAmount', defaultValue: '0' },
                { checkbox: 'touLoanInterestEnabled', amount: 'touLoanInterestAmount', defaultValue: '0' },

                // Family and personal
                { checkbox: 'touChildcareEnabled', amount: 'touChildcareAmount', defaultValue: '0' },
                { checkbox: 'touAlimonyEnabled', amount: 'touAlimonyAmount', defaultValue: '0' },
                { checkbox: 'touTrainingEnabled', amount: 'touTrainingAmount', defaultValue: '0' },
                { checkbox: 'touUnionEnabled', amount: 'touUnionAmount', defaultValue: '0' },

                // Property and other
                { checkbox: 'touPropertyMaintenanceEnabled', amount: 'touPropertyMaintenanceRent', defaultValue: '0' },
                { checkbox: 'touRealEstateWorkEnabled', amount: 'touRealEstateWorkAmount', defaultValue: '0' },
                { checkbox: 'touDoubleResidenceEnabled', amount: 'touDoubleResidenceAmount', defaultValue: '0' }
            ];

            // Additional fields that need special handling
            const additionalFields = [
                { id: 'touMedicalExpensesReimbursement', defaultValue: '0' },
                { id: 'touChildcareChildren', defaultValue: '0' },
                { id: 'touPillar3BAdults', defaultValue: '1' },
                { id: 'touDoubleResidenceMonths', defaultValue: '12' },
                { id: 'touHealthInsuranceCategory', defaultValue: 'adults' }
            ];

            // Additional checkboxes
            const additionalCheckboxes = [
                'touMealsEmployerContribution',
                'touPillar3AEmployed',
                'touAlimonyChildrenUnder18'
            ];

            // Reset main fields
            fraisReelsFields.forEach(field => {
                const checkbox = document.getElementById(field.checkbox);
                const amountField = document.getElementById(field.amount);

                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.classList.remove('tou-error-border');
                }

                if (amountField) {
                    amountField.value = field.defaultValue;
                    amountField.disabled = true;
                    amountField.classList.remove('tou-error-border');
                }
            });

            // Reset additional fields
            additionalFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    if (element.tagName === 'SELECT') {
                        element.value = field.defaultValue;
                    } else {
                        element.value = field.defaultValue;
                    }
                    element.disabled = true;
                    element.classList.remove('tou-error-border');
                }
            });

            // Reset additional checkboxes
            additionalCheckboxes.forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.disabled = true;
                    checkbox.classList.remove('tou-error-border');
                }
            });

            // Reset accordion summaries and progress indicators
            if (typeof touUpdateFraisSummaries === 'function') {
                touUpdateFraisSummaries();
            }

            // Reset accordion states (collapse all sections)
            const accordionHeaders = document.querySelectorAll('.tou-frais-accordion-header');
            accordionHeaders.forEach(header => {
                header.setAttribute('aria-expanded', 'false');
                const contentId = header.getAttribute('aria-controls');
                const content = document.getElementById(contentId);
                if (content) {
                    content.style.display = 'none';
                }
            });

            // Remove any validation messages
            const validationMessages = document.querySelectorAll('#touFraisValidationContainer .tou-validation-message');
            validationMessages.forEach(message => message.remove());

            console.log('✅ [RESET] Frais réels accordion reset completed');
        }

        /**
         * Initialize enhanced deduction field handlers
         */
        function touInitializeEnhancedDeductionFields() {
            // Professional expenses handlers
            const commutingCheckbox = document.getElementById('touCommutingEnabled');
            const commutingAmount = document.getElementById('touCommutingAmount');

            if (commutingCheckbox && commutingAmount) {
                commutingCheckbox.addEventListener('change', function() {
                    commutingAmount.disabled = !this.checked;
                    if (this.checked) {
                        commutingAmount.focus();
                    } else {
                        commutingAmount.value = '0';
                    }
                });
            }

            const mealsCheckbox = document.getElementById('touMealsEnabled');
            const mealsWorkingDays = document.getElementById('touMealsWorkingDays');
            const mealsEmployerContribution = document.getElementById('touMealsEmployerContribution');

            if (mealsCheckbox && mealsWorkingDays && mealsEmployerContribution) {
                mealsCheckbox.addEventListener('change', function() {
                    mealsWorkingDays.disabled = !this.checked;
                    mealsEmployerContribution.disabled = !this.checked;
                    if (!this.checked) {
                        mealsWorkingDays.value = '220';
                        mealsEmployerContribution.checked = false;
                    }
                });
            }

            // Health insurance handlers
            const healthInsuranceCheckbox = document.getElementById('touHealthInsuranceEnabled');
            const healthInsuranceAmount = document.getElementById('touHealthInsuranceAmount');
            const healthInsuranceCategory = document.getElementById('touHealthInsuranceCategory');

            if (healthInsuranceCheckbox && healthInsuranceAmount && healthInsuranceCategory) {
                healthInsuranceCheckbox.addEventListener('change', function() {
                    healthInsuranceAmount.disabled = !this.checked;
                    healthInsuranceCategory.disabled = !this.checked;
                    if (this.checked) {
                        healthInsuranceAmount.focus();
                    } else {
                        healthInsuranceAmount.value = '0';
                    }
                });
            }

            // Medical expenses handlers
            const medicalExpensesCheckbox = document.getElementById('touMedicalExpensesEnabled');
            const medicalExpensesAmount = document.getElementById('touMedicalExpensesAmount');
            const medicalExpensesReimbursement = document.getElementById('touMedicalExpensesReimbursement');

            if (medicalExpensesCheckbox && medicalExpensesAmount && medicalExpensesReimbursement) {
                medicalExpensesCheckbox.addEventListener('change', function() {
                    medicalExpensesAmount.disabled = !this.checked;
                    medicalExpensesReimbursement.disabled = !this.checked;
                    if (!this.checked) {
                        medicalExpensesAmount.value = '0';
                        medicalExpensesReimbursement.value = '0';
                    }
                });
            }

            // 3rd Pillar A handlers
            const pillar3ACheckbox = document.getElementById('touPillar3AEnabled');
            const pillar3AAmount = document.getElementById('touPillar3AAmount');
            const pillar3AHasSecondPillar = document.getElementById('touPillar3AHasSecondPillar');

            if (pillar3ACheckbox && pillar3AAmount && pillar3AHasSecondPillar) {
                pillar3ACheckbox.addEventListener('change', function() {
                    pillar3AAmount.disabled = !this.checked;
                    pillar3AHasSecondPillar.disabled = !this.checked;
                    if (!this.checked) {
                        pillar3AAmount.value = '0';
                        pillar3AHasSecondPillar.checked = false;
                    }
                });
            }

            // 3rd Pillar B handlers
            const pillar3BCheckbox = document.getElementById('touPillar3BEnabled');
            const pillar3BAmount = document.getElementById('touPillar3BAmount');
            const pillar3BAdults = document.getElementById('touPillar3BAdults');

            if (pillar3BCheckbox && pillar3BAmount && pillar3BAdults) {
                pillar3BCheckbox.addEventListener('change', function() {
                    pillar3BAmount.disabled = !this.checked;
                    pillar3BAdults.disabled = !this.checked;
                    if (!this.checked) {
                        pillar3BAmount.value = '0';
                        pillar3BAdults.value = '1';
                    }
                });
            }

            // Add similar handlers for all other deduction categories
            touInitializeRemainingDeductionHandlers();
        }

        /**
         * Initialize remaining deduction field handlers
         */
        function touInitializeRemainingDeductionHandlers() {
            // Loan interest
            const loanInterestCheckbox = document.getElementById('touLoanInterestEnabled');
            const loanInterestAmount = document.getElementById('touLoanInterestAmount');

            if (loanInterestCheckbox && loanInterestAmount) {
                loanInterestCheckbox.addEventListener('change', function() {
                    loanInterestAmount.disabled = !this.checked;
                    if (!this.checked) loanInterestAmount.value = '0';
                });
            }

            // Childcare
            const childcareCheckbox = document.getElementById('touChildcareEnabled');
            const childcareAmount = document.getElementById('touChildcareAmount');
            const childcareChildren = document.getElementById('touChildcareChildren');

            if (childcareCheckbox && childcareAmount && childcareChildren) {
                childcareCheckbox.addEventListener('change', function() {
                    childcareAmount.disabled = !this.checked;
                    childcareChildren.disabled = !this.checked;
                    if (!this.checked) {
                        childcareAmount.value = '0';
                        childcareChildren.value = '0';
                    }
                });
            }

            // Alimony
            const alimonyCheckbox = document.getElementById('touAlimonyEnabled');
            const alimonyAmount = document.getElementById('touAlimonyAmount');
            const alimonyChildrenUnder18 = document.getElementById('touAlimonyChildrenUnder18');

            if (alimonyCheckbox && alimonyAmount && alimonyChildrenUnder18) {
                alimonyCheckbox.addEventListener('change', function() {
                    alimonyAmount.disabled = !this.checked;
                    alimonyChildrenUnder18.disabled = !this.checked;
                    if (!this.checked) {
                        alimonyAmount.value = '0';
                        alimonyChildrenUnder18.checked = false;
                    }
                });
            }

            // Training expenses
            const trainingCheckbox = document.getElementById('touTrainingEnabled');
            const trainingAmount = document.getElementById('touTrainingAmount');

            if (trainingCheckbox && trainingAmount) {
                trainingCheckbox.addEventListener('change', function() {
                    trainingAmount.disabled = !this.checked;
                    if (!this.checked) trainingAmount.value = '0';
                });
            }

            // Union contributions
            const unionCheckbox = document.getElementById('touUnionEnabled');
            const unionAmount = document.getElementById('touUnionAmount');

            if (unionCheckbox && unionAmount) {
                unionCheckbox.addEventListener('change', function() {
                    unionAmount.disabled = !this.checked;
                    if (!this.checked) unionAmount.value = '0';
                });
            }

            // Property maintenance
            const propertyMaintenanceCheckbox = document.getElementById('touPropertyMaintenanceEnabled');
            const propertyMaintenanceRent = document.getElementById('touPropertyMaintenanceRent');

            if (propertyMaintenanceCheckbox && propertyMaintenanceRent) {
                propertyMaintenanceCheckbox.addEventListener('change', function() {
                    propertyMaintenanceRent.disabled = !this.checked;
                    if (!this.checked) propertyMaintenanceRent.value = '0';
                });
            }

            // Real estate work
            const realEstateWorkCheckbox = document.getElementById('touRealEstateWorkEnabled');
            const realEstateWorkAmount = document.getElementById('touRealEstateWorkAmount');

            if (realEstateWorkCheckbox && realEstateWorkAmount) {
                realEstateWorkCheckbox.addEventListener('change', function() {
                    realEstateWorkAmount.disabled = !this.checked;
                    if (!this.checked) realEstateWorkAmount.value = '0';
                });
            }

            // Double residence
            const doubleResidenceCheckbox = document.getElementById('touDoubleResidenceEnabled');
            const doubleResidenceAmount = document.getElementById('touDoubleResidenceAmount');
            const doubleResidenceMonths = document.getElementById('touDoubleResidenceMonths');

            if (doubleResidenceCheckbox && doubleResidenceAmount && doubleResidenceMonths) {
                doubleResidenceCheckbox.addEventListener('change', function() {
                    doubleResidenceAmount.disabled = !this.checked;
                    doubleResidenceMonths.disabled = !this.checked;
                    if (!this.checked) {
                        doubleResidenceAmount.value = '0';
                        doubleResidenceMonths.value = '12';
                    }
                });
            }
        }

        /**
         * Collect actual expense options from the enhanced form
         * @returns {Object} Comprehensive actual expense options
         */
        function touCollectActualExpenseOptions() {
            const options = {
                type: 'reel'
            };

            // Professional expenses
            options.commuting = {
                enabled: document.getElementById('touCommutingEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touCommutingAmount')?.value) || 0
            };

            options.meals = {
                enabled: document.getElementById('touMealsEnabled')?.checked || false,
                workingDays: parseInt(document.getElementById('touMealsWorkingDays')?.value) || 220,
                employerContribution: document.getElementById('touMealsEmployerContribution')?.checked || false
            };

            // Health and insurance
            options.healthInsurance = {
                enabled: document.getElementById('touHealthInsuranceEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touHealthInsuranceAmount')?.value) || 0,
                category: document.getElementById('touHealthInsuranceCategory')?.value || 'adults'
            };

            options.medicalExpenses = {
                enabled: document.getElementById('touMedicalExpensesEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touMedicalExpensesAmount')?.value) || 0,
                insuranceReimbursement: parseFloat(document.getElementById('touMedicalExpensesReimbursement')?.value) || 0
            };

            // Pension and investment
            options.pillar3A = {
                enabled: document.getElementById('touPillar3AEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touPillar3AAmount')?.value) || 0,
                hasSecondPillar: document.getElementById('touPillar3AHasSecondPillar')?.checked || false
            };

            options.pillar3B = {
                enabled: document.getElementById('touPillar3BEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touPillar3BAmount')?.value) || 0,
                adults: parseInt(document.getElementById('touPillar3BAdults')?.value) || 1
            };

            options.loanInterest = {
                enabled: document.getElementById('touLoanInterestEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touLoanInterestAmount')?.value) || 0
            };

            // Family and personal
            options.childcare = {
                enabled: document.getElementById('touChildcareEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touChildcareAmount')?.value) || 0,
                children: parseInt(document.getElementById('touChildcareChildren')?.value) || 0
            };

            options.alimony = {
                enabled: document.getElementById('touAlimonyEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touAlimonyAmount')?.value) || 0,
                childrenUnder18: document.getElementById('touAlimonyChildrenUnder18')?.checked || false
            };

            options.trainingExpenses = {
                enabled: document.getElementById('touTrainingEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touTrainingAmount')?.value) || 0
            };

            options.unionContributions = {
                enabled: document.getElementById('touUnionEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touUnionAmount')?.value) || 0
            };

            // Property and other
            options.propertyMaintenance = {
                enabled: document.getElementById('touPropertyMaintenanceEnabled')?.checked || false,
                grossRent: parseFloat(document.getElementById('touPropertyMaintenanceRent')?.value) || 0
            };

            options.realEstateWork = {
                enabled: document.getElementById('touRealEstateWorkEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touRealEstateWorkAmount')?.value) || 0
            };

            options.doubleResidence = {
                enabled: document.getElementById('touDoubleResidenceEnabled')?.checked || false,
                amount: parseFloat(document.getElementById('touDoubleResidenceAmount')?.value) || 0,
                months: parseInt(document.getElementById('touDoubleResidenceMonths')?.value) || 12
            };

            console.log('📋 [COLLECT] Collected actual expense options:', options);
            return options;
        }

        /**
         * Validate actual expense deduction inputs
         * @param {Object} options - Actual expense options
         * @returns {Object} Validation result with errors if any
         */
        function touValidateActualExpenseInputs(options) {
            const errors = [];
            const warnings = [];

            // Validate professional expenses
            if (options.commuting.enabled && options.commuting.amount > 3200) {
                warnings.push('Les frais de transport sont limités à 3,200 CHF pour l\'IFD');
            }

            if (options.meals.enabled) {
                if (options.meals.workingDays > 250) {
                    errors.push('Le nombre de jours de travail ne peut pas dépasser 250 par an');
                }
                if (options.meals.workingDays < 0) {
                    errors.push('Le nombre de jours de travail doit être positif');
                }
            }

            // Validate health insurance
            if (options.healthInsurance.enabled && options.healthInsurance.amount < 0) {
                errors.push('Le montant des primes d\'assurance maladie doit être positif');
            }

            // Validate medical expenses
            if (options.medicalExpenses.enabled) {
                if (options.medicalExpenses.amount < 0) {
                    errors.push('Le montant des frais médicaux doit être positif');
                }
                if (options.medicalExpenses.insuranceReimbursement < 0) {
                    errors.push('Le montant des remboursements d\'assurance doit être positif');
                }
                if (options.medicalExpenses.insuranceReimbursement > options.medicalExpenses.amount) {
                    errors.push('Les remboursements d\'assurance ne peuvent pas dépasser les frais médicaux');
                }
            }

            // Validate 3rd pillar A
            if (options.pillar3A.enabled) {
                if (options.pillar3A.amount > 7056) {
                    warnings.push('Le 3ème pilier A est limité à 7,056 CHF par an');
                }
                if (!options.pillar3A.hasSecondPillar && options.pillar3A.amount > 0) {
                    warnings.push('Le 3ème pilier A nécessite un 2ème pilier pour être déductible');
                }
            }

            // Validate 3rd pillar B
            if (options.pillar3B.enabled && options.pillar3B.amount > (2324 * options.pillar3B.adults)) {
                warnings.push(`Le 3ème pilier B est limité à ${2324 * options.pillar3B.adults} CHF pour ${options.pillar3B.adults} adulte(s)`);
            }

            // Validate loan interest
            if (options.loanInterest.enabled && options.loanInterest.amount > 50000) {
                warnings.push('Les intérêts d\'emprunts sont limités à 50,000 CHF par an');
            }

            // Validate childcare
            if (options.childcare.enabled) {
                if (options.childcare.children < 0) {
                    errors.push('Le nombre d\'enfants doit être positif');
                }
                if (options.childcare.amount > (26080 * options.childcare.children)) {
                    warnings.push(`Les frais de garde sont limités à ${26080 * options.childcare.children} CHF pour ${options.childcare.children} enfant(s) (ICC)`);
                }
            }

            // Validate union contributions
            if (options.unionContributions.enabled && options.unionContributions.amount > 700) {
                warnings.push('Les cotisations syndicales sont limitées à 700 CHF par an (ICC uniquement)');
            }

            // Validate training expenses
            if (options.trainingExpenses.enabled && options.trainingExpenses.amount > 12900) {
                warnings.push('Les frais de formation sont limités à 12,140 CHF (ICC) ou 12,900 CHF (IFD)');
            }

            // Validate double residence
            if (options.doubleResidence.enabled) {
                if (options.doubleResidence.months > 12 || options.doubleResidence.months < 1) {
                    errors.push('Le nombre de mois pour le double domicile doit être entre 1 et 12');
                }
                if (options.doubleResidence.amount > (500 * options.doubleResidence.months)) {
                    warnings.push(`Les frais de double domicile sont limités à ${500 * options.doubleResidence.months} CHF pour ${options.doubleResidence.months} mois`);
                }
            }

            return {
                isValid: errors.length === 0,
                errors: errors,
                warnings: warnings
            };
        }

        /**
         * Display validation errors and warnings to the user
         * @param {Object} validation - Validation result
         */
        function touDisplayValidationMessages(validation) {
            // Remove existing validation messages
            const existingMessages = document.querySelectorAll('.tou-validation-message');
            existingMessages.forEach(msg => msg.remove());

            const validationContainer = document.getElementById('touFraisValidationContainer');
            if (!validationContainer) return;

            // Display errors
            if (validation.errors.length > 0) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'tou-validation-message bg-red-50 border border-red-200 rounded-lg p-4 mb-4';
                errorDiv.setAttribute('role', 'alert');
                errorDiv.setAttribute('aria-live', 'assertive');
                errorDiv.innerHTML = `
                    <h5 class="font-medium text-red-800 mb-2 flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2" aria-hidden="true"></i>
                        Erreurs de validation
                    </h5>
                    <ul class="text-sm text-red-700 list-disc list-inside">
                        ${validation.errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                `;
                validationContainer.appendChild(errorDiv);
            }

            // Display warnings
            if (validation.warnings.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'tou-validation-message bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4';
                warningDiv.setAttribute('role', 'status');
                warningDiv.setAttribute('aria-live', 'polite');
                warningDiv.innerHTML = `
                    <h5 class="font-medium text-yellow-800 mb-2 flex items-center">
                        <i class="fas fa-exclamation-circle text-yellow-600 mr-2" aria-hidden="true"></i>
                        Avertissements
                    </h5>
                    <ul class="text-sm text-yellow-700 list-disc list-inside">
                        ${validation.warnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                `;
                validationContainer.appendChild(warningDiv);
            }
        }

        // Enhanced dropdown validation with visual feedback
        function touValidateDropdown(selectElement) {
            // Remove existing validation classes
            selectElement.classList.remove('tou-error-border', 'tou-success-border');

            // Add visual feedback based on selection
            if (selectElement.value && selectElement.value !== '') {
                // Valid selection - add success styling
                selectElement.classList.add('tou-success-border');

                // Add a subtle animation
                selectElement.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    selectElement.style.transform = 'scale(1)';
                }, 150);

            } else if (selectElement.hasAttribute('required') || selectElement.closest('.tou-input-group').querySelector('.tou-input-required')) {
                // Required field but no selection - add error styling
                selectElement.classList.add('tou-error-border');
            }

            // Trigger any existing onchange handlers
            if (selectElement.id === 'touCommune') {
                // Additional validation for commune selection
                const communeHelp = selectElement.closest('.tou-input-group').querySelector('.tou-input-help');
                if (selectElement.value) {
                    communeHelp.style.color = '#10b981';
                    communeHelp.innerHTML = `<i class="fas fa-check-circle mr-1"></i>Commune sélectionnée: ${selectElement.value}`;
                } else {
                    communeHelp.style.color = '#6b7280';
                    communeHelp.innerHTML = 'Votre commune de résidence influence le calcul de l\'impôt communal';
                }
            }
        }

        // Enhanced dropdown interaction effects
        function touInitializeDropdownEffects() {
            const dropdowns = document.querySelectorAll('.tou-simulator-wrapper select.tou-input-focus');

            dropdowns.forEach(dropdown => {
                // Add focus effects
                dropdown.addEventListener('focus', function() {
                    this.closest('.tou-dropdown-container')?.classList.add('focused');
                });

                dropdown.addEventListener('blur', function() {
                    this.closest('.tou-dropdown-container')?.classList.remove('focused');
                    // Validate on blur
                    touValidateDropdown(this);
                });

                // Add hover effects
                dropdown.addEventListener('mouseenter', function() {
                    if (!this.disabled) {
                        this.style.transform = 'translateY(-1px)';
                    }
                });

                dropdown.addEventListener('mouseleave', function() {
                    if (!this.disabled) {
                        this.style.transform = 'translateY(0)';
                    }
                });
            });
        }



        // Utility function to format tax rates with exactly 2 decimal places
        function formatTaxRate(rate) {
            if (rate === null || rate === undefined) {
                return '0.00%';
            }
            return parseFloat(rate).toFixed(2) + '%';
        }

        // TOU Tax calculation functions
        function touGetWithholdingTaxRate(income, familyStatus, childrenCount, enableDebug = false, useA1A5Brackets = false, a1a5Bracket = 'A1') {
            if (enableDebug) console.log(`[DEBUG] Tax calculation for: Income=${income}, FamilyStatus=${familyStatus}, Children=${childrenCount}, UseA1A5=${useA1A5Brackets}, Bracket=${a1a5Bracket}`);

            // Check if A1-A5 brackets should be used
            if (useA1A5Brackets && touA1A5TaxBracketsLoaded) {
                console.log(`🔄 [A1-A5] Utilisation des barèmes A1-A5 avec ${a1a5Bracket}`);
                const a1a5Rate = touGetA1A5WithholdingTaxRate(income, a1a5Bracket);
                if (a1a5Rate !== null) {
                    if (enableDebug) console.log(`[DEBUG] A1-A5 rate found: ${a1a5Rate}%`);
                    return a1a5Rate;
                } else {
                    console.warn('⚠️ [A1-A5] Échec du calcul A1-A5, retour aux barèmes A0 standard');
                }
            }

            // Find the appropriate tax bracket based on income (standard A0 brackets)
            let applicableBracket = null;

            // Find the bracket that contains the income
            for (const bracket of touTaxBrackets) {
                if (bracket.annee_fr) {
                    // Parse the income range from the annee_fr field
                    // Handle French number format with apostrophes (e.g., "79'800 - 80'399")
                    const rangeMatch = bracket.annee_fr.match(/(\d+(?:'?\d+)*)\s*-\s*(\d+(?:'?\d+)*)/);
                    if (rangeMatch) {
                        // Remove apostrophes and convert to numbers
                        const minIncome = parseInt(rangeMatch[1].replace(/'/g, ''));
                        const maxIncome = parseInt(rangeMatch[2].replace(/'/g, ''));

                        if (enableDebug) console.log(`[DEBUG] Checking bracket: ${bracket.annee_fr} (${minIncome} - ${maxIncome}) for income ${income}`);

                        if (income >= minIncome && income <= maxIncome) {
                            applicableBracket = bracket;
                            if (enableDebug) console.log(`[DEBUG] ✓ Found matching bracket: ${bracket.annee_fr} (${minIncome} - ${maxIncome})`);
                            break;
                        }
                    } else {
                        if (enableDebug) console.log(`[DEBUG] Could not parse range: ${bracket.annee_fr}`);
                    }
                }
            }

            // If no bracket found, use the highest bracket available
            if (!applicableBracket && touTaxBrackets.length > 0) {
                applicableBracket = touTaxBrackets[touTaxBrackets.length - 1];
                if (enableDebug) console.log(`[DEBUG] No exact bracket found, using highest bracket: ${applicableBracket.annee_fr}`);
            }

            // Determine bracket code and rate based on family status
            let bracket = 'A0'; // Default single
            let rate = 0;
            let debugInfo = '';

            if (applicableBracket) {
                if (enableDebug) console.log(`[DEBUG] Applicable bracket data:`, applicableBracket);

                if (familyStatus === 'single') {
                    bracket = 'A0';
                    rate = applicableBracket.A0_seule_pourcent;
                    debugInfo = `Single person (A0): ${rate}%`;
                } else if (familyStatus === 'married-no-income') {
                    const childrenForKey = Math.min(childrenCount || 0, 5);
                    // Generate correct key format: B0_0_enfants_pourcent, B1_1_enfant_pourcent, B2_2_enfants_pourcent
                    const childKey = childrenForKey === 0 ?
                        `B0_0_enfants_pourcent` :
                        childrenForKey === 1 ?
                            `B1_1_enfant_pourcent` :
                            `B${childrenForKey}_${childrenForKey}_enfants_pourcent`;
                    bracket = `B${childrenForKey}`;
                    rate = applicableBracket.B_marie_conjoint_ne_travaille_pas?.[childKey];
                    debugInfo = `Married no spouse income (${bracket}): key=${childKey}, rate=${rate}%`;
                } else if (familyStatus === 'married-with-income') {
                    const childrenForKey = Math.min(childrenCount || 0, 5);
                    // Generate correct key format: C0_0_enfants_pourcent, C1_1_enfant_pourcent, C2_2_enfants_pourcent
                    const childKey = childrenForKey === 0 ?
                        `C0_0_enfants_pourcent` :
                        childrenForKey === 1 ?
                            `C1_1_enfant_pourcent` :
                            `C${childrenForKey}_${childrenForKey}_enfants_pourcent`;
                    bracket = `C${childrenForKey}`;
                    rate = applicableBracket.C_marie_2_conjoints_travaillent?.[childKey];
                    debugInfo = `Married both working (${bracket}): key=${childKey}, rate=${rate}%`;
                } else if (familyStatus === 'divorced-with-children' || familyStatus === 'divorced-single') {
                    const childrenForKey = Math.max(childrenCount || 1, 1);
                    const childrenForKey2 = Math.min(childrenForKey, 5);
                    // Generate correct key format: H1_1_enfant_pourcent, H2_2_enfants_pourcent
                    const childKey = childrenForKey2 === 1 ?
                        `H1_1_enfant_pourcent` :
                        `H${childrenForKey2}_${childrenForKey2}_enfants_pourcent`;
                    bracket = `H${childrenForKey2}`;
                    rate = applicableBracket.H_famille_monoparentale?.[childKey];
                    debugInfo = `Single parent (${bracket}): key=${childKey}, rate=${rate}%`;
                } else if (familyStatus === 'widow') {
                    // Treat widow as single parent with children if applicable
                    if (childrenCount > 0) {
                        const childrenForKey = Math.max(childrenCount, 1);
                        const childrenForKey2 = Math.min(childrenForKey, 5);
                        // Generate correct key format: H1_1_enfant_pourcent, H2_2_enfants_pourcent
                        const childKey = childrenForKey2 === 1 ?
                            `H1_1_enfant_pourcent` :
                            `H${childrenForKey2}_${childrenForKey2}_enfants_pourcent`;
                        bracket = `H${childrenForKey2}`;
                        rate = applicableBracket.H_famille_monoparentale?.[childKey];
                        debugInfo = `Widow with children (${bracket}): key=${childKey}, rate=${rate}%`;
                    } else {
                        bracket = 'A0';
                        rate = applicableBracket.A0_seule_pourcent;
                        debugInfo = `Widow without children (A0): ${rate}%`;
                    }
                }

                if (enableDebug) console.log(`[DEBUG] ${debugInfo}`);
            }

            // If rate is null or undefined (but NOT 0, as 0 is a valid tax rate), try to find a fallback rate
            if (rate === null || rate === undefined) {
                if (enableDebug) console.log(`[DEBUG] Rate is null/undefined, using fallback calculation`);
                // Use a simplified fallback calculation
                if (income < 30000) rate = 0.5;
                else if (income < 50000) rate = 3.0;
                else if (income < 80000) rate = 8.0;
                else rate = 12.0;
                if (enableDebug) console.log(`[DEBUG] Fallback rate: ${formatTaxRate(rate)}`);
            } else if (rate === 0 || rate === 0.0) {
                if (enableDebug) console.log(`[DEBUG] Valid 0% tax rate found for this bracket`);
            }

            if (enableDebug) console.log(`[DEBUG] Final result: bracket=${bracket}, rate=${formatTaxRate(rate)}`);
            return { bracket, rate };
        }

        function touCalculateTOU(income, deductions, isQuasiResident, commune = 'GENEVE', familyStatus = 'single', deductionDetails = null) {
            // Calculate separate net incomes for ICC and IFD based on their respective deductions
            let netIncomeIcc, netIncomeIfd;

            if (deductionDetails && deductionDetails.type === 'forfaitaire' && deductionDetails.ICC && deductionDetails.IFD) {
                // Use specific deductions for each tax type
                netIncomeIcc = income - deductionDetails.ICC.total_deductions_sur_revenu;
                netIncomeIfd = income - deductionDetails.IFD.total_deductions_sur_revenu;

                console.log(`💰 [TOU CALC] Revenus imposables séparés:`);
                console.log(`   ICC: ${formatCurrency(income)} - ${formatCurrency(deductionDetails.ICC.total_deductions_sur_revenu)} = ${formatCurrency(netIncomeIcc)}`);
                console.log(`   IFD: ${formatCurrency(income)} - ${formatCurrency(deductionDetails.IFD.total_deductions_sur_revenu)} = ${formatCurrency(netIncomeIfd)}`);
            } else {
                // Fallback: use the same net income for both (legacy behavior)
                const netIncome = income - deductions;
                netIncomeIcc = netIncome;
                netIncomeIfd = netIncome;

                console.log(`💰 [TOU CALC] Revenu imposable unique: ${formatCurrency(netIncome)}`);
            }

            // Map family status to ICC algorithm format based on official Swiss tax splitting rules
            let statutFiscal;
            switch (familyStatus) {
                case 'single':
                case 'divorced-single':
                    // Single taxpayers without dependents - no splitting
                    statutFiscal = 'celibataire';
                    break;
                case 'married-no-income':
                    // Full splitting (Splitting Intégral):
                    // - Married couples or registered partners living in common household
                    // - Single taxpayers living alone with children/dependents providing majority support
                    statutFiscal = 'marie_splitting';
                    break;
                case 'married-with-income':
                    // Married couples where both have income - typically use full splitting
                    // (Note: This could be 'splitting_partiel' in specific cases, but generally full splitting applies)
                    statutFiscal = 'marie_splitting';
                    break;
                case 'divorced-with-children':
                    // Partial splitting (Splitting Partiel) - effective from 2024:
                    // - Single, divorced, or separated taxpayers
                    // - Living in common household with children
                    // - Court judgment/agreement for shared custody (50% care/expenses)
                    statutFiscal = 'splitting_partiel';
                    break;
                case 'widow':
                    // Widowed taxpayers with dependents typically qualify for full splitting
                    statutFiscal = 'marie_splitting';
                    break;
                default:
                    console.warn(`⚠️ [TOU] Unknown family status: ${familyStatus}, using celibataire`);
                    statutFiscal = 'celibataire';
            }

            // Calculate ICC tax using the new accurate implementation
            let iccTax = 0;
            let iccCalculationDetails = null;

            console.log(`🔍 [TOU] ICC data availability:`, {
                iccTaxBrackets: iccTaxBrackets?.length || 0,
                municipalTaxRates: Object.keys(municipalTaxRates || {}).length,
                netIncomeIcc,
                statutFiscal,
                commune
            });

            console.log(`🔍 [TOU DEBUG] Global ICC variables:`, {
                iccTaxBracketsExists: typeof iccTaxBrackets !== 'undefined',
                municipalTaxRatesExists: typeof municipalTaxRates !== 'undefined',
                iccTaxBracketsValue: iccTaxBrackets,
                municipalTaxRatesValue: municipalTaxRates
            });

            // Always try ICC calculation (now has embedded fallback data)
            try {
                iccCalculationDetails = calculateIccFinalTax(netIncomeIcc, statutFiscal, commune, 2024);
                iccTax = iccCalculationDetails.impotTotalDu;
                console.log(`✅ [TOU] Using ICC calculation: ${iccTax.toFixed(2)} CHF (revenu imposable ICC: ${formatCurrency(netIncomeIcc)})`);
                console.log(`📊 [TOU] ICC calculation details:`, iccCalculationDetails);
            } catch (error) {
                // Fallback to simplified calculation only if ICC calculation fails
                console.warn('⚠️ [TOU] ICC calculation failed, using simplified calculation:', error);
                let iccRate = 0.08; // 8% base rate
                if (netIncomeIcc > 100000) iccRate = 0.12;
                else if (netIncomeIcc > 50000) iccRate = 0.10;
                iccTax = netIncomeIcc * iccRate;
            }

            // IFD calculation using the official algorithm
            console.log(`🏛️ [TOU] Starting IFD calculation for ${formatCurrency(netIncomeIfd)} CHF, family status: ${familyStatus}`);

            // Map family status to IFD fiscal status
            let ifdStatutFiscal;
            switch (familyStatus) {
                case 'married-no-income':
                case 'married-with-income':
                    ifdStatutFiscal = 'marie';
                    break;
                default:
                    ifdStatutFiscal = 'celibataire';
            }

            const ifdResult = calculateIfdTax(netIncomeIfd, ifdStatutFiscal);
            const ifdTax = ifdResult.impotTotal;

            console.log(`✅ [TOU] IFD calculation completed: ${formatCurrency(ifdTax)} (revenu imposable IFD: ${formatCurrency(netIncomeIfd)})`);

            return {
                netIncomeIcc: netIncomeIcc,
                netIncomeIfd: netIncomeIfd,
                iccTax: iccTax,
                ifdTax: ifdTax,
                iccRate: iccTax > 0 ? (iccTax / netIncomeIcc) * 100 : 0, // Calculate effective rate based on ICC taxable income
                ifdRate: ifdResult.tauxEffectif, // Use calculated effective rate
                totalTax: iccTax + ifdTax,
                deductions: deductions,
                deductionDetails: deductionDetails, // Include detailed deduction breakdown
                iccDetails: iccCalculationDetails, // Include detailed ICC breakdown
                ifdDetails: ifdResult // Include detailed IFD breakdown
            };
        }

        function touCalculateTaxes() {
            // Check if tax brackets are loaded
            if (!touTaxBrackets || touTaxBrackets.length === 0) {
                alert('Erreur: Les barèmes fiscaux ne sont pas chargés. Veuillez réessayer le chargement des données.');
                console.error('Cannot calculate taxes: No tax brackets loaded');
                return;
            }

            // Get form values with enhanced debugging
            const commune = document.getElementById('touCommune')?.value;
            const familyStatus = document.getElementById('touFamilyStatus')?.value;
            const childrenCount = parseInt(document.getElementById('touChildrenCount')?.value) || 0;

            // Enhanced income parsing with debugging
            const annualIncomeElement = document.getElementById('touAnnualIncome');
            const annualIncomeValue = annualIncomeElement?.value;
            const annualIncome = parseFloat(annualIncomeValue) || 0;

            console.log(`🔍 [TOU DEBUG] Form values:
                - Commune: "${commune}"
                - Family Status: "${familyStatus}"
                - Annual Income Element: ${annualIncomeElement ? 'Found' : 'NOT FOUND'}
                - Annual Income Value: "${annualIncomeValue}"
                - Parsed Annual Income: ${annualIncome}
                - Is NaN: ${isNaN(annualIncome)}`);

            const spouseIncome = parseFloat(document.getElementById('touSpouseIncome')?.value) || 0;
            const wealth = parseFloat(document.getElementById('touWealth')?.value) || 0;
            const alimony = parseFloat(document.getElementById('touAlimony')?.value) || 0;
            const deductionOption = document.getElementById('touDeductionOption')?.value;
            const isQuasiResident = document.getElementById('touQuasiResident')?.checked;

            // Enhanced validation with better error messages
            if (!commune) {
                alert('Veuillez sélectionner une commune.');
                return;
            }
            if (!familyStatus) {
                alert('Veuillez sélectionner un statut familial.');
                return;
            }
            if (!annualIncome || isNaN(annualIncome) || annualIncome <= 0) {
                alert('Veuillez saisir un revenu annuel valide (supérieur à 0).');
                return;
            }

            // Create taxpayer profile for deduction calculations
            const profilContribuable = {
                revenu_brut_determinant: annualIncome,
                statut_familial: familyStatus,
                etat_civil: familyStatus === 'single' ? 'célibataire' : 'marié',
                nombre_enfants: childrenCount,
                revenu_conjoint: spouseIncome,
                revenu_brut_le_plus_bas: spouseIncome || 0,
                epoux_exercent_activite_lucrative: familyStatus === 'married-with-income',
                fortune: wealth,
                pension_alimentaire: alimony,
                quasi_resident: isQuasiResident,
                commune: commune
            };

            // Calculate deductions
            let totalDeductions = 0;
            let deductionDetails = null;
            let optimizationResult = null;

            if (deductionOption === 'optimize') {
                // Optimization mode: compute both and select best
                console.log('🔍 [TOU] Using deduction optimization mode');

                try {
                    optimizationResult = optimizeDeductions(profilContribuable, { type: 'optimize' });

                    // Use the recommended deduction result
                    const recommendedResult = optimizationResult.recommended;
                    totalDeductions = recommendedResult.ICC?.total_deductions_sur_revenu || 0; // Use ICC for TOU compatibility

                    deductionDetails = {
                        type: 'optimize',
                        recommendedType: optimizationResult.recommendedType,
                        optimization: optimizationResult,
                        ICC: recommendedResult.ICC || recommendedResult,
                        IFD: recommendedResult.IFD || recommendedResult
                    };

                    // Enhanced logging with safe property access
                    const savingsAmount = optimizationResult.analysis?.totalSavings || optimizationResult.savings?.total || 0;
                    console.log(`✅ [TOU] Optimization complete: recommended ${optimizationResult.recommendedType}, savings: ${savingsAmount.toFixed(2)} CHF`);

                } catch (error) {
                    console.error('❌ [TOU] Optimization failed, falling back to forfaitaire:', error);
                    // Fallback to forfaitaire
                    const forfaitResult = calculerDeductionsComprehensives(profilContribuable, { type: 'forfaitaire' });
                    totalDeductions = forfaitResult.ICC?.total_deductions_sur_revenu || 0;
                    deductionDetails = {
                        type: 'optimize_fallback',
                        ICC: forfaitResult.ICC || forfaitResult,
                        IFD: forfaitResult.IFD || forfaitResult,
                        error: error.message
                    };
                }

            } else if (deductionOption === 'reel') {
                // Comprehensive actual expense deductions
                console.log('🧮 [TOU] Calculating comprehensive actual expense deductions');

                const actualExpenseOptions = touCollectActualExpenseOptions();

                // Validate actual expense inputs
                const validation = touValidateActualExpenseInputs(actualExpenseOptions);
                touDisplayValidationMessages(validation);

                if (!validation.isValid) {
                    alert('Veuillez corriger les erreurs dans les déductions réelles avant de continuer.');
                    return;
                }

                try {
                    // Calculate comprehensive actual deductions using the new system
                    const resultatsDeductions = calculerDeductionsComprehensives(profilContribuable, actualExpenseOptions);

                    // For TOU calculation, we use ICC deductions as the base (legacy compatibility)
                    totalDeductions = resultatsDeductions.ICC.total_deductions_sur_revenu;

                    deductionDetails = {
                        type: 'reel',
                        ICC: resultatsDeductions.ICC,
                        IFD: resultatsDeductions.IFD
                    };

                    console.log('✅ [TOU] Comprehensive actual deductions calculated:', formatCurrency(totalDeductions));

                } catch (error) {
                    console.error('❌ [TOU] Error calculating actual deductions, using fallback:', error);
                    // Fallback to simple calculation
                    const healthDeduction = parseFloat(document.getElementById('touHealthInsuranceAmount').value) || 0;
                    const pensionDeduction = parseFloat(document.getElementById('touPillar3AAmount').value) || 0;
                    const otherDeduction = parseFloat(document.getElementById('touTrainingAmount').value) || 0;
                    totalDeductions = healthDeduction + pensionDeduction + otherDeduction;

                    deductionDetails = {
                        type: 'reel_fallback',
                        details: {
                            'Assurance maladie': healthDeduction,
                            '3ème pilier A': pensionDeduction,
                            'Formation': otherDeduction
                        }
                    };
                }
            } else {
                // Déductions forfaitaires selon l'algorithme complet
                console.log('🧮 [TOU] Calcul des déductions forfaitaires');
                console.log('👤 [PROFIL] Contribuable:', profilContribuable);

                try {
                    // Calculate forfait deductions using the comprehensive system
                    const forfaitOptions = { type: 'forfaitaire' };
                    const resultatsDeductions = calculerDeductionsComprehensives(profilContribuable, forfaitOptions);

                    // Pour le calcul TOU, on utilise les déductions ICC comme base
                    totalDeductions = resultatsDeductions.ICC.total_deductions_sur_revenu;

                    deductionDetails = {
                        type: 'forfaitaire',
                        ICC: resultatsDeductions.ICC,
                        IFD: resultatsDeductions.IFD
                    };

                    console.log('✅ [DEDUCTIONS] Total calculé:', formatCurrency(totalDeductions));

                } catch (error) {
                    console.error('❌ [DEDUCTIONS] Erreur, utilisation du forfait de base:', error);
                    totalDeductions = 11826; // Fallback
                    deductionDetails = {
                        type: 'forfaitaire_fallback',
                        details: { 'Déduction forfaitaire standard': totalDeductions }
                    };
                }
            }

            // Add alimony to deductions
            totalDeductions += alimony;
            if (alimony > 0 && deductionDetails) {
                if (!deductionDetails.details) deductionDetails.details = {};
                deductionDetails.details['Pension alimentaire'] = alimony;
            }

            // Check if user wants to use A1-A5 brackets
            const useA1A5Brackets = document.getElementById('touUseA1A5Brackets')?.checked || false;

            // Check A1-A5 eligibility and calculate withholding tax
            const a1a5Profile = {
                commune: commune,
                isGenevaresident: true, // Assuming Geneva resident for TOU calculation
                isQuasiResident: isQuasiResident,
                alimony: alimony,
                childrenCount: childrenCount
            };

            const a1a5Eligibility = touCheckA1A5Eligibility(a1a5Profile);
            let withholdingResult, withholdingTax;

            if (useA1A5Brackets && a1a5Eligibility.eligible && touA1A5TaxBracketsLoaded) {
                console.log(`🎯 [A1-A5] Utilisation des barèmes A1-A5: ${a1a5Eligibility.recommendedBracket}`);
                withholdingResult = touGetWithholdingTaxRate(annualIncome, familyStatus, childrenCount, false, true, a1a5Eligibility.recommendedBracket);
                withholdingResult.bracketType = 'A1-A5';
                withholdingResult.bracketUsed = a1a5Eligibility.recommendedBracket;
                withholdingResult.alimonyConsidered = a1a5Eligibility.alimonyAmount;
                withholdingResult.eligibilityReason = a1a5Eligibility.reason;
            } else {
                if (useA1A5Brackets && !a1a5Eligibility.eligible) {
                    console.warn(`⚠️ [A1-A5] Barèmes A1-A5 demandés mais non éligible: ${a1a5Eligibility.reason}`);
                }
                console.log('📊 [A0] Utilisation des barèmes A0 standard');
                withholdingResult = touGetWithholdingTaxRate(annualIncome, familyStatus, childrenCount);
                withholdingResult.bracketType = 'A0';
                withholdingResult.bracketUsed = withholdingResult.bracket || 'A0';
                withholdingResult.alimonyConsidered = 0;
                withholdingResult.eligibilityReason = useA1A5Brackets ? a1a5Eligibility.reason : 'Barèmes A0 standard utilisés';
            }

            withholdingTax = annualIncome * (withholdingResult.rate / 100);

            // Calculate TOU
            const touResult = touCalculateTOU(annualIncome, totalDeductions, isQuasiResident, commune, familyStatus, deductionDetails);

            // Display results
            touDisplayResults(withholdingResult, withholdingTax, touResult, annualIncome, alimony, isQuasiResident);
        }

        // Function to toggle ICC details in the TOU card
        function touToggleIccDetails() {
            const breakdownSection = document.getElementById('touIccBreakdown');
            const toggleButton = document.getElementById('touIccToggle');
            const toggleText = toggleButton.querySelector('span');
            const toggleIcon = toggleButton.querySelector('svg');

            if (breakdownSection.classList.contains('hidden')) {
                // Show details
                breakdownSection.classList.remove('hidden');
                breakdownSection.style.maxHeight = '0px';

                requestAnimationFrame(() => {
                    breakdownSection.style.maxHeight = breakdownSection.scrollHeight + 'px';
                });

                toggleText.textContent = 'Masquer';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Hide details
                breakdownSection.style.maxHeight = '0px';

                setTimeout(() => {
                    breakdownSection.classList.add('hidden');
                    breakdownSection.style.maxHeight = '';
                }, 300);

                toggleText.textContent = 'Afficher';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        // Function to toggle IFD details in the TOU card
        function touToggleIfdDetails() {
            const breakdownSection = document.getElementById('touIfdBreakdown');
            const toggleButton = document.getElementById('touIfdToggle');
            const toggleText = toggleButton.querySelector('span');
            const toggleIcon = toggleButton.querySelector('svg');

            if (breakdownSection.classList.contains('hidden')) {
                // Show details
                breakdownSection.classList.remove('hidden');
                breakdownSection.style.maxHeight = '0px';

                requestAnimationFrame(() => {
                    breakdownSection.style.maxHeight = breakdownSection.scrollHeight + 'px';
                });

                toggleText.textContent = 'Masquer';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Hide details
                breakdownSection.style.maxHeight = '0px';

                setTimeout(() => {
                    breakdownSection.classList.add('hidden');
                    breakdownSection.style.maxHeight = '';
                }, 300);

                toggleText.textContent = 'Afficher';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        // Function to toggle Calculated Tax details in the TOU card
        function touToggleCalculatedTaxDetails() {
            const breakdownSection = document.getElementById('touCalculatedTaxBreakdown');
            const toggleButton = document.getElementById('touCalculatedTaxToggle');
            const toggleText = toggleButton.querySelector('span');
            const toggleIcon = toggleButton.querySelector('svg');

            if (breakdownSection.classList.contains('hidden')) {
                // Show details
                breakdownSection.classList.remove('hidden');
                breakdownSection.style.maxHeight = '0px';

                requestAnimationFrame(() => {
                    breakdownSection.style.maxHeight = breakdownSection.scrollHeight + 'px';
                });

                toggleText.textContent = 'Masquer';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Hide details
                breakdownSection.style.maxHeight = '0px';

                setTimeout(() => {
                    breakdownSection.classList.add('hidden');
                    breakdownSection.style.maxHeight = '';
                }, 300);

                toggleText.textContent = 'Afficher';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        // Function to update ICC details in the TOU card
        function touUpdateIccDetailsInCard(touResult) {
            console.log('🔍 [ICC CARD DEBUG] Function called with touResult:', touResult);

            const iccDetailsSection = document.getElementById('touIccDetailsSection');
            const toggleButton = document.getElementById('touIccToggle');

            console.log('🔍 [ICC CARD DEBUG] Elements found:', {
                iccDetailsSection: !!iccDetailsSection,
                toggleButton: !!toggleButton,
                hasIccDetails: !!touResult?.iccDetails
            });

            // Using global formatCurrency function

            // Reset expanded state
            const breakdownSection = document.getElementById('touIccBreakdown');
            if (breakdownSection && !breakdownSection.classList.contains('hidden')) {
                breakdownSection.classList.add('hidden');
                breakdownSection.style.maxHeight = '';

                const toggleText = toggleButton?.querySelector('span');
                const toggleIcon = toggleButton?.querySelector('svg');
                if (toggleText) toggleText.textContent = 'Afficher';
                if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
            }

            // Show ICC details section if we have calculation data
            if (iccDetailsSection) {
                console.log('🎨 [ICC CARD] Processing ICC details section');

                // Get the selected commune to determine municipal rate
                const selectedCommune = document.getElementById('touCommune')?.value || 'GENEVE';
                let municipalRate = 45.49; // Default Geneva rate

                // Use the municipal rate from ICC calculation details if available
                if (touResult.iccDetails && touResult.iccDetails.tauxCommunal) {
                    municipalRate = touResult.iccDetails.tauxCommunal;
                    console.log(`📍 [ICC CARD] Using municipal rate from ICC calculation: ${municipalRate}%`);
                } else {
                    // Fallback: Get the actual municipal rate if data is available
                    if (typeof getMunicipalTaxRate === 'function') {
                        try {
                            municipalRate = getMunicipalTaxRate(selectedCommune, 2024);
                            console.log(`📍 [ICC CARD] Municipal rate for ${selectedCommune}: ${municipalRate}%`);
                        } catch (error) {
                            console.warn(`⚠️ [ICC CARD] Could not get municipal rate for ${selectedCommune}, using default:`, error);
                        }
                    } else {
                        console.warn(`⚠️ [ICC CARD] getMunicipalTaxRate function not available`);
                    }
                }

                // Update the dynamic labels with correct percentages
                const cantonalLabel = document.getElementById('touIccCantonalLabel');
                const municipalLabel = document.getElementById('touIccMunicipalLabel');

                if (cantonalLabel) {
                    cantonalLabel.textContent = 'Centimes cantonaux (47.5%):';
                }
                if (municipalLabel) {
                    municipalLabel.textContent = `Centimes communaux (${municipalRate}%):`;
                }

                if (touResult.iccDetails) {
                    // Real ICC data available
                    const details = touResult.iccDetails;
                    console.log('✅ [ICC CARD] Using real ICC calculation data');
                    console.log('📊 [ICC CARD DEBUG] ICC details object:', details);

                    // Validate ICC details to prevent NaN errors
                    const validatedDetails = {
                        impotDeBase: isNaN(details.impotDeBase) ? 0 : details.impotDeBase,
                        centimesCantonaux: isNaN(details.centimesCantonaux) ? 0 : details.centimesCantonaux,
                        reductionBase: isNaN(details.reductionBase) ? 0 : details.reductionBase,
                        centimeAideDomicile: isNaN(details.centimeAideDomicile) ? 0 : details.centimeAideDomicile,
                        centimesCommunaux: isNaN(details.centimesCommunaux) ? 0 : details.centimesCommunaux,
                        impotTotalDu: isNaN(details.impotTotalDu) ? 0 : details.impotTotalDu
                    };

                    // Log any NaN values found
                    Object.keys(validatedDetails).forEach(key => {
                        if (isNaN(details[key])) {
                            console.warn(`⚠️ [ICC CARD] NaN detected in ${key}: ${details[key]}, using 0 instead`);
                        }
                    });

                    // Show the ICC details section
                    iccDetailsSection.classList.remove('hidden');

                    // Populate the breakdown values using validated details
                    document.getElementById('touIccBase').textContent = formatCurrency(validatedDetails.impotDeBase);
                    document.getElementById('touIccCantonal').textContent = formatCurrency(validatedDetails.centimesCantonaux);
                    document.getElementById('touIccReduction').textContent = '-' + formatCurrency(validatedDetails.reductionBase);
                    document.getElementById('touIccHomeCare').textContent = formatCurrency(validatedDetails.centimeAideDomicile);
                    document.getElementById('touIccMunicipal').textContent = formatCurrency(validatedDetails.centimesCommunaux);
                    document.getElementById('touIccTotal').textContent = formatCurrency(validatedDetails.impotTotalDu);

                    console.log('📊 [ICC CARD] Populated values:', {
                        base: validatedDetails.impotDeBase,
                        cantonal: validatedDetails.centimesCantonaux,
                        reduction: validatedDetails.reductionBase,
                        homeCare: validatedDetails.centimeAideDomicile,
                        municipal: validatedDetails.centimesCommunaux,
                        total: validatedDetails.impotTotalDu
                    });

                    // Populate splitting details if available
                    const splittingDetailsSection = document.getElementById('touSplittingDetails');
                    if (details.splittingDetails && details.splittingDetails.hasSplitting) {
                        const splitting = details.splittingDetails;

                        // Show splitting details section
                        splittingDetailsSection.classList.remove('hidden');

                        // Determine splitting type and update title
                        let splittingType = '';
                        let divisionText = '';
                        let multiplierText = '';

                        if (splitting.statutFiscal === 'marie_splitting') {
                            splittingType = 'Splitting Intégral (Complet)';
                            divisionText = '2 (50%)';
                            multiplierText = '2.0';
                        } else if (splitting.statutFiscal === 'splitting_partiel') {
                            splittingType = 'Splitting Partiel';
                            divisionText = '1.8 (55.56%)';
                            // For partial splitting, show the proportional calculation instead of simple multiplication
                            const proportionalCalculation = (splitting.revenuImposable * splitting.impotIntermediaire) / splitting.referenceIncome;
                            multiplierText = `Formule: (${formatCurrency(splitting.revenuImposable)} × ${formatCurrency(splitting.impotIntermediaire)}) ÷ ${formatCurrency(splitting.referenceIncome)}`;
                        }

                        document.getElementById('touSplittingTitle').textContent = `Calcul avec ${splittingType}:`;

                        // Populate splitting calculation details with correct terminology
                        document.getElementById('touSplittingOriginalIncome').textContent = formatCurrency(splitting.revenuImposable);
                        document.getElementById('touSplittingDivision').textContent = divisionText;
                        document.getElementById('touSplittingReferenceIncome').textContent = formatCurrency(splitting.referenceIncome);
                        document.getElementById('touSplittingIntermediateTax').textContent = formatCurrency(splitting.impotIntermediaire);
                        document.getElementById('touSplittingMultiplier').textContent = multiplierText;
                        document.getElementById('touSplittingFinalTax').textContent = formatCurrency(splitting.impotDeBase);

                        console.log(`📊 [ICC CARD] Showing ${splittingType} details for ${splitting.statutFiscal}`);
                    } else {
                        // Hide splitting details section for single taxpayers
                        splittingDetailsSection.classList.add('hidden');
                    }

                    console.log('✅ [ICC CARD] Real ICC data populated');
                } else {
                    // No detailed ICC data, but show section with calculated ICC tax
                    console.log('⚠️ [ICC CARD] No detailed ICC data, showing simplified version');
                    iccDetailsSection.classList.remove('hidden');

                    // Show simplified breakdown based on calculated ICC tax
                    const estimatedBase = touResult.iccTax * 0.6; // Rough estimate
                    document.getElementById('touIccBase').textContent = formatCurrency(estimatedBase);
                    document.getElementById('touIccCantonal').textContent = formatCurrency(estimatedBase * 0.475);
                    document.getElementById('touIccReduction').textContent = '-' + formatCurrency(estimatedBase * 0.12);
                    document.getElementById('touIccHomeCare').textContent = formatCurrency(estimatedBase * 0.01);
                    document.getElementById('touIccMunicipal').textContent = formatCurrency(touResult.iccTax - estimatedBase * 1.365);
                    document.getElementById('touIccTotal').textContent = formatCurrency(touResult.iccTax);

                    // Hide splitting details section for simplified view
                    const splittingDetailsSection = document.getElementById('touSplittingDetails');
                    if (splittingDetailsSection) {
                        splittingDetailsSection.classList.add('hidden');
                    }

                    console.log('✅ [ICC CARD] Simplified ICC data populated');
                }

                // Ensure toggle button has event listener
                if (toggleButton && !toggleButton.hasAttribute('data-listener-added')) {
                    toggleButton.addEventListener('click', touToggleIccDetails);
                    toggleButton.setAttribute('data-listener-added', 'true');
                    console.log('✅ [ICC CARD] Toggle event listener added');
                }
            }

            if (false) { // Keep the old logic disabled for now
                // Hide the ICC details section if no detailed data available
                if (iccDetailsSection) {
                    iccDetailsSection.classList.add('hidden');
                    console.log('⚠️ [ICC CARD DEBUG] Section hidden due to missing data');
                }
                console.log('⚠️ [ICC CARD] No ICC details available, section hidden');
                console.log('🔍 [ICC CARD DEBUG] Missing data analysis:', {
                    hasIccDetails: !!touResult?.iccDetails,
                    hasSection: !!iccDetailsSection,
                    iccDetailsValue: touResult?.iccDetails
                });
            }
        }

        // Function to update IFD details in the TOU card
        function touUpdateIfdDetailsInCard(touResult) {
            console.log('🏛️ [IFD CARD] Updating IFD details display');

            const ifdDetailsSection = document.getElementById('touIfdDetailsSection');
            const toggleButton = document.getElementById('touIfdToggle');

            if (!ifdDetailsSection) {
                console.warn('⚠️ [IFD CARD] IFD details section not found');
                return;
            }

            // Check if we have detailed IFD data
            if (touResult && touResult.ifdDetails) {
                const ifdDetails = touResult.ifdDetails;

                // Show the IFD details section
                ifdDetailsSection.classList.remove('hidden');

                // Calculate and populate the three specific IFD fields
                if (ifdDetails.details && Array.isArray(ifdDetails.details)) {
                    let previousBracketsTax = 0;
                    let currentBracketRate = 0;
                    let remainingAmount = 0;

                    // Find the current bracket (the one with partial filling or the last complete one)
                    let currentBracketIndex = -1;
                    for (let i = 0; i < ifdDetails.details.length; i++) {
                        const bracket = ifdDetails.details[i];
                        if (bracket.montantImpose > 0) {
                            currentBracketIndex = i;
                            currentBracketRate = bracket.taux;

                            // If this is a partial bracket, calculate remaining amount
                            if (bracket.type === 'partial') {
                                remainingAmount = bracket.montantImpose;
                                break;
                            }
                        }
                    }

                    // Calculate tax from all previous (completed) brackets
                    for (let i = 0; i < currentBracketIndex; i++) {
                        const bracket = ifdDetails.details[i];
                        if (bracket.type === 'complete') {
                            previousBracketsTax += bracket.impot;
                        }
                    }

                    // If no partial bracket found, use the last complete bracket's info
                    if (remainingAmount === 0 && currentBracketIndex >= 0) {
                        const currentBracket = ifdDetails.details[currentBracketIndex];
                        if (currentBracket.type === 'complete') {
                            remainingAmount = currentBracket.montantImpose;
                        }
                    }

                    // Calculate tax on remaining amount for formula display
                    const taxOnRemainingAmount = remainingAmount * (currentBracketRate / 100);

                    // Populate the three specific fields
                    document.getElementById('touIfdPreviousBracketsTax').textContent = formatCurrency(previousBracketsTax);
                    document.getElementById('touIfdCurrentBracketRate').textContent = currentBracketRate + '%';

                    // Display remaining amount with complete calculation formula
                    const remainingAmountFormula = `${formatCurrency(remainingAmount)} × ${currentBracketRate}% = ${formatCurrency(taxOnRemainingAmount)}`;
                    document.getElementById('touIfdRemainingAmount').textContent = remainingAmountFormula;

                    // Populate the total IFD field
                    document.getElementById('touIfdFinalTotal').textContent = formatCurrency(ifdDetails.impotTotal);

                    console.log(`🏛️ [IFD CARD] IFD bracket details: Previous tax ${formatCurrency(previousBracketsTax)}, Current rate ${currentBracketRate}%, Remaining formula: ${remainingAmountFormula}, Total IFD ${formatCurrency(ifdDetails.impotTotal)}`);
                } else {
                    // Fallback values if no detailed data available
                    document.getElementById('touIfdPreviousBracketsTax').textContent = '-';
                    document.getElementById('touIfdCurrentBracketRate').textContent = '-';
                    document.getElementById('touIfdRemainingAmount').textContent = '-';
                    document.getElementById('touIfdFinalTotal').textContent = formatCurrency(ifdDetails.impotTotal);
                    console.warn('⚠️ [IFD CARD] No detailed IFD brackets data available, using fallback values');
                }

                // Ensure toggle button has event listener
                if (toggleButton && !toggleButton.hasAttribute('data-listener-added')) {
                    toggleButton.addEventListener('click', touToggleIfdDetails);
                    toggleButton.setAttribute('data-listener-added', 'true');
                    console.log('✅ [IFD CARD] Toggle event listener added');
                }

                console.log(`🏛️ [IFD CARD] IFD details updated: ${formatCurrency(ifdDetails.impotTotal)} (${ifdDetails.tauxEffectif.toFixed(2)}%)`);
            } else {
                console.warn('⚠️ [IFD CARD] No detailed IFD data available, hiding section');
                ifdDetailsSection.classList.add('hidden');
            }
        }

        // Function to update Calculated Tax details in the TOU card
        function touUpdateCalculatedTaxDetailsInCard(touResult) {
            console.log('💰 [CALCULATED TAX CARD] Updating calculated tax details display');

            const calculatedTaxDetailsSection = document.getElementById('touCalculatedTaxDetailsSection');
            const toggleButton = document.getElementById('touCalculatedTaxToggle');

            if (!calculatedTaxDetailsSection) {
                console.warn('⚠️ [CALCULATED TAX CARD] Calculated tax details section not found');
                return;
            }

            // Check if we have tax calculation data
            if (touResult && touResult.totalTax !== undefined) {
                // Show the calculated tax details section
                calculatedTaxDetailsSection.classList.remove('hidden');

                // Get individual tax components
                const iccTax = touResult.iccTax || 0;
                const ifdTax = touResult.ifdTax || 0;
                const totalTax = touResult.totalTax || 0;

                // Populate the breakdown fields
                // document.getElementById('touCalculatedTaxTotal').textContent = formatCurrency(totalTax); // Removed - field no longer exists
                document.getElementById('touCalculatedTaxICC').textContent = formatCurrency(iccTax);
                document.getElementById('touCalculatedTaxIFD').textContent = formatCurrency(ifdTax);
                document.getElementById('touCalculatedTaxFinalTotal').textContent = formatCurrency(totalTax);

                // Ensure toggle button has event listener
                if (toggleButton && !toggleButton.hasAttribute('data-listener-added')) {
                    toggleButton.addEventListener('click', touToggleCalculatedTaxDetails);
                    toggleButton.setAttribute('data-listener-added', 'true');
                    console.log('✅ [CALCULATED TAX CARD] Toggle event listener added');
                }

                console.log(`💰 [CALCULATED TAX CARD] Tax breakdown updated: ICC ${formatCurrency(iccTax)} + IFD ${formatCurrency(ifdTax)} = Total ${formatCurrency(totalTax)}`);
            } else {
                console.warn('⚠️ [CALCULATED TAX CARD] No tax calculation data available, hiding section');
                calculatedTaxDetailsSection.classList.add('hidden');
            }
        }

        // Function to toggle ICC Deductions details
        function touToggleIccDeductionsDetails() {
            const breakdownSection = document.getElementById('touIccDeductionsBreakdown');
            const toggleButton = document.getElementById('touIccDeductionsToggle');
            const toggleText = toggleButton.querySelector('span');
            const toggleIcon = toggleButton.querySelector('svg');

            if (breakdownSection.classList.contains('hidden')) {
                // Show details
                breakdownSection.classList.remove('hidden');
                breakdownSection.style.maxHeight = '0px';

                requestAnimationFrame(() => {
                    breakdownSection.style.maxHeight = breakdownSection.scrollHeight + 'px';
                });

                toggleText.textContent = 'Masquer';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Hide details
                breakdownSection.style.maxHeight = '0px';

                setTimeout(() => {
                    breakdownSection.classList.add('hidden');
                    breakdownSection.style.maxHeight = '';
                }, 300);

                toggleText.textContent = 'Afficher';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        // Function to toggle IFD Deductions details
        function touToggleIfdDeductionsDetails() {
            const breakdownSection = document.getElementById('touIfdDeductionsBreakdown');
            const toggleButton = document.getElementById('touIfdDeductionsToggle');
            const toggleText = toggleButton.querySelector('span');
            const toggleIcon = toggleButton.querySelector('svg');

            if (breakdownSection.classList.contains('hidden')) {
                // Show details
                breakdownSection.classList.remove('hidden');
                breakdownSection.style.maxHeight = '0px';

                requestAnimationFrame(() => {
                    breakdownSection.style.maxHeight = breakdownSection.scrollHeight + 'px';
                });

                toggleText.textContent = 'Masquer';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Hide details
                breakdownSection.style.maxHeight = '0px';

                setTimeout(() => {
                    breakdownSection.classList.add('hidden');
                    breakdownSection.style.maxHeight = '';
                }, 300);

                toggleText.textContent = 'Afficher';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        // Function to update ICC Deductions details
        function touUpdateIccDeductionsDetailsInCard(touResult) {
            console.log('📊 [ICC DEDUCTIONS] Updating ICC deductions details display');

            const iccDeductionsDetailsSection = document.getElementById('touIccDeductionsDetailsSection');
            const toggleButton = document.getElementById('touIccDeductionsToggle');
            const contentContainer = document.getElementById('touIccDeductionsContent');

            if (!iccDeductionsDetailsSection || !contentContainer) {
                console.warn('⚠️ [ICC DEDUCTIONS] ICC deductions details section not found');
                return;
            }

            // Check if we have ICC deduction details
            if (touResult && touResult.deductionDetails && touResult.deductionDetails.ICC) {
                const iccDetails = touResult.deductionDetails.ICC.details;

                // Update header text based on deduction type
                const headerLabel = document.getElementById('touIccDeductionsLabel');
                if (headerLabel) {
                    const deductionType = touResult.deductionDetails.type;
                    let labelText = 'Détail Déductions ICC';
                    if (deductionType === 'forfaitaire' || deductionType === 'forfaitaire_fallback') {
                        labelText = 'Détail Déductions forfaitaires ICC';
                    } else if (deductionType === 'reel' || deductionType === 'reel_fallback') {
                        labelText = 'Détail Déductions réelles ICC';
                    } else if (deductionType === 'optimize' || deductionType === 'optimize_fallback') {
                        const recommendedType = touResult.deductionDetails.recommendedType || 'forfaitaire';
                        labelText = `Détail Déductions ${recommendedType === 'forfaitaire' ? 'forfaitaires' : 'réelles'} ICC (optimisées)`;
                    }
                    headerLabel.textContent = labelText;
                }

                // Show the ICC deductions details section
                iccDeductionsDetailsSection.classList.remove('hidden');

                // Clear existing content
                contentContainer.innerHTML = '';

                // Categorize deductions into social contributions and tax deductions
                const socialContributions = {};
                const taxDeductions = {};

                // Define social contribution categories
                const socialContributionKeys = [
                    'Cotisation AVS/AI/APG',
                    'Cotisation chômage',
                    'Cotisation 2ème pilier',
                    'Cotisation maternité',
                    'Prime AANP'
                ];

                // Categorize each deduction
                Object.entries(iccDetails).forEach(([nom, montant]) => {
                    if (montant > 0) {
                        if (socialContributionKeys.includes(nom)) {
                            socialContributions[nom] = montant;
                        } else {
                            taxDeductions[nom] = montant;
                        }
                    }
                });

                // Create social contributions section
                if (Object.keys(socialContributions).length > 0) {
                    const socialSection = document.createElement('div');
                    socialSection.className = 'social-contributions-section';

                    // Header with icon and tooltip
                    const socialHeader = document.createElement('div');
                    socialHeader.className = 'social-contributions-header enhanced-section-header';
                    socialHeader.innerHTML = `
                        <div class="flex items-center">
                            <svg class="social-contributions-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="social-contributions-title">Cotisations sociales obligatoires</span>
                        </div>
                        <div class="info-tooltip">
                            <svg class="section-info-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tooltip-text">
                                <strong>Cotisations sociales obligatoires</strong><br>
                                Ces déductions sont automatiquement calculées selon les taux légaux en vigueur. Elles incluent l'AVS/AI/APG, l'assurance chômage, le 2ème pilier, l'allocation maternité et l'AANP. Ces montants ne peuvent pas être modifiés.
                            </span>
                        </div>
                    `;

                    // Content
                    const socialContent = document.createElement('div');
                    socialContent.className = 'social-contributions-content';

                    let socialTotal = 0;
                    Object.entries(socialContributions).forEach(([nom, montant]) => {
                        socialTotal += montant;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'deduction-item';
                        itemDiv.innerHTML = `
                            <span class="deduction-item-label">${nom}</span>
                            <span class="deduction-item-amount">${formatCurrency(montant)}</span>
                        `;
                        socialContent.appendChild(itemDiv);
                    });

                    // Add social contributions total
                    const socialTotalDiv = document.createElement('div');
                    socialTotalDiv.className = 'section-total';
                    socialTotalDiv.innerHTML = `
                        <span class="section-total-label">Total cotisations sociales:</span>
                        <span class="section-total-amount">${formatCurrency(socialTotal)}</span>
                    `;
                    socialContent.appendChild(socialTotalDiv);

                    socialSection.appendChild(socialHeader);
                    socialSection.appendChild(socialContent);
                    contentContainer.appendChild(socialSection);
                }

                // Create tax deductions section
                if (Object.keys(taxDeductions).length > 0) {
                    const taxSection = document.createElement('div');
                    taxSection.className = 'tax-deductions-section';

                    // Header with icon and tooltip
                    const taxHeader = document.createElement('div');
                    taxHeader.className = 'tax-deductions-header enhanced-section-header';
                    taxHeader.innerHTML = `
                        <div class="flex items-center">
                            <svg class="tax-deductions-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tax-deductions-title">Déductions fiscales</span>
                        </div>
                        <div class="info-tooltip">
                            <svg class="section-info-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tooltip-text">
                                <strong>Déductions fiscales</strong><br>
                                Ces déductions réduisent votre revenu imposable. Elles peuvent être forfaitaires (montants standards) ou réelles (frais effectifs justifiés). L'optimisation choisit automatiquement la meilleure option.
                            </span>
                        </div>
                    `;

                    // Content
                    const taxContent = document.createElement('div');
                    taxContent.className = 'tax-deductions-content';

                    let taxTotal = 0;
                    Object.entries(taxDeductions).forEach(([nom, montant]) => {
                        taxTotal += montant;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'deduction-item';

                        // Enhanced display for professional expenses
                        if (nom === 'Frais professionnels') {
                            itemDiv.innerHTML = `
                                <div>
                                    <span class="deduction-item-label">${nom} (3% revenu net)</span>
                                    <div class="deduction-item-explanation">Min 634 CHF - Max 1,796 CHF</div>
                                </div>
                                <span class="deduction-item-amount">${formatCurrency(montant)}</span>
                            `;
                        } else {
                            itemDiv.innerHTML = `
                                <span class="deduction-item-label">${nom}</span>
                                <span class="deduction-item-amount">${formatCurrency(montant)}</span>
                            `;
                        }
                        taxContent.appendChild(itemDiv);
                    });

                    // Add tax deductions total
                    const taxTotalDiv = document.createElement('div');
                    taxTotalDiv.className = 'section-total';
                    taxTotalDiv.innerHTML = `
                        <span class="section-total-label">Total déductions fiscales:</span>
                        <span class="section-total-amount">${formatCurrency(taxTotal)}</span>
                    `;
                    taxContent.appendChild(taxTotalDiv);

                    taxSection.appendChild(taxHeader);
                    taxSection.appendChild(taxContent);
                    contentContainer.appendChild(taxSection);
                }

                // Add overall total at the bottom
                const overallTotalDiv = document.createElement('div');
                overallTotalDiv.className = 'flex justify-between border-t-2 border-gray-400 pt-3 mt-3 bg-gray-50 rounded px-3 py-2';
                overallTotalDiv.innerHTML = `
                    <span class="text-gray-700 font-bold text-sm">Total déductions ICC:</span>
                    <span class="text-gray-900 font-bold text-sm">${formatCurrency(touResult.deductionDetails.ICC.total_deductions_sur_revenu)}</span>
                `;
                contentContainer.appendChild(overallTotalDiv);

                // Ensure toggle button has event listener
                if (toggleButton && !toggleButton.hasAttribute('data-listener-added')) {
                    toggleButton.addEventListener('click', touToggleIccDeductionsDetails);
                    toggleButton.setAttribute('data-listener-added', 'true');
                    console.log('✅ [ICC DEDUCTIONS] Toggle event listener added');
                }

                console.log(`📊 [ICC DEDUCTIONS] ICC deductions details updated: ${formatCurrency(touResult.deductionDetails.ICC.total_deductions_sur_revenu)}`);
            } else {
                console.warn('⚠️ [ICC DEDUCTIONS] No ICC deduction details available, hiding section');
                iccDeductionsDetailsSection.classList.add('hidden');
            }
        }

        // Function to update IFD Deductions details
        function touUpdateIfdDeductionsDetailsInCard(touResult) {
            console.log('📊 [IFD DEDUCTIONS] Updating IFD deductions details display');

            const ifdDeductionsDetailsSection = document.getElementById('touIfdDeductionsDetailsSection');
            const toggleButton = document.getElementById('touIfdDeductionsToggle');
            const contentContainer = document.getElementById('touIfdDeductionsContent');

            if (!ifdDeductionsDetailsSection || !contentContainer) {
                console.warn('⚠️ [IFD DEDUCTIONS] IFD deductions details section not found');
                return;
            }

            // Check if we have IFD deduction details
            if (touResult && touResult.deductionDetails && touResult.deductionDetails.IFD) {
                const ifdDetails = touResult.deductionDetails.IFD.details;

                // Update header text based on deduction type
                const headerLabel = document.getElementById('touIfdDeductionsLabel');
                if (headerLabel) {
                    const deductionType = touResult.deductionDetails.type;
                    let labelText = 'Détail Déductions IFD';
                    if (deductionType === 'forfaitaire' || deductionType === 'forfaitaire_fallback') {
                        labelText = 'Détail Déductions forfaitaires IFD';
                    } else if (deductionType === 'reel' || deductionType === 'reel_fallback') {
                        labelText = 'Détail Déductions réelles IFD';
                    } else if (deductionType === 'optimize' || deductionType === 'optimize_fallback') {
                        const recommendedType = touResult.deductionDetails.recommendedType || 'forfaitaire';
                        labelText = `Détail Déductions ${recommendedType === 'forfaitaire' ? 'forfaitaires' : 'réelles'} IFD (optimisées)`;
                    }
                    headerLabel.textContent = labelText;
                }

                // Show the IFD deductions details section
                ifdDeductionsDetailsSection.classList.remove('hidden');

                // Clear existing content
                contentContainer.innerHTML = '';

                // Categorize deductions into social contributions and tax deductions
                const socialContributions = {};
                const taxDeductions = {};

                // Define social contribution categories (same as ICC)
                const socialContributionKeys = [
                    'Cotisation AVS/AI/APG',
                    'Cotisation chômage',
                    'Cotisation 2ème pilier',
                    'Cotisation maternité',
                    'Prime AANP'
                ];

                // Categorize each deduction
                Object.entries(ifdDetails).forEach(([nom, montant]) => {
                    if (montant > 0) {
                        if (socialContributionKeys.includes(nom)) {
                            socialContributions[nom] = montant;
                        } else {
                            taxDeductions[nom] = montant;
                        }
                    }
                });

                // Create social contributions section
                if (Object.keys(socialContributions).length > 0) {
                    const socialSection = document.createElement('div');
                    socialSection.className = 'social-contributions-section';

                    // Header with icon and tooltip
                    const socialHeader = document.createElement('div');
                    socialHeader.className = 'social-contributions-header enhanced-section-header';
                    socialHeader.innerHTML = `
                        <div class="flex items-center">
                            <svg class="social-contributions-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="social-contributions-title">Cotisations sociales obligatoires</span>
                        </div>
                        <div class="info-tooltip">
                            <svg class="section-info-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tooltip-text">
                                <strong>Cotisations sociales obligatoires</strong><br>
                                Ces déductions sont automatiquement calculées selon les taux légaux en vigueur. Elles incluent l'AVS/AI/APG, l'assurance chômage, le 2ème pilier, l'allocation maternité et l'AANP. Ces montants ne peuvent pas être modifiés.
                            </span>
                        </div>
                    `;

                    // Content
                    const socialContent = document.createElement('div');
                    socialContent.className = 'social-contributions-content';

                    let socialTotal = 0;
                    Object.entries(socialContributions).forEach(([nom, montant]) => {
                        socialTotal += montant;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'deduction-item';
                        itemDiv.innerHTML = `
                            <span class="deduction-item-label">${nom}</span>
                            <span class="deduction-item-amount">${formatCurrency(montant)}</span>
                        `;
                        socialContent.appendChild(itemDiv);
                    });

                    // Add social contributions total
                    const socialTotalDiv = document.createElement('div');
                    socialTotalDiv.className = 'section-total';
                    socialTotalDiv.innerHTML = `
                        <span class="section-total-label">Total cotisations sociales:</span>
                        <span class="section-total-amount">${formatCurrency(socialTotal)}</span>
                    `;
                    socialContent.appendChild(socialTotalDiv);

                    socialSection.appendChild(socialHeader);
                    socialSection.appendChild(socialContent);
                    contentContainer.appendChild(socialSection);
                }

                // Create tax deductions section
                if (Object.keys(taxDeductions).length > 0) {
                    const taxSection = document.createElement('div');
                    taxSection.className = 'tax-deductions-section';

                    // Header with icon and tooltip
                    const taxHeader = document.createElement('div');
                    taxHeader.className = 'tax-deductions-header enhanced-section-header';
                    taxHeader.innerHTML = `
                        <div class="flex items-center">
                            <svg class="tax-deductions-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tax-deductions-title">Déductions fiscales</span>
                        </div>
                        <div class="info-tooltip">
                            <svg class="section-info-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tooltip-text">
                                <strong>Déductions fiscales</strong><br>
                                Ces déductions réduisent votre revenu imposable. Elles peuvent être forfaitaires (montants standards) ou réelles (frais effectifs justifiés). L'optimisation choisit automatiquement la meilleure option.
                            </span>
                        </div>
                    `;

                    // Content
                    const taxContent = document.createElement('div');
                    taxContent.className = 'tax-deductions-content';

                    let taxTotal = 0;
                    Object.entries(taxDeductions).forEach(([nom, montant]) => {
                        taxTotal += montant;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'deduction-item';

                        // Enhanced display for professional expenses
                        if (nom === 'Frais professionnels') {
                            itemDiv.innerHTML = `
                                <div>
                                    <span class="deduction-item-label">${nom} (3% revenu net)</span>
                                    <div class="deduction-item-explanation">Min 2,000 CHF - Max 4,000 CHF</div>
                                </div>
                                <span class="deduction-item-amount">${formatCurrency(montant)}</span>
                            `;
                        } else {
                            itemDiv.innerHTML = `
                                <span class="deduction-item-label">${nom}</span>
                                <span class="deduction-item-amount">${formatCurrency(montant)}</span>
                            `;
                        }
                        taxContent.appendChild(itemDiv);
                    });

                    // Add tax deductions total
                    const taxTotalDiv = document.createElement('div');
                    taxTotalDiv.className = 'section-total';
                    taxTotalDiv.innerHTML = `
                        <span class="section-total-label">Total déductions fiscales:</span>
                        <span class="section-total-amount">${formatCurrency(taxTotal)}</span>
                    `;
                    taxContent.appendChild(taxTotalDiv);

                    taxSection.appendChild(taxHeader);
                    taxSection.appendChild(taxContent);
                    contentContainer.appendChild(taxSection);
                }

                // Add overall total at the bottom (but before credit d'impôt)
                const overallTotalDiv = document.createElement('div');
                overallTotalDiv.className = 'flex justify-between border-t-2 border-gray-400 pt-3 mt-3 bg-gray-50 rounded px-3 py-2';
                overallTotalDiv.innerHTML = `
                    <span class="text-gray-700 font-bold text-sm">Total déductions IFD:</span>
                    <span class="text-gray-900 font-bold text-sm">${formatCurrency(touResult.deductionDetails.IFD.total_deductions_sur_revenu)}</span>
                `;
                contentContainer.appendChild(overallTotalDiv);

                // Add credit d'impôt if exists (after the total)
                if (touResult.deductionDetails.IFD.credit_impot_final > 0) {
                    const creditSection = document.createElement('div');
                    creditSection.className = 'mt-3 p-3 bg-green-50 rounded border border-green-200';
                    creditSection.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-green-700 font-semibold text-xs">Crédit d'impôt</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-green-600 text-xs">Crédit d'impôt enfants:</span>
                            <span class="text-green-700 font-bold text-xs">${formatCurrency(touResult.deductionDetails.IFD.credit_impot_final)}</span>
                        </div>
                    `;
                    contentContainer.appendChild(creditSection);
                }

                // Ensure toggle button has event listener
                if (toggleButton && !toggleButton.hasAttribute('data-listener-added')) {
                    toggleButton.addEventListener('click', touToggleIfdDeductionsDetails);
                    toggleButton.setAttribute('data-listener-added', 'true');
                    console.log('✅ [IFD DEDUCTIONS] Toggle event listener added');
                }

                console.log(`📊 [IFD DEDUCTIONS] IFD deductions details updated: ${formatCurrency(touResult.deductionDetails.IFD.total_deductions_sur_revenu)}`);
            } else {
                console.warn('⚠️ [IFD DEDUCTIONS] No IFD deduction details available, hiding section');
                ifdDeductionsDetailsSection.classList.add('hidden');
            }
        }

        function touDisplayResults(withholdingResult, withholdingTax, touResult, annualIncome, alimony, isQuasiResident) {
            // Show results section
            document.getElementById('touResultsSection').classList.remove('hidden');

            // Using global formatCurrency function

            // Update withholding tax results with A1-A5 information
            const bracketDisplay = withholdingResult.bracketType === 'A1-A5'
                ? `${withholdingResult.bracketUsed} (avec pension alimentaire)`
                : withholdingResult.bracket;

            document.getElementById('touSourceBracket').textContent = bracketDisplay;
            document.getElementById('touSourceBase').textContent = formatCurrency(annualIncome);
            document.getElementById('touReferenceIncome').textContent = formatCurrency(annualIncome);
            document.getElementById('touWithholdingRate').textContent = formatTaxRate(withholdingResult.rate);

            // Add A1-A5 information if applicable
            if (withholdingResult.bracketType === 'A1-A5') {
                console.log(`📋 [A1-A5] Affichage des résultats avec barème ${withholdingResult.bracketUsed}`);
                console.log(`💰 [A1-A5] Pension alimentaire considérée: ${formatCurrency(withholdingResult.alimonyConsidered)}`);
            }
            document.getElementById('touSourceTax').textContent = formatCurrency(withholdingTax);

            // Update TOU results
            document.getElementById('touTouDeductions').textContent = formatCurrency(touResult.deductions);
            document.getElementById('touRevenuNetIcc').textContent = formatCurrency(touResult.netIncomeIcc);
            document.getElementById('touRevenuNetIfd').textContent = formatCurrency(touResult.netIncomeIfd);
            document.getElementById('touIccRate').textContent = formatTaxRate(touResult.iccRate);
            document.getElementById('touIfdRate').textContent = formatTaxRate(touResult.ifdRate);
            document.getElementById('touTouTax').textContent = formatCurrency(touResult.totalTax);

            // Update ICC details section
            touUpdateIccDetailsInCard(touResult);

            // Update IFD details section
            touUpdateIfdDetailsInCard(touResult);

            // Update Calculated Tax details section
            touUpdateCalculatedTaxDetailsInCard(touResult);

            // Update ICC and IFD Deductions details sections
            touUpdateIccDeductionsDetailsInCard(touResult);
            touUpdateIfdDeductionsDetailsInCard(touResult);

            // Update deduction comparison panel if optimization was used
            if (touResult.deductionDetails && touResult.deductionDetails.type === 'optimize' && touResult.deductionDetails.optimization) {
                touUpdateDeductionComparisonPanel(touResult.deductionDetails.optimization);
            } else {
                // Hide comparison panel if not using optimization
                const comparisonSection = document.getElementById('touDeductionComparisonSection');
                if (comparisonSection) {
                    comparisonSection.classList.add('hidden');
                }
            }

            // Calculate and display comparison
            const difference = withholdingTax - touResult.totalTax;
            const comparisonSummary = document.getElementById('touComparisonSummary');
            const recommendation = document.getElementById('touRecommendation');
            const taxDifference = document.getElementById('touTaxDifference');
            const bestOption = document.getElementById('touBestOption');
            const savingsAmount = document.getElementById('touSavingsAmount');

            comparisonSummary.classList.remove('hidden');
            recommendation.classList.remove('hidden');

            if (difference > 0) {
                // TOU is better
                taxDifference.textContent = '-' + formatCurrency(Math.abs(difference));
                taxDifference.className = 'text-2xl font-bold text-green-600';
                bestOption.textContent = 'Taxation Ordinaire (TOU)';
                savingsAmount.textContent = formatCurrency(Math.abs(difference));

                // Highlight TOU card
                document.getElementById('touTouResult').classList.add('tou-best-option');
                document.getElementById('touWithholdingResult').classList.remove('tou-best-option');
            } else {
                // Withholding is better
                taxDifference.textContent = '+' + formatCurrency(Math.abs(difference));
                taxDifference.className = 'text-2xl font-bold text-red-600';
                bestOption.textContent = 'Retenue à la Source';
                savingsAmount.textContent = formatCurrency(Math.abs(difference));

                // Highlight withholding card
                document.getElementById('touWithholdingResult').classList.add('tou-best-option');
                document.getElementById('touTouResult').classList.remove('tou-best-option');
            }

            // Show warnings if applicable
            const warningsSection = document.getElementById('touWarningsSection');
            const alimonyWarning = document.getElementById('touAlimonyWarning');
            const quasiResidentWarning = document.getElementById('touQuasiResidentWarning');

            warningsSection.classList.remove('hidden');

            if (alimony > 0) {
                alimonyWarning.classList.remove('hidden');
            } else {
                alimonyWarning.classList.add('hidden');
            }

            if (isQuasiResident) {
                document.getElementById('touQuasiResidentAlert').classList.remove('hidden');
                quasiResidentWarning.classList.add('hidden');
            } else {
                document.getElementById('touQuasiResidentAlert').classList.add('hidden');
                quasiResidentWarning.classList.remove('hidden');
            }

            // Enable download button
            const downloadBtn = document.getElementById('touDownloadBtn');
            downloadBtn.disabled = false;
            downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Scroll to results
            document.getElementById('touResultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // TOU Simulator initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log(`🚀 [DEBUG] TOU Simulator initialization started - ICC System v1.0`);
            console.log(`🌐 [DEBUG] Current URL: ${window.location.href}`);
            console.log(`📁 [DEBUG] Protocol: ${window.location.protocol}`);
            console.log(`🕐 [DEBUG] Initialization time: ${new Date().toISOString()}`);

            // Get TOU simulator elements
            const touCalculateBtn = document.getElementById('touCalculateBtn');
            const touResetBtn = document.getElementById('touResetBtn');
            const touDownloadBtn = document.getElementById('touDownloadBtn');

            console.log(`🔍 [DEBUG] TOU elements found:`, {
                calculateBtn: !!touCalculateBtn,
                resetBtn: !!touResetBtn,
                downloadBtn: !!touDownloadBtn
            });

            if (!touCalculateBtn) {
                console.warn(`⚠️ [DEBUG] TOU calculate button not found - exiting initialization`);
                return; // Exit if TOU simulator not present
            }

            // Load tax brackets from JSON file (UI loading indicators removed for cleaner interface)

            // Load tax brackets from JSON file
            console.log(`📥 [DEBUG] Starting tax bracket loading process...`);

            // First, try the direct test function
            console.log(`🧪 [DEBUG] Trying direct JSON load test...`);
            let loadSuccess = await touTestDirectJSONLoad();

            if (!loadSuccess) {
                console.log(`🔄 [DEBUG] Direct test failed, trying main loading function...`);
                loadSuccess = await touLoadTaxBrackets();
            } else {
                console.log(`✅ [DEBUG] Direct test succeeded, skipping main loading function`);
            }
            console.log(`📊 [DEBUG] Tax bracket loading result: ${loadSuccess ? 'SUCCESS' : 'FAILED'}`);
            console.log(`📊 [DEBUG] Final touTaxBrackets length: ${touTaxBrackets.length}`);

            if (touTaxBrackets.length > 0) {
                console.log(`📋 [DEBUG] First bracket sample:`, touTaxBrackets[0]);
                console.log(`📋 [DEBUG] Last bracket sample:`, touTaxBrackets[touTaxBrackets.length - 1]);
            }

            // Load unified tax data from single source
            console.log(`📥 [UNIFIED DATA] Loading all tax data from single source...`);
            try {
                const dataLoadSuccess = await loadUnifiedTaxData();
                console.log(`📊 [UNIFIED DATA] Data loading result: ${dataLoadSuccess ? 'SUCCESS' : 'FAILED'}`);

                if (dataLoadSuccess) {
                    // Validate loaded data
                    const validation = validateUnifiedDataIntegrity();
                    console.log(`🔍 [UNIFIED DATA] Validation result: ${validation.valid ? 'VALID' : 'INVALID'}`);

                    if (validation.errors.length > 0) {
                        console.error('❌ [UNIFIED DATA] Validation errors:', validation.errors);
                    }
                    if (validation.warnings.length > 0) {
                        console.warn('⚠️ [UNIFIED DATA] Validation warnings:', validation.warnings);
                    }

                    console.log('=== UNIFIED TAX DATA LOADED ===');
                    console.log(`📊 ICC brackets: ${validation.details.iccTranches}`);
                    console.log(`🏛️ Municipal rates: ${validation.details.communes}`);
                    console.log(`📊 IFD brackets: ${validation.details.ifdBrackets?.single} single, ${validation.details.ifdBrackets?.couple} couple`);
                } else {
                    throw new Error('Failed to load unified tax data');
                }
            } catch (error) {
                console.error('❌ [UNIFIED DATA] Critical error loading tax data:', error.message);
                alert('Erreur critique: Impossible de charger les données fiscales. Veuillez actualiser la page.');
                return;
            }

            // Unified data validation
            console.log(`✅ [UNIFIED DATA] ICC tranches loaded: ${iccTaxBrackets?.length || 0} (expected: 18)`);
            console.log(`✅ [UNIFIED DATA] Communes loaded: ${Object.keys(municipalTaxRates || {}).length} (expected: 44)`);
            console.log(`✅ [UNIFIED DATA] IFD brackets loaded: ${ifdTaxBrackets ? 'YES' : 'NO'}`);

            if (ifdTaxBrackets) {
                console.log(`✅ [UNIFIED DATA] IFD single brackets: ${ifdTaxBrackets.Célibataires?.length || 0}`);
                console.log(`✅ [UNIFIED DATA] IFD married brackets: ${ifdTaxBrackets.Mariés?.length || 0}`);
            }

            // Test key parameters
            if (iccTaxBrackets && iccTaxBrackets.length === 18) {
                console.log(`✅ [UNIFIED DATA] ICC 18 tranches confirmed`);
            } else {
                console.warn(`⚠️ [UNIFIED DATA] ICC tranches mismatch: got ${iccTaxBrackets?.length}, expected 18`);
            }

            if (municipalTaxRates && Object.keys(municipalTaxRates).length >= 40) {
                console.log(`✅ [UNIFIED DATA] Municipal rates confirmed`);
                // Test a few key communes
                const testCommunes = ['GENEVE', 'CAROUGE', 'VANDOEUVRES'];
                testCommunes.forEach(commune => {
                    const rate = municipalTaxRates[commune];
                    console.log(`✅ [UNIFIED DATA] ${commune}: ${rate ? rate + '%' : 'NOT FOUND'}`);
                });
            } else {
                console.warn(`⚠️ [UNIFIED DATA] Communes count: ${Object.keys(municipalTaxRates || {}).length}, expected ~44`);
            }
            console.log('=== END VALIDATION ===');

            // Test ICC calculations if unified data loaded successfully
            if (dataLoadingStatus.loaded) {
                setTimeout(() => {
                    testIccCalculations();

                    // Manual test logging removed for cleaner console output

                    // Test Carouge specifically
                    console.log('🧪 [CAROUGE TEST] Testing Carouge municipal rate...');
                    console.log('📊 [CAROUGE TEST] Municipal data loaded:', Object.keys(municipalTaxRates || {}).length, 'communes');
                    if (municipalTaxRates && Object.keys(municipalTaxRates).length > 0) {
                        const carougeRate = municipalTaxRates['CAROUGE'];
                        console.log('📊 [CAROUGE TEST] Carouge rate found:', carougeRate);
                        if (carougeRate) {
                            console.log('📊 [CAROUGE TEST] Carouge rate from unified data:', carougeRate + '%');
                        } else {
                            console.warn('⚠️ [CAROUGE TEST] Carouge rate not found in unified data');
                        }

                        // Test the getMunicipalTaxRate function directly
                        const carougeFunctionRate = getMunicipalTaxRate('CAROUGE', 2024);
                        console.log('📊 [CAROUGE TEST] getMunicipalTaxRate result:', carougeFunctionRate);

                        // Test a full ICC calculation for Carouge
                        const carougeIccTest = calculateIccFinalTax(80000, 'celibataire', 'CAROUGE', 2024);
                        console.log('📊 [CAROUGE TEST] Full ICC calculation:', carougeIccTest);
                    }

                    // Add a global debug function for testing municipal rates
                    window.debugMunicipalRate = function(commune) {
                        console.log(`🔍 [DEBUG] Testing municipal rate for: ${commune}`);

                        const rate = getMunicipalTaxRate(commune, 2024);
                        console.log(`📊 [DEBUG] Result: ${rate}%`);

                        // Also test the full calculation
                        try {
                            const iccResult = calculateIccFinalTax(80000, 'celibataire', commune, 2024);
                            console.log(`📊 [DEBUG] Full ICC calculation:`, iccResult);
                            return { rate, iccResult };
                        } catch (error) {
                            console.error(`❌ [DEBUG] ICC calculation failed:`, error);
                            return { rate, iccResult: null };
                        }
                    };

                    // Add Chloé's base tax validation test
                    window.validateChloeBaseTax = function() {
                        console.log('🧪 [CHLOÉ TEST] Validating base tax calculation for Chloé...');
                        console.log('📋 [CHLOÉ TEST] Input: 50,000 CHF, célibataire status');

                        // Expected manual calculation (CORRECTED):
                        // 1. Income 50,000 CHF falls in bracket 47,869 – 76,811 CHF (15%)
                        // 2. Previous bracket cumulative tax: 3,486.60 CHF
                        // 3. Income above previous bracket: 50,000 - 47,868 = 2,132 CHF (previous bracket ends at 47,868)
                        // 4. Tax on excess: 2,132 × 15% = 319.80 CHF
                        // 5. Total base tax: 3,486.60 + 319.80 = 3,806.40 CHF

                        const expectedBaseTax = 3806.40;

                        try {
                            const baseTaxResult = calculateIccBaseTax(50000, 'celibataire');
                            const actualBaseTax = baseTaxResult.impotDeBase;
                            console.log(`📊 [CHLOÉ TEST] Expected base tax: ${expectedBaseTax.toFixed(2)} CHF`);
                            console.log(`📊 [CHLOÉ TEST] Actual base tax: ${actualBaseTax.toFixed(2)} CHF`);

                            const difference = Math.abs(actualBaseTax - expectedBaseTax);
                            const tolerance = 0.01; // 1 centime tolerance

                            if (difference <= tolerance) {
                                console.log(`✅ [CHLOÉ TEST] PASSED - Base tax calculation is correct!`);
                                console.log(`📈 [CHLOÉ TEST] Difference: ${difference.toFixed(2)} CHF (within tolerance)`);
                                return { passed: true, expected: expectedBaseTax, actual: actualBaseTax, difference };
                            } else {
                                console.error(`❌ [CHLOÉ TEST] FAILED - Base tax calculation is incorrect!`);
                                console.error(`📉 [CHLOÉ TEST] Difference: ${difference.toFixed(2)} CHF (exceeds tolerance)`);
                                return { passed: false, expected: expectedBaseTax, actual: actualBaseTax, difference };
                            }
                        } catch (error) {
                            console.error(`❌ [CHLOÉ TEST] ERROR - Base tax calculation failed:`, error);
                            return { passed: false, error: error.message };
                        }
                    };

                    // Detailed step-by-step validation of Chloé's calculation
                    window.validateChloeStepByStep = function() {
                        console.log('🔍 [CHLOÉ DETAILED] Step-by-step validation of base tax calculation...');

                        const income = 50000;
                        const status = 'celibataire';

                        console.log(`📋 [STEP 1] Input: ${income} CHF, ${status}`);

                        // Step 1: Reference income (same as input for célibataire)
                        const referenceIncome = income; // No splitting for single
                        console.log(`📋 [STEP 2] Reference income: ${referenceIncome} CHF (no splitting for célibataire)`);

                        // Step 2: Find the correct bracket
                        const brackets = iccTaxBrackets;
                        let currentBracket = null;
                        let previousBracket = null;

                        for (let i = 0; i < brackets.length; i++) {
                            const bracket = brackets[i];
                            if (bracket.revenu_max === "plus") {
                                if (referenceIncome >= bracket.revenu_min) {
                                    currentBracket = bracket;
                                    previousBracket = i > 0 ? brackets[i - 1] : null;
                                    break;
                                }
                            } else {
                                if (referenceIncome >= bracket.revenu_min && referenceIncome <= bracket.revenu_max) {
                                    currentBracket = bracket;
                                    previousBracket = i > 0 ? brackets[i - 1] : null;
                                    break;
                                }
                            }
                        }

                        console.log(`📋 [STEP 3] Found bracket: ${currentBracket.revenu_min} - ${currentBracket.revenu_max} CHF`);
                        console.log(`📋 [STEP 3] Bracket tax rate: ${currentBracket.taux_imposition_pourcentage}%`);

                        if (previousBracket) {
                            console.log(`📋 [STEP 4] Previous bracket: ${previousBracket.revenu_min} - ${previousBracket.revenu_max} CHF`);
                            console.log(`📋 [STEP 4] Cumulative tax from previous bracket: ${previousBracket.impot_total_cumul_chf} CHF`);

                            const incomeAbovePrevious = Math.max(0, referenceIncome - previousBracket.revenu_max);
                            console.log(`📋 [STEP 5] Income above previous bracket: ${referenceIncome} - ${previousBracket.revenu_max} = ${incomeAbovePrevious} CHF`);

                            const taxOnExcess = incomeAbovePrevious * (currentBracket.taux_imposition_pourcentage / 100);
                            console.log(`📋 [STEP 6] Tax on excess: ${incomeAbovePrevious} × ${currentBracket.taux_imposition_pourcentage}% = ${taxOnExcess.toFixed(2)} CHF`);

                            const totalBaseTax = previousBracket.impot_total_cumul_chf + taxOnExcess;
                            console.log(`📋 [STEP 7] Total base tax: ${previousBracket.impot_total_cumul_chf} + ${taxOnExcess.toFixed(2)} = ${totalBaseTax.toFixed(2)} CHF`);

                            // Expected calculation verification
                            console.log(`🔍 [VERIFICATION] Expected calculation:`);
                            console.log(`  - Previous cumulative: 3,486.60 CHF`);
                            console.log(`  - Income above 47,869: 50,000 - 47,869 = 2,131 CHF`);
                            console.log(`  - Tax on excess: 2,131 × 15% = 319.65 CHF`);
                            console.log(`  - Total: 3,486.60 + 319.65 = 3,806.25 CHF`);

                            return {
                                referenceIncome,
                                currentBracket,
                                previousBracket,
                                incomeAbovePrevious,
                                taxOnExcess,
                                totalBaseTax
                            };
                        }

                        return null;
                    };

                    // Add official Swiss tax splitting validation function
                    window.validateOfficialSplitting = function() {
                        console.log('🧪 [MANUAL] Testing official Swiss tax splitting example...');
                        console.log('📋 [MANUAL] Test case: Married couple with 95,736 CHF net taxable income');

                        try {
                            const result = calculateIccBaseTax(95736, 'marie_splitting');

                            console.log('📊 [MANUAL] Expected vs Actual:');
                            console.log(`  Reference income: Expected 47,868.00 CHF | Actual ${result.referenceIncome.toFixed(2)} CHF`);
                            console.log(`  Intermediate tax: Expected 3,486.60 CHF | Actual ${result.impotIntermediaire.toFixed(2)} CHF`);
                            console.log(`  Final base tax:  Expected 6,973.20 CHF | Actual ${result.impotDeBase.toFixed(2)} CHF`);

                            // Detailed breakdown for debugging
                            console.log('🔍 [MANUAL] Detailed calculation breakdown:');
                            console.log(`  Intermediate tax precise: ${result.impotIntermediaire} CHF`);
                            console.log(`  Final tax precise: ${result.impotDeBase} CHF`);
                            console.log(`  Expected intermediate × 2: ${3486.60 * 2} CHF`);
                            console.log(`  Actual intermediate × 2: ${result.impotIntermediaire * 2} CHF`);

                            // Check if values match
                            const referenceMatch = Math.abs(result.referenceIncome - 47868) < 0.01;
                            const intermediateMatch = Math.abs(result.impotIntermediaire - 3486.60) < 0.01;
                            const finalMatch = Math.abs(result.impotDeBase - 6973.20) < 0.01;

                            console.log('📊 [MANUAL] Validation:');
                            console.log(`  Reference income: ${referenceMatch ? '✅ CORRECT' : '❌ INCORRECT'}`);
                            console.log(`  Intermediate tax: ${intermediateMatch ? '✅ CORRECT' : '❌ INCORRECT'}`);
                            console.log(`  Final base tax: ${finalMatch ? '✅ CORRECT' : '❌ INCORRECT'}`);

                            if (referenceMatch && intermediateMatch && finalMatch) {
                                console.log('✅ [MANUAL] All calculations match official Swiss methodology!');
                            } else {
                                console.error('❌ [MANUAL] Discrepancies found - calculation needs correction');

                                // Show exact differences
                                if (!intermediateMatch) {
                                    const diff = result.impotIntermediaire - 3486.60;
                                    console.log(`  Intermediate tax difference: ${diff.toFixed(4)} CHF`);
                                }
                                if (!finalMatch) {
                                    const diff = result.impotDeBase - 6973.20;
                                    console.log(`  Final tax difference: ${diff.toFixed(4)} CHF`);
                                }
                            }

                            return result;
                        } catch (error) {
                            console.error('❌ [MANUAL] Test failed:', error);
                            return null;
                        }
                    };

                    // Add function to debug the exact tax bracket calculation for 47,868 CHF
                    window.debugTaxBracketCalculation = function() {
                        console.log('🔍 [DEBUG] Analyzing tax bracket calculation for 47,868 CHF...');

                        const income = 47868;
                        const brackets = iccTaxBrackets;

                        // Find the bracket containing 47,868 CHF
                        let currentBracket = null;
                        let previousBracket = null;

                        for (let i = 0; i < brackets.length; i++) {
                            const bracket = brackets[i];
                            if (bracket.revenu_max === "plus") {
                                if (income >= bracket.revenu_min) {
                                    currentBracket = bracket;
                                    previousBracket = i > 0 ? brackets[i - 1] : null;
                                    break;
                                }
                            } else {
                                if (income >= bracket.revenu_min && income <= bracket.revenu_max) {
                                    currentBracket = bracket;
                                    previousBracket = i > 0 ? brackets[i - 1] : null;
                                    break;
                                }
                            }
                        }

                        console.log(`📊 [DEBUG] Income: ${income} CHF`);
                        console.log(`📊 [DEBUG] Current bracket: ${currentBracket.revenu_min} - ${currentBracket.revenu_max}, rate: ${currentBracket.taux_imposition_pourcentage}%`);

                        if (previousBracket) {
                            console.log(`📊 [DEBUG] Previous bracket: ${previousBracket.revenu_min} - ${previousBracket.revenu_max}`);
                            console.log(`📊 [DEBUG] Previous cumulative tax: ${previousBracket.impot_total_cumul_chf} CHF`);

                            const incomeAbovePrevious = Math.max(0, income - previousBracket.revenu_max);
                            const taxOnExcess = incomeAbovePrevious * (currentBracket.taux_imposition_pourcentage / 100);
                            const totalTax = previousBracket.impot_total_cumul_chf + taxOnExcess;

                            console.log(`📊 [DEBUG] Income above previous bracket: ${income} - ${previousBracket.revenu_max} = ${incomeAbovePrevious} CHF`);
                            console.log(`📊 [DEBUG] Tax on excess: ${incomeAbovePrevious} × ${currentBracket.taux_imposition_pourcentage}% = ${taxOnExcess} CHF`);
                            console.log(`📊 [DEBUG] Total tax: ${previousBracket.impot_total_cumul_chf} + ${taxOnExcess} = ${totalTax} CHF`);
                            console.log(`📊 [DEBUG] Expected: 3,486.60 CHF`);
                            console.log(`📊 [DEBUG] Difference: ${(totalTax - 3486.60).toFixed(4)} CHF`);

                            return {
                                income,
                                currentBracket,
                                previousBracket,
                                incomeAbovePrevious,
                                taxOnExcess,
                                totalTax,
                                expected: 3486.60,
                                difference: totalTax - 3486.60
                            };
                        }

                        return null;
                    };

                    // Add IFD calculation validation function
                    window.validateIfdCalculation = function(income = 70000, status = 'celibataire') {
                        console.log('🏛️ [IFD MANUAL] Testing IFD calculation...');
                        console.log(`📋 [IFD MANUAL] Test case: ${status} with ${income.toLocaleString()} CHF income`);

                        try {
                            const result = calculateIfdTax(income, status);

                            console.log('📊 [IFD MANUAL] Calculation results:');
                            console.log(`  Total IFD tax: ${result.impotTotal.toFixed(2)} CHF`);
                            console.log(`  Effective rate: ${result.tauxEffectif.toFixed(2)}%`);
                            console.log(`  Fiscal status: ${result.statutFiscal}`);

                            console.log('📊 [IFD MANUAL] Detailed breakdown:');
                            result.details.forEach((detail, index) => {
                                console.log(`  ${index + 1}. Bracket ${detail.tranche}:`);
                                console.log(`     Amount taxed: ${detail.montantImpose.toLocaleString()} CHF`);
                                console.log(`     Rate: ${detail.taux}%`);
                                console.log(`     Tax: ${detail.impot.toFixed(2)} CHF`);
                                console.log(`     Type: ${detail.type === 'complete' ? 'Complete bracket' : 'Partial bracket'}`);
                            });

                            // For the official example (70,000 CHF célibataire)
                            if (income === 70000 && status === 'celibataire') {
                                const expectedTax = 983.65;
                                const difference = Math.abs(result.impotTotal - expectedTax);
                                console.log('📊 [IFD MANUAL] Official example validation:');
                                console.log(`  Expected: ${expectedTax} CHF`);
                                console.log(`  Actual: ${result.impotTotal.toFixed(2)} CHF`);
                                console.log(`  Difference: ${difference.toFixed(2)} CHF`);
                                console.log(`  Status: ${difference <= 1.0 ? '✅ PASSED' : '❌ FAILED'}`);
                            }

                            return result;
                        } catch (error) {
                            console.error('❌ [IFD MANUAL] Test failed:', error);
                            return null;
                        }
                    };

                    // Add official partial splitting validation function
                    window.validatePartialSplitting = function() {
                        console.log('🧪 [PARTIAL] Testing official Swiss partial splitting example...');
                        console.log('📋 [PARTIAL] Test case: Single taxpayer with 86,156 CHF net taxable income');

                        try {
                            const result = calculateIccBaseTax(86156, 'splitting_partiel');

                            console.log('📊 [PARTIAL] Expected calculation steps:');
                            console.log('  1. Reference income: 86,156 × 55.56% = 47,868 CHF');
                            console.log('  2. Tax on reference income: 3,486.60 CHF');
                            console.log('  3. Final base tax: 86,156 × 3,486.60 ÷ 47,868 = 6,275.40 CHF');

                            console.log('📊 [PARTIAL] Actual calculation results:');
                            console.log(`  1. Reference income: ${result.referenceIncome.toFixed(2)} CHF`);
                            console.log(`  2. Intermediate tax: ${result.impotIntermediaire.toFixed(2)} CHF`);
                            console.log(`  3. Final base tax: ${result.impotDeBase.toFixed(2)} CHF`);

                            // Calculate expected values
                            const expectedReferenceIncome = 86156 / 1.8; // Should be exactly 47868
                            const expectedIntermediateTax = 3486.60;
                            const expectedFinalTax = (86156 * expectedIntermediateTax) / expectedReferenceIncome;

                            console.log('📊 [PARTIAL] Expected vs Actual:');
                            console.log(`  Reference income: Expected ${expectedReferenceIncome.toFixed(2)} | Actual ${result.referenceIncome.toFixed(2)}`);
                            console.log(`  Intermediate tax: Expected ${expectedIntermediateTax.toFixed(2)} | Actual ${result.impotIntermediaire.toFixed(2)}`);
                            console.log(`  Final base tax:  Expected ${expectedFinalTax.toFixed(2)} | Actual ${result.impotDeBase.toFixed(2)}`);

                            // Validate calculations
                            const referenceMatch = Math.abs(result.referenceIncome - expectedReferenceIncome) < 0.01;
                            const intermediateMatch = Math.abs(result.impotIntermediaire - expectedIntermediateTax) < 0.01;
                            const finalMatch = Math.abs(result.impotDeBase - expectedFinalTax) < 0.01;

                            console.log('📊 [PARTIAL] Validation:');
                            console.log(`  Reference income: ${referenceMatch ? '✅ CORRECT' : '❌ INCORRECT'}`);
                            console.log(`  Intermediate tax: ${intermediateMatch ? '✅ CORRECT' : '❌ INCORRECT'}`);
                            console.log(`  Final base tax: ${finalMatch ? '✅ CORRECT' : '❌ INCORRECT'}`);

                            if (referenceMatch && intermediateMatch && finalMatch) {
                                console.log('✅ [PARTIAL] All calculations match official Swiss partial splitting methodology!');
                            } else {
                                console.error('❌ [PARTIAL] Discrepancies found - partial splitting calculation needs correction');

                                // Show exact differences and debugging info
                                if (!finalMatch) {
                                    const diff = result.impotDeBase - expectedFinalTax;
                                    console.log(`  Final tax difference: ${diff.toFixed(4)} CHF`);
                                    console.log(`  Current method (× 1.8): ${(result.impotIntermediaire * 1.8).toFixed(2)} CHF`);
                                    console.log(`  Correct method (proportional): ${expectedFinalTax.toFixed(2)} CHF`);
                                    console.log(`  Formula should be: ${result.revenuImposable} × ${result.impotIntermediaire} ÷ ${result.referenceIncome}`);
                                }
                            }

                            return result;
                        } catch (error) {
                            console.error('❌ [PARTIAL] Test failed:', error);
                            return null;
                        }
                    };

                    // Automatic test for Carouge after data loads
                    setTimeout(() => {
                        console.log('🚀 [AUTO TEST] Running automatic Carouge test...');
                        // Test will now work with embedded data even if JSON fails to load
                        const carougeTest = debugMunicipalRate('CAROUGE');
                        if (carougeTest && carougeTest.rate === 40) {
                            console.log('✅ [AUTO TEST] CAROUGE test PASSED - Rate is 40%');
                        } else {
                            console.error('❌ [AUTO TEST] CAROUGE test FAILED - Expected 40%, got:', carougeTest?.rate);
                        }

                        // Also run Chloé's base tax validation test
                        console.log('🚀 [AUTO TEST] Running Chloé base tax validation...');
                        const chloeTest = validateChloeBaseTax();
                        if (chloeTest.passed) {
                            console.log('✅ [AUTO TEST] Chloé base tax test PASSED');
                        } else {
                            console.error('❌ [AUTO TEST] Chloé base tax test FAILED');
                        }
                    }, 2000);
                    // Sample calculation result logging removed for cleaner console output

                    // Test ICC Details in Card button removed as requested

                    // Debug ICC Data button removed from UI

                    // Test Commune Rates button removed from UI
                }, 1000); // Delay to ensure data is fully loaded
            }

            // Loading status messages removed for cleaner UI (console logging preserved)

            // Only proceed with initialization if tax data loaded successfully
            if (loadSuccess) {
                console.log('✅ TOU Simulator: Using comprehensive tax brackets from JSON file');

                // Comprehensive test suite for tax rate accuracy
                console.log('=== TAX RATE VALIDATION TESTS ===');

                // Test 1: Single person with 80,000 CHF (should be 12.79% based on bracket "79'800 - 80'399")
                const test1 = touGetWithholdingTaxRate(80000, 'single', 0, true);
                console.log(`Test 1 - Single 80k: Expected 12.79%, Got ${formatTaxRate(test1.rate)}`, test1.rate === 12.79 ? '✓ PASS' : '✗ FAIL');

                // Test 2: Married no spouse income, 0 children, 80,000 CHF (should be 3.79%)
                const test2 = touGetWithholdingTaxRate(80000, 'married-no-income', 0, false);
                console.log(`Test 2 - Married B0 80k: Expected 3.79%, Got ${formatTaxRate(test2.rate)}`, test2.rate === 3.79 ? '✓ PASS' : '✗ FAIL');

                // Test 3: Married no spouse income, 1 child, 80,000 CHF (should be 0.40%)
                const test3 = touGetWithholdingTaxRate(80000, 'married-no-income', 1, false);
                console.log(`Test 3 - Married B1 80k: Expected 0.40%, Got ${formatTaxRate(test3.rate)}`, test3.rate === 0.40 ? '✓ PASS' : '✗ FAIL');

                // Test 4: Married both working, 0 children, 80,000 CHF (should be 12.14%)
                const test4 = touGetWithholdingTaxRate(80000, 'married-with-income', 0, false);
                console.log(`Test 4 - Married C0 80k: Expected 12.14%, Got ${formatTaxRate(test4.rate)}`, test4.rate === 12.14 ? '✓ PASS' : '✗ FAIL');

                // Test 5: Married both working, 1 child, 80,000 CHF (should be 9.15%)
                const test5 = touGetWithholdingTaxRate(80000, 'married-with-income', 1, false);
                console.log(`Test 5 - Married C1 80k: Expected 9.15%, Got ${formatTaxRate(test5.rate)}`, test5.rate === 9.15 ? '✓ PASS' : '✗ FAIL');

                // Test 6: Single parent, 1 child, 80,000 CHF (should be 1.57%)
                const test6 = touGetWithholdingTaxRate(80000, 'divorced-with-children', 1, false);
                console.log(`Test 6 - Single parent H1 80k: Expected 1.57%, Got ${formatTaxRate(test6.rate)}`, test6.rate === 1.57 ? '✓ PASS' : '✗ FAIL');

                // Test 7: Lower income bracket - Single person with 30,000 CHF
                const test7 = touGetWithholdingTaxRate(30000, 'single', 0, false);
                console.log(`Test 7 - Single 30k: Got ${formatTaxRate(test7.rate)} (bracket: ${test7.bracket})`);

                // Test 8: Very low income bracket - Single person with 20,000 CHF (should be 0.0%)
                const test8 = touGetWithholdingTaxRate(20000, 'single', 0, false);
                console.log(`Test 8 - Single 20k: Expected 0.00%, Got ${formatTaxRate(test8.rate)}`, test8.rate === 0.0 ? '✓ PASS' : '✗ FAIL');

                // Test 9: Zero tax rate for married with children - 20,000 CHF (should be 0.0%)
                const test9 = touGetWithholdingTaxRate(20000, 'married-no-income', 2, false);
                console.log(`Test 9 - Married B2 20k: Expected 0.00%, Got ${formatTaxRate(test9.rate)}`, test9.rate === 0.0 ? '✓ PASS' : '✗ FAIL');

                // Test 10: Edge case - Whole number rate (should display as X.00%)
                const test10 = touGetWithholdingTaxRate(120000, 'single', 0, false);
                console.log(`Test 10 - Single 120k: Got ${formatTaxRate(test10.rate)} (should show 2 decimals)`);

                // Test 11: Edge case - Very small rate (should display as 0.XX%)
                const test11 = touGetWithholdingTaxRate(29000, 'married-no-income', 3, false);
                console.log(`Test 11 - Married B3 29k: Got ${formatTaxRate(test11.rate)} (should show 2 decimals)`);

                console.log('=== END VALIDATION TESTS ===');

                // Initialize simulator functionality only if data loaded successfully
                touInitializeSimulatorFunctionality();
            } else {
                console.error('❌ TOU Simulator: Cannot initialize without official tax data');
                // Error handling is already done in touLoadTaxBrackets() and touShowDataLoadingError()
                return; // Exit initialization - simulator will show error message
            }
        });

        // Function to initialize TOU simulator functionality (only called when data loads successfully)
        function touInitializeSimulatorFunctionality() {
            const touCalculateBtn = document.getElementById('touCalculateBtn');
            const touResetBtn = document.getElementById('touResetBtn');
            const touDownloadBtn = document.getElementById('touDownloadBtn');

            // Initialize multi-step form
            touUpdateStepDisplay();

            // Initialize enhanced dropdown effects
            touInitializeDropdownEffects();

            // Add event listeners to TOU currency fields for real-time conversion updates
            document.querySelectorAll('#tou-simulator-container .tou-currency-container input').forEach(input => {
                input.addEventListener('input', function() {
                    touUpdateCurrencyConversion(this);
                });
            });

            // Set default values for TOU simulator
            if (document.getElementById('touAnnualIncome')) {
                document.getElementById('touAnnualIncome').value = '80000';
                document.getElementById('touCommune').value = 'GENEVE';
                document.getElementById('touFamilyStatus').value = 'single';

                // Trigger validation for the commune field to update help text and styling
                const communeField = document.getElementById('touCommune');
                if (communeField && typeof touValidateDropdown === 'function') {
                    touValidateDropdown(communeField);
                }

                // Initialize some sample actual expenses for demo purposes
                const deductionOption = document.getElementById('touDeductionOption');
                if (deductionOption) {
                    deductionOption.value = 'reel';
                    // Trigger the change event to show the accordion
                    deductionOption.dispatchEvent(new Event('change'));

                    // Set some sample values after a brief delay to ensure accordion is initialized
                    setTimeout(() => {
                        // Professional expenses
                        const commutingEnabled = document.getElementById('touCommutingEnabled');
                        const commutingAmount = document.getElementById('touCommutingAmount');
                        if (commutingEnabled && commutingAmount) {
                            commutingEnabled.checked = true;
                            commutingAmount.disabled = false;
                            commutingAmount.value = '2000';
                        }

                        // Health insurance
                        const healthEnabled = document.getElementById('touHealthInsuranceEnabled');
                        const healthAmount = document.getElementById('touHealthInsuranceAmount');
                        if (healthEnabled && healthAmount) {
                            healthEnabled.checked = true;
                            healthAmount.disabled = false;
                            healthAmount.value = '3000';
                        }

                        // Update summaries
                        if (typeof touUpdateFraisSummaries === 'function') {
                            touUpdateFraisSummaries();
                        }
                    }, 200);
                }
            }

            // TOU Event listeners
            if (touCalculateBtn) {
                touCalculateBtn.addEventListener('click', function() {
                    // Validate step 3 before calculating
                    if (touValidateStep(3)) {
                        // Show loading state in step 4
                        const step4Content = document.querySelector('#touStep4 .tou-form-group > div');
                        if (step4Content) {
                            step4Content.innerHTML = `
                                <div class="text-center py-8">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                        <h4 class="text-lg font-medium text-blue-800 mb-2">Calcul en cours...</h4>
                                        <p class="text-blue-600">Traitement de vos données fiscales</p>
                                    </div>
                                </div>
                            `;
                        }

                        // Move to results step
                        touCurrentStep = 4;
                        touUpdateStepDisplay();

                        // Calculate taxes with a small delay for better UX
                        setTimeout(() => {
                            console.log('🚀 [TOU] About to trigger tax calculation...');

                            // Debug form values before calculation
                            const debugInfo = {
                                commune: document.getElementById('touCommune')?.value,
                                familyStatus: document.getElementById('touFamilyStatus')?.value,
                                annualIncome: document.getElementById('touAnnualIncome')?.value,
                                annualIncomeElement: document.getElementById('touAnnualIncome') ? 'Found' : 'NOT FOUND'
                            };
                            console.log('🔍 [TOU] Pre-calculation debug:', debugInfo);

                            touCalculateTaxes();

                            // Update step 4 with results
                            if (step4Content) {
                                step4Content.innerHTML = `
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                                        <div class="flex flex-col items-center"> <!-- Modification ici -->
                                            <div class="flex items-center mb-2"> <!-- Conteneur icône + texte -->
                                                <i class="fas fa-check-circle text-green-600 text-xl mr-3"></i>
                                                <h4 class="text-lg font-medium text-green-800">Calcul terminé avec succès</h4>
                                            </div>
                                            <p class="text-green-600 text-center w-full">Consultez vos résultats détaillés ci-dessous</p>
                                        </div>
                                    </div>
                                `;
                            }
                        }, 800);
                    }
                });
            }

            if (touResetBtn) {
                touResetBtn.addEventListener('click', function() {
                    // Reset TOU form inputs
                    document.getElementById('touTaxForm').reset();

                    // Reset to step 1
                    touCurrentStep = 1;
                    touUpdateStepDisplay();

                    // Hide conditional fields
                    document.getElementById('touChildrenContainer').classList.add('hidden');
                    document.getElementById('touSpouseIncomeContainer').classList.add('hidden');
                    document.getElementById('touRealDeductionsContainer').classList.add('hidden');
                    // Hide results panel
                    document.getElementById('touResultsSection').classList.add('hidden');
                    // Reset deduction option
                    document.getElementById('touDeductionOption').value = 'forfaitaire';
                    // Reset frais réels accordion
                    if (typeof touResetFraisReelsAccordion === 'function') {
                        touResetFraisReelsAccordion();
                    }
                    // Reset download button
                    if (touDownloadBtn) {
                        touDownloadBtn.disabled = true;
                        touDownloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    // Reset result styling
                    document.getElementById('touTouResult').classList.remove('tou-best-option');
                    document.getElementById('touWithholdingResult').classList.remove('tou-best-option');

                    // Reset currency fields to CHF
                    document.querySelectorAll('#tou-simulator-container .tou-currency-container').forEach(container => {
                        container.dataset.currency = 'CHF';
                        const toggleBtn = container.querySelector('.tou-currency-toggle');
                        if (toggleBtn) toggleBtn.textContent = 'CHF/EUR';
                        const conversionDisplay = container.querySelector('.tou-conversion-display');
                        if (conversionDisplay) conversionDisplay.classList.add('hidden');
                    });

                    // Reset default values
                    setTimeout(() => {
                        if (document.getElementById('touAnnualIncome')) {
                            document.getElementById('touAnnualIncome').value = '80000';
                            document.getElementById('touCommune').value = 'GENEVE';
                            document.getElementById('touFamilyStatus').value = 'single';

                            // Trigger validation for the commune field
                            const communeField = document.getElementById('touCommune');
                            if (communeField && typeof touValidateDropdown === 'function') {
                                touValidateDropdown(communeField);
                            }

                            // Reset to forfaitaire deductions (no need to set the removed fields)
                            const deductionOption = document.getElementById('touDeductionOption');
                            if (deductionOption) {
                                deductionOption.value = 'forfaitaire';
                            }
                        }
                    }, 100);
                });
            }

            if (touDownloadBtn) {
                touDownloadBtn.addEventListener('click', function() {
                    alert('Fonctionnalité de téléchargement à implémenter');
                });
            }

            console.log('✓ TOU Simulator functionality initialized successfully');

            // Ensure frais réels accordion is in clean state on page load
            setTimeout(() => {
                if (typeof touResetFraisReelsAccordion === 'function') {
                    touResetFraisReelsAccordion();
                }
            }, 100);

            // Run automatic validation tests after initialization
            setTimeout(() => {
                console.log('🚀 [AUTO TEST] Starting automatic validation tests...');

                // Test 1: Carouge municipal rate
                console.log('🧪 [AUTO TEST] Testing Carouge municipal rate...');
                try {
                    const carougeRate = getMunicipalTaxRate('CAROUGE', 2024);
                    console.log(`📊 [AUTO TEST] Carouge municipal rate: ${carougeRate}%`);
                    if (carougeRate === 40) {
                        console.log('✅ [AUTO TEST] Carouge test PASSED - Rate is 40%');
                    } else {
                        console.error(`❌ [AUTO TEST] Carouge test FAILED - Expected 40%, got: ${carougeRate}%`);
                    }
                } catch (error) {
                    console.error('❌ [AUTO TEST] Carouge test ERROR:', error);
                }

                // Test 2: Chloé's base tax calculation
                console.log('🧪 [AUTO TEST] Testing Chloé base tax calculation...');
                try {
                    const baseTaxResult = calculateIccBaseTax(50000, 'celibataire');
                    const actualBaseTax = baseTaxResult.impotDeBase;
                    const expectedBaseTax = 3806.40; // Corrected value
                    console.log(`📊 [AUTO TEST] Expected base tax: ${expectedBaseTax} CHF`);
                    console.log(`📊 [AUTO TEST] Actual base tax: ${actualBaseTax.toFixed(2)} CHF`);

                    const difference = Math.abs(actualBaseTax - expectedBaseTax);
                    if (difference <= 0.01) {
                        console.log('✅ [AUTO TEST] Chloé base tax test PASSED');
                    } else {
                        console.error(`❌ [AUTO TEST] Chloé base tax test FAILED - Difference: ${difference.toFixed(2)} CHF`);
                    }
                } catch (error) {
                    console.error('❌ [AUTO TEST] Chloé base tax test ERROR:', error);
                }

                // Test 3: Swiss tax splitting methodology validation
                console.log('🧪 [AUTO TEST] Testing Swiss tax splitting methodology...');
                try {
                    // Test Full Splitting (marie_splitting)
                    const fullSplittingResult = calculateIccBaseTax(80000, 'marie_splitting');
                    console.log(`📊 [AUTO TEST] Full splitting test:`);
                    console.log(`  Original income: 80,000 CHF`);
                    console.log(`  Reference income: ${fullSplittingResult.referenceIncome.toFixed(2)} CHF (should be 40,000)`);
                    console.log(`  Splitting factor: ${(fullSplittingResult.splittingFactor * 100).toFixed(1)}% (should be 50.0%)`);
                    console.log(`  Multiplier: ${fullSplittingResult.splittingMultiplier} (should be 2.0)`);
                    console.log(`  Final base tax: ${fullSplittingResult.impotDeBase.toFixed(2)} CHF`);

                    // Test Partial Splitting (splitting_partiel)
                    const partialSplittingResult = calculateIccBaseTax(80000, 'splitting_partiel');
                    console.log(`📊 [AUTO TEST] Partial splitting test:`);
                    console.log(`  Original income: 80,000 CHF`);
                    console.log(`  Reference income: ${partialSplittingResult.referenceIncome.toFixed(2)} CHF (should be 44,448)`);
                    console.log(`  Splitting factor: ${(partialSplittingResult.splittingFactor * 100).toFixed(2)}% (should be 55.56%)`);
                    console.log(`  Multiplier: ${partialSplittingResult.splittingMultiplier} (should be 1.8)`);
                    console.log(`  Final base tax: ${partialSplittingResult.impotDeBase.toFixed(2)} CHF`);

                    // Validate calculations
                    const fullSplittingValid = Math.abs(fullSplittingResult.referenceIncome - 40000) < 1 &&
                                             fullSplittingResult.splittingMultiplier === 2.0;
                    const partialSplittingValid = Math.abs(partialSplittingResult.referenceIncome - 44448) < 1 &&
                                                partialSplittingResult.splittingMultiplier === 1.8;

                    if (fullSplittingValid && partialSplittingValid) {
                        console.log('✅ [AUTO TEST] Swiss tax splitting methodology test PASSED');
                    } else {
                        console.error('❌ [AUTO TEST] Swiss tax splitting methodology test FAILED');
                    }
                } catch (error) {
                    console.error('❌ [AUTO TEST] Swiss tax splitting test ERROR:', error);
                }

                // Test 4: Official Swiss tax splitting validation with specific example
                console.log('🧪 [AUTO TEST] Testing official Swiss tax splitting example...');
                try {
                    console.log('📋 [OFFICIAL TEST] Married couple with 95,736 CHF net taxable income');
                    const officialTest = calculateIccBaseTax(95736, 'marie_splitting');

                    console.log('📊 [OFFICIAL TEST] Expected calculation steps:');
                    console.log('  1. Reference income: 95,736 ÷ 2 = 47,868 CHF');
                    console.log('  2. Tax on reference income: 3,486.60 CHF');
                    console.log('  3. Final base tax: 3,486.60 × 2 = 6,973.20 CHF');

                    console.log('📊 [OFFICIAL TEST] Actual calculation results:');
                    console.log(`  1. Reference income: ${officialTest.referenceIncome.toFixed(2)} CHF`);
                    console.log(`  2. Intermediate tax: ${officialTest.impotIntermediaire.toFixed(2)} CHF`);
                    console.log(`  3. Final base tax: ${officialTest.impotDeBase.toFixed(2)} CHF`);

                    // Validate against expected values
                    const referenceIncomeCorrect = Math.abs(officialTest.referenceIncome - 47868) < 0.01;
                    const intermediateTaxCorrect = Math.abs(officialTest.impotIntermediaire - 3486.60) < 0.01;
                    const finalTaxCorrect = Math.abs(officialTest.impotDeBase - 6973.20) < 0.01;

                    console.log('📊 [OFFICIAL TEST] Validation results:');
                    console.log(`  Reference income match: ${referenceIncomeCorrect ? '✅' : '❌'} (${officialTest.referenceIncome.toFixed(2)} vs 47,868.00)`);
                    console.log(`  Intermediate tax match: ${intermediateTaxCorrect ? '✅' : '❌'} (${officialTest.impotIntermediaire.toFixed(2)} vs 3,486.60)`);
                    console.log(`  Final tax match: ${finalTaxCorrect ? '✅' : '❌'} (${officialTest.impotDeBase.toFixed(2)} vs 6,973.20)`);

                    if (referenceIncomeCorrect && intermediateTaxCorrect && finalTaxCorrect) {
                        console.log('✅ [OFFICIAL TEST] Swiss tax splitting calculation PASSED - matches official methodology');
                    } else {
                        console.error('❌ [OFFICIAL TEST] Swiss tax splitting calculation FAILED - discrepancies found');

                        // Additional debugging
                        if (!referenceIncomeCorrect) {
                            console.error(`  ❌ Reference income error: Expected 47,868.00, got ${officialTest.referenceIncome.toFixed(2)}`);
                        }
                        if (!intermediateTaxCorrect) {
                            console.error(`  ❌ Intermediate tax error: Expected 3,486.60, got ${officialTest.impotIntermediaire.toFixed(2)}`);
                        }
                        if (!finalTaxCorrect) {
                            console.error(`  ❌ Final tax error: Expected 6,973.20, got ${officialTest.impotDeBase.toFixed(2)}`);
                        }
                    }
                } catch (error) {
                    console.error('❌ [OFFICIAL TEST] Swiss tax splitting test ERROR:', error);
                }

                // Test 5: Official partial splitting validation
                console.log('🧪 [AUTO TEST] Testing official Swiss partial splitting example...');
                try {
                    console.log('📋 [PARTIAL AUTO] Single taxpayer with 86,156 CHF net taxable income');
                    const partialTest = calculateIccBaseTax(86156, 'splitting_partiel');

                    const expectedReferenceIncome = 86156 / 1.8; // Should be exactly 47868
                    const expectedIntermediateTax = 3486.60;
                    const expectedFinalTax = (86156 * expectedIntermediateTax) / expectedReferenceIncome;

                    console.log('📊 [PARTIAL AUTO] Expected vs Actual:');
                    console.log(`  Reference income: Expected ${expectedReferenceIncome.toFixed(2)} | Actual ${partialTest.referenceIncome.toFixed(2)}`);
                    console.log(`  Intermediate tax: Expected ${expectedIntermediateTax.toFixed(2)} | Actual ${partialTest.impotIntermediaire.toFixed(2)}`);
                    console.log(`  Final base tax:  Expected ${expectedFinalTax.toFixed(2)} | Actual ${partialTest.impotDeBase.toFixed(2)}`);

                    const referenceMatch = Math.abs(partialTest.referenceIncome - expectedReferenceIncome) < 0.01;
                    const intermediateMatch = Math.abs(partialTest.impotIntermediaire - expectedIntermediateTax) < 0.01;
                    const finalMatch = Math.abs(partialTest.impotDeBase - expectedFinalTax) < 0.01;

                    if (referenceMatch && intermediateMatch && finalMatch) {
                        console.log('✅ [PARTIAL AUTO] Swiss partial splitting calculation PASSED - matches official methodology');
                    } else {
                        console.error('❌ [PARTIAL AUTO] Swiss partial splitting calculation FAILED - discrepancies found');
                        if (!finalMatch) {
                            console.error(`  ❌ Final tax error: Expected ${expectedFinalTax.toFixed(2)}, got ${partialTest.impotDeBase.toFixed(2)}`);
                            console.error(`  ❌ Old method (× 1.8): ${(partialTest.impotIntermediaire * 1.8).toFixed(2)} CHF`);
                            console.error(`  ✅ Correct method (proportional): ${expectedFinalTax.toFixed(2)} CHF`);
                        }
                    }
                } catch (error) {
                    console.error('❌ [PARTIAL AUTO] Swiss partial splitting test ERROR:', error);
                }

                // Test 6: IFD calculation validation with official example
                console.log('🧪 [AUTO TEST] Testing IFD calculation with official example...');
                try {
                    console.log('📋 [IFD TEST] Célibataire with 70,000 CHF income');
                    const ifdTestResult = calculateIfdTax(70000, 'celibataire');

                    const expectedIfdTax = 983.65; // Official expected result
                    const actualIfdTax = ifdTestResult.impotTotal;
                    const difference = Math.abs(actualIfdTax - expectedIfdTax);
                    const tolerance = 1.0; // 1 CHF tolerance for rounding differences

                    console.log('📊 [IFD TEST] Expected vs Actual:');
                    console.log(`  Expected IFD tax: ${expectedIfdTax.toFixed(2)} CHF`);
                    console.log(`  Actual IFD tax: ${actualIfdTax.toFixed(2)} CHF`);
                    console.log(`  Difference: ${difference.toFixed(2)} CHF`);
                    console.log(`  Effective rate: ${ifdTestResult.tauxEffectif.toFixed(2)}%`);

                    // Show calculation details
                    console.log('📊 [IFD TEST] Calculation breakdown:');
                    ifdTestResult.details.forEach((detail, index) => {
                        console.log(`  Bracket ${index + 1}: ${detail.tranche} - ${detail.montantImpose} CHF × ${detail.taux}% = ${detail.impot.toFixed(2)} CHF (${detail.type})`);
                    });

                    if (difference <= tolerance) {
                        console.log('✅ [IFD TEST] IFD calculation PASSED - matches official methodology');
                    } else {
                        console.error('❌ [IFD TEST] IFD calculation FAILED - significant difference from expected result');
                    }
                } catch (error) {
                    console.error('❌ [IFD TEST] IFD calculation test ERROR:', error);
                }

                // Test 7: Social contribution rates validation
                console.log('🧪 [AUTO TEST] Testing social contribution rates...');
                try {
                    testSocialContributionRates();
                } catch (error) {
                    console.error('❌ [SOCIAL TEST] Social contribution rates test ERROR:', error);
                }

                // Test 8: IFD rate conversion fix validation
                console.log('🧪 [AUTO TEST] Testing IFD rate conversion fix...');
                try {
                    const ifdRateTestPassed = testIfdRateConversionFix();
                    if (ifdRateTestPassed) {
                        console.log('✅ [AUTO TEST] IFD rate conversion test PASSED');
                    } else {
                        console.error('❌ [AUTO TEST] IFD rate conversion test FAILED');
                    }
                } catch (error) {
                    console.error('❌ [AUTO TEST] IFD rate conversion test ERROR:', error);
                }

                // Test 9: ICC 12% reduction calculation validation
                console.log('🧪 [AUTO TEST] Testing ICC 12% reduction calculation...');
                try {
                    const iccReductionTestPassed = testIcc12PercentReduction();
                    if (iccReductionTestPassed) {
                        console.log('✅ [AUTO TEST] ICC 12% reduction test PASSED');
                    } else {
                        console.error('❌ [AUTO TEST] ICC 12% reduction test FAILED');
                    }
                } catch (error) {
                    console.error('❌ [AUTO TEST] ICC 12% reduction test ERROR:', error);
                }

                console.log('🏁 [AUTO TEST] Automatic validation tests completed');
            }, 1000);


        }

        // Function to manually load embedded data (called from error message button)
        async function touLoadEmbeddedDataManually() {
            console.log('🔄 Manually loading embedded tax brackets data...');

            // Remove existing error message
            const errorDiv = document.getElementById('touDataLoadingError');
            if (errorDiv) {
                errorDiv.remove();
            }

            // Attempt to load embedded data (loading indicator removed for cleaner UI)
            const success = await touLoadEmbeddedTaxBrackets();

            if (success) {
                console.log('✓ Embedded tax data successfully loaded');

                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4 text-yellow-700 text-sm';
                successDiv.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h4 class="font-medium">Données intégrées chargées</h4>
                        <p class="mt-1">Le simulateur utilise maintenant un sous-ensemble des barèmes fiscaux intégrés. Pour des calculs plus précis, utilisez un serveur web local.</p>
                    </div>
                </div>
                `;

                if (touSimulatorContainer) {
                    touSimulatorContainer.insertBefore(successDiv, touSimulatorContainer.firstChild);
                    setTimeout(() => {
                        if (successDiv && successDiv.parentNode) {
                            successDiv.parentNode.removeChild(successDiv);
                        }
                    }, 5000);
                }

                // Initialize simulator functionality
                touInitializeSimulatorFunctionality();

                // Run validation tests
                console.log('=== TAX RATE VALIDATION TESTS (EMBEDDED DATA) ===');
                console.log(`Loaded ${touTaxBrackets.length} tax brackets from embedded data`);

                const test1 = touGetWithholdingTaxRate(80000, 'single', 0, true);
                console.log(`Test 1 - Single 80k: Expected 12.79%, Got ${formatTaxRate(test1.rate)}`, test1.rate === 12.79 ? '✓ PASS' : '✗ FAIL');

                const test2 = touGetWithholdingTaxRate(80000, 'married-no-income', 0, false);
                console.log(`Test 2 - Married B0 80k: Expected 3.79%, Got ${formatTaxRate(test2.rate)}`, test2.rate === 3.79 ? '✓ PASS' : '✗ FAIL');

                const test3 = touGetWithholdingTaxRate(50000, 'single', 0, false);
                console.log(`Test 3 - Single 50k: Expected 5.80%, Got ${formatTaxRate(test3.rate)}`, test3.rate === 5.8 ? '✓ PASS' : '✗ FAIL');

                // Test 4: Zero tax rate - Low income single person (should be 0.0%)
                const test4 = touGetWithholdingTaxRate(20000, 'single', 0, false);
                console.log(`Test 4 - Single 20k: Expected 0.00%, Got ${formatTaxRate(test4.rate)}`, test4.rate === 0.0 ? '✓ PASS' : '✗ FAIL');

                console.log('=== END VALIDATION TESTS ===');

            } else {
                console.error('❌ Failed to load embedded tax data');
                touShowDataLoadingError('Failed to load embedded tax brackets data', false);
            }
        }

        /**
         * Test function for comprehensive deduction system
         */
        function testComprehensiveDeductionSystem() {
            console.log('🧪 [TEST] Starting comprehensive deduction system tests...');

            // Test 1: Forfait deductions
            console.log('📋 [TEST 1] Testing forfait deductions...');
            const testProfile = {
                revenu_brut_determinant: 80000,
                etat_civil: 'celibataire',
                nombre_enfants: 0
            };

            try {
                const forfaitOptions = { type: 'forfaitaire' };
                const forfaitResult = calculerDeductionsComprehensives(testProfile, forfaitOptions);
                console.log('✅ [TEST 1] Forfait deductions calculated successfully:', forfaitResult);

                // Validate that ICC and IFD have different deduction amounts
                if (forfaitResult.ICC.total_deductions_sur_revenu !== forfaitResult.IFD.total_deductions_sur_revenu) {
                    console.log('✅ [TEST 1] ICC and IFD deductions are correctly different');
                } else {
                    console.warn('⚠️ [TEST 1] ICC and IFD deductions are the same - this might be expected for forfait');
                }
            } catch (error) {
                console.error('❌ [TEST 1] Forfait deduction test failed:', error);
            }

            // Test 2: Actual expense deductions
            console.log('📋 [TEST 2] Testing actual expense deductions...');
            const actualExpenseOptions = {
                type: 'reel',
                commuting: { enabled: true, amount: 2000 },
                meals: { enabled: true, workingDays: 220, employerContribution: false },
                healthInsurance: { enabled: true, amount: 5000, category: 'adults' },
                pillar3A: { enabled: true, amount: 6000, hasSecondPillar: true },
                childcare: { enabled: true, amount: 20000, children: 1 },
                loanInterest: { enabled: true, amount: 10000 },
                trainingExpenses: { enabled: true, amount: 5000 }
            };

            try {
                const actualResult = calculerDeductionsComprehensives(testProfile, actualExpenseOptions);
                console.log('✅ [TEST 2] Actual expense deductions calculated successfully:', actualResult);

                // Validate that ICC and IFD have different limits applied
                const iccTotal = actualResult.ICC.total_deductions_sur_revenu;
                const ifdTotal = actualResult.IFD.total_deductions_sur_revenu;

                if (iccTotal !== ifdTotal) {
                    console.log('✅ [TEST 2] ICC and IFD actual deductions are correctly different');
                    console.log(`   ICC total: ${formatCurrency(iccTotal)}`);
                    console.log(`   IFD total: ${formatCurrency(ifdTotal)}`);
                } else {
                    console.warn('⚠️ [TEST 2] ICC and IFD actual deductions are the same');
                }
            } catch (error) {
                console.error('❌ [TEST 2] Actual expense deduction test failed:', error);
            }

            // Test 3: Validation system
            console.log('📋 [TEST 3] Testing validation system...');
            const invalidOptions = {
                type: 'reel',
                meals: { enabled: true, workingDays: 300, employerContribution: false }, // Invalid: too many days
                medicalExpenses: { enabled: true, amount: 1000, insuranceReimbursement: 1500 }, // Invalid: reimbursement > amount
                doubleResidence: { enabled: true, amount: 10000, months: 15 } // Invalid: too many months
            };

            try {
                const validation = touValidateActualExpenseInputs(invalidOptions);
                if (!validation.isValid && validation.errors.length > 0) {
                    console.log('✅ [TEST 3] Validation system correctly detected errors:', validation.errors);
                } else {
                    console.error('❌ [TEST 3] Validation system failed to detect errors');
                }
            } catch (error) {
                console.error('❌ [TEST 3] Validation test failed:', error);
            }

            // Test 4: Limits enforcement
            console.log('📋 [TEST 4] Testing limits enforcement...');
            const limitsTestOptions = {
                type: 'reel',
                pillar3A: { enabled: true, amount: 10000, hasSecondPillar: true }, // Should be limited to 7,056
                unionContributions: { enabled: true, amount: 1000 }, // Should be limited to 700 for ICC
                loanInterest: { enabled: true, amount: 60000 } // Should be limited to 50,000
            };

            try {
                const limitsResult = calculerDeductionsComprehensives(testProfile, limitsTestOptions);
                console.log('✅ [TEST 4] Limits enforcement test completed:', limitsResult);

                // Check if limits were applied
                const iccDetails = limitsResult.ICC.details;
                const ifdDetails = limitsResult.IFD.details;

                if (iccDetails['3ème pilier A'] <= 7056) {
                    console.log('✅ [TEST 4] 3rd pillar A limit correctly applied');
                }
                if (iccDetails['Cotisations syndicales'] <= 700) {
                    console.log('✅ [TEST 4] Union contributions limit correctly applied');
                }
                if (iccDetails['Intérêts d\'emprunts'] <= 50000) {
                    console.log('✅ [TEST 4] Loan interest limit correctly applied');
                }
            } catch (error) {
                console.error('❌ [TEST 4] Limits enforcement test failed:', error);
            }

            console.log('🏁 [TEST] Comprehensive deduction system tests completed');
        }

        /**
         * Test function for social contribution rates from JSON configuration
         */
        function testSocialContributionRates() {
            console.log('🧪 [TEST] Testing social contribution rates from JSON configuration...');

            // Test 1: Check if social contribution rates are loaded
            console.log('📋 [TEST 1] Checking social contribution rates availability...');
            if (socialContributionRates && Object.keys(socialContributionRates).length > 0) {
                console.log('✅ [TEST 1] Social contribution rates loaded successfully');
                console.log('📊 [TEST 1] Available rates:', Object.keys(socialContributionRates).filter(key => key !== 'description' && key !== 'source'));
            } else {
                console.error('❌ [TEST 1] Social contribution rates not loaded');
                return;
            }

            // Test 2: Test individual rate retrieval
            console.log('📋 [TEST 2] Testing individual rate retrieval...');
            const testCases = [
                { type: 'avs', rateType: 'taux_employe', expected: 0.0435 },
                { type: 'ai', rateType: 'taux_employe', expected: 0.007 },
                { type: 'apg', rateType: 'taux_employe', expected: 0.0025 },
                { type: 'ac', rateType: 'taux_employe', expected: 0.011 },
                { type: 'ac', rateType: 'plafond_salaire', expected: 148200 },
                { type: 'amat', rateType: 'taux_employe', expected: 0.00032 },
                { type: 'pilier2', rateType: 'taux_employe_moyen', expected: 0.06 },
                { type: 'aanp', rateType: 'taux_employe', expected: 0.01 }
            ];

            testCases.forEach((testCase, index) => {
                const rate = getSocialContributionRate(testCase.type, testCase.rateType);
                const match = rate === testCase.expected;
                console.log(`   Test ${index + 1}: ${testCase.type}.${testCase.rateType} = ${rate} ${match ? '✅' : '❌'} (expected: ${testCase.expected})`);
            });

            // Test 3: Test full social contribution calculation
            console.log('📋 [TEST 3] Testing full social contribution calculation...');
            const testIncome = 80000;
            const contributions = calculateSocialContributions(testIncome);

            console.log(`📊 [TEST 3] Social contributions for ${testIncome.toLocaleString()} CHF:`);
            console.log(`   AVS/AI/APG: ${contributions.avs_ai_apg.toFixed(2)} CHF`);
            console.log(`   Chômage: ${contributions.chomage.toFixed(2)} CHF`);
            console.log(`   2ème pilier: ${contributions.pilier2.toFixed(2)} CHF`);
            console.log(`   Maternité: ${contributions.maternite.toFixed(2)} CHF`);
            console.log(`   AANP: ${contributions.aanp.toFixed(2)} CHF`);
            console.log(`   Total: ${contributions.total.toFixed(2)} CHF`);

            // Validate against expected values (using 2025 rates)
            const expectedAvsAiApg = testIncome * (0.0435 + 0.007 + 0.0025); // 4240.00
            const expectedChomage = testIncome * 0.011; // 880.00
            const expectedPilier2 = Math.min(testIncome * 0.06, 54432); // 4800.00
            const expectedMaternite = testIncome * 0.00032; // 25.60
            const expectedAanp = Math.min(testIncome * 0.01, 1482); // 800.00
            const expectedTotal = expectedAvsAiApg + expectedChomage + expectedPilier2 + expectedMaternite + expectedAanp;

            const tolerance = 0.01;
            const avsMatch = Math.abs(contributions.avs_ai_apg - expectedAvsAiApg) <= tolerance;
            const chomageMatch = Math.abs(contributions.chomage - expectedChomage) <= tolerance;
            const pilier2Match = Math.abs(contributions.pilier2 - expectedPilier2) <= tolerance;
            const materniteMatch = Math.abs(contributions.maternite - expectedMaternite) <= tolerance;
            const aanpMatch = Math.abs(contributions.aanp - expectedAanp) <= tolerance;
            const totalMatch = Math.abs(contributions.total - expectedTotal) <= tolerance;

            console.log('📊 [TEST 3] Validation results:');
            console.log(`   AVS/AI/APG: ${avsMatch ? '✅' : '❌'} (${contributions.avs_ai_apg.toFixed(2)} vs ${expectedAvsAiApg.toFixed(2)})`);
            console.log(`   Chômage: ${chomageMatch ? '✅' : '❌'} (${contributions.chomage.toFixed(2)} vs ${expectedChomage.toFixed(2)})`);
            console.log(`   2ème pilier: ${pilier2Match ? '✅' : '❌'} (${contributions.pilier2.toFixed(2)} vs ${expectedPilier2.toFixed(2)})`);
            console.log(`   Maternité: ${materniteMatch ? '✅' : '❌'} (${contributions.maternite.toFixed(2)} vs ${expectedMaternite.toFixed(2)})`);
            console.log(`   AANP: ${aanpMatch ? '✅' : '❌'} (${contributions.aanp.toFixed(2)} vs ${expectedAanp.toFixed(2)})`);
            console.log(`   Total: ${totalMatch ? '✅' : '❌'} (${contributions.total.toFixed(2)} vs ${expectedTotal.toFixed(2)})`);

            if (avsMatch && chomageMatch && pilier2Match && materniteMatch && aanpMatch && totalMatch) {
                console.log('✅ [TEST 3] All social contribution calculations are correct!');
            } else {
                console.error('❌ [TEST 3] Some social contribution calculations are incorrect');
            }

            console.log('🏁 [TEST] Social contribution rates tests completed');
        }

        // Add the test function to the window object for manual testing
        window.testSocialContributionRates = testSocialContributionRates;

        /**
         * Test function for IFD calculation accuracy - specifically testing rate conversion fix
         */
        function testIfdRateConversionFix() {
            console.log('🧪 [TEST] Testing IFD rate conversion fix...');

            // Test case: Income that falls in the 2.97% bracket (55,401 - 72,800)
            const testIncome = 65000; // Falls in 2.97% bracket
            console.log(`📋 [TEST] Test case: Single person with ${testIncome.toLocaleString()} CHF income`);

            try {
                const result = calculateIfdTax(testIncome, 'celibataire');

                console.log('📊 [TEST] IFD Calculation Results:');
                console.log(`   Total tax: ${result.impotTotal.toFixed(2)} CHF`);
                console.log(`   Effective rate: ${result.tauxEffectif.toFixed(2)}%`);

                // Show calculation breakdown to verify rates are displayed correctly
                console.log('📊 [TEST] Calculation breakdown:');
                result.details.forEach((detail, index) => {
                    console.log(`   Bracket ${index + 1}: ${detail.tranche} - ${detail.montantImpose.toFixed(2)} CHF × ${detail.taux.toFixed(2)}% = ${detail.impot.toFixed(2)} CHF`);

                    // Specific check for the 2.97% bracket
                    if (detail.taux > 2.9 && detail.taux < 3.0) {
                        console.log(`   ✅ [TEST] Rate display check: ${detail.taux.toFixed(2)}% (should be ~2.97%)`);

                        // Verify the calculation is correct
                        const expectedTax = detail.montantImpose * 0.0297;
                        const actualTax = detail.impot;
                        const difference = Math.abs(actualTax - expectedTax);

                        if (difference < 0.01) {
                            console.log(`   ✅ [TEST] Calculation check: ${actualTax.toFixed(2)} CHF (expected: ${expectedTax.toFixed(2)} CHF)`);
                        } else {
                            console.error(`   ❌ [TEST] Calculation error: ${actualTax.toFixed(2)} CHF (expected: ${expectedTax.toFixed(2)} CHF)`);
                            return false;
                        }
                    }
                });

                // Test specific case mentioned in the issue: 9,976 CHF at 2.97%
                const testAmount = 9976;
                const expectedTax = testAmount * 0.0297; // Should be ~296.28 CHF
                console.log(`📋 [TEST] Specific case: ${testAmount.toLocaleString()} CHF × 2.97% = ${expectedTax.toFixed(2)} CHF`);

                console.log('✅ [TEST] IFD rate conversion fix validation PASSED');
                return true;

            } catch (error) {
                console.error('❌ [TEST] IFD rate conversion test ERROR:', error);
                return false;
            }
        }

        // Add the IFD rate test function to the window object for manual testing
        window.testIfdRateConversionFix = testIfdRateConversionFix;

        /**
         * Test function for ICC 12% reduction calculation fix
         */
        function testIcc12PercentReduction() {
            console.log('🧪 [TEST] Testing ICC 12% reduction calculation fix...');

            // Test case: Income that should generate a clear base tax and reduction
            const testIncome = 60000; // Should generate a reasonable base tax
            const testCommune = 'GENEVE';
            const testFamilyStatus = 'celibataire';

            console.log(`📋 [TEST] Test case: ${testFamilyStatus} with ${testIncome.toLocaleString()} CHF income in ${testCommune}`);

            try {
                const result = calculateIccFinalTax(testIncome, testFamilyStatus, testCommune, 2025);

                console.log('📊 [TEST] ICC Calculation Results:');
                console.log(`   Base tax: ${result.impotDeBase.toFixed(2)} CHF`);
                console.log(`   12% reduction: ${result.reductionBase.toFixed(2)} CHF`);
                console.log(`   After reduction: ${result.impotApresReduction.toFixed(2)} CHF`);
                console.log(`   Cantonal centimes: ${result.centimesCantonaux.toFixed(2)} CHF`);
                console.log(`   Aide domicile: ${result.centimeAideDomicile.toFixed(2)} CHF`);
                console.log(`   Municipal centimes: ${result.centimesCommunaux.toFixed(2)} CHF`);
                console.log(`   Total ICC: ${result.impotTotalDu.toFixed(2)} CHF`);

                // Validate the 12% reduction calculation
                const expectedReduction = result.impotDeBase * 0.12;
                const actualReduction = result.reductionBase;
                const reductionDifference = Math.abs(actualReduction - expectedReduction);

                console.log('📊 [TEST] 12% Reduction Validation:');
                console.log(`   Expected reduction: ${expectedReduction.toFixed(2)} CHF`);
                console.log(`   Actual reduction: ${actualReduction.toFixed(2)} CHF`);
                console.log(`   Difference: ${reductionDifference.toFixed(2)} CHF`);

                // Check for NaN values
                const hasNaN = Object.values(result).some(value =>
                    typeof value === 'number' && isNaN(value)
                );

                if (hasNaN) {
                    console.error('❌ [TEST] NaN values detected in ICC calculation result');
                    return false;
                }

                if (reductionDifference < 0.01) {
                    console.log('✅ [TEST] 12% reduction calculation is correct');
                } else {
                    console.error('❌ [TEST] 12% reduction calculation is incorrect');
                    return false;
                }

                // Test specific case: 1000 CHF base tax should give 120 CHF reduction
                console.log('📋 [TEST] Testing specific reduction case...');
                if (result.impotDeBase > 0) {
                    const reductionPercentage = (result.reductionBase / result.impotDeBase) * 100;
                    console.log(`   Reduction percentage: ${reductionPercentage.toFixed(2)}% (should be 12.00%)`);

                    if (Math.abs(reductionPercentage - 12.0) < 0.01) {
                        console.log('✅ [TEST] Reduction percentage is exactly 12%');
                    } else {
                        console.error('❌ [TEST] Reduction percentage is not 12%');
                        return false;
                    }
                }

                console.log('✅ [TEST] ICC 12% reduction calculation test PASSED');
                return true;

            } catch (error) {
                console.error('❌ [TEST] ICC 12% reduction test ERROR:', error);
                return false;
            }
        }

        // Add the ICC reduction test function to the window object for manual testing
        window.testIcc12PercentReduction = testIcc12PercentReduction;


    </script>
</body>
</html>